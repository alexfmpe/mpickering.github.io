<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Handles @deriving@ clauses on @data@ declarations.
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcDeriv</span><span> </span><span class="hs-special">(</span><span> </span><a href="TcDeriv.html#tcDeriving"><span class="hs-identifier hs-var">tcDeriving</span></a><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-type">DerivInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#mkDerivInfos"><span class="hs-identifier hs-var">mkDerivInfos</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="HsSyn.html"><span class="hs-identifier">HsSyn</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="TcErrors.html"><span class="hs-identifier">TcErrors</span></a><span class="hs-special">(</span><span> </span><a href="TcErrors.html#reportAllUnsolved"><span class="hs-identifier hs-var">reportAllUnsolved</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="TcValidity.html"><span class="hs-identifier">TcValidity</span></a><span class="hs-special">(</span><span> </span><a href="TcValidity.html#validDerivPred"><span class="hs-identifier hs-var">validDerivPred</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="TcClassDcl.html"><span class="hs-identifier">TcClassDcl</span></a><span class="hs-special">(</span><span> </span><a href="TcClassDcl.html#tcATDefault"><span class="hs-identifier hs-var">tcATDefault</span></a><span class="hs-special">,</span><span> </span><a href="TcClassDcl.html#tcMkDeclCtxt"><span class="hs-identifier hs-var">tcMkDeclCtxt</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="TcGenDeriv.html"><span class="hs-identifier">TcGenDeriv</span></a><span>                       </span><span class="hs-comment">-- Deriv stuff</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="TcGenGenerics.html"><span class="hs-identifier">TcGenGenerics</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="InstEnv.html"><span class="hs-identifier">InstEnv</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="FamInstEnv.html"><span class="hs-identifier">FamInstEnv</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsType.html"><span class="hs-identifier">TcHsType</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="TcSimplify.html"><span class="hs-identifier">TcSimplify</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span class="hs-special">(</span><span> </span><a href="TcUnify.html#buildImplicationFor"><span class="hs-identifier hs-var">buildImplicationFor</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span class="hs-special">(</span><span> </span><a href="LoadIface.html#loadInterfaceForName"><span class="hs-identifier hs-var">loadInterfaceForName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span class="hs-special">(</span><span> </span><a href="Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="RnNames.html"><span class="hs-identifier">RnNames</span></a><span class="hs-special">(</span><span> </span><a href="RnNames.html#extendGlobalRdrEnvRn"><span class="hs-identifier hs-var">extendGlobalRdrEnvRn</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="RnBinds.html"><span class="hs-identifier">RnBinds</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="RnEnv.html"><span class="hs-identifier">RnEnv</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="RnSource.html"><span class="hs-identifier">RnSource</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="RnSource.html#addTcgDUs"><span class="hs-identifier hs-var">addTcgDUs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="HscTypes.html"><span class="hs-identifier">HscTypes</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Avail.html"><span class="hs-identifier">Avail</span></a><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Unify.html"><span class="hs-identifier">Unify</span></a><span class="hs-special">(</span><span> </span><a href="Unify.html#tcUnifyTy"><span class="hs-identifier hs-var">tcUnifyTy</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="Class.html"><span class="hs-identifier">Class</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="ErrUtils.html"><span class="hs-identifier">ErrUtils</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="RdrName.html"><span class="hs-identifier">RdrName</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="NameSet.html"><span class="hs-identifier">NameSet</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="TcType.html"><span class="hs-identifier">TcType</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="PrelNames.html"><span class="hs-identifier">PrelNames</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="THNames.html"><span class="hs-identifier">THNames</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="THNames.html#liftClassKey"><span class="hs-identifier hs-var">liftClassKey</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="Bag.html"><span class="hs-identifier">Bag</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">LanguageExtensions</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Overview
*                                                                      *
************************************************************************

Overall plan
~~~~~~~~~~~~
1.  Convert the decls (i.e. data/newtype deriving clauses,
    plus standalone deriving) to [EarlyDerivSpec]

2.  Infer the missing contexts for the InferTheta's

3.  Add the derived bindings, generating InstInfos
-}</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">-- DerivSpec is purely  local to this module</span><span>
</span><a name="line-88"></a><span class="hs-keyword">data</span><span> </span><a name="DerivSpec"><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier">DerivSpec</span></a></a><span> </span><a name="local-1628276097"><a href="#local-1628276097"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="DS"><a href="TcDeriv.html#DS"><span class="hs-identifier">DS</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a href="TcDeriv.html#ds_loc"><span class="hs-identifier">ds_loc</span></a><span>     </span><span class="hs-glyph">::</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span>
</span><a name="line-89"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#ds_name"><span class="hs-identifier">ds_name</span></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>           </span><span class="hs-comment">-- DFun name</span><span>
</span><a name="line-90"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#ds_tvs"><span class="hs-identifier">ds_tvs</span></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-91"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#ds_theta"><span class="hs-identifier">ds_theta</span></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="#local-1628276097"><span class="hs-identifier hs-type">theta</span></a><span>
</span><a name="line-92"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#ds_cls"><span class="hs-identifier">ds_cls</span></a><span>     </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span>
</span><a name="line-93"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#ds_tys"><span class="hs-identifier">ds_tys</span></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-94"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#ds_tc"><span class="hs-identifier">ds_tc</span></a><span>      </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-95"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#ds_overlap"><span class="hs-identifier">ds_overlap</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="BasicTypes.html#OverlapMode"><span class="hs-identifier hs-type">OverlapMode</span></a><span>
</span><a name="line-96"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#ds_newtype"><span class="hs-identifier">ds_newtype</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- The newtype rep type</span><span>
</span><a name="line-97"></a><span>        </span><span class="hs-comment">-- This spec implies a dfun declaration of the form</span><span>
</span><a name="line-98"></a><span>        </span><span class="hs-comment">--       df :: forall tvs. theta =&gt; C tys</span><span>
</span><a name="line-99"></a><span>        </span><span class="hs-comment">-- The Name is the name for the DFun we'll build</span><span>
</span><a name="line-100"></a><span>        </span><span class="hs-comment">-- The tyvars bind all the variables in the theta</span><span>
</span><a name="line-101"></a><span>        </span><span class="hs-comment">-- For type families, the tycon in</span><span>
</span><a name="line-102"></a><span>        </span><span class="hs-comment">--       in ds_tys is the *family* tycon</span><span>
</span><a name="line-103"></a><span>        </span><span class="hs-comment">--       in ds_tc is the *representation* type</span><span>
</span><a name="line-104"></a><span>        </span><span class="hs-comment">-- For non-family tycons, both are the same</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span>        </span><span class="hs-comment">-- the theta is either the given and final theta, in standalone deriving,</span><span>
</span><a name="line-107"></a><span>        </span><span class="hs-comment">-- or the not-yet-simplified list of constraints together with their origin</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>        </span><span class="hs-comment">-- ds_newtype = Just rep_ty  &lt;=&gt; Generalised Newtype Deriving (GND)</span><span>
</span><a name="line-110"></a><span>        </span><span class="hs-comment">--              Nothing      &lt;=&gt; Vanilla deriving</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-comment">{-
Example:

     newtype instance T [a] = MkT (Tree a) deriving( C s )
==&gt;
     axiom T [a] = :RTList a
     axiom :RTList a = Tree a

     DS { ds_tvs = [a,s], ds_cls = C, ds_tys = [s, T [a]]
        , ds_tc = :RTList, ds_newtype = Just (Tree a) }
-}</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-keyword">type</span><span> </span><a name="DerivContext"><a href="TcDeriv.html#DerivContext"><span class="hs-identifier">DerivContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span>
</span><a name="line-125"></a><span>   </span><span class="hs-comment">-- Nothing    &lt;=&gt; Vanilla deriving; infer the context of the instance decl</span><span>
</span><a name="line-126"></a><span>   </span><span class="hs-comment">-- Just theta &lt;=&gt; Standalone deriving: context supplied by programmer</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-keyword">data</span><span> </span><a name="PredOrigin"><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier">PredOrigin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PredOrigin"><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier">PredOrigin</span></a></a><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span> </span><a href="TcRnTypes.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a><span>
</span><a name="line-129"></a><span class="hs-keyword">type</span><span> </span><a name="ThetaOrigin"><a href="TcDeriv.html#ThetaOrigin"><span class="hs-identifier">ThetaOrigin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span class="hs-special">]</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-identifier">mkPredOrigin</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span>
</span><a name="line-132"></a><a name="mkPredOrigin"><a href="TcDeriv.html#mkPredOrigin"><span class="hs-identifier">mkPredOrigin</span></a></a><span> </span><a name="local-1628276101"><a href="#local-1628276101"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-1628276102"><a href="#local-1628276102"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-1628276103"><a href="#local-1628276103"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier hs-var">PredOrigin</span></a><span> </span><a href="#local-1628276103"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-1628276101"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628276102"><span class="hs-identifier hs-var">t_or_k</span></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-identifier">mkThetaOrigin</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#ThetaOrigin"><span class="hs-identifier hs-type">ThetaOrigin</span></a><span>
</span><a name="line-135"></a><a name="mkThetaOrigin"><a href="TcDeriv.html#mkThetaOrigin"><span class="hs-identifier">mkThetaOrigin</span></a></a><span> </span><a name="local-1628276104"><a href="#local-1628276104"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-1628276105"><a href="#local-1628276105"><span class="hs-identifier">t_or_k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#mkPredOrigin"><span class="hs-identifier hs-var">mkPredOrigin</span></a><span> </span><a href="#local-1628276104"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628276105"><span class="hs-identifier hs-var">t_or_k</span></a><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-keyword">data</span><span> </span><a name="EarlyDerivSpec"><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier">EarlyDerivSpec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="InferTheta"><a href="TcDeriv.html#InferTheta"><span class="hs-identifier">InferTheta</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="TcDeriv.html#ThetaOrigin"><span class="hs-identifier hs-type">ThetaOrigin</span></a><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a name="GivenTheta"><a href="TcDeriv.html#GivenTheta"><span class="hs-identifier">GivenTheta</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>        </span><span class="hs-comment">-- InferTheta ds =&gt; the context for the instance should be inferred</span><span>
</span><a name="line-140"></a><span>        </span><span class="hs-comment">--      In this case ds_theta is the list of all the constraints</span><span>
</span><a name="line-141"></a><span>        </span><span class="hs-comment">--      needed, such as (Eq [a], Eq a), together with a suitable CtLoc</span><span>
</span><a name="line-142"></a><span>        </span><span class="hs-comment">--      to get good error messages.</span><span>
</span><a name="line-143"></a><span>        </span><span class="hs-comment">--      The inference process is to reduce this to a</span><span>
</span><a name="line-144"></a><span>        </span><span class="hs-comment">--      simpler form (e.g. Eq a)</span><span>
</span><a name="line-145"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-146"></a><span>        </span><span class="hs-comment">-- GivenTheta ds =&gt; the exact context for the instance is supplied</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-comment">--                  by the programmer; it is ds_theta</span><span>
</span><a name="line-148"></a><span>        </span><span class="hs-comment">-- See Note [Inferring the instance context]</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-identifier">earlyDSLoc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier hs-type">EarlyDerivSpec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span>
</span><a name="line-151"></a><a name="earlyDSLoc"><a href="TcDeriv.html#earlyDSLoc"><span class="hs-identifier">earlyDSLoc</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#InferTheta"><span class="hs-identifier hs-var">InferTheta</span></a><span> </span><a name="local-1628276106"><a href="#local-1628276106"><span class="hs-identifier">spec</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ds_loc</span><span> </span><a href="#local-1628276106"><span class="hs-identifier hs-var">spec</span></a><span>
</span><a name="line-152"></a><span class="hs-identifier">earlyDSLoc</span><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#GivenTheta"><span class="hs-identifier hs-var">GivenTheta</span></a><span> </span><a name="local-1628276107"><a href="#local-1628276107"><span class="hs-identifier">spec</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ds_loc</span><span> </span><a href="#local-1628276107"><span class="hs-identifier hs-var">spec</span></a><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-identifier">splitEarlyDerivSpec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier hs-type">EarlyDerivSpec</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="TcDeriv.html#ThetaOrigin"><span class="hs-identifier hs-type">ThetaOrigin</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><a name="splitEarlyDerivSpec"><a href="TcDeriv.html#splitEarlyDerivSpec"><span class="hs-identifier">splitEarlyDerivSpec</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span class="hs-identifier">splitEarlyDerivSpec</span><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#InferTheta"><span class="hs-identifier hs-var">InferTheta</span></a><span> </span><a name="local-1628276108"><a href="#local-1628276108"><span class="hs-identifier">spec</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1628276109"><a href="#local-1628276109"><span class="hs-identifier">specs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-157"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="TcDeriv.html#splitEarlyDerivSpec"><span class="hs-identifier hs-var">splitEarlyDerivSpec</span></a><span> </span><a href="#local-1628276109"><span class="hs-identifier hs-var">specs</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">(</span><a name="local-1628276110"><a href="#local-1628276110"><span class="hs-identifier">is</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276111"><a href="#local-1628276111"><span class="hs-identifier">gs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628276108"><span class="hs-identifier hs-var">spec</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1628276110"><span class="hs-identifier hs-var">is</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628276111"><span class="hs-identifier hs-var">gs</span></a><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span class="hs-identifier">splitEarlyDerivSpec</span><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#GivenTheta"><span class="hs-identifier hs-var">GivenTheta</span></a><span> </span><a name="local-1628276112"><a href="#local-1628276112"><span class="hs-identifier">spec</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1628276113"><a href="#local-1628276113"><span class="hs-identifier">specs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="TcDeriv.html#splitEarlyDerivSpec"><span class="hs-identifier hs-var">splitEarlyDerivSpec</span></a><span> </span><a href="#local-1628276113"><span class="hs-identifier hs-var">specs</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">(</span><a name="local-1628276114"><a href="#local-1628276114"><span class="hs-identifier">is</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276115"><a href="#local-1628276115"><span class="hs-identifier">gs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628276114"><span class="hs-identifier hs-var">is</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628276112"><span class="hs-identifier hs-var">spec</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1628276115"><span class="hs-identifier hs-var">gs</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span class="hs-identifier">pprDerivSpec</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628276100"><span class="hs-identifier hs-type">theta</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="#local-1628276100"><span class="hs-identifier hs-type">theta</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-162"></a><a name="pprDerivSpec"><a href="TcDeriv.html#pprDerivSpec"><span class="hs-identifier">pprDerivSpec</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#DS"><span class="hs-identifier hs-var">DS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276116"><a href="#local-1628276116"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276117"><a href="#local-1628276117"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276118"><a href="#local-1628276118"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-163"></a><span>                   </span><span class="hs-identifier">ds_cls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276119"><a href="#local-1628276119"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276120"><a href="#local-1628276120"><span class="hs-identifier">tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276121"><a href="#local-1628276121"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;DerivSpec&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;ds_loc   =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276116"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-166"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;ds_name  =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276117"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-167"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;ds_tvs   =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276118"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-168"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;ds_cls   =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276119"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-169"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;ds_tys   =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276120"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-170"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;ds_theta =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276121"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628276599"><span class="hs-identifier hs-type">theta</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="#local-1628276599"><span class="hs-identifier hs-type">theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-173"></a><span>  </span><a name="local-1912686315"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#pprDerivSpec"><span class="hs-identifier hs-var">pprDerivSpec</span></a><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier hs-type">EarlyDerivSpec</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-176"></a><span>  </span><a name="local-1912686315"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#InferTheta"><span class="hs-identifier hs-var">InferTheta</span></a><span> </span><a name="local-1628276597"><a href="#local-1628276597"><span class="hs-identifier">spec</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276597"><span class="hs-identifier hs-var">spec</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;(Infer)&quot;</span><span>
</span><a name="line-177"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#GivenTheta"><span class="hs-identifier hs-var">GivenTheta</span></a><span> </span><a name="local-1628276598"><a href="#local-1628276598"><span class="hs-identifier">spec</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276598"><span class="hs-identifier hs-var">spec</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;(Given)&quot;</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-180"></a><span>  </span><a name="local-1912686315"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier hs-var">PredOrigin</span></a><span> </span><a name="local-1628276596"><a href="#local-1628276596"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276596"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-comment">-- The origin is not so interesting when debugging</span><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span class="hs-comment">{- Note [Inferring the instance context]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There are two sorts of 'deriving':

  * InferTheta: the deriving clause for a data type
      data T a = T1 a deriving( Eq )
    Here we must infer an instance context,
    and generate instance declaration
      instance Eq a =&gt; Eq (T a) where ...

  * CheckTheta: standalone deriving
      deriving instance Eq a =&gt; Eq (T a)
    Here we only need to fill in the bindings;
    the instance context is user-supplied

For a deriving clause (InferTheta) we must figure out the
instance context (inferConstraints). Suppose we are inferring
the instance context for
    C t1 .. tn (T s1 .. sm)
There are two cases

  * (T s1 .. sm) :: *         (the normal case)
    Then we behave like Eq and guess (C t1 .. tn t)
    for each data constructor arg of type t.  More
    details below.

  * (T s1 .. sm) :: * -&gt; *    (the functor-like case)
    Then we behave like Functor.

In both cases we produce a bunch of un-simplified constraints
and them simplify them in simplifyInstanceContexts; see
Note [Simplifying the instance context].


Note [Data decl contexts]
~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

        data (RealFloat a) =&gt; Complex a = !a :+ !a deriving( Read )

We will need an instance decl like:

        instance (Read a, RealFloat a) =&gt; Read (Complex a) where
          ...

The RealFloat in the context is because the read method for Complex is bound
to construct a Complex, and doing that requires that the argument type is
in RealFloat.

But this ain't true for Show, Eq, Ord, etc, since they don't construct
a Complex; they only take them apart.

Our approach: identify the offending classes, and add the data type
context to the instance decl.  The &quot;offending classes&quot; are

        Read, Enum?

FURTHER NOTE ADDED March 2002.  In fact, Haskell98 now requires that
pattern matching against a constructor from a data type with a context
gives rise to the constraints for that context -- or at least the thinned
version.  So now all classes are &quot;offending&quot;.

Note [Newtype deriving]
~~~~~~~~~~~~~~~~~~~~~~~
Consider this:
    class C a b
    instance C [a] Char
    newtype T = T Char deriving( C [a] )

Notice the free 'a' in the deriving.  We have to fill this out to
    newtype T = T Char deriving( forall a. C [a] )

And then translate it to:
    instance C [a] Char =&gt; C [a] T where ...


Note [Newtype deriving superclasses]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(See also Trac #1220 for an interesting exchange on newtype
deriving and superclasses.)

The 'tys' here come from the partial application in the deriving
clause. The last arg is the new instance type.

We must pass the superclasses; the newtype might be an instance
of them in a different way than the representation type
E.g.            newtype Foo a = Foo a deriving( Show, Num, Eq )
Then the Show instance is not done via Coercible; it shows
        Foo 3 as &quot;Foo 3&quot;
The Num instance is derived via Coercible, but the Show superclass
dictionary must the Show instance for Foo, *not* the Show dictionary
gotten from the Num dictionary. So we must build a whole new dictionary
not just use the Num one.  The instance we want is something like:
     instance (Num a, Show (Foo a), Eq (Foo a)) =&gt; Num (Foo a) where
        (+) = ((+)@a)
        ...etc...
There may be a coercion needed which we get from the tycon for the newtype
when the dict is constructed in TcInstDcls.tcInstDecl2


Note [Unused constructors and deriving clauses]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See Trac #3221.  Consider
   data T = T1 | T2 deriving( Show )
Are T1 and T2 unused?  Well, no: the deriving clause expands to mention
both of them.  So we gather defs/uses from deriving just like anything else.

-}</span><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span class="hs-comment">-- | Stuff needed to process a `deriving` clause</span><span>
</span><a name="line-292"></a><span class="hs-keyword">data</span><span> </span><a name="DerivInfo"><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier">DerivInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="DerivInfo"><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier">DerivInfo</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a href="TcDeriv.html#di_rep_tc"><span class="hs-identifier">di_rep_tc</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-293"></a><span>                             </span><span class="hs-comment">-- ^ The data tycon for normal datatypes,</span><span>
</span><a name="line-294"></a><span>                             </span><span class="hs-comment">-- or the *representation* tycon for data families</span><span>
</span><a name="line-295"></a><span>                           </span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#di_preds"><span class="hs-identifier">di_preds</span></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HsTypes.html#LHsSigType"><span class="hs-identifier hs-type">LHsSigType</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span>
</span><a name="line-296"></a><span>                           </span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#di_ctxt"><span class="hs-identifier">di_ctxt</span></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-comment">-- ^ error context</span><span>
</span><a name="line-297"></a><span>                           </span><span class="hs-special">}</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-comment">-- | Extract `deriving` clauses of proper data type (skips data families)</span><span>
</span><a name="line-300"></a><span class="hs-identifier">mkDerivInfos</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#TyClGroup"><span class="hs-identifier hs-type">TyClGroup</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-type">DerivInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-301"></a><a name="mkDerivInfos"><a href="TcDeriv.html#mkDerivInfos"><span class="hs-identifier">mkDerivInfos</span></a></a><span> </span><a name="local-1628276122"><a href="#local-1628276122"><span class="hs-identifier">tycls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MonadUtils.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="#local-1628276123"><span class="hs-identifier hs-var">mk_derivs</span></a><span> </span><a href="#local-1628276122"><span class="hs-identifier hs-var">tycls</span></a><span>
</span><a name="line-302"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-303"></a><span>    </span><a name="local-1628276123"><a href="#local-1628276123"><span class="hs-identifier">mk_derivs</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#TyClGroup"><span class="hs-identifier hs-var">TyClGroup</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276125"><a href="#local-1628276125"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="MonadUtils.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276124"><span class="hs-identifier hs-var">mk_deriv</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276125"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span>    </span><a name="local-1628276124"><a href="#local-1628276124"><span class="hs-identifier">mk_deriv</span></a></a><span> </span><a name="local-1628276126"><a href="#local-1628276126"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="HsDecls.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628276127"><a href="#local-1628276127"><span class="hs-identifier">data_name</span></a></a><span>
</span><a name="line-307"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdDataDefn</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-308"></a><span>                                </span><a href="HsDecls.html#HsDataDefn"><span class="hs-identifier hs-var">HsDataDefn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dd_derivs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628276128"><a href="#local-1628276128"><span class="hs-identifier">preds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276129"><a href="#local-1628276129"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><a href="#local-1628276127"><span class="hs-identifier hs-var">data_name</span></a><span>
</span><a name="line-310"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-var">DerivInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">di_rep_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276129"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">di_preds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276128"><span class="hs-identifier hs-var">preds</span></a><span>
</span><a name="line-311"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">di_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcClassDcl.html#tcMkDeclCtxt"><span class="hs-identifier hs-var">tcMkDeclCtxt</span></a><span> </span><a href="#local-1628276126"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-312"></a><span>    </span><span class="hs-identifier">mk_deriv</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span class="hs-comment">{-

************************************************************************
*                                                                      *
\subsection[TcDeriv-driver]{Top-level function for \tr{derivings}}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span class="hs-identifier">tcDeriving</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-type">DerivInfo</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- All `deriving` clauses</span><span>
</span><a name="line-324"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LDerivDecl"><span class="hs-identifier hs-type">LDerivDecl</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- All stand-alone deriving declarations</span><span>
</span><a name="line-325"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a><span class="hs-special">,</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="HsBinds.html#HsValBinds"><span class="hs-identifier hs-type">HsValBinds</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">)</span><span>
</span><a name="line-326"></a><a name="tcDeriving"><a href="TcDeriv.html#tcDeriving"><span class="hs-identifier">tcDeriving</span></a></a><span> </span><a name="local-1628276130"><a href="#local-1628276130"><span class="hs-identifier">deriv_infos</span></a></a><span> </span><a name="local-1628276131"><a href="#local-1628276131"><span class="hs-identifier">deriv_decls</span></a></a><span>
</span><a name="line-327"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#recoverM"><span class="hs-identifier hs-var">recoverM</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276140"><a href="#local-1628276140"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-328"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276140"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">,</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span class="hs-special">,</span><span> </span><a href="HsBinds.html#emptyValBindsOut"><span class="hs-identifier hs-var">emptyValBindsOut</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-329"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Fish the &quot;deriving&quot;-related information out of the TcEnv</span><span>
</span><a name="line-330"></a><span>                </span><span class="hs-comment">-- And make the necessary &quot;equations&quot;.</span><span>
</span><a name="line-331"></a><span>          </span><a name="local-1628276141"><a href="#local-1628276141"><span class="hs-identifier">is_boot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tcIsHsBootOrSig"><span class="hs-identifier hs-var">tcIsHsBootOrSig</span></a><span>
</span><a name="line-332"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcDeriving&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276141"><span class="hs-identifier hs-var">is_boot</span></a><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628276142"><a href="#local-1628276142"><span class="hs-identifier">early_specs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#makeDerivSpecs"><span class="hs-identifier hs-var">makeDerivSpecs</span></a><span> </span><a href="#local-1628276141"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><a href="#local-1628276130"><span class="hs-identifier hs-var">deriv_infos</span></a><span> </span><a href="#local-1628276131"><span class="hs-identifier hs-var">deriv_decls</span></a><span>
</span><a name="line-335"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcDeriving 1&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276142"><span class="hs-identifier hs-var">early_specs</span></a><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628276143"><a href="#local-1628276143"><span class="hs-identifier">infer_specs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276144"><a href="#local-1628276144"><span class="hs-identifier">given_specs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#splitEarlyDerivSpec"><span class="hs-identifier hs-var">splitEarlyDerivSpec</span></a><span> </span><a href="#local-1628276142"><span class="hs-identifier hs-var">early_specs</span></a><span>
</span><a name="line-338"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628276145"><a href="#local-1628276145"><span class="hs-identifier">insts1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcDeriv.html#genInst"><span class="hs-identifier hs-var">genInst</span></a><span> </span><a href="#local-1628276144"><span class="hs-identifier hs-var">given_specs</span></a><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span>        </span><span class="hs-comment">-- the stand-alone derived instances (@insts1@) are used when inferring</span><span>
</span><a name="line-341"></a><span>        </span><span class="hs-comment">-- the contexts for &quot;deriving&quot; clauses' instances (@infer_specs@)</span><span>
</span><a name="line-342"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628276146"><a href="#local-1628276146"><span class="hs-identifier">final_specs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#extendLocalInstEnv"><span class="hs-identifier hs-var">extendLocalInstEnv</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">iSpec</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Util.html#fstOf3"><span class="hs-identifier hs-var">fstOf3</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276145"><span class="hs-identifier hs-var">insts1</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-343"></a><span>                         </span><a href="TcDeriv.html#simplifyInstanceContexts"><span class="hs-identifier hs-var">simplifyInstanceContexts</span></a><span> </span><a href="#local-1628276143"><span class="hs-identifier hs-var">infer_specs</span></a><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628276147"><a href="#local-1628276147"><span class="hs-identifier">insts2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcDeriv.html#genInst"><span class="hs-identifier hs-var">genInst</span></a><span> </span><a href="#local-1628276146"><span class="hs-identifier hs-var">final_specs</span></a><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628276148"><a href="#local-1628276148"><span class="hs-identifier">inst_infos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276149"><a href="#local-1628276149"><span class="hs-identifier">deriv_stuff</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276150"><a href="#local-1628276150"><span class="hs-identifier">maybe_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip3"><span class="hs-identifier hs-var">unzip3</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276145"><span class="hs-identifier hs-var">insts1</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628276147"><span class="hs-identifier hs-var">insts2</span></a><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628276151"><a href="#local-1628276151"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-349"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628276152"><a href="#local-1628276152"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276153"><a href="#local-1628276153"><span class="hs-identifier">famInsts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276154"><a href="#local-1628276154"><span class="hs-identifier">extraInstances</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-350"></a><span>                </span><a href="TcGenDeriv.html#genAuxBinds"><span class="hs-identifier hs-var">genAuxBinds</span></a><span> </span><a href="#local-1628276151"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#unionManyBags"><span class="hs-identifier hs-var">unionManyBags</span></a><span> </span><a href="#local-1628276149"><span class="hs-identifier hs-var">deriv_stuff</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628276155"><a href="#local-1628276155"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628276156"><a href="#local-1628276156"><span class="hs-identifier">inst_info</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276157"><a href="#local-1628276157"><span class="hs-identifier">rn_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276158"><a href="#local-1628276158"><span class="hs-identifier">rn_dus</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-355"></a><span>            </span><a href="TcDeriv.html#renameDeriv"><span class="hs-identifier hs-var">renameDeriv</span></a><span> </span><a href="#local-1628276141"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276148"><span class="hs-identifier hs-var">inst_infos</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628276154"><span class="hs-identifier hs-var">extraInstances</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1628276152"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-356"></a><span>
</span><a name="line-357"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-1628276156"><span class="hs-identifier hs-var">inst_info</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-358"></a><span>             </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.IO.Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a><span> </span><span class="hs-special">(</span><a href="ErrUtils.html#dumpIfSet_dyn"><span class="hs-identifier hs-var">dumpIfSet_dyn</span></a><span> </span><a href="#local-1628276155"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_deriv"><span class="hs-identifier hs-var">Opt_D_dump_deriv</span></a><span> </span><span class="hs-string">&quot;Derived instances&quot;</span><span>
</span><a name="line-359"></a><span>                        </span><span class="hs-special">(</span><a href="#local-1628276132"><span class="hs-identifier hs-var">ddump_deriving</span></a><span> </span><a href="#local-1628276156"><span class="hs-identifier hs-var">inst_info</span></a><span> </span><a href="#local-1628276157"><span class="hs-identifier hs-var">rn_binds</span></a><span> </span><a href="#local-1628276153"><span class="hs-identifier hs-var">famInsts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628276159"><a href="#local-1628276159"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcExtendLocalFamInstEnv"><span class="hs-identifier hs-var">tcExtendLocalFamInstEnv</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628276153"><span class="hs-identifier hs-var">famInsts</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-362"></a><span>                     </span><a href="Inst.html#tcExtendLocalInstEnv"><span class="hs-identifier hs-var">tcExtendLocalInstEnv</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-identifier">iSpec</span><span> </span><span class="hs-special">(</span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628276156"><span class="hs-identifier hs-var">inst_info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-363"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276160"><a href="#local-1628276160"><span class="hs-identifier">all_dus</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276158"><span class="hs-identifier hs-var">rn_dus</span></a><span> </span><span class="hs-special">`</span><a href="NameSet.html#plusDU"><span class="hs-identifier hs-var">plusDU</span></a><span class="hs-special">`</span><span> </span><a href="NameSet.html#usesOnly"><span class="hs-identifier hs-var">usesOnly</span></a><span> </span><span class="hs-special">(</span><a href="NameSet.html#mkFVs"><span class="hs-identifier hs-var">mkFVs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#catMaybes"><span class="hs-identifier hs-var">catMaybes</span></a><span> </span><a href="#local-1628276150"><span class="hs-identifier hs-var">maybe_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="RnSource.html#addTcgDUs"><span class="hs-identifier hs-var">addTcgDUs</span></a><span> </span><a href="#local-1628276159"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><a href="#local-1628276160"><span class="hs-identifier hs-var">all_dus</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628276156"><span class="hs-identifier hs-var">inst_info</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628276157"><span class="hs-identifier hs-var">rn_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-365"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-366"></a><span>    </span><span class="hs-identifier">ddump_deriving</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsBinds.html#HsValBinds"><span class="hs-identifier hs-type">HsValBinds</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-367"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span>             </span><span class="hs-comment">-- ^ Rep type family instances</span><span>
</span><a name="line-368"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-369"></a><span>    </span><a name="local-1628276132"><a href="#local-1628276132"><span class="hs-identifier">ddump_deriving</span></a></a><span> </span><a name="local-1628276134"><a href="#local-1628276134"><span class="hs-identifier">inst_infos</span></a></a><span> </span><a name="local-1628276135"><a href="#local-1628276135"><span class="hs-identifier">extra_binds</span></a></a><span> </span><a name="local-1628276136"><a href="#local-1628276136"><span class="hs-identifier">repFamInsts</span></a></a><span>
</span><a name="line-370"></a><span>      </span><span class="hs-glyph">=</span><span>    </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Derived instances:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>              </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1628276137"><a href="#local-1628276137"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#pprInstInfoDetails"><span class="hs-identifier hs-var">pprInstInfoDetails</span></a><span> </span><a href="#local-1628276137"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628276134"><span class="hs-identifier hs-var">inst_infos</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>                 </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276135"><span class="hs-identifier hs-var">extra_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>        </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="#local-1628276133"><span class="hs-identifier hs-var">hangP</span></a><span> </span><span class="hs-string">&quot;GHC.Generics representation types:&quot;</span><span>
</span><a name="line-374"></a><span>             </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="TcDeriv.html#pprRepTy"><span class="hs-identifier hs-var">pprRepTy</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628276136"><span class="hs-identifier hs-var">repFamInsts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span>    </span><a name="local-1628276133"><a href="#local-1628276133"><span class="hs-identifier">hangP</span></a></a><span> </span><a name="local-1628276138"><a href="#local-1628276138"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-1628276139"><a href="#local-1628276139"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ptext"><span class="hs-identifier hs-var">ptext</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#sLit"><span class="hs-identifier hs-var">sLit</span></a><span> </span><a href="#local-1628276138"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-1628276139"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span class="hs-comment">-- Prints the representable type family instance</span><span>
</span><a name="line-379"></a><span class="hs-identifier">pprRepTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-380"></a><a name="pprRepTy"><a href="TcDeriv.html#pprRepTy"><span class="hs-identifier">pprRepTy</span></a></a><span> </span><a name="local-1628276161"><a href="#local-1628276161"><span class="hs-identifier">fi</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276162"><a href="#local-1628276162"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;type&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#famInstTyCon"><span class="hs-identifier hs-var">famInstTyCon</span></a><span> </span><a href="#local-1628276161"><span class="hs-identifier hs-var">fi</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276162"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-382"></a><span>      </span><a href="Outputable.html#equals"><span class="hs-identifier hs-var">equals</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276163"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-383"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1628276163"><a href="#local-1628276163"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#famInstRHS"><span class="hs-identifier hs-var">famInstRHS</span></a><span> </span><a href="#local-1628276161"><span class="hs-identifier hs-var">fi</span></a><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span class="hs-identifier">renameDeriv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-386"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="RdrName.html#RdrName"><span class="hs-identifier hs-type">RdrName</span></a><span class="hs-special">]</span><span>
</span><a name="line-387"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><span class="hs-special">(</span><a href="HsBinds.html#LHsBind"><span class="hs-identifier hs-type">LHsBind</span></a><span> </span><a href="RdrName.html#RdrName"><span class="hs-identifier hs-type">RdrName</span></a><span class="hs-special">,</span><span> </span><a href="HsBinds.html#LSig"><span class="hs-identifier hs-type">LSig</span></a><span> </span><a href="RdrName.html#RdrName"><span class="hs-identifier hs-type">RdrName</span></a><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="HsBinds.html#HsValBinds"><span class="hs-identifier hs-type">HsValBinds</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><span> </span><a href="NameSet.html#DefUses"><span class="hs-identifier hs-type">DefUses</span></a><span class="hs-special">)</span><span>
</span><a name="line-389"></a><a name="renameDeriv"><a href="TcDeriv.html#renameDeriv"><span class="hs-identifier">renameDeriv</span></a></a><span> </span><a name="local-1628276164"><a href="#local-1628276164"><span class="hs-identifier">is_boot</span></a></a><span> </span><a name="local-1628276165"><a href="#local-1628276165"><span class="hs-identifier">inst_infos</span></a></a><span> </span><a name="local-1628276166"><a href="#local-1628276166"><span class="hs-identifier">bagBinds</span></a></a><span>
</span><a name="line-390"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276164"><span class="hs-identifier hs-var">is_boot</span></a><span>     </span><span class="hs-comment">-- If we are compiling a hs-boot file, don't generate any derived bindings</span><span>
</span><a name="line-391"></a><span>                </span><span class="hs-comment">-- The inst-info bindings will all be empty, but it's easier to</span><span>
</span><a name="line-392"></a><span>                </span><span class="hs-comment">-- just use rn_inst_info to change the type appropriately</span><span>
</span><a name="line-393"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628276178"><a href="#local-1628276178"><span class="hs-identifier">rn_inst_infos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276179"><a href="#local-1628276179"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#mapAndUnzipM"><span class="hs-identifier hs-var">mapAndUnzipM</span></a><span> </span><a href="#local-1628276167"><span class="hs-identifier hs-var">rn_inst_info</span></a><span> </span><a href="#local-1628276165"><span class="hs-identifier hs-var">inst_infos</span></a><span>
</span><a name="line-394"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a><span> </span><a href="#local-1628276178"><span class="hs-identifier hs-var">rn_inst_infos</span></a><span>
</span><a name="line-395"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="HsBinds.html#emptyValBindsOut"><span class="hs-identifier hs-var">emptyValBindsOut</span></a><span class="hs-special">,</span><span> </span><a href="NameSet.html#usesOnly"><span class="hs-identifier hs-var">usesOnly</span></a><span> </span><span class="hs-special">(</span><a href="NameSet.html#plusFVs"><span class="hs-identifier hs-var">plusFVs</span></a><span> </span><a href="#local-1628276179"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-398"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#discardWarnings"><span class="hs-identifier hs-var">discardWarnings</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>         </span><span class="hs-comment">-- Discard warnings about unused bindings etc</span><span>
</span><a name="line-399"></a><span>    </span><a href="TcRnMonad.html#setXOptM"><span class="hs-identifier hs-var">setXOptM</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#EmptyCase"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">EmptyCase</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>  </span><span class="hs-comment">-- Derived decls (for empty types) can have</span><span>
</span><a name="line-400"></a><span>                                  </span><span class="hs-comment">--    case x of {}</span><span>
</span><a name="line-401"></a><span>    </span><a href="TcRnMonad.html#setXOptM"><span class="hs-identifier hs-var">setXOptM</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#ScopedTypeVariables"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ScopedTypeVariables</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>  </span><span class="hs-comment">-- Derived decls (for newtype-deriving) can</span><span>
</span><a name="line-402"></a><span>    </span><a href="TcRnMonad.html#setXOptM"><span class="hs-identifier hs-var">setXOptM</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#KindSignatures"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">KindSignatures</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>       </span><span class="hs-comment">-- used ScopedTypeVariables &amp; KindSignatures</span><span>
</span><a name="line-403"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>
</span><a name="line-404"></a><span>        </span><span class="hs-comment">-- Bring the extra deriving stuff into scope</span><span>
</span><a name="line-405"></a><span>        </span><span class="hs-comment">-- before renaming the instances themselves</span><span>
</span><a name="line-406"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;rnd&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1628276180"><a href="#local-1628276180"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#pprInstInfoDetails"><span class="hs-identifier hs-var">pprInstInfoDetails</span></a><span> </span><a href="#local-1628276180"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1628276165"><span class="hs-identifier hs-var">inst_infos</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628276181"><a href="#local-1628276181"><span class="hs-identifier">aux_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276182"><a href="#local-1628276182"><span class="hs-identifier">aux_sigs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Bag.html#mapAndUnzipBagM"><span class="hs-identifier hs-var">mapAndUnzipBagM</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628276166"><span class="hs-identifier hs-var">bagBinds</span></a><span>
</span><a name="line-408"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276183"><a href="#local-1628276183"><span class="hs-identifier">aux_val_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HsBinds.html#ValBindsIn"><span class="hs-identifier hs-var">ValBindsIn</span></a><span> </span><a href="#local-1628276181"><span class="hs-identifier hs-var">aux_binds</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628276182"><span class="hs-identifier hs-var">aux_sigs</span></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628276184"><a href="#local-1628276184"><span class="hs-identifier">rn_aux_lhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnTopBindsLHS"><span class="hs-identifier hs-var">rnTopBindsLHS</span></a><span> </span><a href="FastStringEnv.html#emptyFsEnv"><span class="hs-identifier hs-var">emptyFsEnv</span></a><span> </span><a href="#local-1628276183"><span class="hs-identifier hs-var">aux_val_binds</span></a><span>
</span><a name="line-410"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276185"><a href="#local-1628276185"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HsUtils.html#collectHsValBinders"><span class="hs-identifier hs-var">collectHsValBinders</span></a><span> </span><a href="#local-1628276184"><span class="hs-identifier hs-var">rn_aux_lhs</span></a><span>
</span><a name="line-411"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628276186"><a href="#local-1628276186"><span class="hs-identifier">envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnNames.html#extendGlobalRdrEnvRn"><span class="hs-identifier hs-var">extendGlobalRdrEnvRn</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Avail.html#avail"><span class="hs-identifier hs-var">avail</span></a><span> </span><a href="#local-1628276185"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span> </span><a href="FastStringEnv.html#emptyFsEnv"><span class="hs-identifier hs-var">emptyFsEnv</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-412"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><a href="#local-1628276186"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-413"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628276187"><a href="#local-1628276187"><span class="hs-identifier">rn_aux</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276188"><a href="#local-1628276188"><span class="hs-identifier">dus_aux</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnValBindsRHS"><span class="hs-identifier hs-var">rnValBindsRHS</span></a><span> </span><span class="hs-special">(</span><a href="RnEnv.html#TopSigCtxt"><span class="hs-identifier hs-var">TopSigCtxt</span></a><span> </span><span class="hs-special">(</span><a href="NameSet.html#mkNameSet"><span class="hs-identifier hs-var">mkNameSet</span></a><span> </span><a href="#local-1628276185"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1628276184"><span class="hs-identifier hs-var">rn_aux_lhs</span></a><span>
</span><a name="line-414"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628276189"><a href="#local-1628276189"><span class="hs-identifier">rn_inst_infos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276190"><a href="#local-1628276190"><span class="hs-identifier">fvs_insts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#mapAndUnzipM"><span class="hs-identifier hs-var">mapAndUnzipM</span></a><span> </span><a href="#local-1628276167"><span class="hs-identifier hs-var">rn_inst_info</span></a><span> </span><a href="#local-1628276165"><span class="hs-identifier hs-var">inst_infos</span></a><span>
</span><a name="line-415"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a><span> </span><a href="#local-1628276189"><span class="hs-identifier hs-var">rn_inst_infos</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628276187"><span class="hs-identifier hs-var">rn_aux</span></a><span class="hs-special">,</span><span>
</span><a name="line-416"></a><span>                  </span><a href="#local-1628276188"><span class="hs-identifier hs-var">dus_aux</span></a><span> </span><span class="hs-special">`</span><a href="NameSet.html#plusDU"><span class="hs-identifier hs-var">plusDU</span></a><span class="hs-special">`</span><span> </span><a href="NameSet.html#usesOnly"><span class="hs-identifier hs-var">usesOnly</span></a><span> </span><span class="hs-special">(</span><a href="NameSet.html#plusFVs"><span class="hs-identifier hs-var">plusFVs</span></a><span> </span><a href="#local-1628276190"><span class="hs-identifier hs-var">fvs_insts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-419"></a><span>    </span><span class="hs-identifier">rn_inst_info</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="RdrName.html#RdrName"><span class="hs-identifier hs-type">RdrName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><span> </span><a href="NameSet.html#FreeVars"><span class="hs-identifier hs-type">FreeVars</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>    </span><a name="local-1628276167"><a href="#local-1628276167"><span class="hs-identifier">rn_inst_info</span></a></a><span>
</span><a name="line-421"></a><span>      </span><a name="local-1628276168"><a href="#local-1628276168"><span class="hs-identifier">inst_info</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-var">InstInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">iSpec</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276169"><a href="#local-1628276169"><span class="hs-identifier">inst</span></a></a><span>
</span><a name="line-422"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">iBinds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#InstBindings"><span class="hs-identifier hs-var">InstBindings</span></a><span>
</span><a name="line-423"></a><span>                            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ib_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276170"><a href="#local-1628276170"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-424"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_tyvars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276171"><a href="#local-1628276171"><span class="hs-identifier">tyvars</span></a></a><span>
</span><a name="line-425"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_pragmas</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276172"><a href="#local-1628276172"><span class="hs-identifier">sigs</span></a></a><span>
</span><a name="line-426"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_extensions</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276173"><a href="#local-1628276173"><span class="hs-identifier">exts</span></a></a><span> </span><span class="hs-comment">-- Only for type-checking</span><span>
</span><a name="line-427"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_derived</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276174"><a href="#local-1628276174"><span class="hs-identifier">sa</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span>        </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier">sigs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span>           </span><a href="RnEnv.html#bindLocalNamesFV"><span class="hs-identifier hs-var">bindLocalNamesFV</span></a><span> </span><a href="#local-1628276171"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-430"></a><span>           </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628276175"><a href="#local-1628276175"><span class="hs-identifier">rn_binds</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628276176"><a href="#local-1628276176"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnMethodBinds"><span class="hs-identifier hs-var">rnMethodBinds</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_cls_nm</span><span> </span><a href="#local-1628276169"><span class="hs-identifier hs-var">inst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-1628276170"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-431"></a><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276177"><a href="#local-1628276177"><span class="hs-identifier">binds'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#InstBindings"><span class="hs-identifier hs-var">InstBindings</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ib_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276175"><span class="hs-identifier hs-var">rn_binds</span></a><span>
</span><a name="line-432"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_tyvars</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276171"><span class="hs-identifier hs-var">tyvars</span></a><span>
</span><a name="line-433"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_pragmas</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-434"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_extensions</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276173"><span class="hs-identifier hs-var">exts</span></a><span>
</span><a name="line-435"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_derived</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276174"><span class="hs-identifier hs-var">sa</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-436"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276168"><span class="hs-identifier hs-var">inst_info</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">iBinds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276177"><span class="hs-identifier hs-var">binds'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-1628276176"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-comment">{-
Note [Newtype deriving and unused constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (see Trac #1954):

  module Bug(P) where
  newtype P a = MkP (IO a) deriving Monad

If you compile with -Wunused-binds you do not expect the warning
&quot;Defined but not used: data consructor MkP&quot;. Yet the newtype deriving
code does not explicitly mention MkP, but it should behave as if you
had written
  instance Monad P where
     return x = MkP (return x)
     ...etc...

So we want to signal a user of the data constructor 'MkP'.
This is the reason behind the (Maybe Name) part of the return type
of genInst.

Note [Why we don't pass rep_tc into deriveTyData]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Down in the bowels of mkEqnHelp, we need to convert the fam_tc back into
the rep_tc by means of a lookup. And yet we have the rep_tc right here!
Why look it up again? Answer: it's just easier this way.
We drop some number of arguments from the end of the datatype definition
in deriveTyData. The arguments are dropped from the fam_tc.
This action may drop a *different* number of arguments
passed to the rep_tc, depending on how many free variables, etc., the
dropped patterns have.

Also, this technique carries over the kind substitution from deriveTyData
nicely.

************************************************************************
*                                                                      *
                From HsSyn to DerivSpec
*                                                                      *
************************************************************************

@makeDerivSpecs@ fishes around to find the info about needed derived instances.
-}</span><span>
</span><a name="line-480"></a><span>
</span><a name="line-481"></a><span class="hs-identifier">makeDerivSpecs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-482"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-type">DerivInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-483"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LDerivDecl"><span class="hs-identifier hs-type">LDerivDecl</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span>
</span><a name="line-484"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier hs-type">EarlyDerivSpec</span></a><span class="hs-special">]</span><span>
</span><a name="line-485"></a><a name="makeDerivSpecs"><a href="TcDeriv.html#makeDerivSpecs"><span class="hs-identifier">makeDerivSpecs</span></a></a><span> </span><a name="local-1628276191"><a href="#local-1628276191"><span class="hs-identifier">is_boot</span></a></a><span> </span><a name="local-1628276192"><a href="#local-1628276192"><span class="hs-identifier">deriv_infos</span></a></a><span> </span><a name="local-1628276193"><a href="#local-1628276193"><span class="hs-identifier">deriv_decls</span></a></a><span>
</span><a name="line-486"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-1628276196"><a href="#local-1628276196"><span class="hs-identifier">eqns1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#recoverM"><span class="hs-identifier hs-var">recoverM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcDeriv.html#deriveDerivInfo"><span class="hs-identifier hs-var">deriveDerivInfo</span></a><span class="hs-special">)</span><span>  </span><a href="#local-1628276192"><span class="hs-identifier hs-var">deriv_infos</span></a><span>
</span><a name="line-487"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628276197"><a href="#local-1628276197"><span class="hs-identifier">eqns2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#recoverM"><span class="hs-identifier hs-var">recoverM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcDeriv.html#deriveStandalone"><span class="hs-identifier hs-var">deriveStandalone</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276193"><span class="hs-identifier hs-var">deriv_decls</span></a><span>
</span><a name="line-488"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276198"><a href="#local-1628276198"><span class="hs-identifier">eqns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276196"><span class="hs-identifier hs-var">eqns1</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628276197"><span class="hs-identifier hs-var">eqns2</span></a><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628276191"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><span class="hs-keyword">then</span><span>   </span><span class="hs-comment">-- No 'deriving' at all in hs-boot files</span><span>
</span><a name="line-491"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628276198"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1628276194"><span class="hs-identifier hs-var">add_deriv_err</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#head"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="#local-1628276198"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-492"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-493"></a><span>          </span><span class="hs-keyword">else</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628276198"><span class="hs-identifier hs-var">eqns</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-494"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-495"></a><span>    </span><a name="local-1628276194"><a href="#local-1628276194"><span class="hs-identifier">add_deriv_err</span></a></a><span> </span><a name="local-1628276195"><a href="#local-1628276195"><span class="hs-identifier">eqn</span></a></a><span>
</span><a name="line-496"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#earlyDSLoc"><span class="hs-identifier hs-var">earlyDSLoc</span></a><span> </span><a href="#local-1628276195"><span class="hs-identifier hs-var">eqn</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-497"></a><span>         </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Deriving not permitted in hs-boot file&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-498"></a><span>                    </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use an instance declaration instead&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-499"></a><span>
</span><a name="line-500"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-501"></a><span class="hs-comment">-- | Process a `deriving` clause</span><span>
</span><a name="line-502"></a><span class="hs-identifier">deriveDerivInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-type">DerivInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier hs-type">EarlyDerivSpec</span></a><span class="hs-special">]</span><span>
</span><a name="line-503"></a><a name="deriveDerivInfo"><a href="TcDeriv.html#deriveDerivInfo"><span class="hs-identifier">deriveDerivInfo</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-var">DerivInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">di_rep_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276199"><a href="#local-1628276199"><span class="hs-identifier">rep_tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">di_preds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276200"><a href="#local-1628276200"><span class="hs-identifier">preds</span></a></a><span>
</span><a name="line-504"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">di_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276201"><a href="#local-1628276201"><span class="hs-identifier">err_ctxt</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><a href="#local-1628276201"><span class="hs-identifier hs-var">err_ctxt</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-506"></a><span>    </span><a href="MonadUtils.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#deriveTyData"><span class="hs-identifier hs-var">deriveTyData</span></a><span> </span><a href="#local-1628276202"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1628276203"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628276204"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276200"><span class="hs-identifier hs-var">preds</span></a><span>
</span><a name="line-507"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-508"></a><span>    </span><a name="local-1628276202"><a href="#local-1628276202"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-1628276199"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-509"></a><span>    </span><span class="hs-special">(</span><a name="local-1628276203"><a href="#local-1628276203"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276204"><a href="#local-1628276204"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TyCon.html#tyConFamInstSig_maybe"><span class="hs-identifier hs-var">tyConFamInstSig_maybe</span></a><span> </span><a href="#local-1628276199"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-510"></a><span>                        </span><span class="hs-comment">-- data family:</span><span>
</span><a name="line-511"></a><span>                  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628276205"><a href="#local-1628276205"><span class="hs-identifier">fam_tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276206"><a href="#local-1628276206"><span class="hs-identifier">pats</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628276205"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628276206"><span class="hs-identifier hs-var">pats</span></a><span class="hs-special">)</span><span>
</span><a name="line-512"></a><span>      </span><span class="hs-comment">-- NB: deriveTyData wants the *user-specified*</span><span>
</span><a name="line-513"></a><span>      </span><span class="hs-comment">-- name. See Note [Why we don't pass rep_tc into deriveTyData]</span><span>
</span><a name="line-514"></a><span>
</span><a name="line-515"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1628276199"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><a href="#local-1628276202"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- datatype</span><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-518"></a><span class="hs-identifier">deriveStandalone</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#LDerivDecl"><span class="hs-identifier hs-type">LDerivDecl</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier hs-type">EarlyDerivSpec</span></a><span class="hs-special">]</span><span>
</span><a name="line-519"></a><span class="hs-comment">-- Standalone deriving declarations</span><span>
</span><a name="line-520"></a><span class="hs-comment">--  e.g.   deriving instance Show a =&gt; Show (T a)</span><span>
</span><a name="line-521"></a><span class="hs-comment">-- Rather like tcLocalInstDecl</span><span>
</span><a name="line-522"></a><a name="deriveStandalone"><a href="TcDeriv.html#deriveStandalone"><span class="hs-identifier">deriveStandalone</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-1628276207"><a href="#local-1628276207"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#DerivDecl"><span class="hs-identifier hs-var">DerivDecl</span></a><span> </span><a name="local-1628276208"><a href="#local-1628276208"><span class="hs-identifier">deriv_ty</span></a></a><span> </span><a name="local-1628276209"><a href="#local-1628276209"><span class="hs-identifier">overlap_mode</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-523"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-1628276207"><span class="hs-identifier hs-var">loc</span></a><span>                   </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-524"></a><span>    </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#standaloneCtxt"><span class="hs-identifier hs-var">standaloneCtxt</span></a><span> </span><a href="#local-1628276208"><span class="hs-identifier hs-var">deriv_ty</span></a><span class="hs-special">)</span><span>  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-525"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Standalone deriving decl for&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276208"><span class="hs-identifier hs-var">deriv_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628276210"><a href="#local-1628276210"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276211"><a href="#local-1628276211"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276212"><a href="#local-1628276212"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276213"><a href="#local-1628276213"><span class="hs-identifier">inst_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsClsInstType"><span class="hs-identifier hs-var">tcHsClsInstType</span></a><span> </span><a href="TcType.html#InstDeclCtxt"><span class="hs-identifier hs-var">TcType</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">InstDeclCtxt</span></a><span> </span><a href="#local-1628276208"><span class="hs-identifier hs-var">deriv_ty</span></a><span>
</span><a name="line-527"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Standalone deriving;&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span>
</span><a name="line-528"></a><span>              </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;tvs:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276210"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-529"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;theta:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276211"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-530"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;cls:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276212"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-531"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;tys:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276213"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-532"></a><span>                </span><span class="hs-comment">-- C.f. TcInstDcls.tcLocalInstDecl1</span><span>
</span><a name="line-533"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628276213"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="TcDeriv.html#derivingNullaryErr"><span class="hs-identifier hs-var">derivingNullaryErr</span></a><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276214"><a href="#local-1628276214"><span class="hs-identifier">cls_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#take"><span class="hs-identifier hs-var">take</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1628276213"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-1628276213"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-536"></a><span>             </span><a name="local-1628276215"><a href="#local-1628276215"><span class="hs-identifier">inst_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#last"><span class="hs-identifier hs-var">last</span></a><span> </span><a href="#local-1628276213"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-537"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Standalone deriving:&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span>
</span><a name="line-538"></a><span>              </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;class:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276212"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-539"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;class types:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276214"><span class="hs-identifier hs-var">cls_tys</span></a><span>
</span><a name="line-540"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;type:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276215"><span class="hs-identifier hs-var">inst_ty</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcType.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a><span> </span><a href="#local-1628276215"><span class="hs-identifier hs-var">inst_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-543"></a><span>           </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628276216"><a href="#local-1628276216"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276217"><a href="#local-1628276217"><span class="hs-identifier">tc_args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">className</span><span> </span><a href="#local-1628276212"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#typeableClassName"><span class="hs-identifier hs-var">typeableClassName</span></a><span>
</span><a name="line-545"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcDeriv.html#warnUselessTypeable"><span class="hs-identifier hs-var">warnUselessTypeable</span></a><span>
</span><a name="line-546"></a><span>                    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-547"></a><span>
</span><a name="line-548"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isAlgTyCon"><span class="hs-identifier hs-var">isAlgTyCon</span></a><span> </span><a href="#local-1628276216"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="TyCon.html#isDataFamilyTyCon"><span class="hs-identifier hs-var">isDataFamilyTyCon</span></a><span> </span><a href="#local-1628276216"><span class="hs-identifier hs-var">tc</span></a><span>  </span><span class="hs-comment">-- All other classes</span><span>
</span><a name="line-549"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276218"><a href="#local-1628276218"><span class="hs-identifier">spec</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#mkEqnHelp"><span class="hs-identifier hs-var">mkEqnHelp</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-1628276209"><span class="hs-identifier hs-var">overlap_mode</span></a><span class="hs-special">)</span><span>
</span><a name="line-550"></a><span>                                        </span><a href="#local-1628276210"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1628276212"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276214"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="#local-1628276216"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628276217"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-551"></a><span>                                        </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628276211"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628276218"><span class="hs-identifier hs-var">spec</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span>           </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- Complain about functions, primitive types, etc,</span><span>
</span><a name="line-555"></a><span>                 </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcDeriv.html#derivingThingErr"><span class="hs-identifier hs-var">derivingThingErr</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1628276212"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276214"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="#local-1628276215"><span class="hs-identifier hs-var">inst_ty</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-556"></a><span>                 </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;The last argument of the instance must be a data or newtype application&quot;</span><span>
</span><a name="line-557"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span class="hs-identifier">warnUselessTypeable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-560"></a><a name="warnUselessTypeable"><a href="TcDeriv.html#warnUselessTypeable"><span class="hs-identifier">warnUselessTypeable</span></a></a><span>
</span><a name="line-561"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276219"><a href="#local-1628276219"><span class="hs-identifier">warn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><a href="DynFlags.html#Opt_WarnDerivingTypeable"><span class="hs-identifier hs-var">Opt_WarnDerivingTypeable</span></a><span>
</span><a name="line-562"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="#local-1628276219"><span class="hs-identifier hs-var">warn</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnMonad.html#addWarnTc"><span class="hs-identifier hs-var">addWarnTc</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#Reason"><span class="hs-identifier hs-var">Reason</span></a><span> </span><a href="DynFlags.html#Opt_WarnDerivingTypeable"><span class="hs-identifier hs-var">Opt_WarnDerivingTypeable</span></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>                   </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Deriving&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="PrelNames.html#typeableClassName"><span class="hs-identifier hs-var">typeableClassName</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-564"></a><span>                     </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;has no effect: all types now auto-derive Typeable&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-567"></a><span class="hs-identifier">deriveTyData</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- LHS of data or data instance</span><span>
</span><a name="line-568"></a><span>                                             </span><span class="hs-comment">--   Can be a data instance, hence [Type] args</span><span>
</span><a name="line-569"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsTypes.html#LHsSigType"><span class="hs-identifier hs-type">LHsSigType</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>              </span><span class="hs-comment">-- The deriving predicate</span><span>
</span><a name="line-570"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier hs-type">EarlyDerivSpec</span></a><span class="hs-special">]</span><span>
</span><a name="line-571"></a><span class="hs-comment">-- The deriving clause of a data or newtype declaration</span><span>
</span><a name="line-572"></a><span class="hs-comment">-- I.e. not standalone deriving</span><span>
</span><a name="line-573"></a><a name="deriveTyData"><a href="TcDeriv.html#deriveTyData"><span class="hs-identifier">deriveTyData</span></a></a><span> </span><a name="local-1628276220"><a href="#local-1628276220"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1628276221"><a href="#local-1628276221"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1628276222"><a href="#local-1628276222"><span class="hs-identifier">tc_args</span></a></a><span> </span><a name="local-1628276223"><a href="#local-1628276223"><span class="hs-identifier">deriv_pred</span></a></a><span>
</span><a name="line-574"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#getLoc"><span class="hs-identifier hs-var">getLoc</span></a><span> </span><span class="hs-special">(</span><a href="HsTypes.html#hsSigType"><span class="hs-identifier hs-var">hsSigType</span></a><span> </span><a href="#local-1628276223"><span class="hs-identifier hs-var">deriv_pred</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>  </span><span class="hs-comment">-- Use loc of the 'deriving' item</span><span>
</span><a name="line-575"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628276224"><a href="#local-1628276224"><span class="hs-identifier">deriv_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276225"><a href="#local-1628276225"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276226"><a href="#local-1628276226"><span class="hs-identifier">cls_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276227"><a href="#local-1628276227"><span class="hs-identifier">cls_arg_kind</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-576"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendTyVarEnv"><span class="hs-identifier hs-var">tcExtendTyVarEnv</span></a><span> </span><a href="#local-1628276220"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-577"></a><span>                   </span><a href="TcHsType.html#tcHsDeriv"><span class="hs-identifier hs-var">tcHsDeriv</span></a><span> </span><a href="#local-1628276223"><span class="hs-identifier hs-var">deriv_pred</span></a><span>
</span><a name="line-578"></a><span>                </span><span class="hs-comment">-- Deriving preds may (now) mention</span><span>
</span><a name="line-579"></a><span>                </span><span class="hs-comment">-- the type variables for the type constructor, hence tcExtendTyVarenv</span><span>
</span><a name="line-580"></a><span>                </span><span class="hs-comment">-- The &quot;deriv_pred&quot; is a LHsType to take account of the fact that for</span><span>
</span><a name="line-581"></a><span>                </span><span class="hs-comment">-- newtype deriving we allow deriving (forall a. C [a]).</span><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span>                </span><span class="hs-comment">-- Typeable is special, because Typeable :: forall k. k -&gt; Constraint</span><span>
</span><a name="line-584"></a><span>                </span><span class="hs-comment">-- so the argument kind 'k' is not decomposable by splitKindFunTys</span><span>
</span><a name="line-585"></a><span>                </span><span class="hs-comment">-- as is the case for all other derivable type classes</span><span>
</span><a name="line-586"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">className</span><span> </span><a href="#local-1628276225"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#typeableClassName"><span class="hs-identifier hs-var">typeableClassName</span></a><span>
</span><a name="line-587"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcDeriv.html#warnUselessTypeable"><span class="hs-identifier hs-var">warnUselessTypeable</span></a><span>
</span><a name="line-588"></a><span>                  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-589"></a><span>          </span><span class="hs-keyword">else</span><span>
</span><a name="line-590"></a><span>
</span><a name="line-591"></a><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- Given data T a b c = ... deriving( C d ),</span><span>
</span><a name="line-592"></a><span>           </span><span class="hs-comment">-- we want to drop type variables from T so that (C d (T a)) is well-kinded</span><span>
</span><a name="line-593"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628276228"><a href="#local-1628276228"><span class="hs-identifier">arg_kinds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#splitFunTys"><span class="hs-identifier hs-var">splitFunTys</span></a><span> </span><a href="#local-1628276227"><span class="hs-identifier hs-var">cls_arg_kind</span></a><span>
</span><a name="line-594"></a><span>              </span><a name="local-1628276229"><a href="#local-1628276229"><span class="hs-identifier">n_args_to_drop</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1628276228"><span class="hs-identifier hs-var">arg_kinds</span></a><span>
</span><a name="line-595"></a><span>              </span><a name="local-1628276230"><a href="#local-1628276230"><span class="hs-identifier">n_args_to_keep</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-1628276221"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-1628276229"><span class="hs-identifier hs-var">n_args_to_drop</span></a><span>
</span><a name="line-596"></a><span>              </span><span class="hs-special">(</span><a name="local-1628276231"><a href="#local-1628276231"><span class="hs-identifier">tc_args_to_keep</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276232"><a href="#local-1628276232"><span class="hs-identifier">args_to_drop</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>                              </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#splitAt"><span class="hs-identifier hs-var">splitAt</span></a><span> </span><a href="#local-1628276230"><span class="hs-identifier hs-var">n_args_to_keep</span></a><span> </span><a href="#local-1628276222"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-598"></a><span>              </span><a name="local-1628276233"><a href="#local-1628276233"><span class="hs-identifier">inst_ty_kind</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628276221"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628276231"><span class="hs-identifier hs-var">tc_args_to_keep</span></a><span class="hs-special">)</span><span>
</span><a name="line-599"></a><span>              </span><span class="hs-comment">-- Use exactTyCoVarsOfTypes, not tyCoVarsOfTypes, so that we</span><span>
</span><a name="line-600"></a><span>              </span><span class="hs-comment">-- don't mistakenly grab a type variable mentioned in a type</span><span>
</span><a name="line-601"></a><span>              </span><span class="hs-comment">-- synonym that drops it.</span><span>
</span><a name="line-602"></a><span>              </span><span class="hs-comment">-- See Note [Eta-reducing type synonyms].</span><span>
</span><a name="line-603"></a><span>              </span><a name="local-1628276234"><a href="#local-1628276234"><span class="hs-identifier">dropped_tvs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#exactTyCoVarsOfTypes"><span class="hs-identifier hs-var">exactTyCoVarsOfTypes</span></a><span> </span><a href="#local-1628276232"><span class="hs-identifier hs-var">args_to_drop</span></a><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span>              </span><span class="hs-comment">-- Match up the kinds, and apply the resulting kind substitution</span><span>
</span><a name="line-606"></a><span>              </span><span class="hs-comment">-- to the types.  See Note [Unify kinds in deriving]</span><span>
</span><a name="line-607"></a><span>              </span><span class="hs-comment">-- We are assuming the tycon tyvars and the class tyvars are distinct</span><span>
</span><a name="line-608"></a><span>              </span><a name="local-1628276235"><a href="#local-1628276235"><span class="hs-identifier">mb_match</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Unify.html#tcUnifyTy"><span class="hs-identifier hs-var">tcUnifyTy</span></a><span> </span><a href="#local-1628276233"><span class="hs-identifier hs-var">inst_ty_kind</span></a><span> </span><a href="#local-1628276227"><span class="hs-identifier hs-var">cls_arg_kind</span></a><span>
</span><a name="line-609"></a><span>              </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628276236"><a href="#local-1628276236"><span class="hs-identifier">kind_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276235"><span class="hs-identifier hs-var">mb_match</span></a><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span>              </span><a name="local-1628276237"><a href="#local-1628276237"><span class="hs-identifier">all_tkvs</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#varSetElemsWellScoped"><span class="hs-identifier hs-var">varSetElemsWellScoped</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-612"></a><span>                                </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-1628276224"><span class="hs-identifier hs-var">deriv_tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span>
</span><a name="line-613"></a><span>                                </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="#local-1628276231"><span class="hs-identifier hs-var">tc_args_to_keep</span></a><span>
</span><a name="line-614"></a><span>              </span><a name="local-1628276238"><a href="#local-1628276238"><span class="hs-identifier">unmapped_tkvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="TyCoRep.html#notElemTCvSubst"><span class="hs-identifier hs-var">notElemTCvSubst</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628276236"><span class="hs-identifier hs-var">kind_subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276237"><span class="hs-identifier hs-var">all_tkvs</span></a><span>
</span><a name="line-615"></a><span>              </span><span class="hs-special">(</span><a name="local-1628276239"><a href="#local-1628276239"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276240"><a href="#local-1628276240"><span class="hs-identifier">tkvs</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="TyCoRep.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span>
</span><a name="line-616"></a><span>                                          </span><a href="#local-1628276236"><span class="hs-identifier hs-var">kind_subst</span></a><span> </span><a href="#local-1628276238"><span class="hs-identifier hs-var">unmapped_tkvs</span></a><span>
</span><a name="line-617"></a><span>              </span><a name="local-1628276241"><a href="#local-1628276241"><span class="hs-identifier">final_tc_args</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">substTys</span></a><span> </span><a href="#local-1628276239"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1628276231"><span class="hs-identifier hs-var">tc_args_to_keep</span></a><span>
</span><a name="line-618"></a><span>              </span><a name="local-1628276242"><a href="#local-1628276242"><span class="hs-identifier">final_cls_tys</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">substTys</span></a><span> </span><a href="#local-1628276239"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-1628276226"><span class="hs-identifier hs-var">cls_tys</span></a><span>
</span><a name="line-619"></a><span>
</span><a name="line-620"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;derivTyData1&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="TyCoRep.html#pprTvBndrs"><span class="hs-identifier hs-var">pprTvBndrs</span></a><span> </span><a href="#local-1628276220"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276221"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276222"><span class="hs-identifier hs-var">tc_args</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276223"><span class="hs-identifier hs-var">deriv_pred</span></a><span>
</span><a name="line-621"></a><span>                                       </span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#pprTvBndrs"><span class="hs-identifier hs-var">pprTvBndrs</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfTypesList"><span class="hs-identifier hs-var">tyCoVarsOfTypesList</span></a><span> </span><a href="#local-1628276222"><span class="hs-identifier hs-var">tc_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-622"></a><span>                                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276230"><span class="hs-identifier hs-var">n_args_to_keep</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276229"><span class="hs-identifier hs-var">n_args_to_drop</span></a><span>
</span><a name="line-623"></a><span>                                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276233"><span class="hs-identifier hs-var">inst_ty_kind</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276227"><span class="hs-identifier hs-var">cls_arg_kind</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276235"><span class="hs-identifier hs-var">mb_match</span></a><span>
</span><a name="line-624"></a><span>                                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276241"><span class="hs-identifier hs-var">final_tc_args</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276242"><span class="hs-identifier hs-var">final_cls_tys</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-625"></a><span>
</span><a name="line-626"></a><span>        </span><span class="hs-comment">-- Check that the result really is well-kinded</span><span>
</span><a name="line-627"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276230"><span class="hs-identifier hs-var">n_args_to_keep</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><a href="#local-1628276235"><span class="hs-identifier hs-var">mb_match</span></a><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span>                  </span><span class="hs-special">(</span><a href="TcDeriv.html#derivingKindErr"><span class="hs-identifier hs-var">derivingKindErr</span></a><span> </span><a href="#local-1628276221"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628276225"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276226"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="#local-1628276227"><span class="hs-identifier hs-var">cls_arg_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-629"></a><span>
</span><a name="line-630"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;derivTyData2&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276240"><span class="hs-identifier hs-var">tkvs</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#allDistinctTyVars"><span class="hs-identifier hs-var">allDistinctTyVars</span></a><span> </span><a href="#local-1628276232"><span class="hs-identifier hs-var">args_to_drop</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>              </span><span class="hs-comment">-- (a) and (b)</span><span>
</span><a name="line-633"></a><span>                   </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628276234"><span class="hs-identifier hs-var">dropped_tvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276240"><span class="hs-identifier hs-var">tkvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- (c)</span><span>
</span><a name="line-634"></a><span>                  </span><span class="hs-special">(</span><a href="TcDeriv.html#derivingEtaErr"><span class="hs-identifier hs-var">derivingEtaErr</span></a><span> </span><a href="#local-1628276225"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276242"><span class="hs-identifier hs-var">final_cls_tys</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628276221"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628276241"><span class="hs-identifier hs-var">final_tc_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-635"></a><span>                </span><span class="hs-comment">-- Check that</span><span>
</span><a name="line-636"></a><span>                </span><span class="hs-comment">--  (a) The args to drop are all type variables; eg reject:</span><span>
</span><a name="line-637"></a><span>                </span><span class="hs-comment">--              data instance T a Int = .... deriving( Monad )</span><span>
</span><a name="line-638"></a><span>                </span><span class="hs-comment">--  (b) The args to drop are all *distinct* type variables; eg reject:</span><span>
</span><a name="line-639"></a><span>                </span><span class="hs-comment">--              class C (a :: * -&gt; * -&gt; *) where ...</span><span>
</span><a name="line-640"></a><span>                </span><span class="hs-comment">--              data instance T a a = ... deriving( C )</span><span>
</span><a name="line-641"></a><span>                </span><span class="hs-comment">--  (c) The type class args, or remaining tycon args,</span><span>
</span><a name="line-642"></a><span>                </span><span class="hs-comment">--      do not mention any of the dropped type variables</span><span>
</span><a name="line-643"></a><span>                </span><span class="hs-comment">--              newtype T a s = ... deriving( ST s )</span><span>
</span><a name="line-644"></a><span>                </span><span class="hs-comment">--              newtype instance K a a = ... deriving( Monad )</span><span>
</span><a name="line-645"></a><span>
</span><a name="line-646"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628276243"><a href="#local-1628276243"><span class="hs-identifier">spec</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#mkEqnHelp"><span class="hs-identifier hs-var">mkEqnHelp</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-1628276240"><span class="hs-identifier hs-var">tkvs</span></a><span>
</span><a name="line-647"></a><span>                            </span><a href="#local-1628276225"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276242"><span class="hs-identifier hs-var">final_cls_tys</span></a><span> </span><a href="#local-1628276221"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628276241"><span class="hs-identifier hs-var">final_tc_args</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-648"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;derivTyData&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276243"><span class="hs-identifier hs-var">spec</span></a><span class="hs-special">)</span><span>
</span><a name="line-649"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628276243"><span class="hs-identifier hs-var">spec</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-650"></a><span>
</span><a name="line-651"></a><span>
</span><a name="line-652"></a><span class="hs-comment">{-
Note [Unify kinds in deriving]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (Trac #8534)
    data T a b = MkT a deriving( Functor )
    -- where Functor :: (*-&gt;*) -&gt; Constraint

So T :: forall k. * -&gt; k -&gt; *.   We want to get
    instance Functor (T * (a:*)) where ...
Notice the '*' argument to T.

Moreover, as well as instantiating T's kind arguments, we may need to instantiate
C's kind args.  Consider (Trac #8865):
  newtype T a b = MkT (Either a b) deriving( Category )
where
  Category :: forall k. (k -&gt; k -&gt; *) -&gt; Constraint
We need to generate the instance
  instance Category * (Either a) where ...
Notice the '*' argument to Category.

So we need to
 * drop arguments from (T a b) to match the number of
   arrows in the (last argument of the) class;
 * and then *unify* kind of the remaining type against the
   expected kind, to figure out how to instantiate C's and T's
   kind arguments.

In the two examples,
 * we unify   kind-of( T k (a:k) ) ~ kind-of( Functor )
         i.e.      (k -&gt; *) ~ (* -&gt; *)   to find k:=*.
         yielding  k:=*

 * we unify   kind-of( Either ) ~ kind-of( Category )
         i.e.      (* -&gt; * -&gt; *)  ~ (k -&gt; k -&gt; k)
         yielding  k:=*

Now we get a kind substitution.  We then need to:

  1. Remove the substituted-out kind variables from the quantified kind vars

  2. Apply the substitution to the kinds of quantified *type* vars
     (and extend the substitution to reflect this change)

  3. Apply that extended substitution to the non-dropped args (types and
     kinds) of the type and class

Forgetting step (2) caused Trac #8893:
  data V a = V [a] deriving Functor
  data P (x::k-&gt;*) (a:k) = P (x a) deriving Functor
  data C (x::k-&gt;*) (a:k) = C (V (P x a)) deriving Functor

When deriving Functor for P, we unify k to *, but we then want
an instance   $df :: forall (x:*-&gt;*). Functor x =&gt; Functor (P * (x:*-&gt;*))
and similarly for C.  Notice the modified kind of x, both at binding
and occurrence sites.

Note [Eta-reducing type synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
One can instantiate a type in a data family instance with a type synonym that
mentions other type variables:

  type Const a b = a
  data family Fam (f :: * -&gt; *) (a :: *)
  newtype instance Fam f (Const a f) = Fam (f a) deriving Functor

With -XTypeInType, it is also possible to define kind synonyms, and they can
mention other types in a datatype declaration. For example,

  type Const a b = a
  newtype T f (a :: Const * f) = T (f a) deriving Functor

When deriving, we need to perform eta-reduction analysis to ensure that none of
the eta-reduced type variables are mentioned elsewhere in the declaration. But
we need to be careful, because if we don't expand through the Const type
synonym, we will mistakenly believe that f is an eta-reduced type variable and
fail to derive Functor, even though the code above is correct (see Trac #11416,
where this was first noticed).

For this reason, we call exactTyCoVarsOfTypes on the eta-reduced types so that
we only consider the type variables that remain after expanding through type
synonyms.
-}</span><span>
</span><a name="line-734"></a><span>
</span><a name="line-735"></a><span class="hs-identifier">mkEqnHelp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="BasicTypes.html#OverlapMode"><span class="hs-identifier hs-type">OverlapMode</span></a><span>
</span><a name="line-736"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-737"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-738"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-739"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span>       </span><span class="hs-comment">-- Just    =&gt; context supplied (standalone deriving)</span><span>
</span><a name="line-740"></a><span>                                </span><span class="hs-comment">-- Nothing =&gt; context inferred (deriving on data decl)</span><span>
</span><a name="line-741"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcRn"><span class="hs-identifier hs-type">TcRn</span></a><span> </span><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier hs-type">EarlyDerivSpec</span></a><span>
</span><a name="line-742"></a><span class="hs-comment">-- Make the EarlyDerivSpec for an instance</span><span>
</span><a name="line-743"></a><span class="hs-comment">--      forall tvs. theta =&gt; cls (tys ++ [ty])</span><span>
</span><a name="line-744"></a><span class="hs-comment">-- where the 'theta' is optional (that's the Maybe part)</span><span>
</span><a name="line-745"></a><span class="hs-comment">-- Assumes that this declaration is well-kinded</span><span>
</span><a name="line-746"></a><span>
</span><a name="line-747"></a><a name="mkEqnHelp"><a href="TcDeriv.html#mkEqnHelp"><span class="hs-identifier">mkEqnHelp</span></a></a><span> </span><a name="local-1628276244"><a href="#local-1628276244"><span class="hs-identifier">overlap_mode</span></a></a><span> </span><a name="local-1628276245"><a href="#local-1628276245"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1628276246"><a href="#local-1628276246"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-1628276247"><a href="#local-1628276247"><span class="hs-identifier">cls_tys</span></a></a><span> </span><a name="local-1628276248"><a href="#local-1628276248"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-1628276249"><a href="#local-1628276249"><span class="hs-identifier">tc_args</span></a></a><span> </span><a name="local-1628276250"><a href="#local-1628276250"><span class="hs-identifier">mtheta</span></a></a><span>
</span><a name="line-748"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>      </span><span class="hs-comment">-- Find the instance of a data family</span><span>
</span><a name="line-749"></a><span>              </span><span class="hs-comment">-- Note [Looking up family instances for deriving]</span><span>
</span><a name="line-750"></a><span>         </span><a name="local-1628276253"><a href="#local-1628276253"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-751"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628276254"><a href="#local-1628276254"><span class="hs-identifier">rep_tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276255"><a href="#local-1628276255"><span class="hs-identifier">rep_tc_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276256"><a href="#local-1628276256"><span class="hs-identifier">_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#tcLookupDataFamInst"><span class="hs-identifier hs-var">tcLookupDataFamInst</span></a><span> </span><a href="#local-1628276253"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-1628276248"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-1628276249"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-752"></a><span>              </span><span class="hs-comment">-- If it's still a data family, the lookup failed; i.e no instance exists</span><span>
</span><a name="line-753"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#isDataFamilyTyCon"><span class="hs-identifier hs-var">isDataFamilyTyCon</span></a><span> </span><a href="#local-1628276254"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-754"></a><span>              </span><span class="hs-special">(</span><a href="#local-1628276251"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;No family instance for&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#pprTypeApp"><span class="hs-identifier hs-var">pprTypeApp</span></a><span> </span><a href="#local-1628276248"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-1628276249"><span class="hs-identifier hs-var">tc_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-755"></a><span>
</span><a name="line-756"></a><span>       </span><span class="hs-comment">-- For standalone deriving (mtheta /= Nothing),</span><span>
</span><a name="line-757"></a><span>       </span><span class="hs-comment">-- check that all the data constructors are in scope.</span><span>
</span><a name="line-758"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628276257"><a href="#local-1628276257"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span>
</span><a name="line-759"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276258"><a href="#local-1628276258"><span class="hs-identifier">data_con_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="DataCon.html#dataConName"><span class="hs-identifier hs-var">dataConName</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-1628276254"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-760"></a><span>             </span><a name="local-1628276259"><a href="#local-1628276259"><span class="hs-identifier">hidden_data_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Name.html#isWiredInName"><span class="hs-identifier hs-var">isWiredInName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-1628276254"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-761"></a><span>                                </span><span class="hs-special">(</span><a href="TyCon.html#isAbstractTyCon"><span class="hs-identifier hs-var">isAbstractTyCon</span></a><span> </span><a href="#local-1628276254"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-762"></a><span>                                 </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><a href="#local-1628276260"><span class="hs-identifier hs-var">not_in_scope</span></a><span> </span><a href="#local-1628276258"><span class="hs-identifier hs-var">data_con_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-763"></a><span>             </span><a name="local-1628276260"><a href="#local-1628276260"><span class="hs-identifier">not_in_scope</span></a></a><span> </span><a name="local-1628276261"><a href="#local-1628276261"><span class="hs-identifier">dc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-special">(</span><a href="RdrName.html#lookupGRE_Name"><span class="hs-identifier hs-var">lookupGRE_Name</span></a><span> </span><a href="#local-1628276257"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-1628276261"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-764"></a><span>
</span><a name="line-765"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnEnv.html#addUsedDataCons"><span class="hs-identifier hs-var">addUsedDataCons</span></a><span> </span><a href="#local-1628276257"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-1628276254"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-766"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a><span> </span><a href="#local-1628276250"><span class="hs-identifier hs-var">mtheta</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1628276259"><span class="hs-identifier hs-var">hidden_data_cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-767"></a><span>                </span><span class="hs-special">(</span><a href="#local-1628276251"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#derivingHiddenErr"><span class="hs-identifier hs-var">derivingHiddenErr</span></a><span> </span><a href="#local-1628276248"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-768"></a><span>
</span><a name="line-769"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628276262"><a href="#local-1628276262"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-770"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="TyCon.html#isDataTyCon"><span class="hs-identifier hs-var">isDataTyCon</span></a><span> </span><a href="#local-1628276254"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-771"></a><span>            </span><a href="TcDeriv.html#mkDataTypeEqn"><span class="hs-identifier hs-var">mkDataTypeEqn</span></a><span> </span><a href="#local-1628276262"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628276244"><span class="hs-identifier hs-var">overlap_mode</span></a><span> </span><a href="#local-1628276245"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1628276246"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276247"><span class="hs-identifier hs-var">cls_tys</span></a><span>
</span><a name="line-772"></a><span>                          </span><a href="#local-1628276248"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-1628276249"><span class="hs-identifier hs-var">tc_args</span></a><span> </span><a href="#local-1628276254"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><a href="#local-1628276255"><span class="hs-identifier hs-var">rep_tc_args</span></a><span> </span><a href="#local-1628276250"><span class="hs-identifier hs-var">mtheta</span></a><span>
</span><a name="line-773"></a><span>         </span><span class="hs-keyword">else</span><span>
</span><a name="line-774"></a><span>            </span><a href="TcDeriv.html#mkNewTypeEqn"><span class="hs-identifier hs-var">mkNewTypeEqn</span></a><span> </span><a href="#local-1628276262"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628276244"><span class="hs-identifier hs-var">overlap_mode</span></a><span> </span><a href="#local-1628276245"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1628276246"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276247"><span class="hs-identifier hs-var">cls_tys</span></a><span>
</span><a name="line-775"></a><span>                         </span><a href="#local-1628276248"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-1628276249"><span class="hs-identifier hs-var">tc_args</span></a><span> </span><a href="#local-1628276254"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><a href="#local-1628276255"><span class="hs-identifier hs-var">rep_tc_args</span></a><span> </span><a href="#local-1628276250"><span class="hs-identifier hs-var">mtheta</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-776"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-777"></a><span>     </span><a name="local-1628276251"><a href="#local-1628276251"><span class="hs-identifier">bale_out</span></a></a><span> </span><a name="local-1628276252"><a href="#local-1628276252"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#derivingThingErr"><span class="hs-identifier hs-var">derivingThingErr</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1628276246"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276247"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628276248"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-1628276249"><span class="hs-identifier hs-var">tc_args</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276252"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-778"></a><span>
</span><a name="line-779"></a><span class="hs-comment">{-
Note [Looking up family instances for deriving]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
tcLookupFamInstExact is an auxiliary lookup wrapper which requires
that looked-up family instances exist.  If called with a vanilla
tycon, the old type application is simply returned.

If we have
  data instance F () = ... deriving Eq
  data instance F () = ... deriving Eq
then tcLookupFamInstExact will be confused by the two matches;
but that can't happen because tcInstDecls1 doesn't call tcDeriving
if there are any overlaps.

There are two other things that might go wrong with the lookup.
First, we might see a standalone deriving clause
   deriving Eq (F ())
when there is no data instance F () in scope.

Note that it's OK to have
  data instance F [a] = ...
  deriving Eq (F [(a,b)])
where the match is not exact; the same holds for ordinary data types
with standalone deriving declarations.

Note [Deriving, type families, and partial applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When there are no type families, it's quite easy:

    newtype S a = MkS [a]
    -- :CoS :: S  ~ []  -- Eta-reduced

    instance Eq [a] =&gt; Eq (S a)         -- by coercion sym (Eq (:CoS a)) : Eq [a] ~ Eq (S a)
    instance Monad [] =&gt; Monad S        -- by coercion sym (Monad :CoS)  : Monad [] ~ Monad S

When type familes are involved it's trickier:

    data family T a b
    newtype instance T Int a = MkT [a] deriving( Eq, Monad )
    -- :RT is the representation type for (T Int a)
    --  :Co:RT    :: :RT ~ []          -- Eta-reduced!
    --  :CoF:RT a :: T Int a ~ :RT a   -- Also eta-reduced!

    instance Eq [a] =&gt; Eq (T Int a)     -- easy by coercion
       -- d1 :: Eq [a]
       -- d2 :: Eq (T Int a) = d1 |&gt; Eq (sym (:Co:RT a ; :coF:RT a))

    instance Monad [] =&gt; Monad (T Int)  -- only if we can eta reduce???
       -- d1 :: Monad []
       -- d2 :: Monad (T Int) = d1 |&gt; Monad (sym (:Co:RT ; :coF:RT))

Note the need for the eta-reduced rule axioms.  After all, we can
write it out
    instance Monad [] =&gt; Monad (T Int)  -- only if we can eta reduce???
      return x = MkT [x]
      ... etc ...

See Note [Eta reduction for data families] in FamInstEnv

%************************************************************************
%*                                                                      *
                Deriving data types
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span class="hs-identifier">mkDataTypeEqn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-846"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="BasicTypes.html#OverlapMode"><span class="hs-identifier hs-type">OverlapMode</span></a><span>
</span><a name="line-847"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- Universally quantified type variables in the instance</span><span>
</span><a name="line-848"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span>                  </span><span class="hs-comment">-- Class for which we need to derive an instance</span><span>
</span><a name="line-849"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- Other parameters to the class except the last</span><span>
</span><a name="line-850"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>                  </span><span class="hs-comment">-- Type constructor for which the instance is requested</span><span>
</span><a name="line-851"></a><span>                                        </span><span class="hs-comment">--    (last parameter to the type class)</span><span>
</span><a name="line-852"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- Parameters to the type constructor</span><span>
</span><a name="line-853"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>                  </span><span class="hs-comment">-- rep of the above (for type families)</span><span>
</span><a name="line-854"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- rep of the above</span><span>
</span><a name="line-855"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span>        </span><span class="hs-comment">-- Context of the instance, for standalone deriving</span><span>
</span><a name="line-856"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcRn"><span class="hs-identifier hs-type">TcRn</span></a><span> </span><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier hs-type">EarlyDerivSpec</span></a><span>    </span><span class="hs-comment">-- Return 'Nothing' if error</span><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><a name="mkDataTypeEqn"><a href="TcDeriv.html#mkDataTypeEqn"><span class="hs-identifier">mkDataTypeEqn</span></a></a><span> </span><a name="local-1628276263"><a href="#local-1628276263"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1628276264"><a href="#local-1628276264"><span class="hs-identifier">overlap_mode</span></a></a><span> </span><a name="local-1628276265"><a href="#local-1628276265"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1628276266"><a href="#local-1628276266"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-1628276267"><a href="#local-1628276267"><span class="hs-identifier">cls_tys</span></a></a><span>
</span><a name="line-859"></a><span>              </span><a name="local-1628276268"><a href="#local-1628276268"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-1628276269"><a href="#local-1628276269"><span class="hs-identifier">tc_args</span></a></a><span> </span><a name="local-1628276270"><a href="#local-1628276270"><span class="hs-identifier">rep_tc</span></a></a><span> </span><a name="local-1628276271"><a href="#local-1628276271"><span class="hs-identifier">rep_tc_args</span></a></a><span> </span><a name="local-1628276272"><a href="#local-1628276272"><span class="hs-identifier">mtheta</span></a></a><span>
</span><a name="line-860"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcDeriv.html#checkSideConditions"><span class="hs-identifier hs-var">checkSideConditions</span></a><span> </span><a href="#local-1628276263"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628276272"><span class="hs-identifier hs-var">mtheta</span></a><span> </span><a href="#local-1628276266"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276267"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="#local-1628276270"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><a href="#local-1628276271"><span class="hs-identifier hs-var">rep_tc_args</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-861"></a><span>        </span><span class="hs-comment">-- NB: pass the *representation* tycon to checkSideConditions</span><span>
</span><a name="line-862"></a><span>        </span><a href="TcDeriv.html#NonDerivableClass"><span class="hs-identifier hs-var">NonDerivableClass</span></a><span>   </span><a name="local-1628276276"><a href="#local-1628276276"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276274"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#nonStdErr"><span class="hs-identifier hs-var">nonStdErr</span></a><span> </span><a href="#local-1628276266"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="#local-1628276276"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-863"></a><span>        </span><a href="TcDeriv.html#DerivableClassError"><span class="hs-identifier hs-var">DerivableClassError</span></a><span> </span><a name="local-1628276277"><a href="#local-1628276277"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276274"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-1628276277"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-864"></a><span>        </span><a href="TcDeriv.html#CanDerive"><span class="hs-identifier hs-var">CanDerive</span></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276273"><span class="hs-identifier hs-var">go_for_it</span></a><span>
</span><a name="line-865"></a><span>        </span><a href="TcDeriv.html#DerivableViaInstance"><span class="hs-identifier hs-var">DerivableViaInstance</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276273"><span class="hs-identifier hs-var">go_for_it</span></a><span>
</span><a name="line-866"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-867"></a><span>    </span><a name="local-1628276273"><a href="#local-1628276273"><span class="hs-identifier">go_for_it</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#mk_data_eqn"><span class="hs-identifier hs-var">mk_data_eqn</span></a><span> </span><a href="#local-1628276264"><span class="hs-identifier hs-var">overlap_mode</span></a><span> </span><a href="#local-1628276265"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1628276266"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276267"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="#local-1628276268"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-1628276269"><span class="hs-identifier hs-var">tc_args</span></a><span> </span><a href="#local-1628276270"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><a href="#local-1628276271"><span class="hs-identifier hs-var">rep_tc_args</span></a><span> </span><a href="#local-1628276272"><span class="hs-identifier hs-var">mtheta</span></a><span>
</span><a name="line-868"></a><span>    </span><a name="local-1628276274"><a href="#local-1628276274"><span class="hs-identifier">bale_out</span></a></a><span> </span><a name="local-1628276275"><a href="#local-1628276275"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#derivingThingErr"><span class="hs-identifier hs-var">derivingThingErr</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1628276266"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276267"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628276268"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-1628276269"><span class="hs-identifier hs-var">tc_args</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276275"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-869"></a><span>
</span><a name="line-870"></a><span class="hs-identifier">mk_data_eqn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="BasicTypes.html#OverlapMode"><span class="hs-identifier hs-type">OverlapMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-871"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span>
</span><a name="line-872"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier hs-type">EarlyDerivSpec</span></a><span>
</span><a name="line-873"></a><a name="mk_data_eqn"><a href="TcDeriv.html#mk_data_eqn"><span class="hs-identifier">mk_data_eqn</span></a></a><span> </span><a name="local-1628276278"><a href="#local-1628276278"><span class="hs-identifier">overlap_mode</span></a></a><span> </span><a name="local-1628276279"><a href="#local-1628276279"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1628276280"><a href="#local-1628276280"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-1628276281"><a href="#local-1628276281"><span class="hs-identifier">cls_tys</span></a></a><span> </span><a name="local-1628276282"><a href="#local-1628276282"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-1628276283"><a href="#local-1628276283"><span class="hs-identifier">tc_args</span></a></a><span> </span><a name="local-1628276284"><a href="#local-1628276284"><span class="hs-identifier">rep_tc</span></a></a><span> </span><a name="local-1628276285"><a href="#local-1628276285"><span class="hs-identifier">rep_tc_args</span></a></a><span> </span><a name="local-1628276286"><a href="#local-1628276286"><span class="hs-identifier">mtheta</span></a></a><span>
</span><a name="line-874"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-1628276289"><a href="#local-1628276289"><span class="hs-identifier">loc</span></a></a><span>                  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-875"></a><span>       </span><a name="local-1628276290"><a href="#local-1628276290"><span class="hs-identifier">dfun_name</span></a></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#newDFunName%27"><span class="hs-identifier hs-var">newDFunName'</span></a><span> </span><a href="#local-1628276280"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276282"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-876"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628276286"><span class="hs-identifier hs-var">mtheta</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-877"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">--Infer context</span><span>
</span><a name="line-878"></a><span>            </span><a name="local-1628276291"><a href="#local-1628276291"><span class="hs-identifier">inferred_constraints</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#inferConstraints"><span class="hs-identifier hs-var">inferConstraints</span></a><span> </span><a href="#local-1628276280"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276281"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="#local-1628276287"><span class="hs-identifier hs-var">inst_ty</span></a><span> </span><a href="#local-1628276284"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><a href="#local-1628276285"><span class="hs-identifier hs-var">rep_tc_args</span></a><span>
</span><a name="line-879"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcDeriv.html#InferTheta"><span class="hs-identifier hs-var">InferTheta</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcDeriv.html#DS"><span class="hs-identifier hs-var">DS</span></a><span>
</span><a name="line-880"></a><span>                   </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276289"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-881"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276290"><span class="hs-identifier hs-var">dfun_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276279"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-882"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_cls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276280"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276288"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-883"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276284"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-884"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276291"><span class="hs-identifier hs-var">inferred_constraints</span></a><span>
</span><a name="line-885"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_overlap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276278"><span class="hs-identifier hs-var">overlap_mode</span></a><span>
</span><a name="line-886"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_newtype</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-887"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628276292"><a href="#local-1628276292"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Specified context</span><span>
</span><a name="line-888"></a><span>            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcDeriv.html#GivenTheta"><span class="hs-identifier hs-var">GivenTheta</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcDeriv.html#DS"><span class="hs-identifier hs-var">DS</span></a><span>
</span><a name="line-889"></a><span>                   </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276289"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-890"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276290"><span class="hs-identifier hs-var">dfun_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276279"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-891"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_cls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276280"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276288"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-892"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276284"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-893"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276292"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-894"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_overlap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276278"><span class="hs-identifier hs-var">overlap_mode</span></a><span>
</span><a name="line-895"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_newtype</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-896"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-897"></a><span>    </span><a name="local-1628276287"><a href="#local-1628276287"><span class="hs-identifier">inst_ty</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628276282"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-1628276283"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-898"></a><span>    </span><a name="local-1628276288"><a href="#local-1628276288"><span class="hs-identifier">inst_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276281"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628276287"><span class="hs-identifier hs-var">inst_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-899"></a><span>
</span><a name="line-900"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-901"></a><span>
</span><a name="line-902"></a><span class="hs-identifier">inferConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>
</span><a name="line-903"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span>
</span><a name="line-904"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcDeriv.html#ThetaOrigin"><span class="hs-identifier hs-type">ThetaOrigin</span></a><span>
</span><a name="line-905"></a><span class="hs-comment">-- inferConstraints figures out the constraints needed for the</span><span>
</span><a name="line-906"></a><span class="hs-comment">-- instance declaration generated by a 'deriving' clause on a</span><span>
</span><a name="line-907"></a><span class="hs-comment">-- data type declaration.</span><span>
</span><a name="line-908"></a><span class="hs-comment">-- See Note [Inferring the instance context]</span><span>
</span><a name="line-909"></a><span>
</span><a name="line-910"></a><span class="hs-comment">-- e.g. inferConstraints</span><span>
</span><a name="line-911"></a><span class="hs-comment">--        C Int (T [a])    -- Class and inst_tys</span><span>
</span><a name="line-912"></a><span class="hs-comment">--        :RTList a        -- Rep tycon and its arg tys</span><span>
</span><a name="line-913"></a><span class="hs-comment">-- where T [a] ~R :RTList a</span><span>
</span><a name="line-914"></a><span class="hs-comment">--</span><span>
</span><a name="line-915"></a><span class="hs-comment">-- Generate a sufficiently large set of constraints that typechecking the</span><span>
</span><a name="line-916"></a><span class="hs-comment">-- generated method definitions should succeed.   This set will be simplified</span><span>
</span><a name="line-917"></a><span class="hs-comment">-- before being used in the instance declaration</span><span>
</span><a name="line-918"></a><a name="inferConstraints"><a href="TcDeriv.html#inferConstraints"><span class="hs-identifier">inferConstraints</span></a></a><span> </span><a name="local-1628276293"><a href="#local-1628276293"><span class="hs-identifier">main_cls</span></a></a><span> </span><a name="local-1628276294"><a href="#local-1628276294"><span class="hs-identifier">cls_tys</span></a></a><span> </span><a name="local-1628276295"><a href="#local-1628276295"><span class="hs-identifier">inst_ty</span></a></a><span> </span><a name="local-1628276296"><a href="#local-1628276296"><span class="hs-identifier">rep_tc</span></a></a><span> </span><a name="local-1628276297"><a href="#local-1628276297"><span class="hs-identifier">rep_tc_args</span></a></a><span>
</span><a name="line-919"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276293"><span class="hs-identifier hs-var">main_cls</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#genClassKey"><span class="hs-identifier hs-var">genClassKey</span></a><span>    </span><span class="hs-comment">-- Generic constraints are easy</span><span>
</span><a name="line-920"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-921"></a><span>
</span><a name="line-922"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276293"><span class="hs-identifier hs-var">main_cls</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#gen1ClassKey"><span class="hs-identifier hs-var">gen1ClassKey</span></a><span>   </span><span class="hs-comment">-- Gen1 needs Functor</span><span>
</span><a name="line-923"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">rep_tc_tvs</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-operator hs-var">&gt;</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- See Note [Getting base classes]</span><span>
</span><a name="line-924"></a><span>    </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-identifier">cls_tys</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-925"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276345"><a href="#local-1628276345"><span class="hs-identifier">functorClass</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span> </span><a href="PrelNames.html#functorClassName"><span class="hs-identifier hs-var">functorClassName</span></a><span>
</span><a name="line-926"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276302"><span class="hs-identifier hs-var">con_arg_constraints</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276304"><span class="hs-identifier hs-var">get_gen1_constraints</span></a><span> </span><a href="#local-1628276345"><span class="hs-identifier hs-var">functorClass</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-927"></a><span>
</span><a name="line-928"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-comment">-- The others are a bit more complicated</span><span>
</span><a name="line-929"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">equalLength</span><span> </span><span class="hs-identifier">rep_tc_tvs</span><span> </span><span class="hs-identifier">all_rep_tc_args</span><span>
</span><a name="line-930"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">main_cls</span><span> </span><a href="Outputable.html#assertPprPanic"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#assertPprPanic"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-identifier">rep_tc</span><span>
</span><a name="line-931"></a><span>             </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">rep_tc_tvs</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">all_rep_tc_args</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-932"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;inferConstraints&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276293"><span class="hs-identifier hs-var">main_cls</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276311"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276301"><span class="hs-identifier hs-var">arg_constraints</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-933"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276314"><span class="hs-identifier hs-var">stupid_constraints</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628276316"><span class="hs-identifier hs-var">extra_constraints</span></a><span>
</span><a name="line-934"></a><span>                 </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628276312"><span class="hs-identifier hs-var">sc_constraints</span></a><span>
</span><a name="line-935"></a><span>                 </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628276301"><span class="hs-identifier hs-var">arg_constraints</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-936"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-937"></a><span>    </span><a name="local-1628276298"><a href="#local-1628276298"><span class="hs-identifier">tc_binders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-1628276296"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-938"></a><span>    </span><a name="local-1628276299"><a href="#local-1628276299"><span class="hs-identifier">choose_level</span></a></a><span> </span><a name="local-1628276318"><a href="#local-1628276318"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-939"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="TyCoRep.html#isNamedBinder"><span class="hs-identifier hs-var">isNamedBinder</span></a><span> </span><a href="#local-1628276318"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a><span>
</span><a name="line-940"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span>
</span><a name="line-941"></a><span>    </span><a name="local-1628276300"><a href="#local-1628276300"><span class="hs-identifier">t_or_ks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1628276299"><span class="hs-identifier hs-var">choose_level</span></a><span> </span><a href="#local-1628276298"><span class="hs-identifier hs-var">tc_binders</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#repeat"><span class="hs-identifier hs-var">repeat</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span>
</span><a name="line-942"></a><span>       </span><span class="hs-comment">-- want to report *kind* errors when possible</span><span>
</span><a name="line-943"></a><span>
</span><a name="line-944"></a><span>    </span><a name="local-1628276301"><a href="#local-1628276301"><span class="hs-identifier">arg_constraints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276302"><span class="hs-identifier hs-var">con_arg_constraints</span></a><span> </span><a href="#local-1628276305"><span class="hs-identifier hs-var">get_std_constrained_tys</span></a><span>
</span><a name="line-945"></a><span>
</span><a name="line-946"></a><span>       </span><span class="hs-comment">-- Constraints arising from the arguments of each constructor</span><span>
</span><a name="line-947"></a><span>    </span><span class="hs-identifier">con_arg_constraints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-948"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span class="hs-special">]</span><span>
</span><a name="line-949"></a><span>    </span><a name="local-1628276302"><a href="#local-1628276302"><span class="hs-identifier">con_arg_constraints</span></a></a><span> </span><a name="local-1628276319"><a href="#local-1628276319"><span class="hs-identifier">get_arg_constraints</span></a></a><span>
</span><a name="line-950"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628276325"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-951"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a name="local-1628276320"><a href="#local-1628276320"><span class="hs-identifier">data_con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-1628276296"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-952"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-1628276321"><a href="#local-1628276321"><span class="hs-identifier">arg_n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276322"><a href="#local-1628276322"><span class="hs-identifier">arg_t_or_k</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276323"><a href="#local-1628276323"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-953"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip3"><span class="hs-identifier hs-var">zip3</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><a href="#local-1628276300"><span class="hs-identifier hs-var">t_or_ks</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-954"></a><span>               </span><a href="DataCon.html#dataConInstOrigArgTys"><span class="hs-identifier hs-var">dataConInstOrigArgTys</span></a><span> </span><a href="#local-1628276320"><span class="hs-identifier hs-var">data_con</span></a><span> </span><a href="#local-1628276309"><span class="hs-identifier hs-var">all_rep_tc_args</span></a><span>
</span><a name="line-955"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a><span> </span><a href="#local-1628276323"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-956"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276324"><a href="#local-1628276324"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#DerivOriginDC"><span class="hs-identifier hs-var">DerivOriginDC</span></a><span> </span><a href="#local-1628276320"><span class="hs-identifier hs-var">data_con</span></a><span> </span><a href="#local-1628276321"><span class="hs-identifier hs-var">arg_n</span></a><span>
</span><a name="line-957"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="local-1628276325"><a href="#local-1628276325"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628276319"><span class="hs-identifier hs-var">get_arg_constraints</span></a><span> </span><a href="#local-1628276324"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-1628276322"><span class="hs-identifier hs-var">arg_t_or_k</span></a><span> </span><a href="#local-1628276323"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-958"></a><span>
</span><a name="line-959"></a><span>                </span><span class="hs-comment">-- No constraints for unlifted types</span><span>
</span><a name="line-960"></a><span>                </span><span class="hs-comment">-- See Note [Deriving and unboxed types]</span><span>
</span><a name="line-961"></a><span>
</span><a name="line-962"></a><span>    </span><span class="hs-comment">-- is_functor_like: see Note [Inferring the instance context]</span><span>
</span><a name="line-963"></a><span>    </span><a name="local-1628276303"><a href="#local-1628276303"><span class="hs-identifier">is_functor_like</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628276295"><span class="hs-identifier hs-var">inst_ty</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#tcEqKind"><span class="hs-identifier hs-var">tcEqKind</span></a><span class="hs-special">`</span><span> </span><a href="TcDeriv.html#typeToTypeKind"><span class="hs-identifier hs-var">typeToTypeKind</span></a><span>
</span><a name="line-964"></a><span>
</span><a name="line-965"></a><span>    </span><a name="local-1628276304"><a href="#local-1628276304"><span class="hs-identifier">get_gen1_constraints</span></a></a><span> </span><a name="local-1628276326"><a href="#local-1628276326"><span class="hs-identifier">functor_cls</span></a></a><span> </span><a name="local-1628276327"><a href="#local-1628276327"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-1628276328"><a href="#local-1628276328"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-1628276329"><a href="#local-1628276329"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-966"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276306"><span class="hs-identifier hs-var">mk_functor_like_constraints</span></a><span> </span><a href="#local-1628276327"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-1628276328"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628276326"><span class="hs-identifier hs-var">functor_cls</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-967"></a><span>         </span><a href="TcGenGenerics.html#get_gen1_constrained_tys"><span class="hs-identifier hs-var">get_gen1_constrained_tys</span></a><span> </span><a href="#local-1628276308"><span class="hs-identifier hs-var">last_tv</span></a><span> </span><a href="#local-1628276329"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-968"></a><span>
</span><a name="line-969"></a><span>    </span><span class="hs-identifier">get_std_constrained_tys</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span class="hs-special">]</span><span>
</span><a name="line-970"></a><span>    </span><a name="local-1628276305"><a href="#local-1628276305"><span class="hs-identifier">get_std_constrained_tys</span></a></a><span> </span><a name="local-1628276330"><a href="#local-1628276330"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-1628276331"><a href="#local-1628276331"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-1628276332"><a href="#local-1628276332"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-971"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276303"><span class="hs-identifier hs-var">is_functor_like</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276306"><span class="hs-identifier hs-var">mk_functor_like_constraints</span></a><span> </span><a href="#local-1628276330"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-1628276331"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628276293"><span class="hs-identifier hs-var">main_cls</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-972"></a><span>                            </span><a href="TcGenDeriv.html#deepSubtypesContaining"><span class="hs-identifier hs-var">deepSubtypesContaining</span></a><span> </span><a href="#local-1628276308"><span class="hs-identifier hs-var">last_tv</span></a><span> </span><a href="#local-1628276332"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-973"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-1628276317"><span class="hs-identifier hs-var">mk_cls_pred</span></a><span> </span><a href="#local-1628276330"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-1628276331"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628276293"><span class="hs-identifier hs-var">main_cls</span></a><span> </span><a href="#local-1628276332"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-974"></a><span>
</span><a name="line-975"></a><span>    </span><span class="hs-identifier">mk_functor_like_constraints</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a><span>
</span><a name="line-976"></a><span>                                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span class="hs-special">]</span><span>
</span><a name="line-977"></a><span>    </span><span class="hs-comment">-- 'cls' is usually main_cls (Functor or Traversable etc), but if</span><span>
</span><a name="line-978"></a><span>    </span><span class="hs-comment">-- main_cls = Generic1, then 'cls' can be Functor; see get_gen1_constraints</span><span>
</span><a name="line-979"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-980"></a><span>    </span><span class="hs-comment">-- For each type, generate two constraints: (cls ty, kind(ty) ~ (*-&gt;*))</span><span>
</span><a name="line-981"></a><span>    </span><span class="hs-comment">-- The second constraint checks that the first is well-kinded.</span><span>
</span><a name="line-982"></a><span>    </span><span class="hs-comment">-- Lacking that, as Trac #10561 showed, we can just generate an</span><span>
</span><a name="line-983"></a><span>    </span><span class="hs-comment">-- ill-kinded instance.</span><span>
</span><a name="line-984"></a><span>    </span><a name="local-1628276306"><a href="#local-1628276306"><span class="hs-identifier">mk_functor_like_constraints</span></a></a><span> </span><a name="local-1628276333"><a href="#local-1628276333"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-1628276334"><a href="#local-1628276334"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-1628276335"><a href="#local-1628276335"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-1628276336"><a href="#local-1628276336"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-985"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628276338"><span class="hs-identifier hs-var">pred_o</span></a><span>
</span><a name="line-986"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a name="local-1628276337"><a href="#local-1628276337"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628276336"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-987"></a><span>         </span><span class="hs-special">,</span><span> </span><a name="local-1628276338"><a href="#local-1628276338"><span class="hs-identifier">pred_o</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628276317"><span class="hs-identifier hs-var">mk_cls_pred</span></a><span> </span><a href="#local-1628276333"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-1628276334"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628276335"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276337"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-988"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#mkPredOrigin"><span class="hs-identifier hs-var">mkPredOrigin</span></a><span> </span><a href="#local-1628276333"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="TcRnTypes.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a><span>
</span><a name="line-989"></a><span>                         </span><span class="hs-special">(</span><a href="Type.html#mkPrimEqPred"><span class="hs-identifier hs-var">mkPrimEqPred</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628276337"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="TcDeriv.html#typeToTypeKind"><span class="hs-identifier hs-var">typeToTypeKind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-990"></a><span>
</span><a name="line-991"></a><span>    </span><a name="local-1628276307"><a href="#local-1628276307"><span class="hs-identifier">rep_tc_tvs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-1628276296"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-992"></a><span>    </span><a name="local-1628276308"><a href="#local-1628276308"><span class="hs-identifier">last_tv</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#last"><span class="hs-identifier hs-var">last</span></a><span> </span><a href="#local-1628276307"><span class="hs-identifier hs-var">rep_tc_tvs</span></a><span>
</span><a name="line-993"></a><span>    </span><a name="local-1628276309"><a href="#local-1628276309"><span class="hs-identifier">all_rep_tc_args</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276303"><span class="hs-identifier hs-var">is_functor_like</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276297"><span class="hs-identifier hs-var">rep_tc_args</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628276308"><span class="hs-identifier hs-var">last_tv</span></a><span class="hs-special">]</span><span>
</span><a name="line-994"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276297"><span class="hs-identifier hs-var">rep_tc_args</span></a><span>
</span><a name="line-995"></a><span>
</span><a name="line-996"></a><span>        </span><span class="hs-comment">-- Constraints arising from superclasses</span><span>
</span><a name="line-997"></a><span>        </span><span class="hs-comment">-- See Note [Superclasses of derived instance]</span><span>
</span><a name="line-998"></a><span>    </span><a name="local-1628276310"><a href="#local-1628276310"><span class="hs-identifier">cls_tvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classTyVars</span><span> </span><a href="#local-1628276293"><span class="hs-identifier hs-var">main_cls</span></a><span>
</span><a name="line-999"></a><span>    </span><a name="local-1628276311"><a href="#local-1628276311"><span class="hs-identifier">inst_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276294"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628276295"><span class="hs-identifier hs-var">inst_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1000"></a><span>    </span><a name="local-1628276312"><a href="#local-1628276312"><span class="hs-identifier">sc_constraints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">equalLength</span><span> </span><span class="hs-identifier">cls_tvs</span><span> </span><span class="hs-identifier">inst_tys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">main_cls</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><a href="Outputable.html#assertPprPanic"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1001"></a><span>                     </span><a href="TcDeriv.html#mkThetaOrigin"><span class="hs-identifier hs-var">mkThetaOrigin</span></a><span> </span><a href="TcRnTypes.html#DerivOrigin"><span class="hs-identifier hs-var">DerivOrigin</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1002"></a><span>                     </span><a href="TyCoRep.html#substTheta"><span class="hs-identifier hs-var">substTheta</span></a><span> </span><a href="#local-1628276313"><span class="hs-identifier hs-var">cls_subst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classSCTheta</span><span> </span><a href="#local-1628276293"><span class="hs-identifier hs-var">main_cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1003"></a><span>    </span><a name="local-1628276313"><a href="#local-1628276313"><span class="hs-identifier">cls_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">equalLength</span><span> </span><span class="hs-identifier">cls_tvs</span><span> </span><span class="hs-identifier">inst_tys</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1004"></a><span>                </span><a href="TyCoRep.html#zipTvSubst"><span class="hs-identifier hs-var">zipTvSubst</span></a><span> </span><a href="#local-1628276310"><span class="hs-identifier hs-var">cls_tvs</span></a><span> </span><a href="#local-1628276311"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-1005"></a><span>
</span><a name="line-1006"></a><span>        </span><span class="hs-comment">-- Stupid constraints</span><span>
</span><a name="line-1007"></a><span>    </span><a name="local-1628276314"><a href="#local-1628276314"><span class="hs-identifier">stupid_constraints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#mkThetaOrigin"><span class="hs-identifier hs-var">mkThetaOrigin</span></a><span> </span><a href="TcRnTypes.html#DerivOrigin"><span class="hs-identifier hs-var">DerivOrigin</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1008"></a><span>                         </span><a href="TyCoRep.html#substTheta"><span class="hs-identifier hs-var">substTheta</span></a><span> </span><a href="#local-1628276315"><span class="hs-identifier hs-var">tc_subst</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConStupidTheta"><span class="hs-identifier hs-var">tyConStupidTheta</span></a><span> </span><a href="#local-1628276296"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1009"></a><span>    </span><a name="local-1628276315"><a href="#local-1628276315"><span class="hs-identifier">tc_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">equalLength</span><span> </span><span class="hs-identifier">rep_tc_tvs</span><span> </span><span class="hs-identifier">all_rep_tc_args</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1010"></a><span>               </span><a href="TyCoRep.html#zipTvSubst"><span class="hs-identifier hs-var">zipTvSubst</span></a><span> </span><a href="#local-1628276307"><span class="hs-identifier hs-var">rep_tc_tvs</span></a><span> </span><a href="#local-1628276309"><span class="hs-identifier hs-var">all_rep_tc_args</span></a><span>
</span><a name="line-1011"></a><span>
</span><a name="line-1012"></a><span>        </span><span class="hs-comment">-- Extra Data constraints</span><span>
</span><a name="line-1013"></a><span>        </span><span class="hs-comment">-- The Data class (only) requires that for</span><span>
</span><a name="line-1014"></a><span>        </span><span class="hs-comment">--    instance (...) =&gt; Data (T t1 t2)</span><span>
</span><a name="line-1015"></a><span>        </span><span class="hs-comment">-- IF   t1:*, t2:*</span><span>
</span><a name="line-1016"></a><span>        </span><span class="hs-comment">-- THEN (Data t1, Data t2) are among the (...) constraints</span><span>
</span><a name="line-1017"></a><span>        </span><span class="hs-comment">-- Reason: when the IF holds, we generate a method</span><span>
</span><a name="line-1018"></a><span>        </span><span class="hs-comment">--             dataCast2 f = gcast2 f</span><span>
</span><a name="line-1019"></a><span>        </span><span class="hs-comment">--         and we need the Data constraints to typecheck the method</span><span>
</span><a name="line-1020"></a><span>    </span><a name="local-1628276316"><a href="#local-1628276316"><span class="hs-identifier">extra_constraints</span></a></a><span>
</span><a name="line-1021"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276293"><span class="hs-identifier hs-var">main_cls</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#dataClassKey"><span class="hs-identifier hs-var">dataClassKey</span></a><span>
</span><a name="line-1022"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#isLiftedTypeKind"><span class="hs-identifier hs-var">isLiftedTypeKind</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276297"><span class="hs-identifier hs-var">rep_tc_args</span></a><span>
</span><a name="line-1023"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628276317"><span class="hs-identifier hs-var">mk_cls_pred</span></a><span> </span><a href="TcRnTypes.html#DerivOrigin"><span class="hs-identifier hs-var">DerivOrigin</span></a><span> </span><a href="#local-1628276339"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628276293"><span class="hs-identifier hs-var">main_cls</span></a><span> </span><a href="#local-1628276340"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1024"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1628276339"><a href="#local-1628276339"><span class="hs-identifier">t_or_k</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276340"><a href="#local-1628276340"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-1628276300"><span class="hs-identifier hs-var">t_or_ks</span></a><span> </span><a href="#local-1628276297"><span class="hs-identifier hs-var">rep_tc_args</span></a><span class="hs-special">]</span><span>
</span><a name="line-1025"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1026"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1027"></a><span>
</span><a name="line-1028"></a><span>    </span><a name="local-1628276317"><a href="#local-1628276317"><span class="hs-identifier">mk_cls_pred</span></a></a><span> </span><a name="local-1628276341"><a href="#local-1628276341"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-1628276342"><a href="#local-1628276342"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-1628276343"><a href="#local-1628276343"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-1628276344"><a href="#local-1628276344"><span class="hs-identifier">ty</span></a></a><span>   </span><span class="hs-comment">-- Don't forget to apply to cls_tys too</span><span>
</span><a name="line-1029"></a><span>                              </span><span class="hs-comment">-- In the awkward Generic1 casde, cls_tys is empty</span><span>
</span><a name="line-1030"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#mkPredOrigin"><span class="hs-identifier hs-var">mkPredOrigin</span></a><span> </span><a href="#local-1628276341"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-1628276342"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-1628276343"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276294"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628276344"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1031"></a><span>
</span><a name="line-1032"></a><span class="hs-comment">{- Note [Getting base classes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Functor and Typeable are defined in package 'base', and that is not available
when compiling 'ghc-prim'.  So we must be careful that 'deriving' for stuff in
ghc-prim does not use Functor or Typeable implicitly via these lookups.

Note [Deriving and unboxed types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We have some special hacks to support things like
   data T = MkT Int# deriving ( Show )

Specifically, we use TcGenDeriv.box to box the Int# into an Int
(which we know how to show), and append a '#'. Parenthesis are not required
for unboxed values (`MkT -3#` is a valid expression).

Note [Deriving any class]
~~~~~~~~~~~~~~~~~~~~~~~~~
Classic uses of a deriving clause, or a standalone-deriving declaration, are
for:
  * a built-in class like Eq or Show, for which GHC knows how to generate
    the instance code
  * a newtype, via the mechanism enabled by GeneralizedNewtypeDeriving

The DeriveAnyClass extension adds a third way to derive instances, based on
empty instance declarations.

The canonical use case is in combination with GHC.Generics and default method
signatures. These allow us to have instance declarations being empty, but still
useful, e.g.

  data T a = ...blah..blah... deriving( Generic )
  instance C a =&gt; C (T a)  -- No 'where' clause

where C is some &quot;random&quot; user-defined class.

This boilerplate code can be replaced by the more compact

  data T a = ...blah..blah... deriving( Generic, C )

if DeriveAnyClass is enabled.

This is not restricted to Generics; any class can be derived, simply giving
rise to an empty instance.

Unfortunately, it is not clear how to determine the context (in case of
standard deriving; in standalone deriving, the user provides the context).
GHC uses the same heuristic for figuring out the class context that it uses for
Eq in the case of *-kinded classes, and for Functor in the case of
* -&gt; *-kinded classes. That may not be optimal or even wrong. But in such
cases, standalone deriving can still be used.
-}</span><span>
</span><a name="line-1083"></a><span>
</span><a name="line-1084"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-1085"></a><span class="hs-comment">-- Check side conditions that dis-allow derivability for particular classes</span><span>
</span><a name="line-1086"></a><span class="hs-comment">-- This is *apart* from the newtype-deriving mechanism</span><span>
</span><a name="line-1087"></a><span class="hs-comment">--</span><span>
</span><a name="line-1088"></a><span class="hs-comment">-- Here we get the representation tycon in case of family instances as it has</span><span>
</span><a name="line-1089"></a><span class="hs-comment">-- the data constructors - but we need to be careful to fall back to the</span><span>
</span><a name="line-1090"></a><span class="hs-comment">-- family tycon (with indexes) in error messages.</span><span>
</span><a name="line-1091"></a><span>
</span><a name="line-1092"></a><span class="hs-keyword">data</span><span> </span><a name="DerivStatus"><a href="TcDeriv.html#DerivStatus"><span class="hs-identifier">DerivStatus</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CanDerive"><a href="TcDeriv.html#CanDerive"><span class="hs-identifier">CanDerive</span></a></a><span>                 </span><span class="hs-comment">-- Standard class, can derive</span><span>
</span><a name="line-1093"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="DerivableClassError"><a href="TcDeriv.html#DerivableClassError"><span class="hs-identifier">DerivableClassError</span></a></a><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>  </span><span class="hs-comment">-- Standard class, but can't do it</span><span>
</span><a name="line-1094"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="DerivableViaInstance"><a href="TcDeriv.html#DerivableViaInstance"><span class="hs-identifier">DerivableViaInstance</span></a></a><span>      </span><span class="hs-comment">-- See Note [Deriving any class]</span><span>
</span><a name="line-1095"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="NonDerivableClass"><a href="TcDeriv.html#NonDerivableClass"><span class="hs-identifier">NonDerivableClass</span></a></a><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>    </span><span class="hs-comment">-- Non-standard class</span><span>
</span><a name="line-1096"></a><span>
</span><a name="line-1097"></a><span class="hs-comment">-- A &quot;standard&quot; class is one defined in the Haskell report which GHC knows how</span><span>
</span><a name="line-1098"></a><span class="hs-comment">-- to generate code for, such as Eq, Ord, Ix, etc.</span><span>
</span><a name="line-1099"></a><span>
</span><a name="line-1100"></a><span class="hs-identifier">checkSideConditions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span>
</span><a name="line-1101"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- tycon and its parameters</span><span>
</span><a name="line-1102"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#DerivStatus"><span class="hs-identifier hs-type">DerivStatus</span></a><span>
</span><a name="line-1103"></a><a name="checkSideConditions"><a href="TcDeriv.html#checkSideConditions"><span class="hs-identifier">checkSideConditions</span></a></a><span> </span><a name="local-1628276346"><a href="#local-1628276346"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1628276347"><a href="#local-1628276347"><span class="hs-identifier">mtheta</span></a></a><span> </span><a name="local-1628276348"><a href="#local-1628276348"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-1628276349"><a href="#local-1628276349"><span class="hs-identifier">cls_tys</span></a></a><span> </span><a name="local-1628276350"><a href="#local-1628276350"><span class="hs-identifier">rep_tc</span></a></a><span> </span><a name="local-1628276351"><a href="#local-1628276351"><span class="hs-identifier">rep_tc_args</span></a></a><span>
</span><a name="line-1104"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628276352"><a href="#local-1628276352"><span class="hs-identifier">cond</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#sideConditions"><span class="hs-identifier hs-var">sideConditions</span></a><span> </span><a href="#local-1628276347"><span class="hs-identifier hs-var">mtheta</span></a><span> </span><a href="#local-1628276348"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1105"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-1628276352"><span class="hs-identifier hs-var">cond</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276346"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628276350"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628276351"><span class="hs-identifier hs-var">rep_tc_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1106"></a><span>        </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><a name="local-1628276353"><a href="#local-1628276353"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#DerivableClassError"><span class="hs-identifier hs-var">DerivableClassError</span></a><span> </span><a href="#local-1628276353"><span class="hs-identifier hs-var">err</span></a><span>  </span><span class="hs-comment">-- Class-specific error</span><span>
</span><a name="line-1107"></a><span>        </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628276349"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#CanDerive"><span class="hs-identifier hs-var">CanDerive</span></a><span>     </span><span class="hs-comment">-- All derivable classes are unary, so</span><span>
</span><a name="line-1108"></a><span>                                                 </span><span class="hs-comment">-- cls_tys (the type args other than last)</span><span>
</span><a name="line-1109"></a><span>                                                 </span><span class="hs-comment">-- should be null</span><span>
</span><a name="line-1110"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#DerivableClassError"><span class="hs-identifier hs-var">DerivableClassError</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#classArgsErr"><span class="hs-identifier hs-var">classArgsErr</span></a><span> </span><a href="#local-1628276348"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276349"><span class="hs-identifier hs-var">cls_tys</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- e.g. deriving( Eq s )</span><span>
</span><a name="line-1111"></a><span>
</span><a name="line-1112"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628276354"><a href="#local-1628276354"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#canDeriveAnyClass"><span class="hs-identifier hs-var">canDeriveAnyClass</span></a><span> </span><a href="#local-1628276346"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628276350"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><a href="#local-1628276348"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1113"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#NonDerivableClass"><span class="hs-identifier hs-var">NonDerivableClass</span></a><span> </span><a href="#local-1628276354"><span class="hs-identifier hs-var">err</span></a><span>  </span><span class="hs-comment">-- DeriveAnyClass does not work</span><span>
</span><a name="line-1114"></a><span>
</span><a name="line-1115"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1116"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#DerivableViaInstance"><span class="hs-identifier hs-var">DerivableViaInstance</span></a><span>   </span><span class="hs-comment">-- DeriveAnyClass should work</span><span>
</span><a name="line-1117"></a><span>
</span><a name="line-1118"></a><span>
</span><a name="line-1119"></a><span class="hs-identifier">classArgsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1120"></a><a name="classArgsErr"><a href="TcDeriv.html#classArgsErr"><span class="hs-identifier">classArgsErr</span></a></a><span> </span><a name="local-1628276355"><a href="#local-1628276355"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-1628276356"><a href="#local-1628276356"><span class="hs-identifier">cls_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-1628276355"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276356"><span class="hs-identifier hs-var">cls_tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;is not a class&quot;</span><span>
</span><a name="line-1121"></a><span>
</span><a name="line-1122"></a><span class="hs-identifier">nonStdErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1123"></a><a name="nonStdErr"><a href="TcDeriv.html#nonStdErr"><span class="hs-identifier">nonStdErr</span></a></a><span> </span><a name="local-1628276357"><a href="#local-1628276357"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1124"></a><span>      </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276357"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1125"></a><span>  </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;is not a standard derivable class (Eq, Show, etc.)&quot;</span><span>
</span><a name="line-1126"></a><span>
</span><a name="line-1127"></a><span class="hs-identifier">sideConditions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1128"></a><span class="hs-comment">-- Side conditions for classes that GHC knows about,</span><span>
</span><a name="line-1129"></a><span class="hs-comment">-- that is, &quot;deriviable classes&quot;</span><span>
</span><a name="line-1130"></a><span class="hs-comment">-- Returns Nothing for a non-derivable class</span><span>
</span><a name="line-1131"></a><a name="sideConditions"><a href="TcDeriv.html#sideConditions"><span class="hs-identifier">sideConditions</span></a></a><span> </span><a name="local-1628276358"><a href="#local-1628276358"><span class="hs-identifier">mtheta</span></a></a><span> </span><a name="local-1628276359"><a href="#local-1628276359"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-1132"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#eqClassKey"><span class="hs-identifier hs-var">eqClassKey</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276361"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDeriv.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-1628276359"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1133"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#ordClassKey"><span class="hs-identifier hs-var">ordClassKey</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276361"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDeriv.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-1628276359"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1134"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#showClassKey"><span class="hs-identifier hs-var">showClassKey</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276361"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDeriv.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-1628276359"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1135"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#readClassKey"><span class="hs-identifier hs-var">readClassKey</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276361"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDeriv.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-1628276359"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1136"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#enumClassKey"><span class="hs-identifier hs-var">enumClassKey</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276361"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDeriv.html#cond_isEnumeration"><span class="hs-identifier hs-var">cond_isEnumeration</span></a><span class="hs-special">)</span><span>
</span><a name="line-1137"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#ixClassKey"><span class="hs-identifier hs-var">ixClassKey</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276361"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDeriv.html#cond_enumOrProduct"><span class="hs-identifier hs-var">cond_enumOrProduct</span></a><span> </span><a href="#local-1628276359"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1138"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#boundedClassKey"><span class="hs-identifier hs-var">boundedClassKey</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276361"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDeriv.html#cond_enumOrProduct"><span class="hs-identifier hs-var">cond_enumOrProduct</span></a><span> </span><a href="#local-1628276359"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1139"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#dataClassKey"><span class="hs-identifier hs-var">dataClassKey</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#DeriveDataTypeable"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">DeriveDataTypeable</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1140"></a><span>                                           </span><a href="#local-1628276361"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1141"></a><span>                                           </span><a href="TcDeriv.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-1628276359"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1142"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#functorClassKey"><span class="hs-identifier hs-var">functorClassKey</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#DeriveFunctor"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">DeriveFunctor</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1143"></a><span>                                           </span><a href="#local-1628276362"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1144"></a><span>                                           </span><a href="TcDeriv.html#cond_functorOK"><span class="hs-identifier hs-var">cond_functorOK</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-1145"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#foldableClassKey"><span class="hs-identifier hs-var">foldableClassKey</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#DeriveFoldable"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">DeriveFoldable</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1146"></a><span>                                           </span><a href="#local-1628276362"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1147"></a><span>                                           </span><a href="TcDeriv.html#cond_functorOK"><span class="hs-identifier hs-var">cond_functorOK</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-1148"></a><span>                                           </span><span class="hs-comment">-- Functor/Fold/Trav works ok</span><span>
</span><a name="line-1149"></a><span>                                           </span><span class="hs-comment">-- for rank-n types</span><span>
</span><a name="line-1150"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#traversableClassKey"><span class="hs-identifier hs-var">traversableClassKey</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#DeriveTraversable"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">DeriveTraversable</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1151"></a><span>                                           </span><a href="#local-1628276362"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1152"></a><span>                                           </span><a href="TcDeriv.html#cond_functorOK"><span class="hs-identifier hs-var">cond_functorOK</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-1153"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#genClassKey"><span class="hs-identifier hs-var">genClassKey</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#DeriveGeneric"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">DeriveGeneric</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1154"></a><span>                                           </span><a href="#local-1628276362"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1155"></a><span>                                           </span><a href="TcDeriv.html#cond_RepresentableOk"><span class="hs-identifier hs-var">cond_RepresentableOk</span></a><span class="hs-special">)</span><span>
</span><a name="line-1156"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#gen1ClassKey"><span class="hs-identifier hs-var">gen1ClassKey</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#DeriveGeneric"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">DeriveGeneric</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1157"></a><span>                                           </span><a href="#local-1628276362"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1158"></a><span>                                           </span><a href="TcDeriv.html#cond_Representable1Ok"><span class="hs-identifier hs-var">cond_Representable1Ok</span></a><span class="hs-special">)</span><span>
</span><a name="line-1159"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276360"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="THNames.html#liftClassKey"><span class="hs-identifier hs-var">liftClassKey</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#DeriveLift"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">DeriveLift</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1160"></a><span>                                           </span><a href="#local-1628276362"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1161"></a><span>                                           </span><a href="TcDeriv.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-1628276359"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1162"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1163"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1164"></a><span>    </span><a name="local-1628276360"><a href="#local-1628276360"><span class="hs-identifier">cls_key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Unique.html#getUnique"><span class="hs-identifier hs-var">getUnique</span></a><span> </span><a href="#local-1628276359"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1165"></a><span>    </span><a name="local-1628276361"><a href="#local-1628276361"><span class="hs-identifier">cond_std</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#cond_stdOK"><span class="hs-identifier hs-var">cond_stdOK</span></a><span> </span><a href="#local-1628276358"><span class="hs-identifier hs-var">mtheta</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- Vanilla data constructors, at least one,</span><span>
</span><a name="line-1166"></a><span>                                            </span><span class="hs-comment">--    and monotype arguments</span><span>
</span><a name="line-1167"></a><span>    </span><a name="local-1628276362"><a href="#local-1628276362"><span class="hs-identifier">cond_vanilla</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#cond_stdOK"><span class="hs-identifier hs-var">cond_stdOK</span></a><span> </span><a href="#local-1628276358"><span class="hs-identifier hs-var">mtheta</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- Vanilla data constructors but</span><span>
</span><a name="line-1168"></a><span>                                            </span><span class="hs-comment">--   allow no data cons or polytype arguments</span><span>
</span><a name="line-1169"></a><span>
</span><a name="line-1170"></a><span class="hs-identifier">canDeriveAnyClass</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1171"></a><span class="hs-comment">-- Nothing: we can (try to) derive it via an empty instance declaration</span><span>
</span><a name="line-1172"></a><span class="hs-comment">-- Just s:  we can't, reason s</span><span>
</span><a name="line-1173"></a><span class="hs-comment">-- Precondition: the class is not one of the standard ones</span><span>
</span><a name="line-1174"></a><a name="canDeriveAnyClass"><a href="TcDeriv.html#canDeriveAnyClass"><span class="hs-identifier">canDeriveAnyClass</span></a></a><span> </span><a name="local-1628276363"><a href="#local-1628276363"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1628276364"><a href="#local-1628276364"><span class="hs-identifier">_tycon</span></a></a><span> </span><a name="local-1628276365"><a href="#local-1628276365"><span class="hs-identifier">clas</span></a></a><span>
</span><a name="line-1175"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#DeriveAnyClass"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">DeriveAnyClass</span></a><span> </span><a href="#local-1628276363"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1176"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Try enabling DeriveAnyClass&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1177"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276366"><span class="hs-identifier hs-var">target_kind</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#tcEqKind"><span class="hs-identifier hs-var">tcEqKind</span></a><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span class="hs-special">,</span><span> </span><a href="TcDeriv.html#typeToTypeKind"><span class="hs-identifier hs-var">typeToTypeKind</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1178"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;The last argument of class&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276365"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span>
</span><a name="line-1179"></a><span>          </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;does not have kind * or (* -&gt; *)&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1180"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1181"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>   </span><span class="hs-comment">-- OK!</span><span>
</span><a name="line-1182"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1183"></a><span>    </span><span class="hs-comment">-- We are making an instance  (C t1 .. tn (T s1 .. sm))</span><span>
</span><a name="line-1184"></a><span>    </span><span class="hs-comment">-- and we can only do so if the kind of C's last argument</span><span>
</span><a name="line-1185"></a><span>    </span><span class="hs-comment">-- is * or (* -&gt; *).  Because only then can we make a reasonable</span><span>
</span><a name="line-1186"></a><span>    </span><span class="hs-comment">-- guess at the instance context</span><span>
</span><a name="line-1187"></a><span>    </span><a name="local-1628276366"><a href="#local-1628276366"><span class="hs-identifier">target_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#last"><span class="hs-identifier hs-var">last</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyVars</span><span> </span><a href="#local-1628276365"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1188"></a><span>
</span><a name="line-1189"></a><span class="hs-identifier">typeToTypeKind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span>
</span><a name="line-1190"></a><a name="typeToTypeKind"><a href="TcDeriv.html#typeToTypeKind"><span class="hs-identifier">typeToTypeKind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span> </span><span class="hs-special">`</span><a href="TyCoRep.html#mkFunTy"><span class="hs-identifier hs-var">mkFunTy</span></a><span class="hs-special">`</span><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span>
</span><a name="line-1191"></a><span>
</span><a name="line-1192"></a><span class="hs-keyword">type</span><span> </span><a name="Condition"><a href="TcDeriv.html#Condition"><span class="hs-identifier">Condition</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span class="hs-special">,</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#Validity"><span class="hs-identifier hs-type">Validity</span></a><span>
</span><a name="line-1193"></a><span>        </span><span class="hs-comment">-- first Bool is whether or not we are allowed to derive Data and Typeable</span><span>
</span><a name="line-1194"></a><span>        </span><span class="hs-comment">-- second Bool is whether or not we are allowed to derive Functor</span><span>
</span><a name="line-1195"></a><span>        </span><span class="hs-comment">-- TyCon is the *representation* tycon if the data type is an indexed one</span><span>
</span><a name="line-1196"></a><span>        </span><span class="hs-comment">-- [Type] are the type arguments to the (representation) TyCon</span><span>
</span><a name="line-1197"></a><span>        </span><span class="hs-comment">-- Nothing =&gt; OK</span><span>
</span><a name="line-1198"></a><span>
</span><a name="line-1199"></a><span class="hs-identifier">orCond</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1200"></a><a name="orCond"><a href="TcDeriv.html#orCond"><span class="hs-identifier">orCond</span></a></a><span> </span><a name="local-1628276367"><a href="#local-1628276367"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-1628276368"><a href="#local-1628276368"><span class="hs-identifier">c2</span></a></a><span> </span><a name="local-1628276369"><a href="#local-1628276369"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-1201"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-1628276367"><span class="hs-identifier hs-var">c1</span></a><span> </span><a href="#local-1628276369"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628276368"><span class="hs-identifier hs-var">c2</span></a><span> </span><a href="#local-1628276369"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1202"></a><span>     </span><span class="hs-special">(</span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span class="hs-special">,</span><span>    </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>    </span><span class="hs-comment">-- c1 succeeds</span><span>
</span><a name="line-1203"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>          </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>    </span><span class="hs-comment">-- c21 succeeds</span><span>
</span><a name="line-1204"></a><span>     </span><span class="hs-special">(</span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><a name="local-1628276370"><a href="#local-1628276370"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><a name="local-1628276371"><a href="#local-1628276371"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276370"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;  or&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="#local-1628276371"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span>
</span><a name="line-1205"></a><span>                                            </span><span class="hs-comment">-- Both fail</span><span>
</span><a name="line-1206"></a><span>
</span><a name="line-1207"></a><span class="hs-identifier">andCond</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1208"></a><a name="andCond"><a href="TcDeriv.html#andCond"><span class="hs-identifier">andCond</span></a></a><span> </span><a name="local-1628276372"><a href="#local-1628276372"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-1628276373"><a href="#local-1628276373"><span class="hs-identifier">c2</span></a></a><span> </span><a name="local-1628276374"><a href="#local-1628276374"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276372"><span class="hs-identifier hs-var">c1</span></a><span> </span><a href="#local-1628276374"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><a href="ErrUtils.html#andValid"><span class="hs-identifier hs-var">andValid</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628276373"><span class="hs-identifier hs-var">c2</span></a><span> </span><a href="#local-1628276374"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1209"></a><span>
</span><a name="line-1210"></a><span class="hs-identifier">cond_stdOK</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span> </span><span class="hs-comment">-- Says whether this is standalone deriving or not;</span><span>
</span><a name="line-1211"></a><span>                           </span><span class="hs-comment">--     if standalone, we just say &quot;yes, go for it&quot;</span><span>
</span><a name="line-1212"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>         </span><span class="hs-comment">-- True &lt;=&gt; permissive: allow higher rank</span><span>
</span><a name="line-1213"></a><span>                           </span><span class="hs-comment">--          args and no data constructors</span><span>
</span><a name="line-1214"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1215"></a><a name="cond_stdOK"><a href="TcDeriv.html#cond_stdOK"><span class="hs-identifier">cond_stdOK</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1216"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>     </span><span class="hs-comment">-- Don't check these conservative conditions for</span><span>
</span><a name="line-1217"></a><span>                </span><span class="hs-comment">-- standalone deriving; just generate the code</span><span>
</span><a name="line-1218"></a><span>                </span><span class="hs-comment">-- and let the typechecker handle the result</span><span>
</span><a name="line-1219"></a><span class="hs-identifier">cond_stdOK</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a name="local-1628276375"><a href="#local-1628276375"><span class="hs-identifier">permissive</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628276376"><a href="#local-1628276376"><span class="hs-identifier">rep_tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1220"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628276378"><span class="hs-identifier hs-var">data_cons</span></a><span>
</span><a name="line-1221"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1628276375"><span class="hs-identifier hs-var">permissive</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#no_cons_why"><span class="hs-identifier hs-var">no_cons_why</span></a><span> </span><a href="#local-1628276376"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="#local-1628276377"><span class="hs-identifier hs-var">suggestion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1222"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628276379"><span class="hs-identifier hs-var">con_whys</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><a href="#local-1628276379"><span class="hs-identifier hs-var">con_whys</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="#local-1628276377"><span class="hs-identifier hs-var">suggestion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1223"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>
</span><a name="line-1224"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1225"></a><span>    </span><a name="local-1628276377"><a href="#local-1628276377"><span class="hs-identifier">suggestion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Possible fix: use a standalone deriving declaration instead&quot;</span><span>
</span><a name="line-1226"></a><span>    </span><a name="local-1628276378"><a href="#local-1628276378"><span class="hs-identifier">data_cons</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-1628276376"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-1227"></a><span>    </span><a name="local-1628276379"><a href="#local-1628276379"><span class="hs-identifier">con_whys</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#getInvalids"><span class="hs-identifier hs-var">getInvalids</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1628276380"><span class="hs-identifier hs-var">check_con</span></a><span> </span><a href="#local-1628276378"><span class="hs-identifier hs-var">data_cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-1228"></a><span>
</span><a name="line-1229"></a><span>    </span><span class="hs-identifier">check_con</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#Validity"><span class="hs-identifier hs-type">Validity</span></a><span>
</span><a name="line-1230"></a><span>    </span><a name="local-1628276380"><a href="#local-1628276380"><span class="hs-identifier">check_con</span></a></a><span> </span><a name="local-1628276381"><a href="#local-1628276381"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-1231"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#isVanillaDataCon"><span class="hs-identifier hs-var">isVanillaDataCon</span></a><span> </span><a href="#local-1628276381"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-1232"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#badCon"><span class="hs-identifier hs-var">badCon</span></a><span> </span><a href="#local-1628276381"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;has existentials or constraints in its type&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1233"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-1628276375"><span class="hs-identifier hs-var">permissive</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="TcType.html#isTauTy"><span class="hs-identifier hs-var">isTauTy</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConOrigArgTys"><span class="hs-identifier hs-var">dataConOrigArgTys</span></a><span> </span><a href="#local-1628276381"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1234"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#badCon"><span class="hs-identifier hs-var">badCon</span></a><span> </span><a href="#local-1628276381"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;has a higher-rank type&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1235"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1236"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>
</span><a name="line-1237"></a><span>
</span><a name="line-1238"></a><span class="hs-identifier">no_cons_why</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1239"></a><a name="no_cons_why"><a href="TcDeriv.html#no_cons_why"><span class="hs-identifier">no_cons_why</span></a></a><span> </span><a name="local-1628276382"><a href="#local-1628276382"><span class="hs-identifier">rep_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#pprSourceTyCon"><span class="hs-identifier hs-var">pprSourceTyCon</span></a><span> </span><a href="#local-1628276382"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-1240"></a><span>                     </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;must have at least one data constructor&quot;</span><span>
</span><a name="line-1241"></a><span>
</span><a name="line-1242"></a><span class="hs-identifier">cond_RepresentableOk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1243"></a><a name="cond_RepresentableOk"><a href="TcDeriv.html#cond_RepresentableOk"><span class="hs-identifier">cond_RepresentableOk</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628276383"><a href="#local-1628276383"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276384"><a href="#local-1628276384"><span class="hs-identifier">tc_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#canDoGenerics"><span class="hs-identifier hs-var">canDoGenerics</span></a><span> </span><a href="#local-1628276383"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628276384"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-1244"></a><span>
</span><a name="line-1245"></a><span class="hs-identifier">cond_Representable1Ok</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1246"></a><a name="cond_Representable1Ok"><a href="TcDeriv.html#cond_Representable1Ok"><span class="hs-identifier">cond_Representable1Ok</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628276385"><a href="#local-1628276385"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276386"><a href="#local-1628276386"><span class="hs-identifier">tc_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#canDoGenerics1"><span class="hs-identifier hs-var">canDoGenerics1</span></a><span> </span><a href="#local-1628276385"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628276386"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-1247"></a><span>
</span><a name="line-1248"></a><span class="hs-identifier">cond_enumOrProduct</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1249"></a><a name="cond_enumOrProduct"><a href="TcDeriv.html#cond_enumOrProduct"><span class="hs-identifier">cond_enumOrProduct</span></a></a><span> </span><a name="local-1628276387"><a href="#local-1628276387"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#cond_isEnumeration"><span class="hs-identifier hs-var">cond_isEnumeration</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#orCond"><span class="hs-identifier hs-var">orCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-1250"></a><span>                         </span><span class="hs-special">(</span><a href="TcDeriv.html#cond_isProduct"><span class="hs-identifier hs-var">cond_isProduct</span></a><span> </span><span class="hs-special">`</span><a href="TcDeriv.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDeriv.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-1628276387"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1251"></a><span>
</span><a name="line-1252"></a><span class="hs-identifier">cond_args</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1253"></a><span class="hs-comment">-- For some classes (eg Eq, Ord) we allow unlifted arg types</span><span>
</span><a name="line-1254"></a><span class="hs-comment">-- by generating specialised code.  For others (eg Data) we don't.</span><span>
</span><a name="line-1255"></a><a name="cond_args"><a href="TcDeriv.html#cond_args"><span class="hs-identifier">cond_args</span></a></a><span> </span><a name="local-1628276388"><a href="#local-1628276388"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628276389"><a href="#local-1628276389"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1256"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628276390"><span class="hs-identifier hs-var">bad_args</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1257"></a><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>
</span><a name="line-1258"></a><span>      </span><span class="hs-special">(</span><a name="local-1628276400"><a href="#local-1628276400"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Don't know how to derive&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276388"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1259"></a><span>                             </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;for type&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276400"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1260"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1261"></a><span>    </span><a name="local-1628276390"><a href="#local-1628276390"><span class="hs-identifier">bad_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628276396"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-1628276395"><a href="#local-1628276395"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-1628276389"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1262"></a><span>                        </span><span class="hs-special">,</span><span> </span><a name="local-1628276396"><a href="#local-1628276396"><span class="hs-identifier">arg_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DataCon.html#dataConOrigArgTys"><span class="hs-identifier hs-var">dataConOrigArgTys</span></a><span> </span><a href="#local-1628276395"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-1263"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a><span> </span><a href="#local-1628276396"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-1264"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-1628276392"><span class="hs-identifier hs-var">ok_ty</span></a><span> </span><a href="#local-1628276396"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1265"></a><span>
</span><a name="line-1266"></a><span>    </span><a name="local-1628276391"><a href="#local-1628276391"><span class="hs-identifier">cls_key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classKey</span><span> </span><a href="#local-1628276388"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1267"></a><span>    </span><a name="local-1628276392"><a href="#local-1628276392"><span class="hs-identifier">ok_ty</span></a></a><span> </span><a name="local-1628276397"><a href="#local-1628276397"><span class="hs-identifier">arg_ty</span></a></a><span>
</span><a name="line-1268"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276391"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#eqClassKey"><span class="hs-identifier hs-var">eqClassKey</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276393"><span class="hs-identifier hs-var">check_in</span></a><span> </span><a href="#local-1628276397"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="TcGenDeriv.html#ordOpTbl"><span class="hs-identifier hs-var">ordOpTbl</span></a><span>
</span><a name="line-1269"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276391"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#ordClassKey"><span class="hs-identifier hs-var">ordClassKey</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276393"><span class="hs-identifier hs-var">check_in</span></a><span> </span><a href="#local-1628276397"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="TcGenDeriv.html#ordOpTbl"><span class="hs-identifier hs-var">ordOpTbl</span></a><span>
</span><a name="line-1270"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276391"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#showClassKey"><span class="hs-identifier hs-var">showClassKey</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276393"><span class="hs-identifier hs-var">check_in</span></a><span> </span><a href="#local-1628276397"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="TcGenDeriv.html#boxConTbl"><span class="hs-identifier hs-var">boxConTbl</span></a><span>
</span><a name="line-1271"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276391"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="THNames.html#liftClassKey"><span class="hs-identifier hs-var">liftClassKey</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276393"><span class="hs-identifier hs-var">check_in</span></a><span> </span><a href="#local-1628276397"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="TcGenDeriv.html#litConTbl"><span class="hs-identifier hs-var">litConTbl</span></a><span>
</span><a name="line-1272"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>    </span><span class="hs-comment">-- Read, Ix etc</span><span>
</span><a name="line-1273"></a><span>
</span><a name="line-1274"></a><span>    </span><span class="hs-identifier">check_in</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><a href="#local-1628276394"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1275"></a><span>    </span><a name="local-1628276393"><a href="#local-1628276393"><span class="hs-identifier">check_in</span></a></a><span> </span><a name="local-1628276398"><a href="#local-1628276398"><span class="hs-identifier">arg_ty</span></a></a><span> </span><a name="local-1628276399"><a href="#local-1628276399"><span class="hs-identifier">tbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span> </span><a href="#local-1628276398"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276399"><span class="hs-identifier hs-var">tbl</span></a><span>
</span><a name="line-1276"></a><span>
</span><a name="line-1277"></a><span>
</span><a name="line-1278"></a><span class="hs-identifier">cond_isEnumeration</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1279"></a><a name="cond_isEnumeration"><a href="TcDeriv.html#cond_isEnumeration"><span class="hs-identifier">cond_isEnumeration</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628276401"><a href="#local-1628276401"><span class="hs-identifier">rep_tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1280"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isEnumerationTyCon"><span class="hs-identifier hs-var">isEnumerationTyCon</span></a><span> </span><a href="#local-1628276401"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>
</span><a name="line-1281"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><a href="#local-1628276402"><span class="hs-identifier hs-var">why</span></a><span>
</span><a name="line-1282"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1283"></a><span>    </span><a name="local-1628276402"><a href="#local-1628276402"><span class="hs-identifier">why</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#pprSourceTyCon"><span class="hs-identifier hs-var">pprSourceTyCon</span></a><span> </span><a href="#local-1628276401"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-1284"></a><span>                  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;must be an enumeration type&quot;</span><span>
</span><a name="line-1285"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;(an enumeration consists of one or more nullary, non-GADT constructors)&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1286"></a><span>                  </span><span class="hs-comment">-- See Note [Enumeration types] in TyCon</span><span>
</span><a name="line-1287"></a><span>
</span><a name="line-1288"></a><span class="hs-identifier">cond_isProduct</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1289"></a><a name="cond_isProduct"><a href="TcDeriv.html#cond_isProduct"><span class="hs-identifier">cond_isProduct</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628276403"><a href="#local-1628276403"><span class="hs-identifier">rep_tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1290"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isProductTyCon"><span class="hs-identifier hs-var">isProductTyCon</span></a><span> </span><a href="#local-1628276403"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>
</span><a name="line-1291"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><a href="#local-1628276404"><span class="hs-identifier hs-var">why</span></a><span>
</span><a name="line-1292"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1293"></a><span>    </span><a name="local-1628276404"><a href="#local-1628276404"><span class="hs-identifier">why</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#pprSourceTyCon"><span class="hs-identifier hs-var">pprSourceTyCon</span></a><span> </span><a href="#local-1628276403"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-1294"></a><span>          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;must have precisely one constructor&quot;</span><span>
</span><a name="line-1295"></a><span>
</span><a name="line-1296"></a><span class="hs-identifier">cond_functorOK</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1297"></a><span class="hs-comment">-- OK for Functor/Foldable/Traversable class</span><span>
</span><a name="line-1298"></a><span class="hs-comment">-- Currently: (a) at least one argument</span><span>
</span><a name="line-1299"></a><span class="hs-comment">--            (b) don't use argument contravariantly</span><span>
</span><a name="line-1300"></a><span class="hs-comment">--            (c) don't use argument in the wrong place, e.g. data T a = T (X a a)</span><span>
</span><a name="line-1301"></a><span class="hs-comment">--            (d) optionally: don't use function types</span><span>
</span><a name="line-1302"></a><span class="hs-comment">--            (e) no &quot;stupid context&quot; on data type</span><span>
</span><a name="line-1303"></a><a name="cond_functorOK"><a href="TcDeriv.html#cond_functorOK"><span class="hs-identifier">cond_functorOK</span></a></a><span> </span><a name="local-1628276405"><a href="#local-1628276405"><span class="hs-identifier">allowFunctions</span></a></a><span> </span><a name="local-1628276406"><a href="#local-1628276406"><span class="hs-identifier">allowExQuantifiedLastTyVar</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628276407"><a href="#local-1628276407"><span class="hs-identifier">rep_tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1304"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628276408"><span class="hs-identifier hs-var">tc_tvs</span></a><span>
</span><a name="line-1305"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Data type&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276407"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1306"></a><span>              </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;must have some type parameters&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1307"></a><span>
</span><a name="line-1308"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628276410"><span class="hs-identifier hs-var">bad_stupid_theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-1309"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Data type&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276407"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1310"></a><span>              </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;must not have a class context:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TyCoRep.html#pprTheta"><span class="hs-identifier hs-var">pprTheta</span></a><span> </span><a href="#local-1628276410"><span class="hs-identifier hs-var">bad_stupid_theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-1311"></a><span>
</span><a name="line-1312"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1313"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#allValid"><span class="hs-identifier hs-var">allValid</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1628276413"><span class="hs-identifier hs-var">check_con</span></a><span> </span><a href="#local-1628276412"><span class="hs-identifier hs-var">data_cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-1314"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1315"></a><span>    </span><a name="local-1628276408"><a href="#local-1628276408"><span class="hs-identifier">tc_tvs</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-1628276407"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-1316"></a><span>    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-1628276409"><a href="#local-1628276409"><span class="hs-identifier">last_tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#snocView"><span class="hs-identifier hs-var">snocView</span></a><span> </span><a href="#local-1628276408"><span class="hs-identifier hs-var">tc_tvs</span></a><span>
</span><a name="line-1317"></a><span>    </span><a name="local-1628276410"><a href="#local-1628276410"><span class="hs-identifier">bad_stupid_theta</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><a href="#local-1628276411"><span class="hs-identifier hs-var">is_bad</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConStupidTheta"><span class="hs-identifier hs-var">tyConStupidTheta</span></a><span> </span><a href="#local-1628276407"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1318"></a><span>    </span><a name="local-1628276411"><a href="#local-1628276411"><span class="hs-identifier">is_bad</span></a></a><span> </span><a name="local-1628276420"><a href="#local-1628276420"><span class="hs-identifier">pred</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276409"><span class="hs-identifier hs-var">last_tv</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-1628276420"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-1319"></a><span>
</span><a name="line-1320"></a><span>    </span><a name="local-1628276412"><a href="#local-1628276412"><span class="hs-identifier">data_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-1628276407"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-1321"></a><span>    </span><a name="local-1628276413"><a href="#local-1628276413"><span class="hs-identifier">check_con</span></a></a><span> </span><a name="local-1628276421"><a href="#local-1628276421"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#allValid"><span class="hs-identifier hs-var">allValid</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276414"><span class="hs-identifier hs-var">check_universal</span></a><span> </span><a href="#local-1628276421"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="TcGenDeriv.html#foldDataConArgs"><span class="hs-identifier hs-var">foldDataConArgs</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276415"><span class="hs-identifier hs-var">ft_check</span></a><span> </span><a href="#local-1628276421"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276421"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-1322"></a><span>
</span><a name="line-1323"></a><span>    </span><span class="hs-identifier">check_universal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#Validity"><span class="hs-identifier hs-type">Validity</span></a><span>
</span><a name="line-1324"></a><span>    </span><a name="local-1628276414"><a href="#local-1628276414"><span class="hs-identifier">check_universal</span></a></a><span> </span><a name="local-1628276422"><a href="#local-1628276422"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-1325"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276406"><span class="hs-identifier hs-var">allowExQuantifiedLastTyVar</span></a><span>
</span><a name="line-1326"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span> </span><span class="hs-comment">-- See Note [DeriveFoldable with ExistentialQuantification]</span><span>
</span><a name="line-1327"></a><span>                </span><span class="hs-comment">-- in TcGenDeriv</span><span>
</span><a name="line-1328"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628276423"><a href="#local-1628276423"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#last"><span class="hs-identifier hs-var">last</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#tyConAppArgs"><span class="hs-identifier hs-var">tyConAppArgs</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConOrigResTy"><span class="hs-identifier hs-var">dataConOrigResTy</span></a><span> </span><a href="#local-1628276422"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1329"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-1628276423"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><a href="DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a><span> </span><a href="#local-1628276422"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-1330"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-1628276423"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConTheta"><span class="hs-identifier hs-var">dataConTheta</span></a><span> </span><a href="#local-1628276422"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1331"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>   </span><span class="hs-comment">-- See Note [Check that the type variable is truly universal]</span><span>
</span><a name="line-1332"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1333"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#badCon"><span class="hs-identifier hs-var">badCon</span></a><span> </span><a href="#local-1628276422"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1628276416"><span class="hs-identifier hs-var">existential</span></a><span class="hs-special">)</span><span>
</span><a name="line-1334"></a><span>
</span><a name="line-1335"></a><span>    </span><span class="hs-identifier">ft_check</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcGenDeriv.html#FFoldType"><span class="hs-identifier hs-type">FFoldType</span></a><span> </span><a href="ErrUtils.html#Validity"><span class="hs-identifier hs-type">Validity</span></a><span>
</span><a name="line-1336"></a><span>    </span><a name="local-1628276415"><a href="#local-1628276415"><span class="hs-identifier">ft_check</span></a></a><span> </span><a name="local-1628276424"><a href="#local-1628276424"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenDeriv.html#FT"><span class="hs-identifier hs-var">FT</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ft_triv</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_var</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>
</span><a name="line-1337"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_co_var</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#badCon"><span class="hs-identifier hs-var">badCon</span></a><span> </span><a href="#local-1628276424"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1628276417"><span class="hs-identifier hs-var">covariant</span></a><span class="hs-special">)</span><span>
</span><a name="line-1338"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-1628276425"><a href="#local-1628276425"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-1628276426"><a href="#local-1628276426"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628276405"><span class="hs-identifier hs-var">allowFunctions</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-1628276425"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><a href="ErrUtils.html#andValid"><span class="hs-identifier hs-var">andValid</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628276426"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-1339"></a><span>                                                           </span><span class="hs-keyword">else</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#badCon"><span class="hs-identifier hs-var">badCon</span></a><span> </span><a href="#local-1628276424"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1628276418"><span class="hs-identifier hs-var">functions</span></a><span class="hs-special">)</span><span>
</span><a name="line-1340"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_tup</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-1628276427"><a href="#local-1628276427"><span class="hs-identifier">xs</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#allValid"><span class="hs-identifier hs-var">allValid</span></a><span> </span><a href="#local-1628276427"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-1341"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_ty_app</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-1628276428"><a href="#local-1628276428"><span class="hs-identifier">x</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276428"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1342"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_bad_app</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#badCon"><span class="hs-identifier hs-var">badCon</span></a><span> </span><a href="#local-1628276424"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-1628276419"><span class="hs-identifier hs-var">wrong_arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1343"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_forall</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-1628276429"><a href="#local-1628276429"><span class="hs-identifier">x</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276429"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1344"></a><span>
</span><a name="line-1345"></a><span>    </span><a name="local-1628276416"><a href="#local-1628276416"><span class="hs-identifier">existential</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;must be truly polymorphic in the last argument of the data type&quot;</span><span>
</span><a name="line-1346"></a><span>    </span><a name="local-1628276417"><a href="#local-1628276417"><span class="hs-identifier">covariant</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;must not use the type variable in a function argument&quot;</span><span>
</span><a name="line-1347"></a><span>    </span><a name="local-1628276418"><a href="#local-1628276418"><span class="hs-identifier">functions</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;must not contain function types&quot;</span><span>
</span><a name="line-1348"></a><span>    </span><a name="local-1628276419"><a href="#local-1628276419"><span class="hs-identifier">wrong_arg</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;must use the type variable only as the last argument of a data type&quot;</span><span>
</span><a name="line-1349"></a><span>
</span><a name="line-1350"></a><span class="hs-identifier">checkFlag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#Extension"><span class="hs-identifier hs-type">LangExt</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Extension</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-1351"></a><a name="checkFlag"><a href="TcDeriv.html#checkFlag"><span class="hs-identifier">checkFlag</span></a></a><span> </span><a name="local-1628276430"><a href="#local-1628276430"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1628276431"><a href="#local-1628276431"><span class="hs-identifier">dflags</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1352"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="#local-1628276430"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-1628276431"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#IsValid"><span class="hs-identifier hs-var">IsValid</span></a><span>
</span><a name="line-1353"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#NotValid"><span class="hs-identifier hs-var">NotValid</span></a><span> </span><a href="#local-1628276432"><span class="hs-identifier hs-var">why</span></a><span>
</span><a name="line-1354"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1355"></a><span>    </span><a name="local-1628276432"><a href="#local-1628276432"><span class="hs-identifier">why</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;You need &quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-1628276433"><span class="hs-identifier hs-var">flag_str</span></a><span>
</span><a name="line-1356"></a><span>          </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;to derive an instance for this class&quot;</span><span>
</span><a name="line-1357"></a><span>    </span><a name="local-1628276433"><a href="#local-1628276433"><span class="hs-identifier">flag_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">flagSpecName</span><span> </span><a href="#local-1628276434"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-1628276434"><a href="#local-1628276434"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#xFlags"><span class="hs-identifier hs-var">xFlags</span></a><span> </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">flagSpecFlag</span><span> </span><a href="#local-1628276434"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1628276430"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1358"></a><span>                 </span><span class="hs-special">[</span><a name="local-1628276435"><a href="#local-1628276435"><span class="hs-identifier">s</span></a></a><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276435"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1359"></a><span>                 </span><a name="local-1628276436"><a href="#local-1628276436"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;checkFlag&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276436"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-1360"></a><span>
</span><a name="line-1361"></a><span class="hs-identifier">std_class_via_coercible</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1362"></a><span class="hs-comment">-- These standard classes can be derived for a newtype</span><span>
</span><a name="line-1363"></a><span class="hs-comment">-- using the coercible trick *even if no -XGeneralizedNewtypeDeriving</span><span>
</span><a name="line-1364"></a><span class="hs-comment">-- because giving so gives the same results as generating the boilerplate</span><span>
</span><a name="line-1365"></a><a name="std_class_via_coercible"><a href="TcDeriv.html#std_class_via_coercible"><span class="hs-identifier">std_class_via_coercible</span></a></a><span> </span><a name="local-1628276437"><a href="#local-1628276437"><span class="hs-identifier">clas</span></a></a><span>
</span><a name="line-1366"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classKey</span><span> </span><a href="#local-1628276437"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="PrelNames.html#eqClassKey"><span class="hs-identifier hs-var">eqClassKey</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#ordClassKey"><span class="hs-identifier hs-var">ordClassKey</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#ixClassKey"><span class="hs-identifier hs-var">ixClassKey</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#boundedClassKey"><span class="hs-identifier hs-var">boundedClassKey</span></a><span class="hs-special">]</span><span>
</span><a name="line-1367"></a><span>        </span><span class="hs-comment">-- Not Read/Show/Lift because they respect the type</span><span>
</span><a name="line-1368"></a><span>        </span><span class="hs-comment">-- Not Enum, because newtypes are never in Enum</span><span>
</span><a name="line-1369"></a><span>
</span><a name="line-1370"></a><span>
</span><a name="line-1371"></a><span class="hs-identifier">non_coercible_class</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1372"></a><span class="hs-comment">-- *Never* derive Read, Show, Typeable, Data, Generic, Generic1, Lift</span><span>
</span><a name="line-1373"></a><span class="hs-comment">-- by Coercible, even with -XGeneralizedNewtypeDeriving</span><span>
</span><a name="line-1374"></a><span class="hs-comment">-- Also, avoid Traversable, as the Coercible-derived instance and the &quot;normal&quot;-derived</span><span>
</span><a name="line-1375"></a><span class="hs-comment">-- instance behave differently if there's a non-lawful Applicative out there.</span><span>
</span><a name="line-1376"></a><span class="hs-comment">-- Besides, with roles, Coercible-deriving Traversable is ill-roled.</span><span>
</span><a name="line-1377"></a><a name="non_coercible_class"><a href="TcDeriv.html#non_coercible_class"><span class="hs-identifier">non_coercible_class</span></a></a><span> </span><a name="local-1628276438"><a href="#local-1628276438"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-1378"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classKey</span><span> </span><a href="#local-1628276438"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span> </span><a href="PrelNames.html#readClassKey"><span class="hs-identifier hs-var">readClassKey</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#showClassKey"><span class="hs-identifier hs-var">showClassKey</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#dataClassKey"><span class="hs-identifier hs-var">dataClassKey</span></a><span>
</span><a name="line-1379"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="PrelNames.html#genClassKey"><span class="hs-identifier hs-var">genClassKey</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#gen1ClassKey"><span class="hs-identifier hs-var">gen1ClassKey</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#typeableClassKey"><span class="hs-identifier hs-var">typeableClassKey</span></a><span>
</span><a name="line-1380"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="PrelNames.html#traversableClassKey"><span class="hs-identifier hs-var">traversableClassKey</span></a><span class="hs-special">,</span><span> </span><a href="THNames.html#liftClassKey"><span class="hs-identifier hs-var">liftClassKey</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1381"></a><span>
</span><a name="line-1382"></a><span class="hs-identifier">badCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1383"></a><a name="badCon"><a href="TcDeriv.html#badCon"><span class="hs-identifier">badCon</span></a></a><span> </span><a name="local-1628276439"><a href="#local-1628276439"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-1628276440"><a href="#local-1628276440"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Constructor&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276439"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-1628276440"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-1384"></a><span>
</span><a name="line-1385"></a><span class="hs-comment">{-
Note [Check that the type variable is truly universal]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For Functor and Traversable instances, we must check that the *last argument*
of the type constructor is used truly universally quantified.  Example

   data T a b where
     T1 :: a -&gt; b -&gt; T a b      -- Fine! Vanilla H-98
     T2 :: b -&gt; c -&gt; T a b      -- Fine! Existential c, but we can still map over 'b'
     T3 :: b -&gt; T Int b         -- Fine! Constraint 'a', but 'b' is still polymorphic
     T4 :: Ord b =&gt; b -&gt; T a b  -- No!  'b' is constrained
     T5 :: b -&gt; T b b           -- No!  'b' is constrained
     T6 :: T a (b,b)            -- No!  'b' is constrained

Notice that only the first of these constructors is vanilla H-98. We only
need to take care about the last argument (b in this case).  See Trac #8678.
Eg. for T1-T3 we can write

     fmap f (T1 a b) = T1 a (f b)
     fmap f (T2 b c) = T2 (f b) c
     fmap f (T3 x)   = T3 (f x)

We need not perform these checks for Foldable instances, however, since
functions in Foldable can only consume existentially quantified type variables,
rather than produce them (as is the case in Functor and Traversable functions.)
As a result, T can have a derived Foldable instance:

    foldr f z (T1 a b) = f b z
    foldr f z (T2 b c) = f b z
    foldr f z (T3 x)   = f x z
    foldr f z (T4 x)   = f x z
    foldr f z (T5 x)   = f x z
    foldr _ z T6       = z

See Note [DeriveFoldable with ExistentialQuantification] in TcGenDeriv.


Note [Superclasses of derived instance]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general, a derived instance decl needs the superclasses of the derived
class too.  So if we have
        data T a = ...deriving( Ord )
then the initial context for Ord (T a) should include Eq (T a).  Often this is
redundant; we'll also generate an Ord constraint for each constructor argument,
and that will probably generate enough constraints to make the Eq (T a) constraint
be satisfied too.  But not always; consider:

 data S a = S
 instance Eq (S a)
 instance Ord (S a)

 data T a = MkT (S a) deriving( Ord )
 instance Num a =&gt; Eq (T a)

The derived instance for (Ord (T a)) must have a (Num a) constraint!
Similarly consider:
        data T a = MkT deriving( Data, Typeable )
Here there *is* no argument field, but we must nevertheless generate
a context for the Data instances:
        instance Typable a =&gt; Data (T a) where ...


************************************************************************
*                                                                      *
                Deriving newtypes
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1453"></a><span>
</span><a name="line-1454"></a><span class="hs-identifier">mkNewTypeEqn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="BasicTypes.html#OverlapMode"><span class="hs-identifier hs-type">OverlapMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span>
</span><a name="line-1455"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-1456"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span>
</span><a name="line-1457"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcRn"><span class="hs-identifier hs-type">TcRn</span></a><span> </span><a href="TcDeriv.html#EarlyDerivSpec"><span class="hs-identifier hs-type">EarlyDerivSpec</span></a><span>
</span><a name="line-1458"></a><a name="mkNewTypeEqn"><a href="TcDeriv.html#mkNewTypeEqn"><span class="hs-identifier">mkNewTypeEqn</span></a></a><span> </span><a name="local-1628276441"><a href="#local-1628276441"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1628276442"><a href="#local-1628276442"><span class="hs-identifier">overlap_mode</span></a></a><span> </span><a name="local-1628276443"><a href="#local-1628276443"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-1459"></a><span>             </span><a name="local-1628276444"><a href="#local-1628276444"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-1628276445"><a href="#local-1628276445"><span class="hs-identifier">cls_tys</span></a></a><span> </span><a name="local-1628276446"><a href="#local-1628276446"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-1628276447"><a href="#local-1628276447"><span class="hs-identifier">tc_args</span></a></a><span> </span><a name="local-1628276448"><a href="#local-1628276448"><span class="hs-identifier">rep_tycon</span></a></a><span> </span><a name="local-1628276449"><a href="#local-1628276449"><span class="hs-identifier">rep_tc_args</span></a></a><span> </span><a name="local-1628276450"><a href="#local-1628276450"><span class="hs-identifier">mtheta</span></a></a><span>
</span><a name="line-1460"></a><span class="hs-comment">-- Want: instance (...) =&gt; cls (cls_tys ++ [tycon tc_args]) where ...</span><span>
</span><a name="line-1461"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">cls_tys</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">classArity</span><span> </span><span class="hs-identifier">cls</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1462"></a><span>    </span><a href="#local-1628276470"><span class="hs-identifier hs-var">might_derive_via_coercible</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-1628276451"><span class="hs-identifier hs-var">newtype_deriving</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1628276452"><span class="hs-identifier hs-var">deriveAnyClass</span></a><span class="hs-special">)</span><span>
</span><a name="line-1463"></a><span>                                  </span><span class="hs-operator hs-var">||</span><span> </span><a href="TcDeriv.html#std_class_via_coercible"><span class="hs-identifier hs-var">std_class_via_coercible</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1464"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;newtype deriving:&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276446"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276460"><span class="hs-identifier hs-var">rep_tys</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276469"><span class="hs-identifier hs-var">all_preds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1465"></a><span>       </span><a name="local-1628276480"><a href="#local-1628276480"><span class="hs-identifier">dfun_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#newDFunName%27"><span class="hs-identifier hs-var">newDFunName'</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276446"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1466"></a><span>       </span><a name="local-1628276481"><a href="#local-1628276481"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-1467"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628276450"><span class="hs-identifier hs-var">mtheta</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1468"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628276482"><a href="#local-1628276482"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcDeriv.html#GivenTheta"><span class="hs-identifier hs-var">GivenTheta</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcDeriv.html#DS"><span class="hs-identifier hs-var">DS</span></a><span>
</span><a name="line-1469"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276481"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1470"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276480"><span class="hs-identifier hs-var">dfun_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#varSetElemsWellScoped"><span class="hs-identifier hs-var">varSetElemsWellScoped</span></a><span> </span><a href="#local-1628276464"><span class="hs-identifier hs-var">dfun_tvs</span></a><span>
</span><a name="line-1471"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_cls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276466"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-1472"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276448"><span class="hs-identifier hs-var">rep_tycon</span></a><span>
</span><a name="line-1473"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276482"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1474"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_overlap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276442"><span class="hs-identifier hs-var">overlap_mode</span></a><span>
</span><a name="line-1475"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_newtype</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628276459"><span class="hs-identifier hs-var">rep_inst_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1476"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcDeriv.html#InferTheta"><span class="hs-identifier hs-var">InferTheta</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcDeriv.html#DS"><span class="hs-identifier hs-var">DS</span></a><span>
</span><a name="line-1477"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276481"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1478"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276480"><span class="hs-identifier hs-var">dfun_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#varSetElemsWellScoped"><span class="hs-identifier hs-var">varSetElemsWellScoped</span></a><span> </span><a href="#local-1628276464"><span class="hs-identifier hs-var">dfun_tvs</span></a><span>
</span><a name="line-1479"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_cls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276466"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-1480"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276448"><span class="hs-identifier hs-var">rep_tycon</span></a><span>
</span><a name="line-1481"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276469"><span class="hs-identifier hs-var">all_preds</span></a><span>
</span><a name="line-1482"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_overlap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276442"><span class="hs-identifier hs-var">overlap_mode</span></a><span>
</span><a name="line-1483"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_newtype</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628276459"><span class="hs-identifier hs-var">rep_inst_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1484"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1485"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcDeriv.html#checkSideConditions"><span class="hs-identifier hs-var">checkSideConditions</span></a><span> </span><a href="#local-1628276441"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628276450"><span class="hs-identifier hs-var">mtheta</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276445"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="#local-1628276448"><span class="hs-identifier hs-var">rep_tycon</span></a><span> </span><a href="#local-1628276449"><span class="hs-identifier hs-var">rep_tc_args</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1486"></a><span>      </span><span class="hs-comment">-- Error with standard class</span><span>
</span><a name="line-1487"></a><span>      </span><a href="TcDeriv.html#DerivableClassError"><span class="hs-identifier hs-var">DerivableClassError</span></a><span> </span><a name="local-1628276483"><a href="#local-1628276483"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-1488"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276470"><span class="hs-identifier hs-var">might_derive_via_coercible</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276454"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276483"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="#local-1628276457"><span class="hs-identifier hs-var">suggest_gnd</span></a><span class="hs-special">)</span><span>
</span><a name="line-1489"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276454"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-1628276483"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-1490"></a><span>
</span><a name="line-1491"></a><span>      </span><span class="hs-comment">-- Must use newtype deriving or DeriveAnyClass</span><span>
</span><a name="line-1492"></a><span>      </span><a href="TcDeriv.html#NonDerivableClass"><span class="hs-identifier hs-var">NonDerivableClass</span></a><span> </span><a name="local-1628276484"><a href="#local-1628276484"><span class="hs-identifier">_msg</span></a></a><span>
</span><a name="line-1493"></a><span>        </span><span class="hs-comment">-- Too hard, even with newtype deriving</span><span>
</span><a name="line-1494"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276451"><span class="hs-identifier hs-var">newtype_deriving</span></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276454"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-1628276473"><span class="hs-identifier hs-var">cant_derive_err</span></a><span>
</span><a name="line-1495"></a><span>        </span><span class="hs-comment">-- Try newtype deriving!</span><span>
</span><a name="line-1496"></a><span>        </span><span class="hs-comment">-- Here we suggest GeneralizedNewtypeDeriving even in cases where it may</span><span>
</span><a name="line-1497"></a><span>        </span><span class="hs-comment">-- not be applicable. See Trac #9600.</span><span>
</span><a name="line-1498"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276454"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276456"><span class="hs-identifier hs-var">non_std</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="#local-1628276457"><span class="hs-identifier hs-var">suggest_gnd</span></a><span class="hs-special">)</span><span>
</span><a name="line-1499"></a><span>
</span><a name="line-1500"></a><span>      </span><span class="hs-comment">-- CanDerive/DerivableViaInstance</span><span>
</span><a name="line-1501"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276451"><span class="hs-identifier hs-var">newtype_deriving</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1628276452"><span class="hs-identifier hs-var">deriveAnyClass</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1502"></a><span>                </span><a href="TcRnMonad.html#addWarnTc"><span class="hs-identifier hs-var">addWarnTc</span></a><span> </span><a href="DynFlags.html#NoReason"><span class="hs-identifier hs-var">NoReason</span></a><span>
</span><a name="line-1503"></a><span>                          </span><span class="hs-special">(</span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Both DeriveAnyClass and GeneralizedNewtypeDeriving are enabled&quot;</span><span>
</span><a name="line-1504"></a><span>                               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Defaulting to the DeriveAnyClass strategy for instantiating&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1505"></a><span>              </span><a href="#local-1628276453"><span class="hs-identifier hs-var">go_for_it</span></a><span>
</span><a name="line-1506"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1507"></a><span>        </span><a name="local-1628276451"><a href="#local-1628276451"><span class="hs-identifier">newtype_deriving</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#GeneralizedNewtypeDeriving"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">GeneralizedNewtypeDeriving</span></a><span> </span><a href="#local-1628276441"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1508"></a><span>        </span><a name="local-1628276452"><a href="#local-1628276452"><span class="hs-identifier">deriveAnyClass</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#DeriveAnyClass"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">DeriveAnyClass</span></a><span>             </span><a href="#local-1628276441"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1509"></a><span>        </span><a name="local-1628276453"><a href="#local-1628276453"><span class="hs-identifier">go_for_it</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#mk_data_eqn"><span class="hs-identifier hs-var">mk_data_eqn</span></a><span> </span><a href="#local-1628276442"><span class="hs-identifier hs-var">overlap_mode</span></a><span> </span><a href="#local-1628276443"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276445"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="#local-1628276446"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-1628276447"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-1510"></a><span>                              </span><a href="#local-1628276448"><span class="hs-identifier hs-var">rep_tycon</span></a><span> </span><a href="#local-1628276449"><span class="hs-identifier hs-var">rep_tc_args</span></a><span> </span><a href="#local-1628276450"><span class="hs-identifier hs-var">mtheta</span></a><span>
</span><a name="line-1511"></a><span>        </span><a name="local-1628276454"><a href="#local-1628276454"><span class="hs-identifier">bale_out</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276455"><span class="hs-identifier hs-var">bale_out'</span></a><span> </span><a href="#local-1628276451"><span class="hs-identifier hs-var">newtype_deriving</span></a><span>
</span><a name="line-1512"></a><span>        </span><a name="local-1628276455"><a href="#local-1628276455"><span class="hs-identifier">bale_out'</span></a></a><span> </span><a name="local-1628276476"><a href="#local-1628276476"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcDeriv.html#derivingThingErr"><span class="hs-identifier hs-var">derivingThingErr</span></a><span> </span><a href="#local-1628276476"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276445"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="#local-1628276465"><span class="hs-identifier hs-var">inst_ty</span></a><span>
</span><a name="line-1513"></a><span>
</span><a name="line-1514"></a><span>        </span><a name="local-1628276456"><a href="#local-1628276456"><span class="hs-identifier">non_std</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#nonStdErr"><span class="hs-identifier hs-var">nonStdErr</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1515"></a><span>        </span><a name="local-1628276457"><a href="#local-1628276457"><span class="hs-identifier">suggest_gnd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Try GeneralizedNewtypeDeriving for GHC's newtype-deriving extension&quot;</span><span>
</span><a name="line-1516"></a><span>
</span><a name="line-1517"></a><span>        </span><span class="hs-comment">-- Here is the plan for newtype derivings.  We see</span><span>
</span><a name="line-1518"></a><span>        </span><span class="hs-comment">--        newtype T a1...an = MkT (t ak+1...an) deriving (.., C s1 .. sm, ...)</span><span>
</span><a name="line-1519"></a><span>        </span><span class="hs-comment">-- where t is a type,</span><span>
</span><a name="line-1520"></a><span>        </span><span class="hs-comment">--       ak+1...an is a suffix of a1..an, and are all tyars</span><span>
</span><a name="line-1521"></a><span>        </span><span class="hs-comment">--       ak+1...an do not occur free in t, nor in the s1..sm</span><span>
</span><a name="line-1522"></a><span>        </span><span class="hs-comment">--       (C s1 ... sm) is a  *partial applications* of class C</span><span>
</span><a name="line-1523"></a><span>        </span><span class="hs-comment">--                      with the last parameter missing</span><span>
</span><a name="line-1524"></a><span>        </span><span class="hs-comment">--       (T a1 .. ak) matches the kind of C's last argument</span><span>
</span><a name="line-1525"></a><span>        </span><span class="hs-comment">--              (and hence so does t)</span><span>
</span><a name="line-1526"></a><span>        </span><span class="hs-comment">-- The latter kind-check has been done by deriveTyData already,</span><span>
</span><a name="line-1527"></a><span>        </span><span class="hs-comment">-- and tc_args are already trimmed</span><span>
</span><a name="line-1528"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1529"></a><span>        </span><span class="hs-comment">-- We generate the instance</span><span>
</span><a name="line-1530"></a><span>        </span><span class="hs-comment">--       instance forall ({a1..ak} u fvs(s1..sm)).</span><span>
</span><a name="line-1531"></a><span>        </span><span class="hs-comment">--                C s1 .. sm t =&gt; C s1 .. sm (T a1...ak)</span><span>
</span><a name="line-1532"></a><span>        </span><span class="hs-comment">-- where T a1...ap is the partial application of</span><span>
</span><a name="line-1533"></a><span>        </span><span class="hs-comment">--       the LHS of the correct kind and p &gt;= k</span><span>
</span><a name="line-1534"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1535"></a><span>        </span><span class="hs-comment">--      NB: the variables below are:</span><span>
</span><a name="line-1536"></a><span>        </span><span class="hs-comment">--              tc_tvs = [a1, ..., an]</span><span>
</span><a name="line-1537"></a><span>        </span><span class="hs-comment">--              tyvars_to_keep = [a1, ..., ak]</span><span>
</span><a name="line-1538"></a><span>        </span><span class="hs-comment">--              rep_ty = t ak .. an</span><span>
</span><a name="line-1539"></a><span>        </span><span class="hs-comment">--              deriv_tvs = fvs(s1..sm) \ tc_tvs</span><span>
</span><a name="line-1540"></a><span>        </span><span class="hs-comment">--              tys = [s1, ..., sm]</span><span>
</span><a name="line-1541"></a><span>        </span><span class="hs-comment">--              rep_fn' = t</span><span>
</span><a name="line-1542"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1543"></a><span>        </span><span class="hs-comment">-- Running example: newtype T s a = MkT (ST s a) deriving( Monad )</span><span>
</span><a name="line-1544"></a><span>        </span><span class="hs-comment">-- We generate the instance</span><span>
</span><a name="line-1545"></a><span>        </span><span class="hs-comment">--      instance Monad (ST s) =&gt; Monad (T s) where</span><span>
</span><a name="line-1546"></a><span>
</span><a name="line-1547"></a><span>        </span><a name="local-1628276458"><a href="#local-1628276458"><span class="hs-identifier">nt_eta_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#newTyConEtadArity"><span class="hs-identifier hs-var">newTyConEtadArity</span></a><span> </span><a href="#local-1628276448"><span class="hs-identifier hs-var">rep_tycon</span></a><span>
</span><a name="line-1548"></a><span>                </span><span class="hs-comment">-- For newtype T a b = MkT (S a a b), the TyCon machinery already</span><span>
</span><a name="line-1549"></a><span>                </span><span class="hs-comment">-- eta-reduces the representation type, so we know that</span><span>
</span><a name="line-1550"></a><span>                </span><span class="hs-comment">--      T a ~ S a a</span><span>
</span><a name="line-1551"></a><span>                </span><span class="hs-comment">-- That's convenient here, because we may have to apply</span><span>
</span><a name="line-1552"></a><span>                </span><span class="hs-comment">-- it to fewer than its original complement of arguments</span><span>
</span><a name="line-1553"></a><span>
</span><a name="line-1554"></a><span>        </span><span class="hs-comment">-- Note [Newtype representation]</span><span>
</span><a name="line-1555"></a><span>        </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-1556"></a><span>        </span><span class="hs-comment">-- Need newTyConRhs (*not* a recursive representation finder)</span><span>
</span><a name="line-1557"></a><span>        </span><span class="hs-comment">-- to get the representation type. For example</span><span>
</span><a name="line-1558"></a><span>        </span><span class="hs-comment">--      newtype B = MkB Int</span><span>
</span><a name="line-1559"></a><span>        </span><span class="hs-comment">--      newtype A = MkA B deriving( Num )</span><span>
</span><a name="line-1560"></a><span>        </span><span class="hs-comment">-- We want the Num instance of B, *not* the Num instance of Int,</span><span>
</span><a name="line-1561"></a><span>        </span><span class="hs-comment">-- when making the Num instance of A!</span><span>
</span><a name="line-1562"></a><span>        </span><a name="local-1628276459"><a href="#local-1628276459"><span class="hs-identifier">rep_inst_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#newTyConInstRhs"><span class="hs-identifier hs-var">newTyConInstRhs</span></a><span> </span><a href="#local-1628276448"><span class="hs-identifier hs-var">rep_tycon</span></a><span> </span><a href="#local-1628276449"><span class="hs-identifier hs-var">rep_tc_args</span></a><span>
</span><a name="line-1563"></a><span>        </span><a name="local-1628276460"><a href="#local-1628276460"><span class="hs-identifier">rep_tys</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276445"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628276459"><span class="hs-identifier hs-var">rep_inst_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1564"></a><span>        </span><a name="local-1628276461"><a href="#local-1628276461"><span class="hs-identifier">rep_pred</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276460"><span class="hs-identifier hs-var">rep_tys</span></a><span>
</span><a name="line-1565"></a><span>        </span><a name="local-1628276462"><a href="#local-1628276462"><span class="hs-identifier">rep_pred_o</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#mkPredOrigin"><span class="hs-identifier hs-var">mkPredOrigin</span></a><span> </span><a href="TcRnTypes.html#DerivOrigin"><span class="hs-identifier hs-var">DerivOrigin</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span> </span><a href="#local-1628276461"><span class="hs-identifier hs-var">rep_pred</span></a><span>
</span><a name="line-1566"></a><span>                </span><span class="hs-comment">-- rep_pred is the representation dictionary, from where</span><span>
</span><a name="line-1567"></a><span>                </span><span class="hs-comment">-- we are gong to get all the methods for the newtype</span><span>
</span><a name="line-1568"></a><span>                </span><span class="hs-comment">-- dictionary</span><span>
</span><a name="line-1569"></a><span>
</span><a name="line-1570"></a><span>        </span><span class="hs-comment">-- Next we figure out what superclass dictionaries to use</span><span>
</span><a name="line-1571"></a><span>        </span><span class="hs-comment">-- See Note [Newtype deriving superclasses] above</span><span>
</span><a name="line-1572"></a><span>        </span><a name="local-1628276463"><a href="#local-1628276463"><span class="hs-identifier">cls_tyvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classTyVars</span><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1573"></a><span>        </span><a name="local-1628276464"><a href="#local-1628276464"><span class="hs-identifier">dfun_tvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="#local-1628276466"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-1574"></a><span>        </span><a name="local-1628276465"><a href="#local-1628276465"><span class="hs-identifier">inst_ty</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628276446"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-1628276447"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-1575"></a><span>        </span><a name="local-1628276466"><a href="#local-1628276466"><span class="hs-identifier">inst_tys</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276445"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628276465"><span class="hs-identifier hs-var">inst_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1576"></a><span>        </span><a name="local-1628276467"><a href="#local-1628276467"><span class="hs-identifier">sc_theta</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcDeriv.html#mkThetaOrigin"><span class="hs-identifier hs-var">mkThetaOrigin</span></a><span> </span><a href="TcRnTypes.html#DerivOrigin"><span class="hs-identifier hs-var">DerivOrigin</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1577"></a><span>                     </span><a href="TyCoRep.html#substTheta"><span class="hs-identifier hs-var">substTheta</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#zipTvSubst"><span class="hs-identifier hs-var">zipTvSubst</span></a><span> </span><a href="#local-1628276463"><span class="hs-identifier hs-var">cls_tyvars</span></a><span> </span><a href="#local-1628276466"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1578"></a><span>                     </span><span class="hs-identifier">classSCTheta</span><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1579"></a><span>
</span><a name="line-1580"></a><span>        </span><span class="hs-comment">-- Next we collect Coercible constraints between</span><span>
</span><a name="line-1581"></a><span>        </span><span class="hs-comment">-- the Class method types, instantiated with the representation and the</span><span>
</span><a name="line-1582"></a><span>        </span><span class="hs-comment">-- newtype type; precisely the constraints required for the</span><span>
</span><a name="line-1583"></a><span>        </span><span class="hs-comment">-- calls to coercible that we are going to generate.</span><span>
</span><a name="line-1584"></a><span>        </span><a name="local-1628276468"><a href="#local-1628276468"><span class="hs-identifier">coercible_constraints</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1585"></a><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-1628276478"><a href="#local-1628276478"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-1628276479"><a href="#local-1628276479"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenDeriv.html#mkCoerceClassMethEqn"><span class="hs-identifier hs-var">mkCoerceClassMethEqn</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#varSetElemsWellScoped"><span class="hs-identifier hs-var">varSetElemsWellScoped</span></a><span> </span><a href="#local-1628276464"><span class="hs-identifier hs-var">dfun_tvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276466"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><a href="#local-1628276459"><span class="hs-identifier hs-var">rep_inst_ty</span></a><span> </span><a href="#local-1628276477"><span class="hs-identifier hs-var">meth</span></a><span>
</span><a name="line-1586"></a><span>              </span><span class="hs-keyword">in</span><span> </span><a href="TcDeriv.html#mkPredOrigin"><span class="hs-identifier hs-var">mkPredOrigin</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#DerivOriginCoerce"><span class="hs-identifier hs-var">DerivOriginCoerce</span></a><span> </span><a href="#local-1628276477"><span class="hs-identifier hs-var">meth</span></a><span> </span><a href="#local-1628276478"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1628276479"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span>
</span><a name="line-1587"></a><span>                              </span><span class="hs-special">(</span><a href="Type.html#mkReprPrimEqPred"><span class="hs-identifier hs-var">mkReprPrimEqPred</span></a><span> </span><a href="#local-1628276478"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1628276479"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1588"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a name="local-1628276477"><a href="#local-1628276477"><span class="hs-identifier">meth</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Class.html#classMethods"><span class="hs-identifier hs-var">classMethods</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1589"></a><span>
</span><a name="line-1590"></a><span>                </span><span class="hs-comment">-- If there are no tyvars, there's no need</span><span>
</span><a name="line-1591"></a><span>                </span><span class="hs-comment">-- to abstract over the dictionaries we need</span><span>
</span><a name="line-1592"></a><span>                </span><span class="hs-comment">-- Example:     newtype T = MkT Int deriving( C )</span><span>
</span><a name="line-1593"></a><span>                </span><span class="hs-comment">-- We get the derived instance</span><span>
</span><a name="line-1594"></a><span>                </span><span class="hs-comment">--              instance C T</span><span>
</span><a name="line-1595"></a><span>                </span><span class="hs-comment">-- rather than</span><span>
</span><a name="line-1596"></a><span>                </span><span class="hs-comment">--              instance C Int =&gt; C T</span><span>
</span><a name="line-1597"></a><span>        </span><a name="local-1628276469"><a href="#local-1628276469"><span class="hs-identifier">all_preds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276462"><span class="hs-identifier hs-var">rep_pred_o</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1628276468"><span class="hs-identifier hs-var">coercible_constraints</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628276467"><span class="hs-identifier hs-var">sc_theta</span></a><span> </span><span class="hs-comment">-- NB: rep_pred comes first</span><span>
</span><a name="line-1598"></a><span>
</span><a name="line-1599"></a><span>        </span><span class="hs-comment">-------------------------------------------------------------------</span><span>
</span><a name="line-1600"></a><span>        </span><span class="hs-comment">--  Figuring out whether we can only do this newtype-deriving thing</span><span>
</span><a name="line-1601"></a><span>
</span><a name="line-1602"></a><span>        </span><span class="hs-comment">-- See Note [Determining whether newtype-deriving is appropriate]</span><span>
</span><a name="line-1603"></a><span>        </span><a name="local-1628276470"><a href="#local-1628276470"><span class="hs-identifier">might_derive_via_coercible</span></a></a><span>
</span><a name="line-1604"></a><span>           </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#non_coercible_class"><span class="hs-identifier hs-var">non_coercible_class</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1605"></a><span>           </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1628276471"><span class="hs-identifier hs-var">eta_ok</span></a><span>
</span><a name="line-1606"></a><span>           </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1628276472"><span class="hs-identifier hs-var">ats_ok</span></a><span>
</span><a name="line-1607"></a><span class="hs-comment">--         &amp;&amp; not (isRecursiveTyCon tycon)      -- Note [Recursive newtypes]</span><span>
</span><a name="line-1608"></a><span>
</span><a name="line-1609"></a><span>        </span><span class="hs-comment">-- Check that eta reduction is OK</span><span>
</span><a name="line-1610"></a><span>        </span><a name="local-1628276471"><a href="#local-1628276471"><span class="hs-identifier">eta_ok</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276458"><span class="hs-identifier hs-var">nt_eta_arity</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1628276449"><span class="hs-identifier hs-var">rep_tc_args</span></a><span>
</span><a name="line-1611"></a><span>                </span><span class="hs-comment">-- The newtype can be eta-reduced to match the number</span><span>
</span><a name="line-1612"></a><span>                </span><span class="hs-comment">--     of type argument actually supplied</span><span>
</span><a name="line-1613"></a><span>                </span><span class="hs-comment">--        newtype T a b = MkT (S [a] b) deriving( Monad )</span><span>
</span><a name="line-1614"></a><span>                </span><span class="hs-comment">--     Here the 'b' must be the same in the rep type (S [a] b)</span><span>
</span><a name="line-1615"></a><span>                </span><span class="hs-comment">--     And the [a] must not mention 'b'.  That's all handled</span><span>
</span><a name="line-1616"></a><span>                </span><span class="hs-comment">--     by nt_eta_rity.</span><span>
</span><a name="line-1617"></a><span>
</span><a name="line-1618"></a><span>        </span><a name="local-1628276472"><a href="#local-1628276472"><span class="hs-identifier">ats_ok</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-special">(</span><a href="Class.html#classATs"><span class="hs-identifier hs-var">classATs</span></a><span> </span><a href="#local-1628276444"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1619"></a><span>               </span><span class="hs-comment">-- No associated types for the class, because we don't</span><span>
</span><a name="line-1620"></a><span>               </span><span class="hs-comment">-- currently generate type 'instance' decls; and cannot do</span><span>
</span><a name="line-1621"></a><span>               </span><span class="hs-comment">-- so for 'data' instance decls</span><span>
</span><a name="line-1622"></a><span>
</span><a name="line-1623"></a><span>        </span><a name="local-1628276473"><a href="#local-1628276473"><span class="hs-identifier">cant_derive_err</span></a></a><span>
</span><a name="line-1624"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppUnless"><span class="hs-identifier hs-var">ppUnless</span></a><span> </span><a href="#local-1628276471"><span class="hs-identifier hs-var">eta_ok</span></a><span> </span><a href="#local-1628276474"><span class="hs-identifier hs-var">eta_msg</span></a><span>
</span><a name="line-1625"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppUnless"><span class="hs-identifier hs-var">ppUnless</span></a><span> </span><a href="#local-1628276472"><span class="hs-identifier hs-var">ats_ok</span></a><span> </span><a href="#local-1628276475"><span class="hs-identifier hs-var">ats_msg</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1626"></a><span>        </span><a name="local-1628276474"><a href="#local-1628276474"><span class="hs-identifier">eta_msg</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;cannot eta-reduce the representation type enough&quot;</span><span>
</span><a name="line-1627"></a><span>        </span><a name="local-1628276475"><a href="#local-1628276475"><span class="hs-identifier">ats_msg</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;the class has associated types&quot;</span><span>
</span><a name="line-1628"></a><span>
</span><a name="line-1629"></a><span class="hs-comment">{-
Note [Recursive newtypes]
~~~~~~~~~~~~~~~~~~~~~~~~~
Newtype deriving works fine, even if the newtype is recursive.
e.g.    newtype S1 = S1 [T1 ()]
        newtype T1 a = T1 (StateT S1 IO a ) deriving( Monad )
Remember, too, that type families are currently (conservatively) given
a recursive flag, so this also allows newtype deriving to work
for type famillies.

We used to exclude recursive types, because we had a rather simple
minded way of generating the instance decl:
   newtype A = MkA [A]
   instance Eq [A] =&gt; Eq A      -- Makes typechecker loop!
But now we require a simple context, so it's ok.

Note [Determining whether newtype-deriving is appropriate]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we see
  newtype NT = MkNT Foo
    deriving C
we have to decide how to perform the deriving. Do we do newtype deriving,
or do we do normal deriving? In general, we prefer to do newtype deriving
wherever possible. So, we try newtype deriving unless there's a glaring
reason not to.

Note that newtype deriving might fail, even after we commit to it. This
is because the derived instance uses `coerce`, which must satisfy its
`Coercible` constraint. This is different than other deriving scenarios,
where we're sure that the resulting instance will type-check.

************************************************************************
*                                                                      *
         Finding the fixed point of deriving equations
*                                                                      *
************************************************************************

Note [Simplifying the instance context]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

        data T a b = C1 (Foo a) (Bar b)
                   | C2 Int (T b a)
                   | C3 (T a a)
                   deriving (Eq)

We want to come up with an instance declaration of the form

        instance (Ping a, Pong b, ...) =&gt; Eq (T a b) where
                x == y = ...

It is pretty easy, albeit tedious, to fill in the code &quot;...&quot;.  The
trick is to figure out what the context for the instance decl is,
namely Ping, Pong and friends.

Let's call the context reqd for the T instance of class C at types
(a,b, ...)  C (T a b).  Thus:

        Eq (T a b) = (Ping a, Pong b, ...)

Now we can get a (recursive) equation from the data decl.  This part
is done by inferConstraints.

        Eq (T a b) = Eq (Foo a) u Eq (Bar b)    -- From C1
                   u Eq (T b a) u Eq Int        -- From C2
                   u Eq (T a a)                 -- From C3


Foo and Bar may have explicit instances for Eq, in which case we can
just substitute for them.  Alternatively, either or both may have
their Eq instances given by deriving clauses, in which case they
form part of the system of equations.

Now all we need do is simplify and solve the equations, iterating to
find the least fixpoint.  This is done by simplifyInstanceConstraints.
Notice that the order of the arguments can
switch around, as here in the recursive calls to T.

Let's suppose Eq (Foo a) = Eq a, and Eq (Bar b) = Ping b.

We start with:

        Eq (T a b) = {}         -- The empty set

Next iteration:
        Eq (T a b) = Eq (Foo a) u Eq (Bar b)    -- From C1
                   u Eq (T b a) u Eq Int        -- From C2
                   u Eq (T a a)                 -- From C3

        After simplification:
                   = Eq a u Ping b u {} u {} u {}
                   = Eq a u Ping b

Next iteration:

        Eq (T a b) = Eq (Foo a) u Eq (Bar b)    -- From C1
                   u Eq (T b a) u Eq Int        -- From C2
                   u Eq (T a a)                 -- From C3

        After simplification:
                   = Eq a u Ping b
                   u (Eq b u Ping a)
                   u (Eq a u Ping a)

                   = Eq a u Ping b u Eq b u Ping a

The next iteration gives the same result, so this is the fixpoint.  We
need to make a canonical form of the RHS to ensure convergence.  We do
this by simplifying the RHS to a form in which

        - the classes constrain only tyvars
        - the list is sorted by tyvar (major key) and then class (minor key)
        - no duplicates, of course

-}</span><span>
</span><a name="line-1744"></a><span>
</span><a name="line-1745"></a><span>
</span><a name="line-1746"></a><span class="hs-identifier">simplifyInstanceContexts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="TcDeriv.html#ThetaOrigin"><span class="hs-identifier hs-type">ThetaOrigin</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span class="hs-special">]</span><span>
</span><a name="line-1747"></a><span class="hs-comment">-- Used only for deriving clauses (InferTheta)</span><span>
</span><a name="line-1748"></a><span class="hs-comment">-- not for standalone deriving</span><span>
</span><a name="line-1749"></a><span class="hs-comment">-- See Note [Simplifying the instance context]</span><span>
</span><a name="line-1750"></a><span>
</span><a name="line-1751"></a><a name="simplifyInstanceContexts"><a href="TcDeriv.html#simplifyInstanceContexts"><span class="hs-identifier">simplifyInstanceContexts</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1752"></a><span>
</span><a name="line-1753"></a><span class="hs-identifier">simplifyInstanceContexts</span><span> </span><a name="local-1628276485"><a href="#local-1628276485"><span class="hs-identifier">infer_specs</span></a></a><span>
</span><a name="line-1754"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyInstanceContexts&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="TcDeriv.html#pprDerivSpec"><span class="hs-identifier hs-var">pprDerivSpec</span></a><span> </span><a href="#local-1628276485"><span class="hs-identifier hs-var">infer_specs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1755"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-1628276487"><span class="hs-identifier hs-var">iterate_deriv</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-1628276486"><span class="hs-identifier hs-var">initial_solutions</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1756"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1757"></a><span>    </span><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-1758"></a><span>        </span><span class="hs-comment">-- The initial solutions for the equations claim that each</span><span>
</span><a name="line-1759"></a><span>        </span><span class="hs-comment">-- instance has an empty context; this solution is certainly</span><span>
</span><a name="line-1760"></a><span>        </span><span class="hs-comment">-- in canonical form.</span><span>
</span><a name="line-1761"></a><span>    </span><span class="hs-identifier">initial_solutions</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span class="hs-special">]</span><span>
</span><a name="line-1762"></a><span>    </span><a name="local-1628276486"><a href="#local-1628276486"><span class="hs-identifier">initial_solutions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628276485"><span class="hs-identifier hs-var">infer_specs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1763"></a><span>
</span><a name="line-1764"></a><span>    </span><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-1765"></a><span>        </span><span class="hs-comment">-- iterate_deriv calculates the next batch of solutions,</span><span>
</span><a name="line-1766"></a><span>        </span><span class="hs-comment">-- compares it with the current one; finishes if they are the</span><span>
</span><a name="line-1767"></a><span>        </span><span class="hs-comment">-- same, otherwise recurses with the new solutions.</span><span>
</span><a name="line-1768"></a><span>        </span><span class="hs-comment">-- It fails if any iteration fails</span><span>
</span><a name="line-1769"></a><span>    </span><span class="hs-identifier">iterate_deriv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span class="hs-special">]</span><span>
</span><a name="line-1770"></a><span>    </span><a name="local-1628276487"><a href="#local-1628276487"><span class="hs-identifier">iterate_deriv</span></a></a><span> </span><a name="local-1628276490"><a href="#local-1628276490"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628276491"><a href="#local-1628276491"><span class="hs-identifier">current_solns</span></a></a><span>
</span><a name="line-1771"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276490"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">20</span><span>  </span><span class="hs-comment">-- Looks as if we are in an infinite loop</span><span>
</span><a name="line-1772"></a><span>                </span><span class="hs-comment">-- This can happen if we have -XUndecidableInstances</span><span>
</span><a name="line-1773"></a><span>                </span><span class="hs-comment">-- (See TcSimplify.tcSimplifyDeriv.)</span><span>
</span><a name="line-1774"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;solveDerivEqns: probable loop&quot;</span><span>
</span><a name="line-1775"></a><span>                 </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="TcDeriv.html#pprDerivSpec"><span class="hs-identifier hs-var">pprDerivSpec</span></a><span> </span><a href="#local-1628276485"><span class="hs-identifier hs-var">infer_specs</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276491"><span class="hs-identifier hs-var">current_solns</span></a><span class="hs-special">)</span><span>
</span><a name="line-1776"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1777"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>      </span><span class="hs-comment">-- Extend the inst info from the explicit instance decls</span><span>
</span><a name="line-1778"></a><span>                  </span><span class="hs-comment">-- with the current set of solutions, and simplify each RHS</span><span>
</span><a name="line-1779"></a><span>             </span><a name="local-1628276492"><a href="#local-1628276492"><span class="hs-identifier">inst_specs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#zipWithM"><span class="hs-identifier hs-var">zipWithM</span></a><span> </span><a href="TcDeriv.html#newDerivClsInst"><span class="hs-identifier hs-var">newDerivClsInst</span></a><span> </span><a href="#local-1628276491"><span class="hs-identifier hs-var">current_solns</span></a><span> </span><a href="#local-1628276485"><span class="hs-identifier hs-var">infer_specs</span></a><span>
</span><a name="line-1780"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628276493"><a href="#local-1628276493"><span class="hs-identifier">new_solns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1781"></a><span>                          </span><a href="TcDeriv.html#extendLocalInstEnv"><span class="hs-identifier hs-var">extendLocalInstEnv</span></a><span> </span><a href="#local-1628276492"><span class="hs-identifier hs-var">inst_specs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1782"></a><span>                          </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="#local-1628276489"><span class="hs-identifier hs-var">gen_soln</span></a><span> </span><a href="#local-1628276485"><span class="hs-identifier hs-var">infer_specs</span></a><span>
</span><a name="line-1783"></a><span>
</span><a name="line-1784"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-1628276491"><span class="hs-identifier hs-var">current_solns</span></a><span> </span><span class="hs-special">`</span><a href="#local-1628276488"><span class="hs-identifier hs-var">eqSolution</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628276493"><span class="hs-identifier hs-var">new_solns</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-1785"></a><span>                </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-1628276494"><span class="hs-identifier hs-var">spec</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276495"><span class="hs-identifier hs-var">soln</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1786"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-1628276494"><a href="#local-1628276494"><span class="hs-identifier">spec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276495"><a href="#local-1628276495"><span class="hs-identifier">soln</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-1628276485"><span class="hs-identifier hs-var">infer_specs</span></a><span> </span><a href="#local-1628276491"><span class="hs-identifier hs-var">current_solns</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1787"></a><span>             </span><span class="hs-keyword">else</span><span>
</span><a name="line-1788"></a><span>                </span><a href="#local-1628276487"><span class="hs-identifier hs-var">iterate_deriv</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276490"><span class="hs-identifier hs-var">n</span></a><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-1628276493"><span class="hs-identifier hs-var">new_solns</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1789"></a><span>
</span><a name="line-1790"></a><span>    </span><a name="local-1628276488"><a href="#local-1628276488"><span class="hs-identifier">eqSolution</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#eqListBy"><span class="hs-identifier hs-var">eqListBy</span></a><span> </span><span class="hs-special">(</span><a href="Util.html#eqListBy"><span class="hs-identifier hs-var">eqListBy</span></a><span> </span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">)</span><span>
</span><a name="line-1791"></a><span>
</span><a name="line-1792"></a><span>    </span><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-1793"></a><span>    </span><span class="hs-identifier">gen_soln</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="TcDeriv.html#ThetaOrigin"><span class="hs-identifier hs-type">ThetaOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span>
</span><a name="line-1794"></a><span>    </span><a name="local-1628276489"><a href="#local-1628276489"><span class="hs-identifier">gen_soln</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#DS"><span class="hs-identifier hs-var">DS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276496"><a href="#local-1628276496"><span class="hs-identifier">loc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276497"><a href="#local-1628276497"><span class="hs-identifier">tyvars</span></a></a><span>
</span><a name="line-1795"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_cls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276498"><a href="#local-1628276498"><span class="hs-identifier">clas</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276499"><a href="#local-1628276499"><span class="hs-identifier">inst_tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276500"><a href="#local-1628276500"><span class="hs-identifier">deriv_rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1796"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-1628276496"><span class="hs-identifier hs-var">loc</span></a><span>  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1797"></a><span>        </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#derivInstCtxt"><span class="hs-identifier hs-var">derivInstCtxt</span></a><span> </span><a href="#local-1628276501"><span class="hs-identifier hs-var">the_pred</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1798"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276502"><a href="#local-1628276502"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#simplifyDeriv"><span class="hs-identifier hs-var">simplifyDeriv</span></a><span> </span><a href="#local-1628276501"><span class="hs-identifier hs-var">the_pred</span></a><span> </span><a href="#local-1628276497"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><a href="#local-1628276500"><span class="hs-identifier hs-var">deriv_rhs</span></a><span>
</span><a name="line-1799"></a><span>                </span><span class="hs-comment">-- checkValidInstance tyvars theta clas inst_tys</span><span>
</span><a name="line-1800"></a><span>                </span><span class="hs-comment">-- Not necessary; see Note [Exotic derived instance contexts]</span><span>
</span><a name="line-1801"></a><span>
</span><a name="line-1802"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;TcDeriv&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276500"><span class="hs-identifier hs-var">deriv_rhs</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276502"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-1803"></a><span>                </span><span class="hs-comment">-- Claim: the result instance declaration is guaranteed valid</span><span>
</span><a name="line-1804"></a><span>                </span><span class="hs-comment">-- Hence no need to call:</span><span>
</span><a name="line-1805"></a><span>                </span><span class="hs-comment">--   checkValidInstance tyvars theta clas inst_tys</span><span>
</span><a name="line-1806"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a><span> </span><a href="Type.html#cmpType"><span class="hs-identifier hs-var">cmpType</span></a><span> </span><a href="#local-1628276502"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>    </span><span class="hs-comment">-- Canonicalise before returning the solution</span><span>
</span><a name="line-1807"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1808"></a><span>        </span><a name="local-1628276501"><a href="#local-1628276501"><span class="hs-identifier">the_pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-1628276498"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628276499"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-1809"></a><span>
</span><a name="line-1810"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-1811"></a><span class="hs-identifier">newDerivClsInst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="#local-1628276099"><span class="hs-identifier hs-type">theta</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="InstEnv.html#ClsInst"><span class="hs-identifier hs-type">ClsInst</span></a><span>
</span><a name="line-1812"></a><a name="newDerivClsInst"><a href="TcDeriv.html#newDerivClsInst"><span class="hs-identifier">newDerivClsInst</span></a></a><span> </span><a name="local-1628276503"><a href="#local-1628276503"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#DS"><span class="hs-identifier hs-var">DS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276504"><a href="#local-1628276504"><span class="hs-identifier">dfun_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_overlap</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276505"><a href="#local-1628276505"><span class="hs-identifier">overlap_mode</span></a></a><span>
</span><a name="line-1813"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276506"><a href="#local-1628276506"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_cls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276507"><a href="#local-1628276507"><span class="hs-identifier">clas</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276508"><a href="#local-1628276508"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1814"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Inst.html#newClsInst"><span class="hs-identifier hs-var">newClsInst</span></a><span> </span><a href="#local-1628276505"><span class="hs-identifier hs-var">overlap_mode</span></a><span> </span><a href="#local-1628276504"><span class="hs-identifier hs-var">dfun_name</span></a><span> </span><a href="#local-1628276506"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1628276503"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-1628276507"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628276508"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1815"></a><span>
</span><a name="line-1816"></a><span class="hs-identifier">extendLocalInstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="InstEnv.html#ClsInst"><span class="hs-identifier hs-type">ClsInst</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628276098"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628276098"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1817"></a><span class="hs-comment">-- Add new locally-defined instances; don't bother to check</span><span>
</span><a name="line-1818"></a><span class="hs-comment">-- for functional dependency errors -- that'll happen in TcInstDcls</span><span>
</span><a name="line-1819"></a><a name="extendLocalInstEnv"><a href="TcDeriv.html#extendLocalInstEnv"><span class="hs-identifier">extendLocalInstEnv</span></a></a><span> </span><a name="local-1628276509"><a href="#local-1628276509"><span class="hs-identifier">dfuns</span></a></a><span> </span><a name="local-1628276510"><a href="#local-1628276510"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1820"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276511"><a href="#local-1628276511"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1821"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>  </span><a name="local-1628276512"><a href="#local-1628276512"><span class="hs-identifier">inst_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InstEnv.html#extendInstEnvList"><span class="hs-identifier hs-var">extendInstEnvList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_inst_env</span><span> </span><a href="#local-1628276511"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628276509"><span class="hs-identifier hs-var">dfuns</span></a><span>
</span><a name="line-1822"></a><span>             </span><a name="local-1628276513"><a href="#local-1628276513"><span class="hs-identifier">env'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276511"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276512"><span class="hs-identifier hs-var">inst_env'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1823"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-1628276513"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1628276510"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1824"></a><span>
</span><a name="line-1825"></a><span class="hs-comment">{-
***********************************************************************************
*                                                                                 *
*            Simplify derived constraints
*                                                                                 *
***********************************************************************************
-}</span><span>
</span><a name="line-1832"></a><span>
</span><a name="line-1833"></a><span class="hs-identifier">simplifyDeriv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span>
</span><a name="line-1834"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-1835"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDeriv.html#ThetaOrigin"><span class="hs-identifier hs-type">ThetaOrigin</span></a><span>      </span><span class="hs-comment">-- Wanted</span><span>
</span><a name="line-1836"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span>  </span><span class="hs-comment">-- Needed</span><span>
</span><a name="line-1837"></a><span class="hs-comment">-- Given  instance (wanted) =&gt; C inst_ty</span><span>
</span><a name="line-1838"></a><span class="hs-comment">-- Simplify 'wanted' as much as possibles</span><span>
</span><a name="line-1839"></a><span class="hs-comment">-- Fail if not possible</span><span>
</span><a name="line-1840"></a><a name="simplifyDeriv"><a href="TcDeriv.html#simplifyDeriv"><span class="hs-identifier">simplifyDeriv</span></a></a><span> </span><a name="local-1628276514"><a href="#local-1628276514"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-1628276515"><a href="#local-1628276515"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-1628276516"><a href="#local-1628276516"><span class="hs-identifier">theta</span></a></a><span>
</span><a name="line-1841"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628276517"><a href="#local-1628276517"><span class="hs-identifier">skol_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276518"><a href="#local-1628276518"><span class="hs-identifier">tvs_skols</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcInstSkolTyVars"><span class="hs-identifier hs-var">tcInstSkolTyVars</span></a><span> </span><a href="#local-1628276515"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-comment">-- Skolemize</span><span>
</span><a name="line-1842"></a><span>                </span><span class="hs-comment">-- The constraint solving machinery</span><span>
</span><a name="line-1843"></a><span>                </span><span class="hs-comment">-- expects *TcTyVars* not TyVars.</span><span>
</span><a name="line-1844"></a><span>                </span><span class="hs-comment">-- We use *non-overlappable* (vanilla) skolems</span><span>
</span><a name="line-1845"></a><span>                </span><span class="hs-comment">-- See Note [Overlap and deriving]</span><span>
</span><a name="line-1846"></a><span>
</span><a name="line-1847"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276519"><a href="#local-1628276519"><span class="hs-identifier">skol_set</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-1628276518"><span class="hs-identifier hs-var">tvs_skols</span></a><span>
</span><a name="line-1848"></a><span>             </span><a name="local-1628276520"><a href="#local-1628276520"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#DerivSkol"><span class="hs-identifier hs-var">DerivSkol</span></a><span> </span><a href="#local-1628276514"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-1849"></a><span>             </span><a name="local-1628276521"><a href="#local-1628276521"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;deriving&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276514"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-1850"></a><span>             </span><a name="local-1628276522"><a href="#local-1628276522"><span class="hs-identifier">mk_ct</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#PredOrigin"><span class="hs-identifier hs-var">PredOrigin</span></a><span> </span><a name="local-1628276523"><a href="#local-1628276523"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1628276524"><a href="#local-1628276524"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-1628276525"><a href="#local-1628276525"><span class="hs-identifier">t_or_k</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1851"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="TcMType.html#newWanted"><span class="hs-identifier hs-var">newWanted</span></a><span> </span><a href="#local-1628276524"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628276525"><span class="hs-identifier hs-var">t_or_k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-1628276517"><span class="hs-identifier hs-var">skol_subst</span></a><span> </span><a href="#local-1628276523"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-1852"></a><span>
</span><a name="line-1853"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628276526"><a href="#local-1628276526"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276527"><a href="#local-1628276527"><span class="hs-identifier">tclvl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#pushTcLevelM"><span class="hs-identifier hs-var">pushTcLevelM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="#local-1628276522"><span class="hs-identifier hs-var">mk_ct</span></a><span> </span><a href="#local-1628276516"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-1854"></a><span>
</span><a name="line-1855"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyDeriv&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1856"></a><span>         </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="TyCoRep.html#pprTvBndrs"><span class="hs-identifier hs-var">pprTvBndrs</span></a><span> </span><a href="#local-1628276515"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276516"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276526"><span class="hs-identifier hs-var">wanted</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628276521"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1857"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628276528"><a href="#local-1628276528"><span class="hs-identifier">residual_wanted</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#simplifyWantedsTcM"><span class="hs-identifier hs-var">simplifyWantedsTcM</span></a><span> </span><a href="#local-1628276526"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-1858"></a><span>            </span><span class="hs-comment">-- Result is zonked</span><span>
</span><a name="line-1859"></a><span>
</span><a name="line-1860"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276529"><a href="#local-1628276529"><span class="hs-identifier">residual_simple</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><a href="#local-1628276528"><span class="hs-identifier hs-var">residual_wanted</span></a><span>
</span><a name="line-1861"></a><span>             </span><span class="hs-special">(</span><a name="local-1628276530"><a href="#local-1628276530"><span class="hs-identifier">good</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276531"><a href="#local-1628276531"><span class="hs-identifier">bad</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#partitionBagWith"><span class="hs-identifier hs-var">partitionBagWith</span></a><span> </span><a href="#local-1628276533"><span class="hs-identifier hs-var">get_good</span></a><span> </span><a href="#local-1628276529"><span class="hs-identifier hs-var">residual_simple</span></a><span>
</span><a name="line-1862"></a><span>             </span><a name="local-1628276532"><a href="#local-1628276532"><span class="hs-identifier">unsolved</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276528"><span class="hs-identifier hs-var">residual_wanted</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276531"><span class="hs-identifier hs-var">bad</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1863"></a><span>
</span><a name="line-1864"></a><span>                         </span><span class="hs-comment">-- See Note [Exotic derived instance contexts]</span><span>
</span><a name="line-1865"></a><span>
</span><a name="line-1866"></a><span>             </span><span class="hs-identifier">get_good</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><a href="TcRnTypes.html#Ct"><span class="hs-identifier hs-type">Ct</span></a><span>
</span><a name="line-1867"></a><span>             </span><a name="local-1628276533"><a href="#local-1628276533"><span class="hs-identifier">get_good</span></a></a><span> </span><a name="local-1628276534"><a href="#local-1628276534"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="TcValidity.html#validDerivPred"><span class="hs-identifier hs-var">validDerivPred</span></a><span> </span><a href="#local-1628276519"><span class="hs-identifier hs-var">skol_set</span></a><span> </span><a href="#local-1628276535"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1868"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#isWantedCt"><span class="hs-identifier hs-var">isWantedCt</span></a><span> </span><a href="#local-1628276534"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1869"></a><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a><span> </span><a href="#local-1628276535"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1870"></a><span>                          </span><span class="hs-comment">-- NB: residual_wanted may contain unsolved</span><span>
</span><a name="line-1871"></a><span>                          </span><span class="hs-comment">-- Derived and we stick them into the bad set</span><span>
</span><a name="line-1872"></a><span>                          </span><span class="hs-comment">-- so that reportUnsolved may decide what to do with them</span><span>
</span><a name="line-1873"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1874"></a><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a><span> </span><a href="#local-1628276534"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1875"></a><span>                           </span><span class="hs-keyword">where</span><span> </span><a name="local-1628276535"><a href="#local-1628276535"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a><span> </span><a href="#local-1628276534"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1876"></a><span>
</span><a name="line-1877"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyDeriv 2&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1878"></a><span>         </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276518"><span class="hs-identifier hs-var">tvs_skols</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276529"><span class="hs-identifier hs-var">residual_simple</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276530"><span class="hs-identifier hs-var">good</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276531"><span class="hs-identifier hs-var">bad</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1879"></a><span>
</span><a name="line-1880"></a><span>       </span><span class="hs-comment">-- If we are deferring type errors, simply ignore any insoluble</span><span>
</span><a name="line-1881"></a><span>       </span><span class="hs-comment">-- constraints.  They'll come up again when we typecheck the</span><span>
</span><a name="line-1882"></a><span>       </span><span class="hs-comment">-- generated instance declaration</span><span>
</span><a name="line-1883"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628276536"><a href="#local-1628276536"><span class="hs-identifier">defer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><a href="DynFlags.html#Opt_DeferTypeErrors"><span class="hs-identifier hs-var">Opt_DeferTypeErrors</span></a><span>
</span><a name="line-1884"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628276537"><a href="#local-1628276537"><span class="hs-identifier">implic</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#buildImplicationFor"><span class="hs-identifier hs-var">buildImplicationFor</span></a><span> </span><a href="#local-1628276527"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-1628276520"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-1628276518"><span class="hs-identifier hs-var">tvs_skols</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-1628276532"><span class="hs-identifier hs-var">unsolved</span></a><span>
</span><a name="line-1885"></a><span>                   </span><span class="hs-comment">-- The buildImplicationFor is just to bind the skolems,</span><span>
</span><a name="line-1886"></a><span>                   </span><span class="hs-comment">-- in case they are mentioned in error messages</span><span>
</span><a name="line-1887"></a><span>                   </span><span class="hs-comment">-- See Trac #11347</span><span>
</span><a name="line-1888"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><a href="#local-1628276536"><span class="hs-identifier hs-var">defer</span></a><span> </span><span class="hs-special">(</span><a href="TcErrors.html#reportAllUnsolved"><span class="hs-identifier hs-var">reportAllUnsolved</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#mkImplicWC"><span class="hs-identifier hs-var">mkImplicWC</span></a><span> </span><a href="#local-1628276537"><span class="hs-identifier hs-var">implic</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1889"></a><span>
</span><a name="line-1890"></a><span>
</span><a name="line-1891"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276538"><a href="#local-1628276538"><span class="hs-identifier">min_theta</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#mkMinimalBySCs"><span class="hs-identifier hs-var">mkMinimalBySCs</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628276530"><span class="hs-identifier hs-var">good</span></a><span class="hs-special">)</span><span>
</span><a name="line-1892"></a><span>             </span><a name="local-1628276539"><a href="#local-1628276539"><span class="hs-identifier">subst_skol</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#zipTvSubst"><span class="hs-identifier hs-var">zipTvSubst</span></a><span> </span><a href="#local-1628276518"><span class="hs-identifier hs-var">tvs_skols</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><a href="#local-1628276515"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1893"></a><span>                          </span><span class="hs-comment">-- The reverse substitution (sigh)</span><span>
</span><a name="line-1894"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTheta"><span class="hs-identifier hs-var">substTheta</span></a><span> </span><a href="#local-1628276539"><span class="hs-identifier hs-var">subst_skol</span></a><span> </span><a href="#local-1628276538"><span class="hs-identifier hs-var">min_theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1895"></a><span>
</span><a name="line-1896"></a><span class="hs-comment">{-
Note [Overlap and deriving]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider some overlapping instances:
  data Show a =&gt; Show [a] where ..
  data Show [Char] where ...

Now a data type with deriving:
  data T a = MkT [a] deriving( Show )

We want to get the derived instance
  instance Show [a] =&gt; Show (T a) where...
and NOT
  instance Show a =&gt; Show (T a) where...
so that the (Show (T Char)) instance does the Right Thing

It's very like the situation when we're inferring the type
of a function
   f x = show [x]
and we want to infer
   f :: Show [a] =&gt; a -&gt; String

BOTTOM LINE: use vanilla, non-overlappable skolems when inferring
             the context for the derived instance.
             Hence tcInstSkolTyVars not tcInstSuperSkolTyVars

Note [Exotic derived instance contexts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a 'derived' instance declaration, we *infer* the context.  It's a
bit unclear what rules we should apply for this; the Haskell report is
silent.  Obviously, constraints like (Eq a) are fine, but what about
        data T f a = MkT (f a) deriving( Eq )
where we'd get an Eq (f a) constraint.  That's probably fine too.

One could go further: consider
        data T a b c = MkT (Foo a b c) deriving( Eq )
        instance (C Int a, Eq b, Eq c) =&gt; Eq (Foo a b c)

Notice that this instance (just) satisfies the Paterson termination
conditions.  Then we *could* derive an instance decl like this:

        instance (C Int a, Eq b, Eq c) =&gt; Eq (T a b c)
even though there is no instance for (C Int a), because there just
*might* be an instance for, say, (C Int Bool) at a site where we
need the equality instance for T's.

However, this seems pretty exotic, and it's quite tricky to allow
this, and yet give sensible error messages in the (much more common)
case where we really want that instance decl for C.

So for now we simply require that the derived instance context
should have only type-variable constraints.

Here is another example:
        data Fix f = In (f (Fix f)) deriving( Eq )
Here, if we are prepared to allow -XUndecidableInstances we
could derive the instance
        instance Eq (f (Fix f)) =&gt; Eq (Fix f)
but this is so delicate that I don't think it should happen inside
'deriving'. If you want this, write it yourself!

NB: if you want to lift this condition, make sure you still meet the
termination conditions!  If not, the deriving mechanism generates
larger and larger constraints.  Example:
  data Succ a = S a
  data Seq a = Cons a (Seq (Succ a)) | Nil deriving Show

Note the lack of a Show instance for Succ.  First we'll generate
  instance (Show (Succ a), Show a) =&gt; Show (Seq a)
and then
  instance (Show (Succ (Succ a)), Show (Succ a), Show a) =&gt; Show (Seq a)
and so on.  Instead we want to complain of no instance for (Show (Succ a)).

The bottom line
~~~~~~~~~~~~~~~
Allow constraints which consist only of type variables, with no repeats.


************************************************************************
*                                                                      *
\subsection[TcDeriv-normal-binds]{Bindings for the various classes}
*                                                                      *
************************************************************************

After all the trouble to figure out the required context for the
derived instance declarations, all that's left is to chug along to
produce them.  They will then be shoved into @tcInstDecls2@, which
will do all its usual business.

There are lots of possibilities for code to generate.  Here are
various general remarks.

PRINCIPLES:
\begin{itemize}
\item
We want derived instances of @Eq@ and @Ord@ (both v common) to be
``you-couldn't-do-better-by-hand'' efficient.

\item
Deriving @Show@---also pretty common--- should also be reasonable good code.

\item
Deriving for the other classes isn't that common or that big a deal.
\end{itemize}

PRAGMATICS:

\begin{itemize}
\item
Deriving @Ord@ is done mostly with the 1.3 @compare@ method.

\item
Deriving @Eq@ also uses @compare@, if we're deriving @Ord@, too.

\item
We {\em normally} generate code only for the non-defaulted methods;
there are some exceptions for @Eq@ and (especially) @Ord@...

\item
Sometimes we use a @_con2tag_&lt;tycon&gt;@ function, which returns a data
constructor's numeric (@Int#@) tag.  These are generated by
@gen_tag_n_con_binds@, and the heuristic for deciding if one of
these is around is given by @hasCon2TagFun@.

The examples under the different sections below will make this
clearer.

\item
Much less often (really just for deriving @Ix@), we use a
@_tag2con_&lt;tycon&gt;@ function.  See the examples.

\item
We use the renamer!!!  Reason: we're supposed to be
producing @LHsBinds Name@ for the methods, but that means
producing correctly-uniquified code on the fly.  This is entirely
possible (the @TcM@ monad has a @UniqueSupply@), but it is painful.
So, instead, we produce @MonoBinds RdrName@ then heave 'em through
the renamer.  What a great hack!
\end{itemize}
-}</span><span>
</span><a name="line-2036"></a><span>
</span><a name="line-2037"></a><span class="hs-comment">-- Generate the InstInfo for the required instance paired with the</span><span>
</span><a name="line-2038"></a><span class="hs-comment">--   *representation* tycon for that instance,</span><span>
</span><a name="line-2039"></a><span class="hs-comment">-- plus any auxiliary bindings required</span><span>
</span><a name="line-2040"></a><span class="hs-comment">--</span><span>
</span><a name="line-2041"></a><span class="hs-comment">-- Representation tycons differ from the tycon in the instance signature in</span><span>
</span><a name="line-2042"></a><span class="hs-comment">-- case of instances for indexed families.</span><span>
</span><a name="line-2043"></a><span class="hs-comment">--</span><span>
</span><a name="line-2044"></a><span class="hs-identifier">genInst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDeriv.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span>
</span><a name="line-2045"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="RdrName.html#RdrName"><span class="hs-identifier hs-type">RdrName</span></a><span class="hs-special">,</span><span> </span><a href="TcGenDeriv.html#BagDerivStuff"><span class="hs-identifier hs-type">BagDerivStuff</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2046"></a><a name="genInst"><a href="TcDeriv.html#genInst"><span class="hs-identifier">genInst</span></a></a><span> </span><a name="local-1628276540"><a href="#local-1628276540"><span class="hs-identifier">spec</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcDeriv.html#DS"><span class="hs-identifier hs-var">DS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276541"><a href="#local-1628276541"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276542"><a href="#local-1628276542"><span class="hs-identifier">rep_tycon</span></a></a><span>
</span><a name="line-2047"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276543"><a href="#local-1628276543"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_newtype</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276544"><a href="#local-1628276544"><span class="hs-identifier">is_newtype</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276545"><a href="#local-1628276545"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-2048"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276546"><a href="#local-1628276546"><span class="hs-identifier">dfun_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_cls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276547"><a href="#local-1628276547"><span class="hs-identifier">clas</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628276548"><a href="#local-1628276548"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2049"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628276549"><a href="#local-1628276549"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628276544"><span class="hs-identifier hs-var">is_newtype</span></a><span>   </span><span class="hs-comment">-- See Note [Bindings for Generalised Newtype Deriving]</span><span>
</span><a name="line-2050"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276550"><a href="#local-1628276550"><span class="hs-identifier">inst_spec</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#newDerivClsInst"><span class="hs-identifier hs-var">newDerivClsInst</span></a><span> </span><a href="#local-1628276543"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-1628276540"><span class="hs-identifier hs-var">spec</span></a><span>
</span><a name="line-2051"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;genInst/is_newtype&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276548"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276547"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276541"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276545"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276549"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2052"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-var">InstInfo</span></a><span>
</span><a name="line-2053"></a><span>                    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">iSpec</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276550"><span class="hs-identifier hs-var">inst_spec</span></a><span>
</span><a name="line-2054"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">iBinds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#InstBindings"><span class="hs-identifier hs-var">InstBindings</span></a><span>
</span><a name="line-2055"></a><span>                        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ib_binds</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcGenDeriv.html#gen_Newtype_binds"><span class="hs-identifier hs-var">gen_Newtype_binds</span></a><span> </span><a href="#local-1628276548"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-1628276547"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-1628276541"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-1628276545"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-1628276549"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-2056"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_tyvars</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-identifier">Var</span><span class="hs-operator">.</span><span class="hs-identifier">varName</span><span> </span><a href="#local-1628276541"><span class="hs-identifier hs-var">tvs</span></a><span>   </span><span class="hs-comment">-- Scope over bindings</span><span>
</span><a name="line-2057"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_pragmas</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2058"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_extensions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#ImpredicativeTypes"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ImpredicativeTypes</span></a><span>
</span><a name="line-2059"></a><span>                                          </span><span class="hs-special">,</span><span> </span><a href="../ghc-boot-8.1/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html#RankNTypes"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">RankNTypes</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2060"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_derived</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2061"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span>
</span><a name="line-2062"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Name.html#getName"><span class="hs-identifier hs-var">getName</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#head"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-1628276542"><span class="hs-identifier hs-var">rep_tycon</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2063"></a><span>              </span><span class="hs-comment">-- See Note [Newtype deriving and unused constructors]</span><span>
</span><a name="line-2064"></a><span>
</span><a name="line-2065"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2066"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628276551"><a href="#local-1628276551"><span class="hs-identifier">meth_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276552"><a href="#local-1628276552"><span class="hs-identifier">deriv_stuff</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#genDerivStuff"><span class="hs-identifier hs-var">genDerivStuff</span></a><span> </span><a href="#local-1628276548"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-1628276547"><span class="hs-identifier hs-var">clas</span></a><span>
</span><a name="line-2067"></a><span>                                        </span><a href="#local-1628276546"><span class="hs-identifier hs-var">dfun_name</span></a><span> </span><a href="#local-1628276542"><span class="hs-identifier hs-var">rep_tycon</span></a><span>
</span><a name="line-2068"></a><span>                                        </span><a href="#local-1628276545"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-1628276541"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-2069"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628276553"><a href="#local-1628276553"><span class="hs-identifier">inst_spec</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#newDerivClsInst"><span class="hs-identifier hs-var">newDerivClsInst</span></a><span> </span><a href="#local-1628276543"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-1628276540"><span class="hs-identifier hs-var">spec</span></a><span>
</span><a name="line-2070"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;newder&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276553"><span class="hs-identifier hs-var">inst_spec</span></a><span class="hs-special">)</span><span>
</span><a name="line-2071"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276554"><a href="#local-1628276554"><span class="hs-identifier">inst_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-var">InstInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">iSpec</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276553"><span class="hs-identifier hs-var">inst_spec</span></a><span>
</span><a name="line-2072"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">iBinds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#InstBindings"><span class="hs-identifier hs-var">InstBindings</span></a><span>
</span><a name="line-2073"></a><span>                                                </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ib_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628276551"><span class="hs-identifier hs-var">meth_binds</span></a><span>
</span><a name="line-2074"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_tyvars</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-identifier">Var</span><span class="hs-operator">.</span><span class="hs-identifier">varName</span><span> </span><a href="#local-1628276541"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-2075"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_pragmas</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2076"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_extensions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2077"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ib_derived</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2078"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-1628276554"><span class="hs-identifier hs-var">inst_info</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628276552"><span class="hs-identifier hs-var">deriv_stuff</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2079"></a><span>
</span><a name="line-2080"></a><span class="hs-comment">-- Generate the bindings needed for a derived class that isn't handled by</span><span>
</span><a name="line-2081"></a><span class="hs-comment">-- -XGeneralizedNewtypeDeriving.</span><span>
</span><a name="line-2082"></a><span class="hs-identifier">genDerivStuff</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-2083"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="HsBinds.html#LHsBinds"><span class="hs-identifier hs-type">LHsBinds</span></a><span> </span><a href="RdrName.html#RdrName"><span class="hs-identifier hs-type">RdrName</span></a><span class="hs-special">,</span><span> </span><a href="TcGenDeriv.html#BagDerivStuff"><span class="hs-identifier hs-type">BagDerivStuff</span></a><span class="hs-special">)</span><span>
</span><a name="line-2084"></a><a name="genDerivStuff"><a href="TcDeriv.html#genDerivStuff"><span class="hs-identifier">genDerivStuff</span></a></a><span> </span><a name="local-1628276555"><a href="#local-1628276555"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-1628276556"><a href="#local-1628276556"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-1628276557"><a href="#local-1628276557"><span class="hs-identifier">dfun_name</span></a></a><span> </span><a name="local-1628276558"><a href="#local-1628276558"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-1628276559"><a href="#local-1628276559"><span class="hs-identifier">inst_tys</span></a></a><span> </span><a name="local-1628276560"><a href="#local-1628276560"><span class="hs-identifier">tyvars</span></a></a><span>
</span><a name="line-2085"></a><span>  </span><span class="hs-comment">-- Special case for DeriveGeneric</span><span>
</span><a name="line-2086"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276566"><a href="#local-1628276566"><span class="hs-identifier">ck</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classKey</span><span> </span><a href="#local-1628276556"><span class="hs-identifier hs-var">clas</span></a><span>
</span><a name="line-2087"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-1628276566"><span class="hs-identifier hs-var">ck</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="PrelNames.html#genClassKey"><span class="hs-identifier hs-var">genClassKey</span></a><span class="hs-special">,</span><span> </span><a href="PrelNames.html#gen1ClassKey"><span class="hs-identifier hs-var">gen1ClassKey</span></a><span class="hs-special">]</span><span>
</span><a name="line-2088"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276567"><a href="#local-1628276567"><span class="hs-identifier">gk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628276566"><span class="hs-identifier hs-var">ck</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PrelNames.html#genClassKey"><span class="hs-identifier hs-var">genClassKey</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="TcGenGenerics.html#Gen0"><span class="hs-identifier hs-var">Gen0</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="TcGenGenerics.html#Gen1"><span class="hs-identifier hs-var">Gen1</span></a><span>
</span><a name="line-2089"></a><span>        </span><span class="hs-comment">-- TODO NSF: correctly identify when we're building Both instead of One</span><span>
</span><a name="line-2090"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2091"></a><span>      </span><span class="hs-special">(</span><a name="local-1628276568"><a href="#local-1628276568"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628276569"><a href="#local-1628276569"><span class="hs-identifier">faminst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcGenGenerics.html#gen_Generic_binds"><span class="hs-identifier hs-var">gen_Generic_binds</span></a><span> </span><a href="#local-1628276567"><span class="hs-identifier hs-var">gk</span></a><span> </span><a href="#local-1628276558"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a><span> </span><a href="#local-1628276557"><span class="hs-identifier hs-var">dfun_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2092"></a><span>      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276568"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">,</span><span> </span><a href="Bag.html#unitBag"><span class="hs-identifier hs-var">unitBag</span></a><span> </span><span class="hs-special">(</span><a href="TcGenDeriv.html#DerivFamInst"><span class="hs-identifier hs-var">DerivFamInst</span></a><span> </span><a href="#local-1628276569"><span class="hs-identifier hs-var">faminst</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2093"></a><span>
</span><a name="line-2094"></a><span>  </span><span class="hs-comment">-- Not deriving Generic(1), so we first check if the compiler has built-in</span><span>
</span><a name="line-2095"></a><span>  </span><span class="hs-comment">-- support for deriving the class in question.</span><span>
</span><a name="line-2096"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2097"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276570"><a href="#local-1628276570"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-2098"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628276571"><a href="#local-1628276571"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDeriv.html#getDataConFixityFun"><span class="hs-identifier hs-var">getDataConFixityFun</span></a><span> </span><a href="#local-1628276558"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-2099"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcGenDeriv.html#hasBuiltinDeriving"><span class="hs-identifier hs-var">hasBuiltinDeriving</span></a><span> </span><a href="#local-1628276570"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628276571"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><a href="#local-1628276556"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2100"></a><span>              </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628276572"><a href="#local-1628276572"><span class="hs-identifier">gen_fn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276572"><span class="hs-identifier hs-var">gen_fn</span></a><span> </span><a href="#local-1628276555"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-1628276558"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-2101"></a><span>              </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628276561"><span class="hs-identifier hs-var">genDerivAnyClass</span></a><span> </span><a href="#local-1628276570"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2102"></a><span>
</span><a name="line-2103"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2104"></a><span>    </span><span class="hs-identifier">genDerivAnyClass</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="HsBinds.html#LHsBinds"><span class="hs-identifier hs-type">LHsBinds</span></a><span> </span><a href="RdrName.html#RdrName"><span class="hs-identifier hs-type">RdrName</span></a><span class="hs-special">,</span><span> </span><a href="TcGenDeriv.html#BagDerivStuff"><span class="hs-identifier hs-type">BagDerivStuff</span></a><span class="hs-special">)</span><span>
</span><a name="line-2105"></a><span>    </span><a name="local-1628276561"><a href="#local-1628276561"><span class="hs-identifier">genDerivAnyClass</span></a></a><span> </span><a name="local-1628276562"><a href="#local-1628276562"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2106"></a><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- If there isn't compiler support for deriving the class, our last</span><span>
</span><a name="line-2107"></a><span>           </span><span class="hs-comment">-- resort is -XDeriveAnyClass (since -XGeneralizedNewtypeDeriving</span><span>
</span><a name="line-2108"></a><span>           </span><span class="hs-comment">-- fell through).</span><span>
</span><a name="line-2109"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-1628276563"><a href="#local-1628276563"><span class="hs-identifier">mini_env</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyVars</span><span> </span><a href="#local-1628276556"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628276559"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-2110"></a><span>              </span><a name="local-1628276564"><a href="#local-1628276564"><span class="hs-identifier">mini_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTvSubst"><span class="hs-identifier hs-var">mkTvSubst</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-1628276560"><span class="hs-identifier hs-var">tyvars</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1628276563"><span class="hs-identifier hs-var">mini_env</span></a><span>
</span><a name="line-2111"></a><span>
</span><a name="line-2112"></a><span>         </span><span class="hs-special">;</span><span> </span><a name="local-1628276565"><a href="#local-1628276565"><span class="hs-identifier">tyfam_insts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-2113"></a><span>             </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">canDeriveAnyClass</span><span> </span><a href="TcDeriv.html#canDeriveAnyClass"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="TcDeriv.html#canDeriveAnyClass"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-1628276562"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span>
</span><a name="line-2114"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-string">&quot;genDerivStuff: bad derived class&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">clas</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2115"></a><span>             </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcClassDcl.html#tcATDefault"><span class="hs-identifier hs-var">tcATDefault</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-1628276555"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-1628276564"><span class="hs-identifier hs-var">mini_subst</span></a><span> </span><a href="NameSet.html#emptyNameSet"><span class="hs-identifier hs-var">emptyNameSet</span></a><span class="hs-special">)</span><span>
</span><a name="line-2116"></a><span>                  </span><span class="hs-special">(</span><a href="Class.html#classATItems"><span class="hs-identifier hs-var">classATItems</span></a><span> </span><a href="#local-1628276556"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span>
</span><a name="line-2117"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span> </span><span class="hs-comment">-- No method bindings are needed...</span><span>
</span><a name="line-2118"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Bag.html#listToBag"><span class="hs-identifier hs-var">listToBag</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="TcGenDeriv.html#DerivFamInst"><span class="hs-identifier hs-var">DerivFamInst</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a><span> </span><a href="#local-1628276565"><span class="hs-identifier hs-var">tyfam_insts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2119"></a><span>                  </span><span class="hs-comment">-- ...but we may need to generate binding for associated type</span><span>
</span><a name="line-2120"></a><span>                  </span><span class="hs-comment">-- family default instances.</span><span>
</span><a name="line-2121"></a><span>                  </span><span class="hs-comment">-- See Note [DeriveAnyClass and default family instances]</span><span>
</span><a name="line-2122"></a><span>                  </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2123"></a><span>
</span><a name="line-2124"></a><span class="hs-identifier">getDataConFixityFun</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Fixity"><span class="hs-identifier hs-type">Fixity</span></a><span class="hs-special">)</span><span>
</span><a name="line-2125"></a><span class="hs-comment">-- If the TyCon is locally defined, we want the local fixity env;</span><span>
</span><a name="line-2126"></a><span class="hs-comment">-- but if it is imported (which happens for standalone deriving)</span><span>
</span><a name="line-2127"></a><span class="hs-comment">-- we need to get the fixity env from the interface file</span><span>
</span><a name="line-2128"></a><span class="hs-comment">-- c.f. RnEnv.lookupFixity, and Trac #9830</span><span>
</span><a name="line-2129"></a><a name="getDataConFixityFun"><a href="TcDeriv.html#getDataConFixityFun"><span class="hs-identifier">getDataConFixityFun</span></a></a><span> </span><a name="local-1628276573"><a href="#local-1628276573"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-2130"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276576"><a href="#local-1628276576"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a><span>
</span><a name="line-2131"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-var">nameIsLocalOrFrom</span></a><span> </span><a href="#local-1628276576"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-1628276574"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2132"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276577"><a href="#local-1628276577"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getFixityEnv"><span class="hs-identifier hs-var">getFixityEnv</span></a><span>
</span><a name="line-2133"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="HscTypes.html#lookupFixity"><span class="hs-identifier hs-var">lookupFixity</span></a><span> </span><a href="#local-1628276577"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2134"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628276578"><a href="#local-1628276578"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#loadInterfaceForName"><span class="hs-identifier hs-var">loadInterfaceForName</span></a><span> </span><a href="#local-1628276575"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-1628276574"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2135"></a><span>                            </span><span class="hs-comment">-- Should already be loaded!</span><span>
</span><a name="line-2136"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="HscTypes.html#mi_fix"><span class="hs-identifier hs-var">mi_fix</span></a><span> </span><a href="#local-1628276578"><span class="hs-identifier hs-var">iface</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="Name.html#nameOccName"><span class="hs-identifier hs-var">nameOccName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2137"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2138"></a><span>    </span><a name="local-1628276574"><a href="#local-1628276574"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-1628276573"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2139"></a><span>    </span><a name="local-1628276575"><a href="#local-1628276575"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Data con fixities for&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276574"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2140"></a><span>
</span><a name="line-2141"></a><span class="hs-comment">{-
Note [Bindings for Generalised Newtype Deriving]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  class Eq a =&gt; C a where
     f :: a -&gt; a
  newtype N a = MkN [a] deriving( C )
  instance Eq (N a) where ...

The 'deriving C' clause generates, in effect
  instance (C [a], Eq a) =&gt; C (N a) where
     f = coerce (f :: [a] -&gt; [a])

This generates a cast for each method, but allows the superclasse to
be worked out in the usual way.  In this case the superclass (Eq (N
a)) will be solved by the explicit Eq (N a) instance.  We do *not*
create the superclasses by casting the superclass dictionaries for the
representation type.

See the paper &quot;Safe zero-cost coercions for Hsakell&quot;.

Note [DeriveAnyClass and default family instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When a class has a associated type family with a default instance, e.g.:

  class C a where
    type T a
    type T a = Char

then there are a couple of scenarios in which a user would expect T a to
default to Char. One is when an instance declaration for C is given without
an implementation for T:

  instance C Int

Another scenario in which this can occur is when the -XDeriveAnyClass extension
is used:

  data Example = Example deriving (C, Generic)

In the latter case, we must take care to check if C has any associated type
families with default instances, because -XDeriveAnyClass will never provide
an implementation for them. We &quot;fill in&quot; the default instances using the
tcATDefault function from TcClsDcl (which is also used in TcInstDcls to handle
the empty instance declaration case).

************************************************************************
*                                                                      *
\subsection[TcDeriv-taggery-Names]{What con2tag/tag2con functions are available?}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2194"></a><span>
</span><a name="line-2195"></a><span class="hs-identifier">derivingNullaryErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span>
</span><a name="line-2196"></a><a name="derivingNullaryErr"><a href="TcDeriv.html#derivingNullaryErr"><span class="hs-identifier">derivingNullaryErr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Cannot derive instances for nullary classes&quot;</span><span>
</span><a name="line-2197"></a><span>
</span><a name="line-2198"></a><span class="hs-identifier">derivingKindErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span>
</span><a name="line-2199"></a><a name="derivingKindErr"><a href="TcDeriv.html#derivingKindErr"><span class="hs-identifier">derivingKindErr</span></a></a><span> </span><a name="local-1628276579"><a href="#local-1628276579"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1628276580"><a href="#local-1628276580"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-1628276581"><a href="#local-1628276581"><span class="hs-identifier">cls_tys</span></a></a><span> </span><a name="local-1628276582"><a href="#local-1628276582"><span class="hs-identifier">cls_kind</span></a></a><span>
</span><a name="line-2200"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Cannot derive well-kinded instance of form&quot;</span><span>
</span><a name="line-2201"></a><span>                </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#pprClassPred"><span class="hs-identifier hs-var">pprClassPred</span></a><span> </span><a href="#local-1628276580"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-1628276581"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276579"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;...&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2202"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Class&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276580"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-2203"></a><span>            </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;expects an argument of kind&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#pprKind"><span class="hs-identifier hs-var">pprKind</span></a><span> </span><a href="#local-1628276582"><span class="hs-identifier hs-var">cls_kind</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2204"></a><span>
</span><a name="line-2205"></a><span class="hs-identifier">derivingEtaErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span>
</span><a name="line-2206"></a><a name="derivingEtaErr"><a href="TcDeriv.html#derivingEtaErr"><span class="hs-identifier">derivingEtaErr</span></a></a><span> </span><a name="local-1628276583"><a href="#local-1628276583"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-1628276584"><a href="#local-1628276584"><span class="hs-identifier">cls_tys</span></a></a><span> </span><a name="local-1628276585"><a href="#local-1628276585"><span class="hs-identifier">inst_ty</span></a></a><span>
</span><a name="line-2207"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Cannot eta-reduce to an instance of form&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-2208"></a><span>         </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;instance (...) =&gt;&quot;</span><span>
</span><a name="line-2209"></a><span>                </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TyCoRep.html#pprClassPred"><span class="hs-identifier hs-var">pprClassPred</span></a><span> </span><a href="#local-1628276583"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276584"><span class="hs-identifier hs-var">cls_tys</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628276585"><span class="hs-identifier hs-var">inst_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2210"></a><span>
</span><a name="line-2211"></a><span class="hs-identifier">derivingThingErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span>
</span><a name="line-2212"></a><a name="derivingThingErr"><a href="TcDeriv.html#derivingThingErr"><span class="hs-identifier">derivingThingErr</span></a></a><span> </span><a name="local-1628276586"><a href="#local-1628276586"><span class="hs-identifier">newtype_deriving</span></a></a><span> </span><a name="local-1628276587"><a href="#local-1628276587"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-1628276588"><a href="#local-1628276588"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-1628276589"><a href="#local-1628276589"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1628276590"><a href="#local-1628276590"><span class="hs-identifier">why</span></a></a><span>
</span><a name="line-2213"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Can't make a derived instance of&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2214"></a><span>             </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276592"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2215"></a><span>          </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="#local-1628276591"><span class="hs-identifier hs-var">extra</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a><span class="hs-special">,</span><span>
</span><a name="line-2216"></a><span>         </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="#local-1628276590"><span class="hs-identifier hs-var">why</span></a><span class="hs-special">]</span><span>
</span><a name="line-2217"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2218"></a><span>    </span><a name="local-1628276591"><a href="#local-1628276591"><span class="hs-identifier">extra</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628276586"><span class="hs-identifier hs-var">newtype_deriving</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;(even with cunning GeneralizedNewtypeDeriving)&quot;</span><span>
</span><a name="line-2219"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">Outputable</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-2220"></a><span>    </span><a name="local-1628276592"><a href="#local-1628276592"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-1628276587"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628276588"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-special">[</span><a href="#local-1628276589"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2221"></a><span>
</span><a name="line-2222"></a><span class="hs-identifier">derivingHiddenErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-2223"></a><a name="derivingHiddenErr"><a href="TcDeriv.html#derivingHiddenErr"><span class="hs-identifier">derivingHiddenErr</span></a></a><span> </span><a name="local-1628276593"><a href="#local-1628276593"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-2224"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;The data constructors of&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276593"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ptext"><span class="hs-identifier hs-var">ptext</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#sLit"><span class="hs-identifier hs-var">sLit</span></a><span> </span><span class="hs-string">&quot;are not all in scope&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2225"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;so you cannot derive an instance for it&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2226"></a><span>
</span><a name="line-2227"></a><span class="hs-identifier">standaloneCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsTypes.html#LHsSigType"><span class="hs-identifier hs-type">LHsSigType</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-2228"></a><a name="standaloneCtxt"><a href="TcDeriv.html#standaloneCtxt"><span class="hs-identifier">standaloneCtxt</span></a></a><span> </span><a name="local-1628276594"><a href="#local-1628276594"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;In the stand-alone deriving instance for&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2229"></a><span>                       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276594"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2230"></a><span>
</span><a name="line-2231"></a><span class="hs-identifier">derivInstCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span>
</span><a name="line-2232"></a><a name="derivInstCtxt"><a href="TcDeriv.html#derivInstCtxt"><span class="hs-identifier">derivInstCtxt</span></a></a><span> </span><a name="local-1628276595"><a href="#local-1628276595"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-2233"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;When deriving the instance for&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628276595"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-2234"></a></pre></body></html>