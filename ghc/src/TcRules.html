<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The AQUA Project, Glasgow University, 1993-1998


TcRules: Typechecking transformation rules
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcRules</span><span> </span><span class="hs-special">(</span><span> </span><a href="TcRules.html#tcRules"><span class="hs-identifier hs-var">tcRules</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="HsSyn.html"><span class="hs-identifier">HsSyn</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="TcSimplify.html"><span class="hs-identifier">TcSimplify</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="TcType.html"><span class="hs-identifier">TcType</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsType.html"><span class="hs-identifier">TcHsType</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="TcExpr.html"><span class="hs-identifier">TcExpr</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="TcEvidence.html"><span class="hs-identifier">TcEvidence</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span class="hs-special">(</span><span> </span><a href="TcUnify.html#buildImplicationFor"><span class="hs-identifier hs-var">buildImplicationFor</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>              </span><span class="hs-special">(</span><span> </span><a href="Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="BasicTypes.html#RuleName"><span class="hs-identifier hs-type">RuleName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Bag.html"><span class="hs-identifier">Bag</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-comment">{-
Note [Typechecking rules]
~~~~~~~~~~~~~~~~~~~~~~~~~
We *infer* the typ of the LHS, and use that type to *check* the type of
the RHS.  That means that higher-rank rules work reasonably well. Here's
an example (test simplCore/should_compile/rule2.hs) produced by Roman:

   foo :: (forall m. m a -&gt; m b) -&gt; m a -&gt; m b
   foo f = ...

   bar :: (forall m. m a -&gt; m a) -&gt; m a -&gt; m a
   bar f = ...

   {-# RULES &quot;foo/bar&quot; foo = bar #-}

He wanted the rule to typecheck.
-}</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-identifier">tcRules</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LRuleDecls"><span class="hs-identifier hs-type">LRuleDecls</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LRuleDecls"><span class="hs-identifier hs-type">LRuleDecls</span></a><span> </span><a href="TcRnTypes.html#TcId"><span class="hs-identifier hs-type">TcId</span></a><span class="hs-special">]</span><span>
</span><a name="line-53"></a><a name="tcRules"><a href="TcRules.html#tcRules"><span class="hs-identifier">tcRules</span></a></a><span> </span><a name="local-1628275480"><a href="#local-1628275480"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="TcRules.html#tcRuleDecls"><span class="hs-identifier hs-var">tcRuleDecls</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628275480"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-identifier">tcRuleDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#RuleDecls"><span class="hs-identifier hs-type">RuleDecls</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#RuleDecls"><span class="hs-identifier hs-type">RuleDecls</span></a><span> </span><a href="TcRnTypes.html#TcId"><span class="hs-identifier hs-type">TcId</span></a><span class="hs-special">)</span><span>
</span><a name="line-56"></a><a name="tcRuleDecls"><a href="TcRules.html#tcRuleDecls"><span class="hs-identifier">tcRuleDecls</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsRules"><span class="hs-identifier hs-var">HsRules</span></a><span> </span><a name="local-1628275481"><a href="#local-1628275481"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-1628275482"><a href="#local-1628275482"><span class="hs-identifier">decls</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628275483"><a href="#local-1628275483"><span class="hs-identifier">tc_decls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="TcRules.html#tcRule"><span class="hs-identifier hs-var">tcRule</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628275482"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-58"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsRules"><span class="hs-identifier hs-var">HsRules</span></a><span> </span><a href="#local-1628275481"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-1628275483"><span class="hs-identifier hs-var">tc_decls</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-identifier">tcRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#RuleDecl"><span class="hs-identifier hs-type">RuleDecl</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#RuleDecl"><span class="hs-identifier hs-type">RuleDecl</span></a><span> </span><a href="TcRnTypes.html#TcId"><span class="hs-identifier hs-type">TcId</span></a><span class="hs-special">)</span><span>
</span><a name="line-61"></a><a name="tcRule"><a href="TcRules.html#tcRule"><span class="hs-identifier">tcRule</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsRule"><span class="hs-identifier hs-var">HsRule</span></a><span> </span><a name="local-1628275484"><a href="#local-1628275484"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-1628275485"><a href="#local-1628275485"><span class="hs-identifier">act</span></a></a><span> </span><a name="local-1628275486"><a href="#local-1628275486"><span class="hs-identifier">hs_bndrs</span></a></a><span> </span><a name="local-1628275487"><a href="#local-1628275487"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-1628275488"><a href="#local-1628275488"><span class="hs-identifier">fv_lhs</span></a></a><span> </span><a name="local-1628275489"><a href="#local-1628275489"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-1628275490"><a href="#local-1628275490"><span class="hs-identifier">fv_rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcRules.html#ruleCtxt"><span class="hs-identifier hs-var">ruleCtxt</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-1628275484"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-63"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;---- Rule ------&quot;</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#pprFullRuleName"><span class="hs-identifier hs-var">pprFullRuleName</span></a><span> </span><a href="#local-1628275484"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span>        </span><span class="hs-comment">-- Note [Typechecking rules]</span><span>
</span><a name="line-66"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628275491"><a href="#local-1628275491"><span class="hs-identifier">vars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628275492"><a href="#local-1628275492"><span class="hs-identifier">bndr_wanted</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-67"></a><span>                                </span><a href="TcRules.html#tcRuleBndrs"><span class="hs-identifier hs-var">tcRuleBndrs</span></a><span> </span><a href="#local-1628275486"><span class="hs-identifier hs-var">hs_bndrs</span></a><span>
</span><a name="line-68"></a><span>              </span><span class="hs-comment">-- bndr_wanted constraints can include wildcard hole</span><span>
</span><a name="line-69"></a><span>              </span><span class="hs-comment">-- constraints, which we should not forget about.</span><span>
</span><a name="line-70"></a><span>              </span><span class="hs-comment">-- It may mention the skolem type variables bound by</span><span>
</span><a name="line-71"></a><span>              </span><span class="hs-comment">-- the RULE.  c.f. Trac #10072</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628275493"><a href="#local-1628275493"><span class="hs-identifier">id_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628275494"><a href="#local-1628275494"><span class="hs-identifier">tv_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-1628275491"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-74"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628275500"><a href="#local-1628275500"><span class="hs-identifier">lhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628275501"><a href="#local-1628275501"><span class="hs-identifier">lhs_wanted</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628275502"><a href="#local-1628275502"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628275503"><a href="#local-1628275503"><span class="hs-identifier">rhs_wanted</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628275504"><a href="#local-1628275504"><span class="hs-identifier">rule_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendTyVarEnv"><span class="hs-identifier hs-var">tcExtendTyVarEnv</span></a><span> </span><a href="#local-1628275494"><span class="hs-identifier hs-var">tv_bndrs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-76"></a><span>               </span><a href="TcEnv.html#tcExtendIdEnv"><span class="hs-identifier hs-var">tcExtendIdEnv</span></a><span>    </span><a href="#local-1628275493"><span class="hs-identifier hs-var">id_bndrs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-77"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- See Note [Solve order for RULES]</span><span>
</span><a name="line-78"></a><span>                    </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-1628275495"><a href="#local-1628275495"><span class="hs-identifier">lhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628275496"><a href="#local-1628275496"><span class="hs-identifier">rule_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-1628275497"><a href="#local-1628275497"><span class="hs-identifier">lhs_wanted</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#tcInferRho"><span class="hs-identifier hs-var">tcInferRho</span></a><span> </span><a href="#local-1628275487"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628275498"><a href="#local-1628275498"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628275499"><a href="#local-1628275499"><span class="hs-identifier">rhs_wanted</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-80"></a><span>                                          </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-1628275489"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628275496"><span class="hs-identifier hs-var">rule_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628275495"><span class="hs-identifier hs-var">lhs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628275497"><span class="hs-identifier hs-var">lhs_wanted</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628275498"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628275499"><span class="hs-identifier hs-var">rhs_wanted</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628275496"><span class="hs-identifier hs-var">rule_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcRule 1&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="HsDecls.html#pprFullRuleName"><span class="hs-identifier hs-var">pprFullRuleName</span></a><span> </span><a href="#local-1628275484"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-84"></a><span>                                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628275501"><span class="hs-identifier hs-var">lhs_wanted</span></a><span>
</span><a name="line-85"></a><span>                                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628275503"><span class="hs-identifier hs-var">rhs_wanted</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628275505"><a href="#local-1628275505"><span class="hs-identifier">all_lhs_wanted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628275492"><span class="hs-identifier hs-var">bndr_wanted</span></a><span> </span><span class="hs-special">`</span><a href="TcRnTypes.html#andWC"><span class="hs-identifier hs-var">andWC</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628275501"><span class="hs-identifier hs-var">lhs_wanted</span></a><span>
</span><a name="line-87"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628275506"><a href="#local-1628275506"><span class="hs-identifier">lhs_evs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRules.html#simplifyRule"><span class="hs-identifier hs-var">simplifyRule</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-1628275484"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span>                                 </span><a href="#local-1628275505"><span class="hs-identifier hs-var">all_lhs_wanted</span></a><span>
</span><a name="line-89"></a><span>                                 </span><a href="#local-1628275503"><span class="hs-identifier hs-var">rhs_wanted</span></a><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span>        </span><span class="hs-comment">-- Now figure out what to quantify over</span><span>
</span><a name="line-92"></a><span>        </span><span class="hs-comment">-- c.f. TcSimplify.simplifyInfer</span><span>
</span><a name="line-93"></a><span>        </span><span class="hs-comment">-- We quantify over any tyvars free in *either* the rule</span><span>
</span><a name="line-94"></a><span>        </span><span class="hs-comment">--  *or* the bound variables.  The latter is important.  Consider</span><span>
</span><a name="line-95"></a><span>        </span><span class="hs-comment">--      ss (x,(y,z)) = (x,z)</span><span>
</span><a name="line-96"></a><span>        </span><span class="hs-comment">--      RULE:  forall v. fst (ss v) = fst v</span><span>
</span><a name="line-97"></a><span>        </span><span class="hs-comment">-- The type of the rhs of the rule is just a, but v::(a,(b,c))</span><span>
</span><a name="line-98"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-99"></a><span>        </span><span class="hs-comment">-- We also need to get the completely-uconstrained tyvars of</span><span>
</span><a name="line-100"></a><span>        </span><span class="hs-comment">-- the LHS, lest they otherwise get defaulted to Any; but we do that</span><span>
</span><a name="line-101"></a><span>        </span><span class="hs-comment">-- during zonking (see TcHsSyn.zonkRule)</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628275507"><a href="#local-1628275507"><span class="hs-identifier">tpl_ids</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628275506"><span class="hs-identifier hs-var">lhs_evs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628275493"><span class="hs-identifier hs-var">id_bndrs</span></a><span>
</span><a name="line-104"></a><span>             </span><a name="local-1628275508"><a href="#local-1628275508"><span class="hs-identifier">forall_tkvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#splitDepVarsOfTypes"><span class="hs-identifier hs-var">splitDepVarsOfTypes</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-105"></a><span>                           </span><a href="#local-1628275504"><span class="hs-identifier hs-var">rule_ty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1628275507"><span class="hs-identifier hs-var">tpl_ids</span></a><span>
</span><a name="line-106"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628275509"><a href="#local-1628275509"><span class="hs-identifier">gbls</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcGetGlobalTyCoVars"><span class="hs-identifier hs-var">tcGetGlobalTyCoVars</span></a><span> </span><span class="hs-comment">-- Even though top level, there might be top-level</span><span>
</span><a name="line-107"></a><span>                                      </span><span class="hs-comment">-- monomorphic bindings from the MR; test tc111</span><span>
</span><a name="line-108"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628275510"><a href="#local-1628275510"><span class="hs-identifier">qtkvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#quantifyTyVars"><span class="hs-identifier hs-var">quantifyTyVars</span></a><span> </span><a href="#local-1628275509"><span class="hs-identifier hs-var">gbls</span></a><span> </span><a href="#local-1628275508"><span class="hs-identifier hs-var">forall_tkvs</span></a><span>
</span><a name="line-109"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcRule&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="HsDecls.html#pprFullRuleName"><span class="hs-identifier hs-var">pprFullRuleName</span></a><span> </span><a href="#local-1628275484"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-110"></a><span>                                </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628275508"><span class="hs-identifier hs-var">forall_tkvs</span></a><span>
</span><a name="line-111"></a><span>                                </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628275510"><span class="hs-identifier hs-var">qtkvs</span></a><span>
</span><a name="line-112"></a><span>                                </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628275504"><span class="hs-identifier hs-var">rule_ty</span></a><span>
</span><a name="line-113"></a><span>                                </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628275511"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1628275511"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-1628275511"><a href="#local-1628275511"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628275507"><span class="hs-identifier hs-var">tpl_ids</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-114"></a><span>                  </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span>           </span><span class="hs-comment">-- Simplify the RHS constraints</span><span>
</span><a name="line-117"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628275512"><a href="#local-1628275512"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#RuleSkol"><span class="hs-identifier hs-var">RuleSkol</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-1628275484"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628275513"><a href="#local-1628275513"><span class="hs-identifier">rhs_implic</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628275514"><a href="#local-1628275514"><span class="hs-identifier">rhs_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#buildImplicationFor"><span class="hs-identifier hs-var">buildImplicationFor</span></a><span> </span><a href="TcType.html#topTcLevel"><span class="hs-identifier hs-var">topTcLevel</span></a><span> </span><a href="#local-1628275512"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-1628275510"><span class="hs-identifier hs-var">qtkvs</span></a><span>
</span><a name="line-119"></a><span>                                         </span><a href="#local-1628275506"><span class="hs-identifier hs-var">lhs_evs</span></a><span> </span><a href="#local-1628275503"><span class="hs-identifier hs-var">rhs_wanted</span></a><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span>           </span><span class="hs-comment">-- For the LHS constraints we must solve the remaining constraints</span><span>
</span><a name="line-122"></a><span>           </span><span class="hs-comment">-- (a) so that we report insoluble ones</span><span>
</span><a name="line-123"></a><span>           </span><span class="hs-comment">-- (b) so that we bind any soluble ones</span><span>
</span><a name="line-124"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628275515"><a href="#local-1628275515"><span class="hs-identifier">lhs_implic</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628275516"><a href="#local-1628275516"><span class="hs-identifier">lhs_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#buildImplicationFor"><span class="hs-identifier hs-var">buildImplicationFor</span></a><span> </span><a href="TcType.html#topTcLevel"><span class="hs-identifier hs-var">topTcLevel</span></a><span> </span><a href="#local-1628275512"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-1628275510"><span class="hs-identifier hs-var">qtkvs</span></a><span>
</span><a name="line-125"></a><span>                                         </span><a href="#local-1628275506"><span class="hs-identifier hs-var">lhs_evs</span></a><span>
</span><a name="line-126"></a><span>                                         </span><span class="hs-special">(</span><a href="#local-1628275505"><span class="hs-identifier hs-var">all_lhs_wanted</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>                                           </span><span class="hs-comment">-- simplifyRule consumed all simple</span><span>
</span><a name="line-128"></a><span>                                           </span><span class="hs-comment">-- constraints</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitImplications"><span class="hs-identifier hs-var">emitImplications</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628275515"><span class="hs-identifier hs-var">lhs_implic</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628275513"><span class="hs-identifier hs-var">rhs_implic</span></a><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#HsRule"><span class="hs-identifier hs-var">HsRule</span></a><span> </span><a href="#local-1628275484"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-1628275485"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-132"></a><span>                    </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#noLoc"><span class="hs-identifier hs-var">noLoc</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="HsDecls.html#RuleBndr"><span class="hs-identifier hs-var">RuleBndr</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="SrcLoc.html#noLoc"><span class="hs-identifier hs-var">noLoc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1628275510"><span class="hs-identifier hs-var">qtkvs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628275507"><span class="hs-identifier hs-var">tpl_ids</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span>                    </span><span class="hs-special">(</span><a href="HsUtils.html#mkHsDictLet"><span class="hs-identifier hs-var">mkHsDictLet</span></a><span> </span><a href="#local-1628275516"><span class="hs-identifier hs-var">lhs_binds</span></a><span> </span><a href="#local-1628275500"><span class="hs-identifier hs-var">lhs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628275488"><span class="hs-identifier hs-var">fv_lhs</span></a><span>
</span><a name="line-134"></a><span>                    </span><span class="hs-special">(</span><a href="HsUtils.html#mkHsDictLet"><span class="hs-identifier hs-var">mkHsDictLet</span></a><span> </span><a href="#local-1628275514"><span class="hs-identifier hs-var">rhs_binds</span></a><span> </span><a href="#local-1628275502"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628275490"><span class="hs-identifier hs-var">fv_rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-identifier">tcRuleBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LRuleBndr"><span class="hs-identifier hs-type">LRuleBndr</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span>
</span><a name="line-137"></a><a name="tcRuleBndrs"><a href="TcRules.html#tcRuleBndrs"><span class="hs-identifier">tcRuleBndrs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-138"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-139"></a><span class="hs-identifier">tcRuleBndrs</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#RuleBndr"><span class="hs-identifier hs-var">RuleBndr</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628275517"><a href="#local-1628275517"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1628275518"><a href="#local-1628275518"><span class="hs-identifier">rule_bndrs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-1628275519"><a href="#local-1628275519"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenFlexiTyVarTy"><span class="hs-identifier hs-var">newOpenFlexiTyVarTy</span></a><span>
</span><a name="line-141"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628275520"><a href="#local-1628275520"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRules.html#tcRuleBndrs"><span class="hs-identifier hs-var">tcRuleBndrs</span></a><span> </span><a href="#local-1628275518"><span class="hs-identifier hs-var">rule_bndrs</span></a><span>
</span><a name="line-142"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#mkLocalId"><span class="hs-identifier hs-var">mkLocalId</span></a><span> </span><a href="#local-1628275517"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-1628275519"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1628275520"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-143"></a><span class="hs-identifier">tcRuleBndrs</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#RuleBndrSig"><span class="hs-identifier hs-var">RuleBndrSig</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628275521"><a href="#local-1628275521"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628275522"><a href="#local-1628275522"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-1628275523"><a href="#local-1628275523"><span class="hs-identifier">rule_bndrs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span class="hs-comment">--  e.g         x :: a-&gt;a</span><span>
</span><a name="line-145"></a><span class="hs-comment">--  The tyvar 'a' is brought into scope first, just as if you'd written</span><span>
</span><a name="line-146"></a><span class="hs-comment">--              a::*, x :: a-&gt;a</span><span>
</span><a name="line-147"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628275524"><a href="#local-1628275524"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#RuleSigCtxt"><span class="hs-identifier hs-var">RuleSigCtxt</span></a><span> </span><a href="#local-1628275521"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-148"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628275525"><a href="#local-1628275525"><span class="hs-identifier">id_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628275526"><a href="#local-1628275526"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsPatSigType"><span class="hs-identifier hs-var">tcHsPatSigType</span></a><span> </span><a href="#local-1628275524"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628275522"><span class="hs-identifier hs-var">rn_ty</span></a><span>
</span><a name="line-149"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628275527"><a href="#local-1628275527"><span class="hs-identifier">id</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#mkLocalIdOrCoVar"><span class="hs-identifier hs-var">mkLocalIdOrCoVar</span></a><span> </span><a href="#local-1628275521"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-1628275525"><span class="hs-identifier hs-var">id_ty</span></a><span>
</span><a name="line-150"></a><span>                    </span><span class="hs-comment">-- See Note [Pattern signature binders] in TcHsType</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span>              </span><span class="hs-comment">-- The type variables scope over subsequent bindings; yuk</span><span>
</span><a name="line-153"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628275528"><a href="#local-1628275528"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendTyVarEnv"><span class="hs-identifier hs-var">tcExtendTyVarEnv</span></a><span> </span><a href="#local-1628275526"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-154"></a><span>                  </span><a href="TcRules.html#tcRuleBndrs"><span class="hs-identifier hs-var">tcRuleBndrs</span></a><span> </span><a href="#local-1628275523"><span class="hs-identifier hs-var">rule_bndrs</span></a><span>
</span><a name="line-155"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628275526"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628275527"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1628275528"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-identifier">ruleCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-158"></a><a name="ruleCtxt"><a href="TcRules.html#ruleCtxt"><span class="hs-identifier">ruleCtxt</span></a></a><span> </span><a name="local-1628275529"><a href="#local-1628275529"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;When checking the transformation rule&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-159"></a><span>                </span><a href="Outputable.html#doubleQuotes"><span class="hs-identifier hs-var">doubleQuotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a><span> </span><a href="#local-1628275529"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">{-
*********************************************************************************
*                                                                                 *
              Constraint simplification for rules
*                                                                                 *
***********************************************************************************

Note [Simplifying RULE constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Example.  Consider the following left-hand side of a rule
        f (x == y) (y &gt; z) = ...
If we typecheck this expression we get constraints
        d1 :: Ord a, d2 :: Eq a
We do NOT want to &quot;simplify&quot; to the LHS
        forall x::a, y::a, z::a, d1::Ord a.
          f ((==) (eqFromOrd d1) x y) ((&gt;) d1 y z) = ...
Instead we want
        forall x::a, y::a, z::a, d1::Ord a, d2::Eq a.
          f ((==) d2 x y) ((&gt;) d1 y z) = ...

Here is another example:
        fromIntegral :: (Integral a, Num b) =&gt; a -&gt; b
        {-# RULES &quot;foo&quot;  fromIntegral = id :: Int -&gt; Int #-}
In the rule, a=b=Int, and Num Int is a superclass of Integral Int. But
we *dont* want to get
        forall dIntegralInt.
           fromIntegral Int Int dIntegralInt (scsel dIntegralInt) = id Int
because the scsel will mess up RULE matching.  Instead we want
        forall dIntegralInt, dNumInt.
          fromIntegral Int Int dIntegralInt dNumInt = id Int

Even if we have
        g (x == y) (y == z) = ..
where the two dictionaries are *identical*, we do NOT WANT
        forall x::a, y::a, z::a, d1::Eq a
          f ((==) d1 x y) ((&gt;) d1 y z) = ...
because that will only match if the dict args are (visibly) equal.
Instead we want to quantify over the dictionaries separately.

In short, simplifyRuleLhs must *only* squash equalities, leaving
all dicts unchanged, with absolutely no sharing.

Also note that we can't solve the LHS constraints in isolation:
Example   foo :: Ord a =&gt; a -&gt; a
          foo_spec :: Int -&gt; Int
          {-# RULE &quot;foo&quot;  foo = foo_spec #-}
Here, it's the RHS that fixes the type variable

HOWEVER, under a nested implication things are different
Consider
  f :: (forall a. Eq a =&gt; a-&gt;a) -&gt; Bool -&gt; ...
  {-# RULES &quot;foo&quot; forall (v::forall b. Eq b =&gt; b-&gt;b).
       f b True = ...
    #-}
Here we *must* solve the wanted (Eq a) from the given (Eq a)
resulting from skolemising the agument type of g.  So we
revert to SimplCheck when going under an implication.


------------------------ So the plan is this -----------------------

* Step 0: typecheck the LHS and RHS to get constraints from each

* Step 1: Simplify the LHS and RHS constraints all together in one bag
          We do this to discover all unification equalities

* Step 2: Zonk the ORIGINAL (unsimplified) lhs constraints, to take
          advantage of those unifications, and partition them into the
          ones we will quantify over, and the others
          See Note [RULE quantification over equalities]

* Step 3: Decide on the type variables to quantify over

* Step 4: Simplify the LHS and RHS constraints separately, using the
          quantified constraints as givens

Note [Solve order for RULES]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In step 1 above, we need to be a bit careful about solve order.
Consider
   f :: Int -&gt; T Int
   type instance T Int = Bool

   RULE f 3 = True

From the RULE we get
   lhs-constraints:  T Int ~ alpha
   rhs-constraints:  Bool ~ alpha
where 'alpha' is the type that connects the two.  If we glom them
all together, and solve the RHS constraint first, we might solve
with alpha := Bool.  But then we'd end up with a RULE like

    RULE: f 3 |&gt; (co :: T Int ~ Booo) = True

which is terrible.  We want

    RULE: f 3 = True |&gt; (sym co :: Bool ~ T Int)

So we are careful to solve the LHS constraints first, and *then* the
RHS constraints.  Actually much of this is done by the on-the-fly
constraint solving, so the same order must be observed in
tcRule.


Note [RULE quantification over equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Deciding which equalities to quantify over is tricky:
 * We do not want to quantify over insoluble equalities (Int ~ Bool)
    (a) because we prefer to report a LHS type error
    (b) because if such things end up in 'givens' we get a bogus
        &quot;inaccessible code&quot; error

 * But we do want to quantify over things like (a ~ F b), where
   F is a type function.

The difficulty is that it's hard to tell what is insoluble!
So we see whether the simplification step yielded any type errors,
and if so refrain from quantifying over *any* equalities.

Note [Quantifying over coercion holes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Equality constraints from the LHS will emit coercion hole Wanteds.
These don't have a name, so we can't quantify over them directly.
Instead, because we really do want to quantify here, invent a new
EvVar for the coercion, fill the hole with the invented EvVar, and
then quantify over the EvVar. Not too tricky -- just some
impedence matching, really.

Note [Simplify *derived* constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
At this stage, we're simplifying constraints only for insolubility
and for unification. Note that all the evidence is quickly discarded.
We make this explicit by working over derived constraints, for which
there is no evidence. Using derived constraints also prevents solved
equalities from being written to coercion holes. If we don't do this,
then RHS coercion-hole constraints get filled in, only to get filled
in *again* when solving the implications emitted from tcRule. That's
terrible, so we avoid the problem by using derived constraints.

-}</span><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span class="hs-identifier">simplifyRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#RuleName"><span class="hs-identifier hs-type">RuleName</span></a><span>
</span><a name="line-304"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>       </span><span class="hs-comment">-- Constraints from LHS</span><span>
</span><a name="line-305"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>       </span><span class="hs-comment">-- Constraints from RHS</span><span>
</span><a name="line-306"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- LHS evidence variables,</span><span>
</span><a name="line-307"></a><span class="hs-comment">-- See Note [Simplifying RULE constraints] in TcRule</span><span>
</span><a name="line-308"></a><span class="hs-comment">-- NB: This consumes all simple constraints on the LHS, but not</span><span>
</span><a name="line-309"></a><span class="hs-comment">-- any LHS implication constraints.</span><span>
</span><a name="line-310"></a><a name="simplifyRule"><a href="TcRules.html#simplifyRule"><span class="hs-identifier">simplifyRule</span></a></a><span> </span><a name="local-1628275530"><a href="#local-1628275530"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-1628275531"><a href="#local-1628275531"><span class="hs-identifier">lhs_wanted</span></a></a><span> </span><a name="local-1628275532"><a href="#local-1628275532"><span class="hs-identifier">rhs_wanted</span></a></a><span>
</span><a name="line-311"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>         </span><span class="hs-comment">-- We allow ourselves to unify environment</span><span>
</span><a name="line-312"></a><span>                 </span><span class="hs-comment">-- variables: runTcS runs with topTcLevel</span><span>
</span><a name="line-313"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628275546"><a href="#local-1628275546"><span class="hs-identifier">tc_lvl</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-314"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628275549"><a href="#local-1628275549"><span class="hs-identifier">insoluble</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#runTcSDeriveds"><span class="hs-identifier hs-var">runTcSDeriveds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-315"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- First solve the LHS and *then* solve the RHS</span><span>
</span><a name="line-316"></a><span>                  </span><span class="hs-comment">-- See Note [Solve order for RULES]</span><span>
</span><a name="line-317"></a><span>                  </span><span class="hs-comment">-- See Note [Simplify *derived* constraints]</span><span>
</span><a name="line-318"></a><span>                  </span><a name="local-1628275547"><a href="#local-1628275547"><span class="hs-identifier">lhs_resid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnTypes.html#toDerivedWC"><span class="hs-identifier hs-var">toDerivedWC</span></a><span> </span><a href="#local-1628275531"><span class="hs-identifier hs-var">lhs_wanted</span></a><span>
</span><a name="line-319"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-1628275548"><a href="#local-1628275548"><span class="hs-identifier">rhs_resid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveWanteds"><span class="hs-identifier hs-var">solveWanteds</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnTypes.html#toDerivedWC"><span class="hs-identifier hs-var">toDerivedWC</span></a><span> </span><a href="#local-1628275532"><span class="hs-identifier hs-var">rhs_wanted</span></a><span>
</span><a name="line-320"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcRnTypes.html#insolubleWC"><span class="hs-identifier hs-var">insolubleWC</span></a><span> </span><a href="#local-1628275546"><span class="hs-identifier hs-var">tc_lvl</span></a><span> </span><a href="#local-1628275547"><span class="hs-identifier hs-var">lhs_resid</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-321"></a><span>                           </span><a href="TcRnTypes.html#insolubleWC"><span class="hs-identifier hs-var">insolubleWC</span></a><span> </span><a href="#local-1628275546"><span class="hs-identifier hs-var">tc_lvl</span></a><span> </span><a href="#local-1628275548"><span class="hs-identifier hs-var">rhs_resid</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628275550"><a href="#local-1628275550"><span class="hs-identifier">zonked_lhs_simples</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkSimples"><span class="hs-identifier hs-var">zonkSimples</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wc_simple</span><span> </span><a href="#local-1628275531"><span class="hs-identifier hs-var">lhs_wanted</span></a><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628275551"><a href="#local-1628275551"><span class="hs-identifier">ev_ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#mapMaybeM"><span class="hs-identifier hs-var">mapMaybeM</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628275533"><span class="hs-identifier hs-var">quantify_ct</span></a><span> </span><a href="#local-1628275549"><span class="hs-identifier hs-var">insoluble</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-326"></a><span>                             </span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-1628275550"><span class="hs-identifier hs-var">zonked_lhs_simples</span></a><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyRule&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-329"></a><span>         </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;LHS of rule&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#doubleQuotes"><span class="hs-identifier hs-var">doubleQuotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a><span> </span><a href="#local-1628275530"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;lhs_wantd&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628275531"><span class="hs-identifier hs-var">lhs_wanted</span></a><span>
</span><a name="line-331"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;rhs_wantd&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628275532"><span class="hs-identifier hs-var">rhs_wanted</span></a><span>
</span><a name="line-332"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;zonked_lhs_simples&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628275550"><span class="hs-identifier hs-var">zonked_lhs_simples</span></a><span>
</span><a name="line-333"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;ev_ids&quot;</span><span>     </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628275551"><span class="hs-identifier hs-var">ev_ids</span></a><span>
</span><a name="line-334"></a><span>              </span><span class="hs-special">]</span><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628275551"><span class="hs-identifier hs-var">ev_ids</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-339"></a><span>    </span><a name="local-1628275533"><a href="#local-1628275533"><span class="hs-identifier">quantify_ct</span></a></a><span> </span><a name="local-1628275536"><a href="#local-1628275536"><span class="hs-identifier">insol</span></a></a><span> </span><span class="hs-comment">-- Note [RULE quantification over equalities]</span><span>
</span><a name="line-340"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628275536"><span class="hs-identifier hs-var">insol</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628275534"><span class="hs-identifier hs-var">quantify_insol</span></a><span>
</span><a name="line-341"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628275535"><span class="hs-identifier hs-var">quantify_normal</span></a><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span>    </span><a name="local-1628275534"><a href="#local-1628275534"><span class="hs-identifier">quantify_insol</span></a></a><span> </span><a name="local-1628275537"><a href="#local-1628275537"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-344"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isEqPred"><span class="hs-identifier hs-var">isEqPred</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctPred"><span class="hs-identifier hs-var">ctPred</span></a><span> </span><a href="#local-1628275537"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-346"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-347"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnTypes.html#ctEvId"><span class="hs-identifier hs-var">ctEvId</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnTypes.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a><span> </span><a href="#local-1628275537"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span>    </span><a name="local-1628275535"><a href="#local-1628275535"><span class="hs-identifier">quantify_normal</span></a></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ctEvidence"><span class="hs-identifier hs-var">ctEvidence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtWanted"><span class="hs-identifier hs-var">CtWanted</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_dest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628275538"><a href="#local-1628275538"><span class="hs-identifier">dest</span></a></a><span>
</span><a name="line-350"></a><span>                                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628275539"><a href="#local-1628275539"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628275538"><span class="hs-identifier hs-var">dest</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- See Note [Quantifying over coercion holes]</span><span>
</span><a name="line-352"></a><span>          </span><a href="TcRnTypes.html#HoleDest"><span class="hs-identifier hs-var">HoleDest</span></a><span> </span><a name="local-1628275540"><a href="#local-1628275540"><span class="hs-identifier">hole</span></a></a><span>
</span><a name="line-353"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#EqPred"><span class="hs-identifier hs-var">EqPred</span></a><span> </span><a href="Type.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a><span> </span><a name="local-1628275541"><a href="#local-1628275541"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-1628275542"><a href="#local-1628275542"><span class="hs-identifier">t2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#classifyPredType"><span class="hs-identifier hs-var">classifyPredType</span></a><span> </span><a href="#local-1628275539"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-354"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-1628275541"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#tcEqType"><span class="hs-identifier hs-var">tcEqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628275542"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-355"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- These are trivial. Don't quantify. But do fill in</span><span>
</span><a name="line-356"></a><span>                    </span><span class="hs-comment">-- the hole.</span><span>
</span><a name="line-357"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#fillCoercionHole"><span class="hs-identifier hs-var">fillCoercionHole</span></a><span> </span><a href="#local-1628275540"><span class="hs-identifier hs-var">hole</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkTcNomReflCo"><span class="hs-identifier hs-var">mkTcNomReflCo</span></a><span> </span><a href="#local-1628275541"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">)</span><span>
</span><a name="line-358"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-361"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628275543"><a href="#local-1628275543"><span class="hs-identifier">ev_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newEvVar"><span class="hs-identifier hs-var">newEvVar</span></a><span> </span><a href="#local-1628275539"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-362"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#fillCoercionHole"><span class="hs-identifier hs-var">fillCoercionHole</span></a><span> </span><a href="#local-1628275540"><span class="hs-identifier hs-var">hole</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkTcCoVarCo"><span class="hs-identifier hs-var">mkTcCoVarCo</span></a><span> </span><a href="#local-1628275543"><span class="hs-identifier hs-var">ev_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-363"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628275543"><span class="hs-identifier hs-var">ev_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-364"></a><span>          </span><a href="TcRnTypes.html#EvVarDest"><span class="hs-identifier hs-var">EvVarDest</span></a><span> </span><a name="local-1628275544"><a href="#local-1628275544"><span class="hs-identifier">evar</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628275544"><span class="hs-identifier hs-var">evar</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>    </span><span class="hs-identifier">quantify_normal</span><span> </span><a name="local-1628275545"><a href="#local-1628275545"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;simplifyRule.quantify_normal&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628275545"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-366"></a></pre></body></html>