<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Type subsumption and unification
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP, MultiWayIf, TupleSections #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcUnify</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>  </span><span class="hs-comment">-- Full-blown subsumption</span><span>
</span><a name="line-13"></a><span>  </span><a href="TcUnify.html#tcWrapResult"><span class="hs-identifier hs-var">tcWrapResult</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#tcWrapResultO"><span class="hs-identifier hs-var">tcWrapResultO</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#tcSkolemise"><span class="hs-identifier hs-var">tcSkolemise</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#tcSkolemiseET"><span class="hs-identifier hs-var">tcSkolemiseET</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>  </span><a href="TcUnify.html#tcSubTypeHR"><span class="hs-identifier hs-var">tcSubTypeHR</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#tcSubType"><span class="hs-identifier hs-var">tcSubType</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#tcSubTypeO"><span class="hs-identifier hs-var">tcSubTypeO</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#tcSubType_NC"><span class="hs-identifier hs-var">tcSubType_NC</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#tcSubTypeDS"><span class="hs-identifier hs-var">tcSubTypeDS</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#tcSubTypeDS_O"><span class="hs-identifier hs-var">tcSubTypeDS_O</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>  </span><a href="TcUnify.html#tcSubTypeDS_NC"><span class="hs-identifier hs-var">tcSubTypeDS_NC</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#tcSubTypeDS_NC_O"><span class="hs-identifier hs-var">tcSubTypeDS_NC_O</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#tcSubTypeET"><span class="hs-identifier hs-var">tcSubTypeET</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#tcSubTypeET_NC"><span class="hs-identifier hs-var">tcSubTypeET_NC</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>  </span><a href="TcUnify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#buildImplicationFor"><span class="hs-identifier hs-var">buildImplicationFor</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-comment">-- Various unifications</span><span>
</span><a name="line-19"></a><span>  </span><a href="TcUnify.html#unifyType_"><span class="hs-identifier hs-var">unifyType_</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#unifyTheta"><span class="hs-identifier hs-var">unifyTheta</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#unifyKind"><span class="hs-identifier hs-var">unifyKind</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#noThing"><span class="hs-identifier hs-var">noThing</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>  </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#unifyExpType"><span class="hs-identifier hs-var">unifyExpType</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>  </span><span class="hs-comment">--------------------------------</span><span>
</span><a name="line-23"></a><span>  </span><span class="hs-comment">-- Holes</span><span>
</span><a name="line-24"></a><span>  </span><a href="TcUnify.html#tcInfer"><span class="hs-identifier hs-var">tcInfer</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>  </span><a href="TcUnify.html#matchExpectedListTy"><span class="hs-identifier hs-var">matchExpectedListTy</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>  </span><a href="TcUnify.html#matchExpectedPArrTy"><span class="hs-identifier hs-var">matchExpectedPArrTy</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>  </span><a href="TcUnify.html#matchExpectedTyConApp"><span class="hs-identifier hs-var">matchExpectedTyConApp</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>  </span><a href="TcUnify.html#matchExpectedAppTy"><span class="hs-identifier hs-var">matchExpectedAppTy</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>  </span><a href="TcUnify.html#matchExpectedFunTys"><span class="hs-identifier hs-var">matchExpectedFunTys</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>  </span><a href="TcUnify.html#matchActualFunTys"><span class="hs-identifier hs-var">matchActualFunTys</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#matchActualFunTysPart"><span class="hs-identifier hs-var">matchActualFunTysPart</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>  </span><a href="TcUnify.html#matchExpectedFunKind"><span class="hs-identifier hs-var">matchExpectedFunKind</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span>  </span><a href="TcUnify.html#wrapFunResCoercion"><span class="hs-identifier hs-var">wrapFunResCoercion</span></a><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="HsSyn.html"><span class="hs-identifier">HsSyn</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="TyCoRep.html"><span class="hs-identifier">TyCoRep</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="TcType.html"><span class="hs-identifier">TcType</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="TcEvidence.html"><span class="hs-identifier">TcEvidence</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Name.html#isSystemName"><span class="hs-identifier hs-var">isSystemName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="TysWiredIn.html"><span class="hs-identifier">TysWiredIn</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="ErrUtils.html"><span class="hs-identifier">ErrUtils</span></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="Bag.html"><span class="hs-identifier">Bag</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Arrow.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Arrow</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Arrow.html#second"><span class="hs-identifier hs-var">second</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
             matchExpected functions
*                                                                      *
************************************************************************

Note [Herald for matchExpectedFunTys]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The 'herald' always looks like:
   &quot;The equation(s) for 'f' have&quot;
   &quot;The abstraction (\x.e) takes&quot;
   &quot;The section (+ x) expects&quot;
   &quot;The function 'f' is applied to&quot;

This is used to construct a message of form

   The abstraction `\Just 1 -&gt; ...' takes two arguments
   but its type `Maybe a -&gt; a' has only one

   The equation(s) for `f' have two arguments
   but its type `Maybe a -&gt; a' has only one

   The section `(f 3)' requires 'f' to take two arguments
   but its type `Int -&gt; Int' has only one

   The function 'f' is applied to two arguments
   but its type `Int -&gt; Int' has only one

Note [matchExpectedFunTys]
~~~~~~~~~~~~~~~~~~~~~~~~~~
matchExpectedFunTys checks that a sigma has the form
of an n-ary function.  It passes the decomposed type to the
thing_inside, and returns a wrapper to coerce between the two types

It's used wherever a language construct must have a functional type,
namely:
        A lambda expression
        A function definition
     An operator section

This function must be written CPS'd because it needs to fill in the
ExpTypes produced for arguments before it can fill in the ExpType
passed in.

-}</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-comment">-- Use this one when you have an &quot;expected&quot; type.</span><span>
</span><a name="line-114"></a><span class="hs-identifier">matchExpectedFunTys</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>   </span><span class="hs-comment">-- See Note [Herald for matchExpectedFunTys]</span><span>
</span><a name="line-115"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span>
</span><a name="line-116"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a><span>  </span><span class="hs-comment">-- deeply skolemised</span><span>
</span><a name="line-117"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TcType.html#ExpSigmaType"><span class="hs-identifier hs-type">ExpSigmaType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628060420"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>                          </span><span class="hs-comment">-- must fill in these ExpTypes here</span><span>
</span><a name="line-119"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060420"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span class="hs-comment">-- If    matchExpectedFunTys n ty = (_, wrap)</span><span>
</span><a name="line-121"></a><span class="hs-comment">-- then  wrap : (t1 -&gt; ... -&gt; tn -&gt; ty_r) &quot;-&gt;&quot; ty,</span><span>
</span><a name="line-122"></a><span class="hs-comment">--   where [t1, ..., tn], ty_r are passed to the thing_inside</span><span>
</span><a name="line-123"></a><a name="matchExpectedFunTys"><a href="TcUnify.html#matchExpectedFunTys"><span class="hs-identifier">matchExpectedFunTys</span></a></a><span> </span><a name="local-1628060421"><a href="#local-1628060421"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-1628060422"><a href="#local-1628060422"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-1628060423"><a href="#local-1628060423"><span class="hs-identifier">orig_ty</span></a></a><span> </span><a name="local-1628060424"><a href="#local-1628060424"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-124"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060423"><span class="hs-identifier hs-var">orig_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-125"></a><span>      </span><a href="TcType.html#Check"><span class="hs-identifier hs-var">Check</span></a><span> </span><a name="local-1628060468"><a href="#local-1628060468"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060425"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-1628060422"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-1628060468"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-126"></a><span>      </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060426"><span class="hs-identifier hs-var">defer</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-1628060422"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-1628060423"><span class="hs-identifier hs-var">orig_ty</span></a><span>
</span><a name="line-127"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-128"></a><span>    </span><a name="local-1628060425"><a href="#local-1628060425"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1628060428"><a href="#local-1628060428"><span class="hs-identifier">acc_arg_tys</span></a></a><span> </span><span class="hs-number">0</span><span> </span><a name="local-1628060429"><a href="#local-1628060429"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-129"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060430"><a href="#local-1628060430"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060424"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-1628060428"><span class="hs-identifier hs-var">acc_arg_tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628060429"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060430"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#idHsWrapper"><span class="hs-identifier hs-var">idHsWrapper</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060431"><a href="#local-1628060431"><span class="hs-identifier">acc_arg_tys</span></a></a><span> </span><a name="local-1628060432"><a href="#local-1628060432"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628060433"><a href="#local-1628060433"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-133"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628060434"><a href="#local-1628060434"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-1628060433"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060425"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060431"><span class="hs-identifier hs-var">acc_arg_tys</span></a><span> </span><a href="#local-1628060432"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1628060434"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060435"><a href="#local-1628060435"><span class="hs-identifier">acc_arg_tys</span></a></a><span> </span><a name="local-1628060436"><a href="#local-1628060436"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Anon"><span class="hs-identifier hs-var">Anon</span></a><span> </span><a name="local-1628060437"><a href="#local-1628060437"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060438"><a href="#local-1628060438"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isPredTy</span><span> </span><span class="hs-identifier">arg_ty</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060439"><a href="#local-1628060439"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060440"><a href="#local-1628060440"><span class="hs-identifier">wrap_res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060425"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628060437"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1628060435"><span class="hs-identifier hs-var">acc_arg_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>                                      </span><span class="hs-special">(</span><a href="#local-1628060436"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-1628060438"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-139"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-1628060439"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-140"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#mkWpFun"><span class="hs-identifier hs-var">mkWpFun</span></a><span> </span><a href="TcEvidence.html#idHsWrapper"><span class="hs-identifier hs-var">idHsWrapper</span></a><span> </span><a href="#local-1628060440"><span class="hs-identifier hs-var">wrap_res</span></a><span> </span><a href="#local-1628060437"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="#local-1628060438"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060441"><a href="#local-1628060441"><span class="hs-identifier">acc_arg_tys</span></a></a><span> </span><a name="local-1628060442"><a href="#local-1628060442"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628060443"><a href="#local-1628060443"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628060444"><a href="#local-1628060444"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTcTyVar</span><span> </span><span class="hs-identifier">tv</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">isMetaTyVar</span><span> </span><span class="hs-identifier">tv</span><span>
</span><a name="line-144"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060445"><a href="#local-1628060445"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a><span> </span><a href="#local-1628060444"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-145"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060445"><span class="hs-identifier hs-var">cts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-146"></a><span>               </span><a href="TcType.html#Indirect"><span class="hs-identifier hs-var">Indirect</span></a><span> </span><a name="local-1628060446"><a href="#local-1628060446"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060425"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060441"><span class="hs-identifier hs-var">acc_arg_tys</span></a><span> </span><a href="#local-1628060442"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1628060446"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-147"></a><span>               </span><a href="TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060426"><span class="hs-identifier hs-var">defer</span></a><span> </span><a href="#local-1628060441"><span class="hs-identifier hs-var">acc_arg_tys</span></a><span> </span><a href="#local-1628060442"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628060443"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span>       </span><span class="hs-comment">-- In all other cases we bale out into ordinary unification</span><span>
</span><a name="line-150"></a><span>       </span><span class="hs-comment">-- However unlike the meta-tyvar case, we are sure that the</span><span>
</span><a name="line-151"></a><span>       </span><span class="hs-comment">-- number of arguments doesn't match arity of the original</span><span>
</span><a name="line-152"></a><span>       </span><span class="hs-comment">-- type, so we can add a bit more context to the error message</span><span>
</span><a name="line-153"></a><span>       </span><span class="hs-comment">-- (cf Trac #7869).</span><span>
</span><a name="line-154"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-155"></a><span>       </span><span class="hs-comment">-- It is not always an error, because specialized type may have</span><span>
</span><a name="line-156"></a><span>       </span><span class="hs-comment">-- different arity, for example:</span><span>
</span><a name="line-157"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-158"></a><span>       </span><span class="hs-comment">-- &gt; f1 = f2 'a'</span><span>
</span><a name="line-159"></a><span>       </span><span class="hs-comment">-- &gt; f2 :: Monad m =&gt; m Bool</span><span>
</span><a name="line-160"></a><span>       </span><span class="hs-comment">-- &gt; f2 = undefined</span><span>
</span><a name="line-161"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-162"></a><span>       </span><span class="hs-comment">-- But in that case we add specialized type into error context</span><span>
</span><a name="line-163"></a><span>       </span><span class="hs-comment">-- anyway, because it may be useful. See also Trac #9605.</span><span>
</span><a name="line-164"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060447"><a href="#local-1628060447"><span class="hs-identifier">acc_arg_tys</span></a></a><span> </span><a name="local-1628060448"><a href="#local-1628060448"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628060449"><a href="#local-1628060449"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a><span> </span><a href="#local-1628060427"><span class="hs-identifier hs-var">mk_ctxt</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-165"></a><span>                          </span><a href="#local-1628060426"><span class="hs-identifier hs-var">defer</span></a><span> </span><a href="#local-1628060447"><span class="hs-identifier hs-var">acc_arg_tys</span></a><span> </span><a href="#local-1628060448"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628060449"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span>    </span><span class="hs-comment">------------</span><span>
</span><a name="line-168"></a><span>    </span><a name="local-1628060426"><a href="#local-1628060426"><span class="hs-identifier">defer</span></a></a><span> </span><a name="local-1628060450"><a href="#local-1628060450"><span class="hs-identifier">acc_arg_tys</span></a></a><span> </span><a name="local-1628060451"><a href="#local-1628060451"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628060452"><a href="#local-1628060452"><span class="hs-identifier">fun_ty</span></a></a><span>
</span><a name="line-169"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060453"><a href="#local-1628060453"><span class="hs-identifier">more_arg_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#replicateM"><span class="hs-identifier hs-var">replicateM</span></a><span> </span><a href="#local-1628060451"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="TcMType.html#newOpenInferExpType"><span class="hs-identifier hs-var">newOpenInferExpType</span></a><span>
</span><a name="line-170"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060454"><a href="#local-1628060454"><span class="hs-identifier">res_ty</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenInferExpType"><span class="hs-identifier hs-var">newOpenInferExpType</span></a><span>
</span><a name="line-171"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060455"><a href="#local-1628060455"><span class="hs-identifier">result</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060424"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-1628060450"><span class="hs-identifier hs-var">acc_arg_tys</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-1628060453"><span class="hs-identifier hs-var">more_arg_tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060454"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-172"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060456"><a href="#local-1628060456"><span class="hs-identifier">more_arg_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-1628060453"><span class="hs-identifier hs-var">more_arg_tys</span></a><span>
</span><a name="line-173"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060457"><a href="#local-1628060457"><span class="hs-identifier">res_ty</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-1628060454"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-174"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628060458"><a href="#local-1628060458"><span class="hs-identifier">unif_fun_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkFunTys"><span class="hs-identifier hs-var">mkFunTys</span></a><span> </span><a href="#local-1628060456"><span class="hs-identifier hs-var">more_arg_tys</span></a><span> </span><a href="#local-1628060457"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-175"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060459"><a href="#local-1628060459"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeDS"><span class="hs-identifier hs-var">tcSubTypeDS</span></a><span> </span><a href="TcType.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a><span> </span><a href="TcUnify.html#noThing"><span class="hs-identifier hs-var">noThing</span></a><span> </span><a href="#local-1628060458"><span class="hs-identifier hs-var">unif_fun_ty</span></a><span> </span><a href="#local-1628060452"><span class="hs-identifier hs-var">fun_ty</span></a><span>
</span><a name="line-176"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060455"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060459"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>    </span><span class="hs-comment">------------</span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-identifier">mk_ctxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>    </span><a name="local-1628060427"><a href="#local-1628060427"><span class="hs-identifier">mk_ctxt</span></a></a><span> </span><a name="local-1628060460"><a href="#local-1628060460"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060462"><a href="#local-1628060462"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060463"><a href="#local-1628060463"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-1628060460"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1628060461"><span class="hs-identifier hs-var">orig_tc_ty</span></a><span>
</span><a name="line-181"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628060464"><a href="#local-1628060464"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitFunTys"><span class="hs-identifier hs-var">tcSplitFunTys</span></a><span> </span><a href="#local-1628060463"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-182"></a><span>                           </span><a name="local-1628060465"><a href="#local-1628060465"><span class="hs-identifier">n_actual</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1628060464"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-183"></a><span>                           </span><span class="hs-special">(</span><a name="local-1628060466"><a href="#local-1628060466"><span class="hs-identifier">env''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060467"><a href="#local-1628060467"><span class="hs-identifier">orig_ty'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyOpenType"><span class="hs-identifier hs-var">tidyOpenType</span></a><span> </span><a href="#local-1628060462"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1628060461"><span class="hs-identifier hs-var">orig_tc_ty</span></a><span>
</span><a name="line-184"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-1628060466"><span class="hs-identifier hs-var">env''</span></a><span>
</span><a name="line-185"></a><span>                              </span><span class="hs-special">,</span><span> </span><a href="TcUnify.html#mk_fun_tys_msg"><span class="hs-identifier hs-var">mk_fun_tys_msg</span></a><span> </span><a href="#local-1628060467"><span class="hs-identifier hs-var">orig_ty'</span></a><span> </span><a href="#local-1628060463"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-1628060465"><span class="hs-identifier hs-var">n_actual</span></a><span> </span><a href="#local-1628060422"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-1628060421"><span class="hs-identifier hs-var">herald</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-186"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-187"></a><span>        </span><a name="local-1628060461"><a href="#local-1628060461"><span class="hs-identifier">orig_tc_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMType.html#checkingExpType"><span class="hs-identifier hs-var">checkingExpType</span></a><span> </span><span class="hs-string">&quot;matchExpectedFunTys&quot;</span><span> </span><a href="#local-1628060423"><span class="hs-identifier hs-var">orig_ty</span></a><span>
</span><a name="line-188"></a><span>            </span><span class="hs-comment">-- this is safe b/c we're called from &quot;go&quot;</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-comment">-- Like 'matchExpectedFunTys', but used when you have an &quot;actual&quot; type,</span><span>
</span><a name="line-191"></a><span class="hs-comment">-- for example in function application</span><span>
</span><a name="line-192"></a><span class="hs-identifier">matchActualFunTys</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060419"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-193"></a><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>   </span><span class="hs-comment">-- See Note [Herald for matchExpectedFunTys]</span><span>
</span><a name="line-194"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>
</span><a name="line-195"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060419"><span class="hs-identifier hs-type">a</span></a><span>   </span><span class="hs-comment">-- the thing with type TcSigmaType</span><span>
</span><a name="line-196"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span>
</span><a name="line-197"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span>
</span><a name="line-198"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span class="hs-comment">-- If    matchActualFunTys n ty = (wrap, [t1,..,tn], ty_r)</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- then  wrap : ty &quot;-&gt;&quot; (t1 -&gt; ... -&gt; tn -&gt; ty_r)</span><span>
</span><a name="line-201"></a><a name="matchActualFunTys"><a href="TcUnify.html#matchActualFunTys"><span class="hs-identifier">matchActualFunTys</span></a></a><span> </span><a name="local-1628060469"><a href="#local-1628060469"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-1628060470"><a href="#local-1628060470"><span class="hs-identifier">ct_orig</span></a></a><span> </span><a name="local-1628060471"><a href="#local-1628060471"><span class="hs-identifier">mb_thing</span></a></a><span> </span><a name="local-1628060472"><a href="#local-1628060472"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-1628060473"><a href="#local-1628060473"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-202"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#matchActualFunTysPart"><span class="hs-identifier hs-var">matchActualFunTysPart</span></a><span> </span><a href="#local-1628060469"><span class="hs-identifier hs-var">herald</span></a><span> </span><a href="#local-1628060470"><span class="hs-identifier hs-var">ct_orig</span></a><span> </span><a href="#local-1628060471"><span class="hs-identifier hs-var">mb_thing</span></a><span> </span><a href="#local-1628060472"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-1628060473"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-1628060472"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">-- | Variant of 'matchActualFunTys' that works when supplied only part</span><span>
</span><a name="line-205"></a><span class="hs-comment">-- (that is, to the right of some arrows) of the full function type</span><span>
</span><a name="line-206"></a><span class="hs-identifier">matchActualFunTysPart</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060418"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-207"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-comment">-- See Note [Herald for matchExpectedFunTys]</span><span>
</span><a name="line-208"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>
</span><a name="line-209"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060418"><span class="hs-identifier hs-type">a</span></a><span>  </span><span class="hs-comment">-- the thing with type TcSigmaType</span><span>
</span><a name="line-210"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span>
</span><a name="line-211"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span>
</span><a name="line-212"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- reversed args. See (*) below.</span><span>
</span><a name="line-213"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span>   </span><span class="hs-comment">-- overall arity of the function, for errs</span><span>
</span><a name="line-214"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><a name="matchActualFunTysPart"><a href="TcUnify.html#matchActualFunTysPart"><span class="hs-identifier">matchActualFunTysPart</span></a></a><span> </span><a name="local-1628060474"><a href="#local-1628060474"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-1628060475"><a href="#local-1628060475"><span class="hs-identifier">ct_orig</span></a></a><span> </span><a name="local-1628060476"><a href="#local-1628060476"><span class="hs-identifier">mb_thing</span></a></a><span> </span><a name="local-1628060477"><a href="#local-1628060477"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-1628060478"><a href="#local-1628060478"><span class="hs-identifier">orig_ty</span></a></a><span>
</span><a name="line-216"></a><span>                      </span><a name="local-1628060479"><a href="#local-1628060479"><span class="hs-identifier">orig_old_args</span></a></a><span> </span><a name="local-1628060480"><a href="#local-1628060480"><span class="hs-identifier">full_arity</span></a></a><span>
</span><a name="line-217"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060481"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060477"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-1628060479"><span class="hs-identifier hs-var">orig_old_args</span></a><span> </span><a href="#local-1628060478"><span class="hs-identifier hs-var">orig_ty</span></a><span>
</span><a name="line-218"></a><span class="hs-comment">-- Does not allocate unnecessary meta variables: if the input already is</span><span>
</span><a name="line-219"></a><span class="hs-comment">-- a function, we just take it apart.  Not only is this efficient,</span><span>
</span><a name="line-220"></a><span class="hs-comment">-- it's important for higher rank: the argument might be of form</span><span>
</span><a name="line-221"></a><span class="hs-comment">--              (forall a. ty) -&gt; other</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- If allocated (fresh-meta-var1 -&gt; fresh-meta-var2) and unified, we'd</span><span>
</span><a name="line-223"></a><span class="hs-comment">-- hide the forall inside a meta-variable</span><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-comment">-- (*) Sometimes it's necessary to call matchActualFunTys with only part</span><span>
</span><a name="line-226"></a><span class="hs-comment">-- (that is, to the right of some arrows) of the type of the function in</span><span>
</span><a name="line-227"></a><span class="hs-comment">-- question. (See TcExpr.tcArgs.) This argument is the reversed list of</span><span>
</span><a name="line-228"></a><span class="hs-comment">-- arguments already seen (that is, not part of the TcSigmaType passed</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- in elsewhere).</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-232"></a><span>    </span><span class="hs-comment">-- This function has a bizarre mechanic: it accumulates arguments on</span><span>
</span><a name="line-233"></a><span>    </span><span class="hs-comment">-- the way down and also builds an argument list on the way up. Why:</span><span>
</span><a name="line-234"></a><span>    </span><span class="hs-comment">-- 1. The returns args list and the accumulated args list might be different.</span><span>
</span><a name="line-235"></a><span>    </span><span class="hs-comment">--    The accumulated args include all the arg types for the function,</span><span>
</span><a name="line-236"></a><span>    </span><span class="hs-comment">--    including those from before this function was called. The returned</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-comment">--    list should include only those arguments produced by this call of</span><span>
</span><a name="line-238"></a><span>    </span><span class="hs-comment">--    matchActualFunTys</span><span>
</span><a name="line-239"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-240"></a><span>    </span><span class="hs-comment">-- 2. The HsWrapper can be built only on the way up. It seems (more)</span><span>
</span><a name="line-241"></a><span>    </span><span class="hs-comment">--    bizarre to build the HsWrapper but not the arg_tys.</span><span>
</span><a name="line-242"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-243"></a><span>    </span><span class="hs-comment">-- Refactoring is welcome.</span><span>
</span><a name="line-244"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span>
</span><a name="line-245"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- accumulator of arguments (reversed)</span><span>
</span><a name="line-246"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span>   </span><span class="hs-comment">-- the remainder of the type as we're processing</span><span>
</span><a name="line-247"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>    </span><a name="local-1628060481"><a href="#local-1628060481"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628060484"><a href="#local-1628060484"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#idHsWrapper"><span class="hs-identifier hs-var">idHsWrapper</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-1628060484"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060485"><a href="#local-1628060485"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628060486"><a href="#local-1628060486"><span class="hs-identifier">acc_args</span></a></a><span> </span><a name="local-1628060487"><a href="#local-1628060487"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-251"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628060488"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628060489"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060490"><a href="#local-1628060490"><span class="hs-identifier">wrap1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060491"><a href="#local-1628060491"><span class="hs-identifier">rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span> </span><a href="#local-1628060475"><span class="hs-identifier hs-var">ct_orig</span></a><span> </span><a href="#local-1628060487"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-253"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628060492"><a href="#local-1628060492"><span class="hs-identifier">wrap2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060493"><a href="#local-1628060493"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060494"><a href="#local-1628060494"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060481"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060485"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1628060486"><span class="hs-identifier hs-var">acc_args</span></a><span> </span><a href="#local-1628060491"><span class="hs-identifier hs-var">rho</span></a><span>
</span><a name="line-254"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060492"><span class="hs-identifier hs-var">wrap2</span></a><span> </span><a href="TcEvidence.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-1628060490"><span class="hs-identifier hs-var">wrap1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060493"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060494"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-255"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-256"></a><span>        </span><span class="hs-special">(</span><a name="local-1628060488"><a href="#local-1628060488"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060489"><a href="#local-1628060489"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitSigmaTy"><span class="hs-identifier hs-var">tcSplitSigmaTy</span></a><span> </span><a href="#local-1628060487"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060495"><a href="#local-1628060495"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628060496"><a href="#local-1628060496"><span class="hs-identifier">acc_args</span></a></a><span> </span><a name="local-1628060497"><a href="#local-1628060497"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-259"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628060498"><a href="#local-1628060498"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-1628060497"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060481"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060495"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1628060496"><span class="hs-identifier hs-var">acc_args</span></a><span> </span><a href="#local-1628060498"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060499"><a href="#local-1628060499"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628060500"><a href="#local-1628060500"><span class="hs-identifier">acc_args</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Anon"><span class="hs-identifier hs-var">Anon</span></a><span> </span><a name="local-1628060501"><a href="#local-1628060501"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060502"><a href="#local-1628060502"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isPredTy</span><span> </span><span class="hs-identifier">arg_ty</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060503"><a href="#local-1628060503"><span class="hs-identifier">wrap_res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060504"><a href="#local-1628060504"><span class="hs-identifier">tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060505"><a href="#local-1628060505"><span class="hs-identifier">ty_r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060481"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060499"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1628060501"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1628060500"><span class="hs-identifier hs-var">acc_args</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060502"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-264"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcEvidence.html#mkWpFun"><span class="hs-identifier hs-var">mkWpFun</span></a><span> </span><a href="TcEvidence.html#idHsWrapper"><span class="hs-identifier hs-var">idHsWrapper</span></a><span> </span><a href="#local-1628060503"><span class="hs-identifier hs-var">wrap_res</span></a><span> </span><a href="#local-1628060501"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="#local-1628060505"><span class="hs-identifier hs-var">ty_r</span></a><span>
</span><a name="line-265"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="#local-1628060501"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-1628060504"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060505"><span class="hs-identifier hs-var">ty_r</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060506"><a href="#local-1628060506"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628060507"><a href="#local-1628060507"><span class="hs-identifier">acc_args</span></a></a><span> </span><a name="local-1628060508"><a href="#local-1628060508"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628060509"><a href="#local-1628060509"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTcTyVar</span><span> </span><span class="hs-identifier">tv</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">isMetaTyVar</span><span> </span><span class="hs-identifier">tv</span><span>
</span><a name="line-269"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060510"><a href="#local-1628060510"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a><span> </span><a href="#local-1628060509"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-270"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060510"><span class="hs-identifier hs-var">cts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-271"></a><span>               </span><a href="TcType.html#Indirect"><span class="hs-identifier hs-var">Indirect</span></a><span> </span><a name="local-1628060511"><a href="#local-1628060511"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060481"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060506"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1628060507"><span class="hs-identifier hs-var">acc_args</span></a><span> </span><a href="#local-1628060511"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-272"></a><span>               </span><a href="TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060482"><span class="hs-identifier hs-var">defer</span></a><span> </span><a href="#local-1628060506"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1628060508"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span>       </span><span class="hs-comment">-- In all other cases we bale out into ordinary unification</span><span>
</span><a name="line-275"></a><span>       </span><span class="hs-comment">-- However unlike the meta-tyvar case, we are sure that the</span><span>
</span><a name="line-276"></a><span>       </span><span class="hs-comment">-- number of arguments doesn't match arity of the original</span><span>
</span><a name="line-277"></a><span>       </span><span class="hs-comment">-- type, so we can add a bit more context to the error message</span><span>
</span><a name="line-278"></a><span>       </span><span class="hs-comment">-- (cf Trac #7869).</span><span>
</span><a name="line-279"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-280"></a><span>       </span><span class="hs-comment">-- It is not always an error, because specialized type may have</span><span>
</span><a name="line-281"></a><span>       </span><span class="hs-comment">-- different arity, for example:</span><span>
</span><a name="line-282"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-283"></a><span>       </span><span class="hs-comment">-- &gt; f1 = f2 'a'</span><span>
</span><a name="line-284"></a><span>       </span><span class="hs-comment">-- &gt; f2 :: Monad m =&gt; m Bool</span><span>
</span><a name="line-285"></a><span>       </span><span class="hs-comment">-- &gt; f2 = undefined</span><span>
</span><a name="line-286"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-287"></a><span>       </span><span class="hs-comment">-- But in that case we add specialized type into error context</span><span>
</span><a name="line-288"></a><span>       </span><span class="hs-comment">-- anyway, because it may be useful. See also Trac #9605.</span><span>
</span><a name="line-289"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060512"><a href="#local-1628060512"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628060513"><a href="#local-1628060513"><span class="hs-identifier">acc_args</span></a></a><span> </span><a name="local-1628060514"><a href="#local-1628060514"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060483"><span class="hs-identifier hs-var">mk_ctxt</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-1628060513"><span class="hs-identifier hs-var">acc_args</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060514"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-290"></a><span>                       </span><a href="#local-1628060482"><span class="hs-identifier hs-var">defer</span></a><span> </span><a href="#local-1628060512"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-1628060514"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span>    </span><span class="hs-comment">------------</span><span>
</span><a name="line-293"></a><span>    </span><a name="local-1628060482"><a href="#local-1628060482"><span class="hs-identifier">defer</span></a></a><span> </span><a name="local-1628060515"><a href="#local-1628060515"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-1628060516"><a href="#local-1628060516"><span class="hs-identifier">fun_ty</span></a></a><span>
</span><a name="line-294"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060517"><a href="#local-1628060517"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#replicateM"><span class="hs-identifier hs-var">replicateM</span></a><span> </span><a href="#local-1628060515"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="TcMType.html#newOpenFlexiTyVarTy"><span class="hs-identifier hs-var">newOpenFlexiTyVarTy</span></a><span>
</span><a name="line-295"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060518"><a href="#local-1628060518"><span class="hs-identifier">res_ty</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenFlexiTyVarTy"><span class="hs-identifier hs-var">newOpenFlexiTyVarTy</span></a><span>
</span><a name="line-296"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628060519"><a href="#local-1628060519"><span class="hs-identifier">unif_fun_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkFunTys"><span class="hs-identifier hs-var">mkFunTys</span></a><span> </span><a href="#local-1628060517"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-1628060518"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-297"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060520"><a href="#local-1628060520"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><a href="#local-1628060476"><span class="hs-identifier hs-var">mb_thing</span></a><span> </span><a href="#local-1628060516"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><a href="#local-1628060519"><span class="hs-identifier hs-var">unif_fun_ty</span></a><span>
</span><a name="line-298"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkWpCastN"><span class="hs-identifier hs-var">mkWpCastN</span></a><span> </span><a href="#local-1628060520"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060517"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060518"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span>    </span><span class="hs-comment">------------</span><span>
</span><a name="line-301"></a><span>    </span><span class="hs-identifier">mk_ctxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>    </span><a name="local-1628060483"><a href="#local-1628060483"><span class="hs-identifier">mk_ctxt</span></a></a><span> </span><a name="local-1628060521"><a href="#local-1628060521"><span class="hs-identifier">arg_tys</span></a></a><span> </span><a name="local-1628060522"><a href="#local-1628060522"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-1628060523"><a href="#local-1628060523"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-303"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628060524"><a href="#local-1628060524"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkFunTys"><span class="hs-identifier hs-var">mkFunTys</span></a><span> </span><a href="#local-1628060521"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-1628060522"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-304"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628060525"><a href="#local-1628060525"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060526"><a href="#local-1628060526"><span class="hs-identifier">zonked</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-1628060523"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1628060524"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-305"></a><span>                   </span><span class="hs-comment">-- zonking might change # of args</span><span>
</span><a name="line-306"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628060527"><a href="#local-1628060527"><span class="hs-identifier">zonked_args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitFunTys"><span class="hs-identifier hs-var">tcSplitFunTys</span></a><span> </span><a href="#local-1628060526"><span class="hs-identifier hs-var">zonked</span></a><span>
</span><a name="line-307"></a><span>                 </span><a name="local-1628060528"><a href="#local-1628060528"><span class="hs-identifier">n_actual</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1628060527"><span class="hs-identifier hs-var">zonked_args</span></a><span>
</span><a name="line-308"></a><span>                 </span><span class="hs-special">(</span><a name="local-1628060529"><a href="#local-1628060529"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060530"><a href="#local-1628060530"><span class="hs-identifier">unzonked</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyOpenType"><span class="hs-identifier hs-var">tidyOpenType</span></a><span> </span><a href="#local-1628060525"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-1628060524"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-309"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-1628060529"><span class="hs-identifier hs-var">env2</span></a><span>
</span><a name="line-310"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="TcUnify.html#mk_fun_tys_msg"><span class="hs-identifier hs-var">mk_fun_tys_msg</span></a><span> </span><a href="#local-1628060530"><span class="hs-identifier hs-var">unzonked</span></a><span> </span><a href="#local-1628060526"><span class="hs-identifier hs-var">zonked</span></a><span> </span><a href="#local-1628060528"><span class="hs-identifier hs-var">n_actual</span></a><span> </span><a href="#local-1628060480"><span class="hs-identifier hs-var">full_arity</span></a><span> </span><a href="#local-1628060474"><span class="hs-identifier hs-var">herald</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-identifier">mk_fun_tys_msg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>  </span><span class="hs-comment">-- the full type passed in (unzonked)</span><span>
</span><a name="line-313"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>  </span><span class="hs-comment">-- the full type passed in (zonked)</span><span>
</span><a name="line-314"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span>   </span><span class="hs-comment">-- the # of args found</span><span>
</span><a name="line-315"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span>   </span><span class="hs-comment">-- the # of args wanted</span><span>
</span><a name="line-316"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>    </span><span class="hs-comment">-- overall herald</span><span>
</span><a name="line-317"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-318"></a><a name="mk_fun_tys_msg"><a href="TcUnify.html#mk_fun_tys_msg"><span class="hs-identifier">mk_fun_tys_msg</span></a></a><span> </span><a name="local-1628060531"><a href="#local-1628060531"><span class="hs-identifier">full_ty</span></a></a><span> </span><a name="local-1628060532"><a href="#local-1628060532"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1628060533"><a href="#local-1628060533"><span class="hs-identifier">n_args</span></a></a><span> </span><a name="local-1628060534"><a href="#local-1628060534"><span class="hs-identifier">full_arity</span></a></a><span> </span><a name="local-1628060535"><a href="#local-1628060535"><span class="hs-identifier">herald</span></a></a><span>
</span><a name="line-319"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060535"><span class="hs-identifier hs-var">herald</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#speakNOf"><span class="hs-identifier hs-var">speakNOf</span></a><span> </span><a href="#local-1628060534"><span class="hs-identifier hs-var">full_arity</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;argument&quot;</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-320"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628060533"><span class="hs-identifier hs-var">n_args</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1628060534"><span class="hs-identifier hs-var">full_arity</span></a><span>
</span><a name="line-321"></a><span>      </span><span class="hs-keyword">then</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;its type is&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#pprType"><span class="hs-identifier hs-var">pprType</span></a><span> </span><a href="#local-1628060531"><span class="hs-identifier hs-var">full_ty</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span>
</span><a name="line-322"></a><span>           </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-323"></a><span>           </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;it is specialized to&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#pprType"><span class="hs-identifier hs-var">pprType</span></a><span> </span><a href="#local-1628060532"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;but its type&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#pprType"><span class="hs-identifier hs-var">pprType</span></a><span> </span><a href="#local-1628060532"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-325"></a><span>                </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628060533"><span class="hs-identifier hs-var">n_args</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;has none&quot;</span><span>
</span><a name="line-326"></a><span>                </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;has only&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#speakN"><span class="hs-identifier hs-var">speakN</span></a><span> </span><a href="#local-1628060533"><span class="hs-identifier hs-var">n_args</span></a><span class="hs-special">]</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-329"></a><span class="hs-identifier">matchExpectedListTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span class="hs-comment">-- Special case for lists</span><span>
</span><a name="line-331"></a><a name="matchExpectedListTy"><a href="TcUnify.html#matchExpectedListTy"><span class="hs-identifier">matchExpectedListTy</span></a></a><span> </span><a name="local-1628060536"><a href="#local-1628060536"><span class="hs-identifier">exp_ty</span></a></a><span>
</span><a name="line-332"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060537"><a href="#local-1628060537"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-1628060538"><a href="#local-1628060538"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedTyConApp"><span class="hs-identifier hs-var">matchExpectedTyConApp</span></a><span> </span><a href="TysWiredIn.html#listTyCon"><span class="hs-identifier hs-var">listTyCon</span></a><span> </span><a href="#local-1628060536"><span class="hs-identifier hs-var">exp_ty</span></a><span>
</span><a name="line-333"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060537"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060538"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-336"></a><span class="hs-identifier">matchExpectedPArrTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span class="hs-comment">-- Special case for parrs</span><span>
</span><a name="line-338"></a><a name="matchExpectedPArrTy"><a href="TcUnify.html#matchExpectedPArrTy"><span class="hs-identifier">matchExpectedPArrTy</span></a></a><span> </span><a name="local-1628060539"><a href="#local-1628060539"><span class="hs-identifier">exp_ty</span></a></a><span>
</span><a name="line-339"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060540"><a href="#local-1628060540"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-1628060541"><a href="#local-1628060541"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedTyConApp"><span class="hs-identifier hs-var">matchExpectedTyConApp</span></a><span> </span><a href="TysWiredIn.html#parrTyCon"><span class="hs-identifier hs-var">parrTyCon</span></a><span> </span><a href="#local-1628060539"><span class="hs-identifier hs-var">exp_ty</span></a><span>
</span><a name="line-340"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060540"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060541"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-341"></a><span>
</span><a name="line-342"></a><span class="hs-comment">---------------------</span><span>
</span><a name="line-343"></a><span class="hs-identifier">matchExpectedTyConApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>                </span><span class="hs-comment">-- T :: forall kv1 ... kvm. k1 -&gt; ... -&gt; kn -&gt; *</span><span>
</span><a name="line-344"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a><span>            </span><span class="hs-comment">-- orig_ty</span><span>
</span><a name="line-345"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- T k1 k2 k3 a b c ~N orig_ty</span><span>
</span><a name="line-346"></a><span>                              </span><span class="hs-special">[</span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Element types, k1 k2 k3 a b c</span><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span class="hs-comment">-- It's used for wired-in tycons, so we call checkWiredInTyCon</span><span>
</span><a name="line-349"></a><span class="hs-comment">-- Precondition: never called with FunTyCon</span><span>
</span><a name="line-350"></a><span class="hs-comment">-- Precondition: input type :: *</span><span>
</span><a name="line-351"></a><span class="hs-comment">-- Postcondition: (T k1 k2 k3 a b c) is well-kinded</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><a name="matchExpectedTyConApp"><a href="TcUnify.html#matchExpectedTyConApp"><span class="hs-identifier">matchExpectedTyConApp</span></a></a><span> </span><a name="local-1628060542"><a href="#local-1628060542"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1628060543"><a href="#local-1628060543"><span class="hs-identifier">orig_ty</span></a></a><span>
</span><a name="line-354"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060544"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060543"><span class="hs-identifier hs-var">orig_ty</span></a><span>
</span><a name="line-355"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-356"></a><span>    </span><a name="local-1628060544"><a href="#local-1628060544"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1628060546"><a href="#local-1628060546"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-357"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628060547"><a href="#local-1628060547"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-1628060546"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-358"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060544"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060547"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060548"><a href="#local-1628060548"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628060549"><a href="#local-1628060549"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-1628060550"><a href="#local-1628060550"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-361"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628060542"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1628060549"><span class="hs-identifier hs-var">tycon</span></a><span>  </span><span class="hs-comment">-- Common case</span><span>
</span><a name="line-362"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkTcNomReflCo"><span class="hs-identifier hs-var">mkTcNomReflCo</span></a><span> </span><a href="#local-1628060548"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060550"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-363"></a><span>
</span><a name="line-364"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628060551"><a href="#local-1628060551"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTcTyVar</span><span> </span><span class="hs-identifier">tv</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">isMetaTyVar</span><span> </span><span class="hs-identifier">tv</span><span>
</span><a name="line-366"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060552"><a href="#local-1628060552"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a><span> </span><a href="#local-1628060551"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-367"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060552"><span class="hs-identifier hs-var">cts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-368"></a><span>                </span><a href="TcType.html#Indirect"><span class="hs-identifier hs-var">Indirect</span></a><span> </span><a name="local-1628060553"><a href="#local-1628060553"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060544"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060553"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-369"></a><span>                </span><a href="TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060545"><span class="hs-identifier hs-var">defer</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060545"><span class="hs-identifier hs-var">defer</span></a><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span>    </span><span class="hs-comment">-- If the common case does not occur, instantiate a template</span><span>
</span><a name="line-374"></a><span>    </span><span class="hs-comment">-- T k1 .. kn t1 .. tm, and unify with the original type</span><span>
</span><a name="line-375"></a><span>    </span><span class="hs-comment">-- Doing it this way ensures that the types we return are</span><span>
</span><a name="line-376"></a><span>    </span><span class="hs-comment">-- kind-compatible with T.  For example, suppose we have</span><span>
</span><a name="line-377"></a><span>    </span><span class="hs-comment">--       matchExpectedTyConApp T (f Maybe)</span><span>
</span><a name="line-378"></a><span>    </span><span class="hs-comment">-- where data T a = MkT a</span><span>
</span><a name="line-379"></a><span>    </span><span class="hs-comment">-- Then we don't want to instantate T's data constructors with</span><span>
</span><a name="line-380"></a><span>    </span><span class="hs-comment">--    (a::*) ~ Maybe</span><span>
</span><a name="line-381"></a><span>    </span><span class="hs-comment">-- because that'll make types that are utterly ill-kinded.</span><span>
</span><a name="line-382"></a><span>    </span><span class="hs-comment">-- This happened in Trac #7368</span><span>
</span><a name="line-383"></a><span>    </span><a name="local-1628060545"><a href="#local-1628060545"><span class="hs-identifier">defer</span></a></a><span>
</span><a name="line-384"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060554"><a href="#local-1628060554"><span class="hs-identifier">_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060555"><a href="#local-1628060555"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#tcInstBinders"><span class="hs-identifier hs-var">tcInstBinders</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-1628060542"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060556"><a href="#local-1628060556"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><a href="TcUnify.html#noThing"><span class="hs-identifier hs-var">noThing</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-1628060542"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-1628060555"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060543"><span class="hs-identifier hs-var">orig_ty</span></a><span>
</span><a name="line-386"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060556"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060555"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-389"></a><span class="hs-identifier">matchExpectedAppTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a><span>                         </span><span class="hs-comment">-- orig_ty</span><span>
</span><a name="line-390"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#TcCoercion"><span class="hs-identifier hs-type">TcCoercion</span></a><span class="hs-special">,</span><span>                   </span><span class="hs-comment">-- m a ~N orig_ty</span><span>
</span><a name="line-391"></a><span>                           </span><span class="hs-special">(</span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Returns m, a</span><span>
</span><a name="line-392"></a><span class="hs-comment">-- If the incoming type is a mutable type variable of kind k, then</span><span>
</span><a name="line-393"></a><span class="hs-comment">-- matchExpectedAppTy returns a new type variable (m: * -&gt; k); note the *.</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><a name="matchExpectedAppTy"><a href="TcUnify.html#matchExpectedAppTy"><span class="hs-identifier">matchExpectedAppTy</span></a></a><span> </span><a name="local-1628060557"><a href="#local-1628060557"><span class="hs-identifier">orig_ty</span></a></a><span>
</span><a name="line-396"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060558"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060557"><span class="hs-identifier hs-var">orig_ty</span></a><span>
</span><a name="line-397"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-398"></a><span>    </span><a name="local-1628060558"><a href="#local-1628060558"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1628060563"><a href="#local-1628060563"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-399"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628060564"><a href="#local-1628060564"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-1628060563"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060558"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060564"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628060565"><a href="#local-1628060565"><span class="hs-identifier">fun_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060566"><a href="#local-1628060566"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcType.html#tcSplitAppTy_maybe"><span class="hs-identifier hs-var">tcSplitAppTy_maybe</span></a><span> </span><a href="#local-1628060563"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-402"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkTcNomReflCo"><span class="hs-identifier hs-var">mkTcNomReflCo</span></a><span> </span><a href="#local-1628060557"><span class="hs-identifier hs-var">orig_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-1628060565"><span class="hs-identifier hs-var">fun_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060566"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628060567"><a href="#local-1628060567"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTcTyVar</span><span> </span><span class="hs-identifier">tv</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">isMetaTyVar</span><span> </span><span class="hs-identifier">tv</span><span>
</span><a name="line-406"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060568"><a href="#local-1628060568"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a><span> </span><a href="#local-1628060567"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-407"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060568"><span class="hs-identifier hs-var">cts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-408"></a><span>               </span><a href="TcType.html#Indirect"><span class="hs-identifier hs-var">Indirect</span></a><span> </span><a name="local-1628060569"><a href="#local-1628060569"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060558"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060569"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-409"></a><span>               </span><a href="TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060559"><span class="hs-identifier hs-var">defer</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-410"></a><span>
</span><a name="line-411"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060559"><span class="hs-identifier hs-var">defer</span></a><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span>    </span><span class="hs-comment">-- Defer splitting by generating an equality constraint</span><span>
</span><a name="line-414"></a><span>    </span><a name="local-1628060559"><a href="#local-1628060559"><span class="hs-identifier">defer</span></a></a><span>
</span><a name="line-415"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060570"><a href="#local-1628060570"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><a href="#local-1628060561"><span class="hs-identifier hs-var">kind1</span></a><span>
</span><a name="line-416"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060571"><a href="#local-1628060571"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><a href="#local-1628060562"><span class="hs-identifier hs-var">kind2</span></a><span>
</span><a name="line-417"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060572"><a href="#local-1628060572"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><a href="TcUnify.html#noThing"><span class="hs-identifier hs-var">noThing</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkAppTy"><span class="hs-identifier hs-var">mkAppTy</span></a><span> </span><a href="#local-1628060570"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060571"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060557"><span class="hs-identifier hs-var">orig_ty</span></a><span>
</span><a name="line-418"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060572"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-1628060570"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060571"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-419"></a><span>
</span><a name="line-420"></a><span>    </span><a name="local-1628060560"><a href="#local-1628060560"><span class="hs-identifier">orig_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628060557"><span class="hs-identifier hs-var">orig_ty</span></a><span>
</span><a name="line-421"></a><span>    </span><a name="local-1628060561"><a href="#local-1628060561"><span class="hs-identifier">kind1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkFunTy"><span class="hs-identifier hs-var">mkFunTy</span></a><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span> </span><a href="#local-1628060560"><span class="hs-identifier hs-var">orig_kind</span></a><span>
</span><a name="line-422"></a><span>    </span><a name="local-1628060562"><a href="#local-1628060562"><span class="hs-identifier">kind2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span>    </span><span class="hs-comment">-- m :: * -&gt; k</span><span>
</span><a name="line-423"></a><span>                              </span><span class="hs-comment">-- arg type :: *</span><span>
</span><a name="line-424"></a><span>
</span><a name="line-425"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Subsumption checking
*                                                                      *
************************************************************************

Note [Subsumption checking: tcSubType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
All the tcSubType calls have the form
                tcSubType actual_ty expected_ty
which checks
                actual_ty &lt;= expected_ty

That is, that a value of type actual_ty is acceptable in
a place expecting a value of type expected_ty.  I.e. that

    actual ty   is more polymorphic than   expected_ty

It returns a coercion function
        co_fn :: actual_ty ~ expected_ty
which takes an HsExpr of type actual_ty into one of type
expected_ty.

These functions do not actually check for subsumption. They check if
expected_ty is an appropriate annotation to use for something of type
actual_ty. This difference matters when thinking about visible type
application. For example,

   forall a. a -&gt; forall b. b -&gt; b
      DOES NOT SUBSUME
   forall a b. a -&gt; b -&gt; b

because the type arguments appear in a different order. (Neither does
it work the other way around.) BUT, these types are appropriate annotations
for one another. Because the user directs annotations, it's OK if some
arguments shuffle around -- after all, it's what the user wants.
Bottom line: none of this changes with visible type application.

There are a number of wrinkles (below).

Notice that Wrinkle 1 and 2 both require eta-expansion, which technically
may increase termination.  We just put up with this, in exchange for getting
more predictable type inference.

Wrinkle 1: Note [Deep skolemisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want   (forall a. Int -&gt; a -&gt; a)  &lt;=  (Int -&gt; forall a. a-&gt;a)
(see section 4.6 of &quot;Practical type inference for higher rank types&quot;)
So we must deeply-skolemise the RHS before we instantiate the LHS.

That is why tc_sub_type starts with a call to tcSkolemise (which does the
deep skolemisation), and then calls the DS variant (which assumes
that expected_ty is deeply skolemised)

Wrinkle 2: Note [Co/contra-variance of subsumption checking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider  g :: (Int -&gt; Int) -&gt; Int
  f1 :: (forall a. a -&gt; a) -&gt; Int
  f1 = g

  f2 :: (forall a. a -&gt; a) -&gt; Int
  f2 x = g x
f2 will typecheck, and it would be odd/fragile if f1 did not.
But f1 will only typecheck if we have that
    (Int-&gt;Int) -&gt; Int  &lt;=  (forall a. a-&gt;a) -&gt; Int
And that is only true if we do the full co/contravariant thing
in the subsumption check.  That happens in the FunTy case of
tcSubTypeDS_NC_O, and is the sole reason for the WpFun form of
HsWrapper.

Another powerful reason for doing this co/contra stuff is visible
in Trac #9569, involving instantiation of constraint variables,
and again involving eta-expansion.

Wrinkle 3: Note [Higher rank types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider tc150:
  f y = \ (x::forall a. a-&gt;a). blah
The following happens:
* We will infer the type of the RHS, ie with a res_ty = alpha.
* Then the lambda will split  alpha := beta -&gt; gamma.
* And then we'll check tcSubType IsSwapped beta (forall a. a-&gt;a)

So it's important that we unify beta := forall a. a-&gt;a, rather than
skolemising the type.
-}</span><span>
</span><a name="line-512"></a><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span class="hs-comment">-- | Call this variant when you are in a higher-rank situation and</span><span>
</span><a name="line-515"></a><span class="hs-comment">-- you know the right-hand type is deeply skolemised.</span><span>
</span><a name="line-516"></a><span class="hs-identifier">tcSubTypeHR</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060417"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-517"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>    </span><span class="hs-comment">-- ^ of the actual type</span><span>
</span><a name="line-518"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060417"><span class="hs-identifier hs-type">a</span></a><span>     </span><span class="hs-comment">-- ^ If present, it has type ty_actual</span><span>
</span><a name="line-519"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-520"></a><a name="tcSubTypeHR"><a href="TcUnify.html#tcSubTypeHR"><span class="hs-identifier">tcSubTypeHR</span></a></a><span> </span><a name="local-1628060573"><a href="#local-1628060573"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#tcSubTypeDS_NC_O"><span class="hs-identifier hs-var">tcSubTypeDS_NC_O</span></a><span> </span><a href="#local-1628060573"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="TcType.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span class="hs-identifier">tcSubType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060416"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-523"></a><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060416"><span class="hs-identifier hs-type">a</span></a><span>  </span><span class="hs-comment">-- ^ If present, it has type ty_actual</span><span>
</span><a name="line-524"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpSigmaType"><span class="hs-identifier hs-type">ExpSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-525"></a><span class="hs-comment">-- Checks that actual &lt;= expected</span><span>
</span><a name="line-526"></a><span class="hs-comment">-- Returns HsWrapper :: actual ~ expected</span><span>
</span><a name="line-527"></a><a name="tcSubType"><a href="TcUnify.html#tcSubType"><span class="hs-identifier">tcSubType</span></a></a><span> </span><a name="local-1628060574"><a href="#local-1628060574"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1628060575"><a href="#local-1628060575"><span class="hs-identifier">maybe_thing</span></a></a><span> </span><a name="local-1628060576"><a href="#local-1628060576"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060577"><a href="#local-1628060577"><span class="hs-identifier">ty_expected</span></a></a><span>
</span><a name="line-528"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#tcSubTypeO"><span class="hs-identifier hs-var">tcSubTypeO</span></a><span> </span><a href="#local-1628060578"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060574"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060576"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060577"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-529"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-530"></a><span>    </span><a name="local-1628060578"><a href="#local-1628060578"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060576"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-531"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060577"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-532"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_thing</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#mkErrorThing"><span class="hs-identifier hs-var">mkErrorThing</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="#local-1628060575"><span class="hs-identifier hs-var">maybe_thing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span class="hs-comment">-- | This is like 'tcSubType' but accepts an 'ExpType' as the /actual/ type.</span><span>
</span><a name="line-536"></a><span class="hs-comment">-- You probably want this only when looking at patterns, never expressions.</span><span>
</span><a name="line-537"></a><span class="hs-identifier">tcSubTypeET</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpSigmaType"><span class="hs-identifier hs-type">ExpSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-538"></a><a name="tcSubTypeET"><a href="TcUnify.html#tcSubTypeET"><span class="hs-identifier">tcSubTypeET</span></a></a><span> </span><a name="local-1628060579"><a href="#local-1628060579"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-1628060580"><a href="#local-1628060580"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060581"><a href="#local-1628060581"><span class="hs-identifier">ty_expected</span></a></a><span>
</span><a name="line-539"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#uExpTypeX"><span class="hs-identifier hs-var">uExpTypeX</span></a><span> </span><a href="#local-1628060579"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-1628060581"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><a href="#local-1628060580"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-540"></a><span>              </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcEvidence.html#mkWpCastN"><span class="hs-identifier hs-var">mkWpCastN</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcEvidence.html#mkTcSymCo"><span class="hs-identifier hs-var">mkTcSymCo</span></a><span class="hs-special">)</span><span>
</span><a name="line-541"></a><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1628060582"><a href="#local-1628060582"><span class="hs-identifier">ty_a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcUnify.html#tcSubTypeO"><span class="hs-identifier hs-var">tcSubTypeO</span></a><span> </span><a href="#local-1628060579"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="TcType.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a><span> </span><a href="#local-1628060582"><span class="hs-identifier hs-var">ty_a</span></a><span>
</span><a name="line-542"></a><span>                                    </span><span class="hs-special">(</span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628060581"><span class="hs-identifier hs-var">ty_expected</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span class="hs-comment">-- | This is like 'tcSubType' but accepts an 'ExpType' as the /actual/ type.</span><span>
</span><a name="line-545"></a><span class="hs-comment">-- You probably want this only when looking at patterns, never expressions.</span><span>
</span><a name="line-546"></a><span class="hs-comment">-- Does not add context.</span><span>
</span><a name="line-547"></a><span class="hs-identifier">tcSubTypeET_NC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpSigmaType"><span class="hs-identifier hs-type">ExpSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-548"></a><a name="tcSubTypeET_NC"><a href="TcUnify.html#tcSubTypeET_NC"><span class="hs-identifier">tcSubTypeET_NC</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628060583"><a href="#local-1628060583"><span class="hs-identifier">ty_actual</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcType.html#Infer"><span class="hs-identifier hs-var">Infer</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-1628060584"><a href="#local-1628060584"><span class="hs-identifier">ty_expected</span></a></a><span>
</span><a name="line-549"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#mkWpCastN"><span class="hs-identifier hs-var">mkWpCastN</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcEvidence.html#mkTcSymCo"><span class="hs-identifier hs-var">mkTcSymCo</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="TcUnify.html#unifyExpType"><span class="hs-identifier hs-var">unifyExpType</span></a><span> </span><a href="TcUnify.html#noThing"><span class="hs-identifier hs-var">noThing</span></a><span> </span><a href="#local-1628060584"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><a href="#local-1628060583"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-550"></a><span class="hs-identifier">tcSubTypeET_NC</span><span> </span><a name="local-1628060585"><a href="#local-1628060585"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><a href="TcType.html#Check"><span class="hs-identifier hs-var">Check</span></a><span> </span><a name="local-1628060586"><a href="#local-1628060586"><span class="hs-identifier">ty_actual</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060587"><a href="#local-1628060587"><span class="hs-identifier">ty_expected</span></a></a><span>
</span><a name="line-551"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#tc_sub_type"><span class="hs-identifier hs-var">tc_sub_type</span></a><span> </span><a href="#local-1628060589"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-1628060589"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-1628060585"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060586"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060588"><span class="hs-identifier hs-var">ty_expected'</span></a><span>
</span><a name="line-552"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-553"></a><span>    </span><a name="local-1628060588"><a href="#local-1628060588"><span class="hs-identifier">ty_expected'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628060587"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-554"></a><span>    </span><a name="local-1628060589"><a href="#local-1628060589"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060586"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-555"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060588"><span class="hs-identifier hs-var">ty_expected'</span></a><span>
</span><a name="line-556"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_thing</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-557"></a><span>
</span><a name="line-558"></a><span class="hs-identifier">tcSubTypeO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>      </span><span class="hs-comment">-- ^ of the actual type</span><span>
</span><a name="line-559"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span>  </span><span class="hs-comment">-- ^ of the expected type</span><span>
</span><a name="line-560"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span>
</span><a name="line-561"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpSigmaType"><span class="hs-identifier hs-type">ExpSigmaType</span></a><span>
</span><a name="line-562"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-563"></a><a name="tcSubTypeO"><a href="TcUnify.html#tcSubTypeO"><span class="hs-identifier">tcSubTypeO</span></a></a><span> </span><a name="local-1628060590"><a href="#local-1628060590"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-1628060591"><a href="#local-1628060591"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1628060592"><a href="#local-1628060592"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060593"><a href="#local-1628060593"><span class="hs-identifier">ty_expected</span></a></a><span>
</span><a name="line-564"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#addSubTypeCtxt"><span class="hs-identifier hs-var">addSubTypeCtxt</span></a><span> </span><a href="#local-1628060592"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060593"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-565"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcSubType&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="TcRnTypes.html#pprCtOrigin"><span class="hs-identifier hs-var">pprCtOrigin</span></a><span> </span><a href="#local-1628060590"><span class="hs-identifier hs-var">origin</span></a><span>
</span><a name="line-566"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a href="TcType.html#pprUserTypeCtxt"><span class="hs-identifier hs-var">pprUserTypeCtxt</span></a><span> </span><a href="#local-1628060591"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-567"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060592"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-568"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060593"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-569"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tc_sub_type"><span class="hs-identifier hs-var">tc_sub_type</span></a><span> </span><a href="#local-1628060594"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="#local-1628060590"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060591"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060592"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060593"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-570"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-571"></a><span>    </span><a name="local-1628060594"><a href="#local-1628060594"><span class="hs-identifier">eq_orig</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060590"><span class="hs-identifier hs-var">origin</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060590"><span class="hs-identifier hs-var">origin</span></a><span>
</span><a name="line-572"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-573"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060592"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-574"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060593"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-575"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_thing</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span class="hs-identifier">tcSubTypeDS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060415"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060415"><span class="hs-identifier hs-type">a</span></a><span>  </span><span class="hs-comment">-- ^ has type ty_actual</span><span>
</span><a name="line-578"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-579"></a><span class="hs-comment">-- Just like tcSubType, but with the additional precondition that</span><span>
</span><a name="line-580"></a><span class="hs-comment">-- ty_expected is deeply skolemised (hence &quot;DS&quot;)</span><span>
</span><a name="line-581"></a><a name="tcSubTypeDS"><a href="TcUnify.html#tcSubTypeDS"><span class="hs-identifier">tcSubTypeDS</span></a></a><span> </span><a name="local-1628060595"><a href="#local-1628060595"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1628060596"><a href="#local-1628060596"><span class="hs-identifier">m_expr</span></a></a><span> </span><a name="local-1628060597"><a href="#local-1628060597"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060598"><a href="#local-1628060598"><span class="hs-identifier">ty_expected</span></a></a><span>
</span><a name="line-582"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#addSubTypeCtxt"><span class="hs-identifier hs-var">addSubTypeCtxt</span></a><span> </span><a href="#local-1628060597"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060598"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-583"></a><span>    </span><a href="TcUnify.html#tcSubTypeDS_NC"><span class="hs-identifier hs-var">tcSubTypeDS_NC</span></a><span> </span><a href="#local-1628060595"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060596"><span class="hs-identifier hs-var">m_expr</span></a><span> </span><a href="#local-1628060597"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060598"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-584"></a><span>
</span><a name="line-585"></a><span class="hs-comment">-- | Like 'tcSubTypeDS', but takes a 'CtOrigin' to use when instantiating</span><span>
</span><a name="line-586"></a><span class="hs-comment">-- the &quot;actual&quot; type</span><span>
</span><a name="line-587"></a><span class="hs-identifier">tcSubTypeDS_O</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060414"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-588"></a><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span>
</span><a name="line-589"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060414"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a><span>
</span><a name="line-590"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-591"></a><a name="tcSubTypeDS_O"><a href="TcUnify.html#tcSubTypeDS_O"><span class="hs-identifier">tcSubTypeDS_O</span></a></a><span> </span><a name="local-1628060599"><a href="#local-1628060599"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-1628060600"><a href="#local-1628060600"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1628060601"><a href="#local-1628060601"><span class="hs-identifier">maybe_thing</span></a></a><span> </span><a name="local-1628060602"><a href="#local-1628060602"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060603"><a href="#local-1628060603"><span class="hs-identifier">ty_expected</span></a></a><span>
</span><a name="line-592"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#addSubTypeCtxt"><span class="hs-identifier hs-var">addSubTypeCtxt</span></a><span> </span><a href="#local-1628060602"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060603"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-593"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcSubTypeDS_O&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="TcRnTypes.html#pprCtOrigin"><span class="hs-identifier hs-var">pprCtOrigin</span></a><span> </span><a href="#local-1628060599"><span class="hs-identifier hs-var">orig</span></a><span>
</span><a name="line-594"></a><span>                                       </span><span class="hs-special">,</span><span> </span><a href="TcType.html#pprUserTypeCtxt"><span class="hs-identifier hs-var">pprUserTypeCtxt</span></a><span> </span><a href="#local-1628060600"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-595"></a><span>                                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060602"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-596"></a><span>                                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060603"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tcSubTypeDS_NC_O"><span class="hs-identifier hs-var">tcSubTypeDS_NC_O</span></a><span> </span><a href="#local-1628060599"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-1628060600"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060601"><span class="hs-identifier hs-var">maybe_thing</span></a><span> </span><a href="#local-1628060602"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060603"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span class="hs-identifier">addSubTypeCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpType"><span class="hs-identifier hs-type">ExpType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628060413"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628060413"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-600"></a><a name="addSubTypeCtxt"><a href="TcUnify.html#addSubTypeCtxt"><span class="hs-identifier">addSubTypeCtxt</span></a></a><span> </span><a name="local-1628060604"><a href="#local-1628060604"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060605"><a href="#local-1628060605"><span class="hs-identifier">ty_expected</span></a></a><span> </span><a name="local-1628060606"><a href="#local-1628060606"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-601"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="TcType.html#isRhoTy"><span class="hs-identifier hs-var">isRhoTy</span></a><span> </span><a href="#local-1628060604"><span class="hs-identifier hs-var">ty_actual</span></a><span>        </span><span class="hs-comment">-- If there is no polymorphism involved, the</span><span>
</span><a name="line-602"></a><span> </span><span class="hs-special">,</span><span> </span><a href="TcType.html#isRhoExpTy"><span class="hs-identifier hs-var">isRhoExpTy</span></a><span> </span><a href="#local-1628060605"><span class="hs-identifier hs-var">ty_expected</span></a><span>   </span><span class="hs-comment">-- TypeEqOrigin stuff (added by the _NC functions)</span><span>
</span><a name="line-603"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060606"><span class="hs-identifier hs-var">thing_inside</span></a><span>             </span><span class="hs-comment">-- gives enough context by itself</span><span>
</span><a name="line-604"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-605"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a><span> </span><a href="#local-1628060607"><span class="hs-identifier hs-var">mk_msg</span></a><span> </span><a href="#local-1628060606"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-606"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-607"></a><span>    </span><a name="local-1628060607"><a href="#local-1628060607"><span class="hs-identifier">mk_msg</span></a></a><span> </span><a name="local-1628060608"><a href="#local-1628060608"><span class="hs-identifier">tidy_env</span></a></a><span>
</span><a name="line-608"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060609"><a href="#local-1628060609"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060610"><a href="#local-1628060610"><span class="hs-identifier">ty_actual</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-1628060608"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-1628060604"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-609"></a><span>                   </span><span class="hs-comment">-- might not be filled if we're debugging. ugh.</span><span>
</span><a name="line-610"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060611"><a href="#local-1628060611"><span class="hs-identifier">mb_ty_expected</span></a></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType_maybe"><span class="hs-identifier hs-var">readExpType_maybe</span></a><span> </span><a href="#local-1628060605"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-611"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628060613"><a href="#local-1628060613"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060614"><a href="#local-1628060614"><span class="hs-identifier">ty_expected</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060611"><span class="hs-identifier hs-var">mb_ty_expected</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-612"></a><span>                                          </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628060612"><a href="#local-1628060612"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Arrow.html#second"><span class="hs-identifier hs-var">second</span></a><span> </span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span>
</span><a name="line-613"></a><span>                                                     </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-1628060609"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-1628060612"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-614"></a><span>                                          </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060609"><span class="hs-identifier hs-var">tidy_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060605"><span class="hs-identifier hs-var">ty_expected</span></a><span class="hs-special">)</span><span>
</span><a name="line-615"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060615"><a href="#local-1628060615"><span class="hs-identifier">ty_expected</span></a></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-1628060614"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-616"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628060616"><a href="#local-1628060616"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060617"><a href="#local-1628060617"><span class="hs-identifier">ty_expected</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-1628060613"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-1628060615"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-617"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628060618"><a href="#local-1628060618"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;When checking that:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>                                 </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060610"><span class="hs-identifier hs-var">ty_actual</span></a><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;is more polymorphic than:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>                                         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060617"><span class="hs-identifier hs-var">ty_expected</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-621"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060616"><span class="hs-identifier hs-var">tidy_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060618"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-622"></a><span>
</span><a name="line-623"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-624"></a><span class="hs-comment">-- The &quot;_NC&quot; variants do not add a typechecker-error context;</span><span>
</span><a name="line-625"></a><span class="hs-comment">-- the caller is assumed to do that</span><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span class="hs-identifier">tcSubType_NC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpSigmaType"><span class="hs-identifier hs-type">ExpSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-628"></a><a name="tcSubType_NC"><a href="TcUnify.html#tcSubType_NC"><span class="hs-identifier">tcSubType_NC</span></a></a><span> </span><a name="local-1628060619"><a href="#local-1628060619"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1628060620"><a href="#local-1628060620"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060621"><a href="#local-1628060621"><span class="hs-identifier">ty_expected</span></a></a><span>
</span><a name="line-629"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcSubType_NC&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="TcType.html#pprUserTypeCtxt"><span class="hs-identifier hs-var">pprUserTypeCtxt</span></a><span> </span><a href="#local-1628060619"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060620"><span class="hs-identifier hs-var">ty_actual</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060621"><span class="hs-identifier hs-var">ty_expected</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-630"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tc_sub_type"><span class="hs-identifier hs-var">tc_sub_type</span></a><span> </span><a href="#local-1628060622"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060622"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060619"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060620"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060621"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-631"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-632"></a><span>    </span><a name="local-1628060622"><a href="#local-1628060622"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060620"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-633"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060621"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-634"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_thing</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-635"></a><span>
</span><a name="line-636"></a><span class="hs-identifier">tcSubTypeDS_NC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060412"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-637"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span>
</span><a name="line-638"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060412"><span class="hs-identifier hs-type">a</span></a><span>  </span><span class="hs-comment">-- ^ If present, this has type ty_actual</span><span>
</span><a name="line-639"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-640"></a><a name="tcSubTypeDS_NC"><a href="TcUnify.html#tcSubTypeDS_NC"><span class="hs-identifier">tcSubTypeDS_NC</span></a></a><span> </span><a name="local-1628060623"><a href="#local-1628060623"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1628060624"><a href="#local-1628060624"><span class="hs-identifier">maybe_thing</span></a></a><span> </span><a name="local-1628060625"><a href="#local-1628060625"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060626"><a href="#local-1628060626"><span class="hs-identifier">ty_expected</span></a></a><span>
</span><a name="line-641"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcSubTypeDS_NC&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="TcType.html#pprUserTypeCtxt"><span class="hs-identifier hs-var">pprUserTypeCtxt</span></a><span> </span><a href="#local-1628060623"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060625"><span class="hs-identifier hs-var">ty_actual</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060626"><span class="hs-identifier hs-var">ty_expected</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tcSubTypeDS_NC_O"><span class="hs-identifier hs-var">tcSubTypeDS_NC_O</span></a><span> </span><a href="#local-1628060627"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060623"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060624"><span class="hs-identifier hs-var">maybe_thing</span></a><span> </span><a href="#local-1628060625"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060626"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-643"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-644"></a><span>    </span><a name="local-1628060627"><a href="#local-1628060627"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060625"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-645"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060626"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-646"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_thing</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#mkErrorThing"><span class="hs-identifier hs-var">mkErrorThing</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="#local-1628060624"><span class="hs-identifier hs-var">maybe_thing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-647"></a><span>
</span><a name="line-648"></a><span class="hs-identifier">tcSubTypeDS_NC_O</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060411"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-649"></a><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>   </span><span class="hs-comment">-- origin used for instantiation only</span><span>
</span><a name="line-650"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span>
</span><a name="line-651"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060411"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-652"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-653"></a><span class="hs-comment">-- Just like tcSubType, but with the additional precondition that</span><span>
</span><a name="line-654"></a><span class="hs-comment">-- ty_expected is deeply skolemised</span><span>
</span><a name="line-655"></a><a name="tcSubTypeDS_NC_O"><a href="TcUnify.html#tcSubTypeDS_NC_O"><span class="hs-identifier">tcSubTypeDS_NC_O</span></a></a><span> </span><a name="local-1628060628"><a href="#local-1628060628"><span class="hs-identifier">inst_orig</span></a></a><span> </span><a name="local-1628060629"><a href="#local-1628060629"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1628060630"><a href="#local-1628060630"><span class="hs-identifier">m_thing</span></a></a><span> </span><a name="local-1628060631"><a href="#local-1628060631"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060632"><a href="#local-1628060632"><span class="hs-identifier">et</span></a></a><span>
</span><a name="line-656"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#uExpTypeX"><span class="hs-identifier hs-var">uExpTypeX</span></a><span> </span><a href="#local-1628060633"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="#local-1628060631"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060632"><span class="hs-identifier hs-var">et</span></a><span>
</span><a name="line-657"></a><span>      </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcEvidence.html#mkWpCastN"><span class="hs-identifier hs-var">mkWpCastN</span></a><span class="hs-special">)</span><span>
</span><a name="line-658"></a><span>      </span><span class="hs-special">(</span><a href="TcUnify.html#tc_sub_type_ds"><span class="hs-identifier hs-var">tc_sub_type_ds</span></a><span> </span><a href="#local-1628060633"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="#local-1628060628"><span class="hs-identifier hs-var">inst_orig</span></a><span> </span><a href="#local-1628060629"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060631"><span class="hs-identifier hs-var">ty_actual</span></a><span class="hs-special">)</span><span>
</span><a name="line-659"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-660"></a><span>    </span><a name="local-1628060633"><a href="#local-1628060633"><span class="hs-identifier">eq_orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060631"><span class="hs-identifier hs-var">ty_actual</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060632"><span class="hs-identifier hs-var">et</span></a><span>
</span><a name="line-661"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_thing</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#mkErrorThing"><span class="hs-identifier hs-var">mkErrorThing</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="#local-1628060630"><span class="hs-identifier hs-var">m_thing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-662"></a><span>
</span><a name="line-663"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-664"></a><span class="hs-identifier">tc_sub_type</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>   </span><span class="hs-comment">-- origin used when calling uType</span><span>
</span><a name="line-665"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>   </span><span class="hs-comment">-- origin used when instantiating</span><span>
</span><a name="line-666"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpSigmaType"><span class="hs-identifier hs-type">ExpSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-667"></a><a name="tc_sub_type"><a href="TcUnify.html#tc_sub_type"><span class="hs-identifier">tc_sub_type</span></a></a><span> </span><a name="local-1628060634"><a href="#local-1628060634"><span class="hs-identifier">eq_orig</span></a></a><span> </span><a name="local-1628060635"><a href="#local-1628060635"><span class="hs-identifier">inst_orig</span></a></a><span> </span><a name="local-1628060636"><a href="#local-1628060636"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1628060637"><a href="#local-1628060637"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060638"><a href="#local-1628060638"><span class="hs-identifier">et</span></a></a><span>
</span><a name="line-668"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#uExpTypeX"><span class="hs-identifier hs-var">uExpTypeX</span></a><span> </span><a href="#local-1628060634"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="#local-1628060637"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060638"><span class="hs-identifier hs-var">et</span></a><span>
</span><a name="line-669"></a><span>      </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcEvidence.html#mkWpCastN"><span class="hs-identifier hs-var">mkWpCastN</span></a><span class="hs-special">)</span><span>
</span><a name="line-670"></a><span>      </span><span class="hs-special">(</span><a href="TcUnify.html#tc_sub_tc_type"><span class="hs-identifier hs-var">tc_sub_tc_type</span></a><span> </span><a href="#local-1628060634"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="#local-1628060635"><span class="hs-identifier hs-var">inst_orig</span></a><span> </span><a href="#local-1628060636"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060637"><span class="hs-identifier hs-var">ty_actual</span></a><span class="hs-special">)</span><span>
</span><a name="line-671"></a><span>
</span><a name="line-672"></a><span class="hs-identifier">tc_sub_tc_type</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>   </span><span class="hs-comment">-- used when calling uType</span><span>
</span><a name="line-673"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>   </span><span class="hs-comment">-- used when instantiating</span><span>
</span><a name="line-674"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-675"></a><a name="tc_sub_tc_type"><a href="TcUnify.html#tc_sub_tc_type"><span class="hs-identifier">tc_sub_tc_type</span></a></a><span> </span><a name="local-1628060639"><a href="#local-1628060639"><span class="hs-identifier">eq_orig</span></a></a><span> </span><a name="local-1628060640"><a href="#local-1628060640"><span class="hs-identifier">inst_orig</span></a></a><span> </span><a name="local-1628060641"><a href="#local-1628060641"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1628060642"><a href="#local-1628060642"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060643"><a href="#local-1628060643"><span class="hs-identifier">ty_expected</span></a></a><span>
</span><a name="line-676"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628060644"><a href="#local-1628060644"><span class="hs-identifier">tv_actual</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcType.html#tcGetTyVar_maybe"><span class="hs-identifier hs-var">tcGetTyVar_maybe</span></a><span> </span><a href="#local-1628060642"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><span class="hs-comment">-- See Note [Higher rank types]</span><span>
</span><a name="line-677"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060645"><a href="#local-1628060645"><span class="hs-identifier">lookup_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#lookupTcTyVar"><span class="hs-identifier hs-var">lookupTcTyVar</span></a><span> </span><a href="#local-1628060644"><span class="hs-identifier hs-var">tv_actual</span></a><span>
</span><a name="line-678"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060645"><span class="hs-identifier hs-var">lookup_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-679"></a><span>           </span><a href="TcUnify.html#Filled"><span class="hs-identifier hs-var">Filled</span></a><span> </span><a name="local-1628060646"><a href="#local-1628060646"><span class="hs-identifier">ty_actual'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcUnify.html#tc_sub_tc_type"><span class="hs-identifier hs-var">tc_sub_tc_type</span></a><span> </span><a href="#local-1628060639"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="#local-1628060640"><span class="hs-identifier hs-var">inst_orig</span></a><span>
</span><a name="line-680"></a><span>                                               </span><a href="#local-1628060641"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060646"><span class="hs-identifier hs-var">ty_actual'</span></a><span> </span><a href="#local-1628060643"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-681"></a><span>
</span><a name="line-682"></a><span>             </span><span class="hs-comment">-- It's tempting to see if tv_actual can unify with a polytype</span><span>
</span><a name="line-683"></a><span>             </span><span class="hs-comment">-- and, if so, call uType; otherwise, skolemise first. But this</span><span>
</span><a name="line-684"></a><span>             </span><span class="hs-comment">-- is wrong, because skolemising will bump the TcLevel and the</span><span>
</span><a name="line-685"></a><span>             </span><span class="hs-comment">-- unification will fail anyway.</span><span>
</span><a name="line-686"></a><span>             </span><span class="hs-comment">-- It's also tempting to call uUnfilledVar directly, but calling</span><span>
</span><a name="line-687"></a><span>             </span><span class="hs-comment">-- uType seems safer in the presence of possible refactoring</span><span>
</span><a name="line-688"></a><span>             </span><span class="hs-comment">-- later.</span><span>
</span><a name="line-689"></a><span>           </span><a href="TcUnify.html#Unfilled"><span class="hs-identifier hs-var">Unfilled</span></a><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEvidence.html#mkWpCastN"><span class="hs-identifier hs-var">mkWpCastN</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span>
</span><a name="line-690"></a><span>                                </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060639"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span> </span><a href="#local-1628060642"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060643"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-691"></a><span>
</span><a name="line-692"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-comment">-- See Note [Deep skolemisation]</span><span>
</span><a name="line-693"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060648"><a href="#local-1628060648"><span class="hs-identifier">sk_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060649"><a href="#local-1628060649"><span class="hs-identifier">inner_wrap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSkolemise"><span class="hs-identifier hs-var">tcSkolemise</span></a><span> </span><a href="#local-1628060641"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060643"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-694"></a><span>                                  </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628060647"><a href="#local-1628060647"><span class="hs-identifier">sk_rho</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-695"></a><span>                                  </span><a href="TcUnify.html#tc_sub_type_ds"><span class="hs-identifier hs-var">tc_sub_type_ds</span></a><span> </span><a href="#local-1628060639"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="#local-1628060640"><span class="hs-identifier hs-var">inst_orig</span></a><span> </span><a href="#local-1628060641"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-696"></a><span>                                                 </span><a href="#local-1628060642"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060647"><span class="hs-identifier hs-var">sk_rho</span></a><span>
</span><a name="line-697"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060648"><span class="hs-identifier hs-var">sk_wrap</span></a><span> </span><a href="TcEvidence.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-1628060649"><span class="hs-identifier hs-var">inner_wrap</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-700"></a><span class="hs-identifier">tc_sub_type_ds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>    </span><span class="hs-comment">-- used when calling uType</span><span>
</span><a name="line-701"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>    </span><span class="hs-comment">-- used when instantiating</span><span>
</span><a name="line-702"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcRhoType"><span class="hs-identifier hs-type">TcRhoType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>
</span><a name="line-703"></a><span class="hs-comment">-- Just like tcSubType, but with the additional precondition that</span><span>
</span><a name="line-704"></a><span class="hs-comment">-- ty_expected is deeply skolemised</span><span>
</span><a name="line-705"></a><a name="tc_sub_type_ds"><a href="TcUnify.html#tc_sub_type_ds"><span class="hs-identifier">tc_sub_type_ds</span></a></a><span> </span><a name="local-1628060650"><a href="#local-1628060650"><span class="hs-identifier">eq_orig</span></a></a><span> </span><a name="local-1628060651"><a href="#local-1628060651"><span class="hs-identifier">inst_orig</span></a></a><span> </span><a name="local-1628060652"><a href="#local-1628060652"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1628060653"><a href="#local-1628060653"><span class="hs-identifier">ty_actual</span></a></a><span> </span><a name="local-1628060654"><a href="#local-1628060654"><span class="hs-identifier">ty_expected</span></a></a><span>
</span><a name="line-706"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060655"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060653"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060654"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-707"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-708"></a><span>    </span><a name="local-1628060655"><a href="#local-1628060655"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1628060658"><a href="#local-1628060658"><span class="hs-identifier">ty_a</span></a></a><span> </span><a name="local-1628060659"><a href="#local-1628060659"><span class="hs-identifier">ty_e</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628060660"><a href="#local-1628060660"><span class="hs-identifier">ty_a'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-1628060658"><span class="hs-identifier hs-var">ty_a</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060655"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060660"><span class="hs-identifier hs-var">ty_a'</span></a><span> </span><a href="#local-1628060659"><span class="hs-identifier hs-var">ty_e</span></a><span>
</span><a name="line-709"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628060661"><a href="#local-1628060661"><span class="hs-identifier">ty_e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-1628060659"><span class="hs-identifier hs-var">ty_e</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060655"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060658"><span class="hs-identifier hs-var">ty_a</span></a><span>  </span><a href="#local-1628060661"><span class="hs-identifier hs-var">ty_e'</span></a><span>
</span><a name="line-710"></a><span>
</span><a name="line-711"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628060662"><a href="#local-1628060662"><span class="hs-identifier">tv_a</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060663"><a href="#local-1628060663"><span class="hs-identifier">ty_e</span></a></a><span>
</span><a name="line-712"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060664"><a href="#local-1628060664"><span class="hs-identifier">lookup_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#lookupTcTyVar"><span class="hs-identifier hs-var">lookupTcTyVar</span></a><span> </span><a href="#local-1628060662"><span class="hs-identifier hs-var">tv_a</span></a><span>
</span><a name="line-713"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060664"><span class="hs-identifier hs-var">lookup_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-714"></a><span>               </span><a href="TcUnify.html#Filled"><span class="hs-identifier hs-var">Filled</span></a><span> </span><a name="local-1628060665"><a href="#local-1628060665"><span class="hs-identifier">ty_a'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-715"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcSubTypeDS_NC_O following filled act meta-tyvar:&quot;</span><span>
</span><a name="line-716"></a><span>                        </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060662"><span class="hs-identifier hs-var">tv_a</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;--&gt;&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060665"><span class="hs-identifier hs-var">ty_a'</span></a><span class="hs-special">)</span><span>
</span><a name="line-717"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tc_sub_type_ds"><span class="hs-identifier hs-var">tc_sub_type_ds</span></a><span> </span><a href="#local-1628060650"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="#local-1628060651"><span class="hs-identifier hs-var">inst_orig</span></a><span> </span><a href="#local-1628060652"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060665"><span class="hs-identifier hs-var">ty_a'</span></a><span> </span><a href="#local-1628060663"><span class="hs-identifier hs-var">ty_e</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-718"></a><span>               </span><a href="TcUnify.html#Unfilled"><span class="hs-identifier hs-var">Unfilled</span></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060657"><span class="hs-identifier hs-var">unify</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span>
</span><a name="line-721"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060666"><a href="#local-1628060666"><span class="hs-identifier">ty_a</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628060667"><a href="#local-1628060667"><span class="hs-identifier">tv_e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-722"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060668"><a href="#local-1628060668"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-723"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060669"><a href="#local-1628060669"><span class="hs-identifier">tclvl</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-724"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060670"><a href="#local-1628060670"><span class="hs-identifier">lookup_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#lookupTcTyVar"><span class="hs-identifier hs-var">lookupTcTyVar</span></a><span> </span><a href="#local-1628060667"><span class="hs-identifier hs-var">tv_e</span></a><span>
</span><a name="line-725"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060670"><span class="hs-identifier hs-var">lookup_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-726"></a><span>               </span><a href="TcUnify.html#Filled"><span class="hs-identifier hs-var">Filled</span></a><span> </span><a name="local-1628060671"><a href="#local-1628060671"><span class="hs-identifier">ty_e'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-727"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcSubTypeDS_NC_O following filled exp meta-tyvar:&quot;</span><span>
</span><a name="line-728"></a><span>                        </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060667"><span class="hs-identifier hs-var">tv_e</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;--&gt;&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060671"><span class="hs-identifier hs-var">ty_e'</span></a><span class="hs-special">)</span><span>
</span><a name="line-729"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tc_sub_tc_type"><span class="hs-identifier hs-var">tc_sub_tc_type</span></a><span> </span><a href="#local-1628060650"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="#local-1628060651"><span class="hs-identifier hs-var">inst_orig</span></a><span> </span><a href="#local-1628060652"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060666"><span class="hs-identifier hs-var">ty_a</span></a><span> </span><a href="#local-1628060671"><span class="hs-identifier hs-var">ty_e'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-730"></a><span>               </span><a href="TcUnify.html#Unfilled"><span class="hs-identifier hs-var">Unfilled</span></a><span> </span><a name="local-1628060672"><a href="#local-1628060672"><span class="hs-identifier">details</span></a></a><span>
</span><a name="line-731"></a><span>                 </span><span class="hs-glyph">|</span><span>  </span><a href="TcType.html#canUnifyWithPolyType"><span class="hs-identifier hs-var">canUnifyWithPolyType</span></a><span> </span><a href="#local-1628060668"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628060672"><span class="hs-identifier hs-var">details</span></a><span>
</span><a name="line-732"></a><span>                    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="TcType.html#isTouchableMetaTyVar"><span class="hs-identifier hs-var">isTouchableMetaTyVar</span></a><span> </span><a href="#local-1628060669"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-1628060667"><span class="hs-identifier hs-var">tv_e</span></a><span>  </span><span class="hs-comment">-- don't want skolems here</span><span>
</span><a name="line-733"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060657"><span class="hs-identifier hs-var">unify</span></a><span>
</span><a name="line-734"></a><span>
</span><a name="line-735"></a><span>     </span><span class="hs-comment">-- We've avoided instantiating ty_actual just in case ty_expected is</span><span>
</span><a name="line-736"></a><span>     </span><span class="hs-comment">-- polymorphic. But we've now assiduously determined that it is *not*</span><span>
</span><a name="line-737"></a><span>     </span><span class="hs-comment">-- polymorphic. So instantiate away. This is needed for e.g. test</span><span>
</span><a name="line-738"></a><span>     </span><span class="hs-comment">-- typecheck/should_compile/T4284.</span><span>
</span><a name="line-739"></a><span>                 </span><span class="hs-glyph">|</span><span>  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-740"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060656"><span class="hs-identifier hs-var">inst_and_unify</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-741"></a><span>
</span><a name="line-742"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Anon"><span class="hs-identifier hs-var">Anon</span></a><span> </span><a name="local-1628060673"><a href="#local-1628060673"><span class="hs-identifier">act_arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060674"><a href="#local-1628060674"><span class="hs-identifier">act_res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Anon"><span class="hs-identifier hs-var">Anon</span></a><span> </span><a name="local-1628060675"><a href="#local-1628060675"><span class="hs-identifier">exp_arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060676"><a href="#local-1628060676"><span class="hs-identifier">exp_res</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-743"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Type.html#isPredTy"><span class="hs-identifier hs-var">isPredTy</span></a><span> </span><a href="#local-1628060673"><span class="hs-identifier hs-var">act_arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-744"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Type.html#isPredTy"><span class="hs-identifier hs-var">isPredTy</span></a><span> </span><a href="#local-1628060675"><span class="hs-identifier hs-var">exp_arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-745"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [Co/contra-variance of subsumption checking]</span><span>
</span><a name="line-746"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060677"><a href="#local-1628060677"><span class="hs-identifier">res_wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tc_sub_type_ds"><span class="hs-identifier hs-var">tc_sub_type_ds</span></a><span> </span><a href="#local-1628060650"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="#local-1628060651"><span class="hs-identifier hs-var">inst_orig</span></a><span> </span><a href="#local-1628060652"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060674"><span class="hs-identifier hs-var">act_res</span></a><span> </span><a href="#local-1628060676"><span class="hs-identifier hs-var">exp_res</span></a><span>
</span><a name="line-747"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060678"><a href="#local-1628060678"><span class="hs-identifier">arg_wrap</span></a></a><span>
</span><a name="line-748"></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tc_sub_tc_type"><span class="hs-identifier hs-var">tc_sub_tc_type</span></a><span> </span><a href="#local-1628060650"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#GivenOrigin"><span class="hs-identifier hs-var">GivenOrigin</span></a><span>
</span><a name="line-749"></a><span>                                          </span><span class="hs-special">(</span><a href="TcRnTypes.html#SigSkol"><span class="hs-identifier hs-var">SigSkol</span></a><span> </span><a href="TcType.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a><span>
</span><a name="line-750"></a><span>                                           </span><span class="hs-special">(</span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628060675"><span class="hs-identifier hs-var">exp_arg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span>                                 </span><a href="#local-1628060652"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060675"><span class="hs-identifier hs-var">exp_arg</span></a><span> </span><a href="#local-1628060673"><span class="hs-identifier hs-var">act_arg</span></a><span>
</span><a name="line-752"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkWpFun"><span class="hs-identifier hs-var">mkWpFun</span></a><span> </span><a href="#local-1628060678"><span class="hs-identifier hs-var">arg_wrap</span></a><span> </span><a href="#local-1628060677"><span class="hs-identifier hs-var">res_wrap</span></a><span> </span><a href="#local-1628060675"><span class="hs-identifier hs-var">exp_arg</span></a><span> </span><a href="#local-1628060676"><span class="hs-identifier hs-var">exp_res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-753"></a><span>               </span><span class="hs-comment">-- arg_wrap :: exp_arg ~ act_arg</span><span>
</span><a name="line-754"></a><span>               </span><span class="hs-comment">-- res_wrap :: act-res ~ exp_res</span><span>
</span><a name="line-755"></a><span>
</span><a name="line-756"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060679"><a href="#local-1628060679"><span class="hs-identifier">ty_a</span></a></a><span> </span><a name="local-1628060680"><a href="#local-1628060680"><span class="hs-identifier">ty_e</span></a></a><span>
</span><a name="line-757"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1628060681"><a href="#local-1628060681"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060682"><a href="#local-1628060682"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitSigmaTy"><span class="hs-identifier hs-var">tcSplitSigmaTy</span></a><span> </span><a href="#local-1628060679"><span class="hs-identifier hs-var">ty_a</span></a><span>
</span><a name="line-758"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628060681"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628060682"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-759"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060683"><a href="#local-1628060683"><span class="hs-identifier">in_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060684"><a href="#local-1628060684"><span class="hs-identifier">in_rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span> </span><a href="#local-1628060651"><span class="hs-identifier hs-var">inst_orig</span></a><span> </span><a href="#local-1628060679"><span class="hs-identifier hs-var">ty_a</span></a><span>
</span><a name="line-760"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060685"><a href="#local-1628060685"><span class="hs-identifier">body_wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tc_sub_type_ds"><span class="hs-identifier hs-var">tc_sub_type_ds</span></a><span>
</span><a name="line-761"></a><span>                            </span><span class="hs-special">(</span><a href="#local-1628060650"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060684"><span class="hs-identifier hs-var">in_rho</span></a><span>
</span><a name="line-762"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-763"></a><span>                                         </span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628060654"><span class="hs-identifier hs-var">ty_expected</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-764"></a><span>                            </span><a href="#local-1628060651"><span class="hs-identifier hs-var">inst_orig</span></a><span> </span><a href="#local-1628060652"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060684"><span class="hs-identifier hs-var">in_rho</span></a><span> </span><a href="#local-1628060680"><span class="hs-identifier hs-var">ty_e</span></a><span>
</span><a name="line-765"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060685"><span class="hs-identifier hs-var">body_wrap</span></a><span> </span><a href="TcEvidence.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-1628060683"><span class="hs-identifier hs-var">in_wrap</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-766"></a><span>
</span><a name="line-767"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>   </span><span class="hs-comment">-- Revert to unification</span><span>
</span><a name="line-768"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060656"><span class="hs-identifier hs-var">inst_and_unify</span></a><span>
</span><a name="line-769"></a><span>         </span><span class="hs-comment">-- It's still possible that ty_actual has nested foralls. Instantiate</span><span>
</span><a name="line-770"></a><span>         </span><span class="hs-comment">-- these, as there's no way unification will succeed with them in.</span><span>
</span><a name="line-771"></a><span>         </span><span class="hs-comment">-- See typecheck/should_compile/T11305 for an example of when this</span><span>
</span><a name="line-772"></a><span>         </span><span class="hs-comment">-- is important. The problem is that we're checking something like</span><span>
</span><a name="line-773"></a><span>         </span><span class="hs-comment">--  a -&gt; forall b. b -&gt; b     &lt;=   alpha beta gamma</span><span>
</span><a name="line-774"></a><span>         </span><span class="hs-comment">-- where we end up with alpha := (-&gt;)</span><span>
</span><a name="line-775"></a><span>
</span><a name="line-776"></a><span>    </span><a name="local-1628060656"><a href="#local-1628060656"><span class="hs-identifier">inst_and_unify</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060686"><a href="#local-1628060686"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060687"><a href="#local-1628060687"><span class="hs-identifier">rho_a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#deeplyInstantiate"><span class="hs-identifier hs-var">deeplyInstantiate</span></a><span> </span><a href="#local-1628060651"><span class="hs-identifier hs-var">inst_orig</span></a><span> </span><a href="#local-1628060653"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-777"></a><span>
</span><a name="line-778"></a><span>                           </span><span class="hs-comment">-- if we haven't recurred through an arrow, then</span><span>
</span><a name="line-779"></a><span>                           </span><span class="hs-comment">-- the eq_orig will list ty_actual. In this case,</span><span>
</span><a name="line-780"></a><span>                           </span><span class="hs-comment">-- we want to update the origin to reflect the</span><span>
</span><a name="line-781"></a><span>                           </span><span class="hs-comment">-- instantiation. If we *have* recurred through</span><span>
</span><a name="line-782"></a><span>                           </span><span class="hs-comment">-- an arrow, it's better not to update.</span><span>
</span><a name="line-783"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628060688"><a href="#local-1628060688"><span class="hs-identifier">eq_orig'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060650"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-784"></a><span>                                </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-1628060689"><a href="#local-1628060689"><span class="hs-identifier">orig_ty_actual</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-785"></a><span>                                  </span><span class="hs-glyph">|</span><span>  </span><a href="#local-1628060689"><span class="hs-identifier hs-var">orig_ty_actual</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#tcEqType"><span class="hs-identifier hs-var">tcEqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628060653"><span class="hs-identifier hs-var">ty_actual</span></a><span>
</span><a name="line-786"></a><span>                                  </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#isIdHsWrapper"><span class="hs-identifier hs-var">isIdHsWrapper</span></a><span> </span><a href="#local-1628060686"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">)</span><span>
</span><a name="line-787"></a><span>                                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060650"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060687"><span class="hs-identifier hs-var">rho_a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-788"></a><span>                                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060650"><span class="hs-identifier hs-var">eq_orig</span></a><span>
</span><a name="line-789"></a><span>
</span><a name="line-790"></a><span>                        </span><span class="hs-special">;</span><span> </span><a name="local-1628060690"><a href="#local-1628060690"><span class="hs-identifier">cow</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060688"><span class="hs-identifier hs-var">eq_orig'</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span> </span><a href="#local-1628060687"><span class="hs-identifier hs-var">rho_a</span></a><span> </span><a href="#local-1628060654"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-791"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkWpCastN"><span class="hs-identifier hs-var">mkWpCastN</span></a><span> </span><a href="#local-1628060690"><span class="hs-identifier hs-var">cow</span></a><span> </span><a href="TcEvidence.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-1628060686"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-792"></a><span>
</span><a name="line-793"></a><span>
</span><a name="line-794"></a><span>     </span><span class="hs-comment">-- use versions without synonyms expanded</span><span>
</span><a name="line-795"></a><span>    </span><a name="local-1628060657"><a href="#local-1628060657"><span class="hs-identifier">unify</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#mkWpCastN"><span class="hs-identifier hs-var">mkWpCastN</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060650"><span class="hs-identifier hs-var">eq_orig</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span> </span><a href="#local-1628060653"><span class="hs-identifier hs-var">ty_actual</span></a><span> </span><a href="#local-1628060654"><span class="hs-identifier hs-var">ty_expected</span></a><span>
</span><a name="line-796"></a><span>
</span><a name="line-797"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-798"></a><span class="hs-comment">-- needs both un-type-checked (for origins) and type-checked (for wrapping)</span><span>
</span><a name="line-799"></a><span class="hs-comment">-- expressions</span><span>
</span><a name="line-800"></a><span class="hs-identifier">tcWrapResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsExpr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsExpr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a><span> </span><a href="TcRnTypes.html#TcId"><span class="hs-identifier hs-type">TcId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a><span>
</span><a name="line-801"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="HsExpr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a><span> </span><a href="TcRnTypes.html#TcId"><span class="hs-identifier hs-type">TcId</span></a><span class="hs-special">)</span><span>
</span><a name="line-802"></a><a name="tcWrapResult"><a href="TcUnify.html#tcWrapResult"><span class="hs-identifier">tcWrapResult</span></a></a><span> </span><a name="local-1628060691"><a href="#local-1628060691"><span class="hs-identifier">rn_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#tcWrapResultO"><span class="hs-identifier hs-var">tcWrapResultO</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#exprCtOrigin"><span class="hs-identifier hs-var">exprCtOrigin</span></a><span> </span><a href="#local-1628060691"><span class="hs-identifier hs-var">rn_expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span class="hs-comment">-- | Sometimes we don't have a @HsExpr Name@ to hand, and this is more</span><span>
</span><a name="line-805"></a><span class="hs-comment">-- convenient.</span><span>
</span><a name="line-806"></a><span class="hs-identifier">tcWrapResultO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsExpr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a><span> </span><a href="TcRnTypes.html#TcId"><span class="hs-identifier hs-type">TcId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a><span>
</span><a name="line-807"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="HsExpr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a><span> </span><a href="TcRnTypes.html#TcId"><span class="hs-identifier hs-type">TcId</span></a><span class="hs-special">)</span><span>
</span><a name="line-808"></a><a name="tcWrapResultO"><a href="TcUnify.html#tcWrapResultO"><span class="hs-identifier">tcWrapResultO</span></a></a><span> </span><a name="local-1628060692"><a href="#local-1628060692"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-1628060693"><a href="#local-1628060693"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-1628060694"><a href="#local-1628060694"><span class="hs-identifier">actual_ty</span></a></a><span> </span><a name="local-1628060695"><a href="#local-1628060695"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-809"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcWrapResult&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Actual:  &quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060694"><span class="hs-identifier hs-var">actual_ty</span></a><span>
</span><a name="line-810"></a><span>                                      </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Expected:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060695"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-811"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628060696"><a href="#local-1628060696"><span class="hs-identifier">cow</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeDS_NC_O"><span class="hs-identifier hs-var">tcSubTypeDS_NC_O</span></a><span> </span><a href="#local-1628060692"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="TcType.html#GenSigCtxt"><span class="hs-identifier hs-var">GenSigCtxt</span></a><span>
</span><a name="line-812"></a><span>                                 </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628060693"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060694"><span class="hs-identifier hs-var">actual_ty</span></a><span> </span><a href="#local-1628060695"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-813"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="HsUtils.html#mkHsWrap"><span class="hs-identifier hs-var">mkHsWrap</span></a><span> </span><a href="#local-1628060696"><span class="hs-identifier hs-var">cow</span></a><span> </span><a href="#local-1628060693"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-814"></a><span>
</span><a name="line-815"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-816"></a><span class="hs-identifier">wrapFunResCoercion</span><span>
</span><a name="line-817"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Type of args</span><span>
</span><a name="line-818"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>       </span><span class="hs-comment">-- HsExpr a -&gt; HsExpr b</span><span>
</span><a name="line-819"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span>   </span><span class="hs-comment">-- HsExpr (arg_tys -&gt; a) -&gt; HsExpr (arg_tys -&gt; b)</span><span>
</span><a name="line-820"></a><a name="wrapFunResCoercion"><a href="TcUnify.html#wrapFunResCoercion"><span class="hs-identifier">wrapFunResCoercion</span></a></a><span> </span><a name="local-1628060697"><a href="#local-1628060697"><span class="hs-identifier">arg_tys</span></a></a><span> </span><a name="local-1628060698"><a href="#local-1628060698"><span class="hs-identifier">co_fn_res</span></a></a><span>
</span><a name="line-821"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcEvidence.html#isIdHsWrapper"><span class="hs-identifier hs-var">isIdHsWrapper</span></a><span> </span><a href="#local-1628060698"><span class="hs-identifier hs-var">co_fn_res</span></a><span>
</span><a name="line-822"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TcEvidence.html#idHsWrapper"><span class="hs-identifier hs-var">idHsWrapper</span></a><span>
</span><a name="line-823"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628060697"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-824"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628060698"><span class="hs-identifier hs-var">co_fn_res</span></a><span>
</span><a name="line-825"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-826"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-1628060699"><a href="#local-1628060699"><span class="hs-identifier">arg_ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newSysLocalIds"><span class="hs-identifier hs-var">newSysLocalIds</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span> </span><span class="hs-string">&quot;sub&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1628060697"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-827"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#mkWpLams"><span class="hs-identifier hs-var">mkWpLams</span></a><span> </span><a href="#local-1628060699"><span class="hs-identifier hs-var">arg_ids</span></a><span> </span><a href="TcEvidence.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="#local-1628060698"><span class="hs-identifier hs-var">co_fn_res</span></a><span> </span><a href="TcEvidence.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="TcEvidence.html#mkWpEvVarApps"><span class="hs-identifier hs-var">mkWpEvVarApps</span></a><span> </span><a href="#local-1628060699"><span class="hs-identifier hs-var">arg_ids</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-828"></a><span>
</span><a name="line-829"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-830"></a><span class="hs-comment">-- | Infer a type using a fresh ExpType</span><span>
</span><a name="line-831"></a><span class="hs-comment">-- See also Note [ExpType] in TcMType</span><span>
</span><a name="line-832"></a><span class="hs-identifier">tcInfer</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628060410"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060410"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">)</span><span>
</span><a name="line-833"></a><a name="tcInfer"><a href="TcUnify.html#tcInfer"><span class="hs-identifier">tcInfer</span></a></a><span> </span><a name="local-1628060700"><a href="#local-1628060700"><span class="hs-identifier">tc_check</span></a></a><span>
</span><a name="line-834"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060701"><a href="#local-1628060701"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenInferExpType"><span class="hs-identifier hs-var">newOpenInferExpType</span></a><span>
</span><a name="line-835"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628060702"><a href="#local-1628060702"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060700"><span class="hs-identifier hs-var">tc_check</span></a><span> </span><a href="#local-1628060701"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-836"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628060703"><a href="#local-1628060703"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-1628060701"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-837"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060702"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060703"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-838"></a><span>
</span><a name="line-839"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Generalisation}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-846"></a><span>
</span><a name="line-847"></a><span class="hs-comment">-- | Take an &quot;expected type&quot; and strip off quantifiers to expose the</span><span>
</span><a name="line-848"></a><span class="hs-comment">-- type underneath, binding the new skolems for the @thing_inside@.</span><span>
</span><a name="line-849"></a><span class="hs-comment">-- The returned 'HsWrapper' has type @specific_ty -&gt; expected_ty@.</span><span>
</span><a name="line-850"></a><span class="hs-identifier">tcSkolemise</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcSigmaType"><span class="hs-identifier hs-type">TcSigmaType</span></a><span>
</span><a name="line-851"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628060409"><span class="hs-identifier hs-type">result</span></a><span class="hs-special">)</span><span>
</span><a name="line-852"></a><span>         </span><span class="hs-comment">-- ^ These are only ever used for scoped type variables.</span><span>
</span><a name="line-853"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060409"><span class="hs-identifier hs-type">result</span></a><span class="hs-special">)</span><span>
</span><a name="line-854"></a><span>        </span><span class="hs-comment">-- ^ The expression has type: spec_ty -&gt; expected_ty</span><span>
</span><a name="line-855"></a><span>
</span><a name="line-856"></a><a name="tcSkolemise"><a href="TcUnify.html#tcSkolemise"><span class="hs-identifier">tcSkolemise</span></a></a><span> </span><a name="local-1628060704"><a href="#local-1628060704"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-1628060705"><a href="#local-1628060705"><span class="hs-identifier">expected_ty</span></a></a><span> </span><a name="local-1628060706"><a href="#local-1628060706"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-857"></a><span>   </span><span class="hs-comment">-- We expect expected_ty to be a forall-type</span><span>
</span><a name="line-858"></a><span>   </span><span class="hs-comment">-- If not, the call is a no-op</span><span>
</span><a name="line-859"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcSkolemise&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">Outputable</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-860"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628060707"><a href="#local-1628060707"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060708"><a href="#local-1628060708"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060709"><a href="#local-1628060709"><span class="hs-identifier">given</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060710"><a href="#local-1628060710"><span class="hs-identifier">rho'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#deeplySkolemise"><span class="hs-identifier hs-var">deeplySkolemise</span></a><span> </span><a href="#local-1628060705"><span class="hs-identifier hs-var">expected_ty</span></a><span>
</span><a name="line-861"></a><span>
</span><a name="line-862"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-1628060711"><a href="#local-1628060711"><span class="hs-identifier">lvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-863"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-864"></a><span>              </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcSkolemise&quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span>
</span><a name="line-865"></a><span>                </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060711"><span class="hs-identifier hs-var">lvl</span></a><span class="hs-special">,</span><span>
</span><a name="line-866"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;expected_ty&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060705"><span class="hs-identifier hs-var">expected_ty</span></a><span class="hs-special">,</span><span>
</span><a name="line-867"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;inst tyvars&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060708"><span class="hs-identifier hs-var">tvs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-868"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;given&quot;</span><span>       </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060709"><span class="hs-identifier hs-var">given</span></a><span class="hs-special">,</span><span>
</span><a name="line-869"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;inst type&quot;</span><span>   </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060710"><span class="hs-identifier hs-var">rho'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-870"></a><span>
</span><a name="line-871"></a><span>        </span><span class="hs-comment">-- Generally we must check that the &quot;forall_tvs&quot; havn't been constrained</span><span>
</span><a name="line-872"></a><span>        </span><span class="hs-comment">-- The interesting bit here is that we must include the free variables</span><span>
</span><a name="line-873"></a><span>        </span><span class="hs-comment">-- of the expected_ty.  Here's an example:</span><span>
</span><a name="line-874"></a><span>        </span><span class="hs-comment">--       runST (newVar True)</span><span>
</span><a name="line-875"></a><span>        </span><span class="hs-comment">-- Here, if we don't make a check, we'll get a type (ST s (MutVar s Bool))</span><span>
</span><a name="line-876"></a><span>        </span><span class="hs-comment">-- for (newVar True), with s fresh.  Then we unify with the runST's arg type</span><span>
</span><a name="line-877"></a><span>        </span><span class="hs-comment">-- forall s'. ST s' a. That unifies s' with s, and a with MutVar s Bool.</span><span>
</span><a name="line-878"></a><span>        </span><span class="hs-comment">-- So now s' isn't unconstrained because it's linked to a.</span><span>
</span><a name="line-879"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-880"></a><span>        </span><span class="hs-comment">-- However [Oct 10] now that the untouchables are a range of</span><span>
</span><a name="line-881"></a><span>        </span><span class="hs-comment">-- TcTyVars, all this is handled automatically with no need for</span><span>
</span><a name="line-882"></a><span>        </span><span class="hs-comment">-- extra faffing around</span><span>
</span><a name="line-883"></a><span>
</span><a name="line-884"></a><span>        </span><span class="hs-comment">-- Use the *instantiated* type in the SkolemInfo</span><span>
</span><a name="line-885"></a><span>        </span><span class="hs-comment">-- so that the names of displayed type variables line up</span><span>
</span><a name="line-886"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628060712"><a href="#local-1628060712"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#SigSkol"><span class="hs-identifier hs-var">SigSkol</span></a><span> </span><a href="#local-1628060704"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-887"></a><span>                                        </span><a href="TyCoRep.html#mkFunTys"><span class="hs-identifier hs-var">mkFunTys</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-identifier">varType</span><span> </span><a href="#local-1628060709"><span class="hs-identifier hs-var">given</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060710"><span class="hs-identifier hs-var">rho'</span></a><span class="hs-special">)</span><span>
</span><a name="line-888"></a><span>
</span><a name="line-889"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628060713"><a href="#local-1628060713"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060714"><a href="#local-1628060714"><span class="hs-identifier">result</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a><span> </span><a href="#local-1628060712"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-1628060708"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-1628060709"><span class="hs-identifier hs-var">given</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-890"></a><span>                                </span><a href="#local-1628060706"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-1628060708"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-1628060710"><span class="hs-identifier hs-var">rho'</span></a><span>
</span><a name="line-891"></a><span>
</span><a name="line-892"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060707"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="TcEvidence.html#%3C.%3E"><span class="hs-operator hs-var">&lt;.&gt;</span></a><span> </span><a href="TcEvidence.html#mkWpLet"><span class="hs-identifier hs-var">mkWpLet</span></a><span> </span><a href="#local-1628060713"><span class="hs-identifier hs-var">ev_binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060714"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-893"></a><span>          </span><span class="hs-comment">-- The ev_binds returned by checkConstraints is very</span><span>
</span><a name="line-894"></a><span>          </span><span class="hs-comment">-- often empty, in which case mkWpLet is a no-op</span><span>
</span><a name="line-895"></a><span>
</span><a name="line-896"></a><span class="hs-comment">-- | Variant of 'tcSkolemise' that takes an ExpType</span><span>
</span><a name="line-897"></a><span class="hs-identifier">tcSkolemiseET</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpSigmaType"><span class="hs-identifier hs-type">ExpSigmaType</span></a><span>
</span><a name="line-898"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TcType.html#ExpRhoType"><span class="hs-identifier hs-type">ExpRhoType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628060408"><span class="hs-identifier hs-type">result</span></a><span class="hs-special">)</span><span>
</span><a name="line-899"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#HsWrapper"><span class="hs-identifier hs-type">HsWrapper</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060408"><span class="hs-identifier hs-type">result</span></a><span class="hs-special">)</span><span>
</span><a name="line-900"></a><a name="tcSkolemiseET"><a href="TcUnify.html#tcSkolemiseET"><span class="hs-identifier">tcSkolemiseET</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628060715"><a href="#local-1628060715"><span class="hs-identifier">et</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcType.html#Infer"><span class="hs-identifier hs-var">Infer</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-1628060716"><a href="#local-1628060716"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-901"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#idHsWrapper"><span class="hs-identifier hs-var">idHsWrapper</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="#local-1628060716"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-1628060715"><span class="hs-identifier hs-var">et</span></a><span>
</span><a name="line-902"></a><span class="hs-identifier">tcSkolemiseET</span><span> </span><a name="local-1628060717"><a href="#local-1628060717"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><a href="TcType.html#Check"><span class="hs-identifier hs-var">Check</span></a><span> </span><a name="local-1628060718"><a href="#local-1628060718"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060719"><a href="#local-1628060719"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-903"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#tcSkolemise"><span class="hs-identifier hs-var">tcSkolemise</span></a><span> </span><a href="#local-1628060717"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-1628060718"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060719"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span>
</span><a name="line-904"></a><span>
</span><a name="line-905"></a><span class="hs-identifier">checkConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#SkolemInfo"><span class="hs-identifier hs-type">SkolemInfo</span></a><span>
</span><a name="line-906"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Skolems</span><span>
</span><a name="line-907"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Given</span><span>
</span><a name="line-908"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628060407"><span class="hs-identifier hs-type">result</span></a><span>
</span><a name="line-909"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#TcEvBinds"><span class="hs-identifier hs-type">TcEvBinds</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060407"><span class="hs-identifier hs-type">result</span></a><span class="hs-special">)</span><span>
</span><a name="line-910"></a><span>
</span><a name="line-911"></a><a name="checkConstraints"><a href="TcUnify.html#checkConstraints"><span class="hs-identifier">checkConstraints</span></a></a><span> </span><a name="local-1628060720"><a href="#local-1628060720"><span class="hs-identifier">skol_info</span></a></a><span> </span><a name="local-1628060721"><a href="#local-1628060721"><span class="hs-identifier">skol_tvs</span></a></a><span> </span><a name="local-1628060722"><a href="#local-1628060722"><span class="hs-identifier">given</span></a></a><span> </span><a name="local-1628060723"><a href="#local-1628060723"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-912"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060724"><a href="#local-1628060724"><span class="hs-identifier">implics</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060725"><a href="#local-1628060725"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060726"><a href="#local-1628060726"><span class="hs-identifier">result</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-913"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#buildImplication"><span class="hs-identifier hs-var">buildImplication</span></a><span> </span><a href="#local-1628060720"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-1628060721"><span class="hs-identifier hs-var">skol_tvs</span></a><span> </span><a href="#local-1628060722"><span class="hs-identifier hs-var">given</span></a><span> </span><a href="#local-1628060723"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-914"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitImplications"><span class="hs-identifier hs-var">emitImplications</span></a><span> </span><a href="#local-1628060724"><span class="hs-identifier hs-var">implics</span></a><span>
</span><a name="line-915"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060725"><span class="hs-identifier hs-var">ev_binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060726"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-916"></a><span>
</span><a name="line-917"></a><span class="hs-identifier">buildImplication</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#SkolemInfo"><span class="hs-identifier hs-type">SkolemInfo</span></a><span>
</span><a name="line-918"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Skolems</span><span>
</span><a name="line-919"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Given</span><span>
</span><a name="line-920"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628060406"><span class="hs-identifier hs-type">result</span></a><span>
</span><a name="line-921"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="TcRnTypes.html#Implication"><span class="hs-identifier hs-type">Implication</span></a><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#TcEvBinds"><span class="hs-identifier hs-type">TcEvBinds</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060406"><span class="hs-identifier hs-type">result</span></a><span class="hs-special">)</span><span>
</span><a name="line-922"></a><a name="buildImplication"><a href="TcUnify.html#buildImplication"><span class="hs-identifier">buildImplication</span></a></a><span> </span><a name="local-1628060727"><a href="#local-1628060727"><span class="hs-identifier">skol_info</span></a></a><span> </span><a name="local-1628060728"><a href="#local-1628060728"><span class="hs-identifier">skol_tvs</span></a></a><span> </span><a name="local-1628060729"><a href="#local-1628060729"><span class="hs-identifier">given</span></a></a><span> </span><a name="local-1628060730"><a href="#local-1628060730"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-923"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060731"><a href="#local-1628060731"><span class="hs-identifier">tc_lvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-924"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628060732"><a href="#local-1628060732"><span class="hs-identifier">deferred_type_errors</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><a href="DynFlags.html#Opt_DeferTypeErrors"><span class="hs-identifier hs-var">Opt_DeferTypeErrors</span></a><span> </span><a href="Util.html#%3C%7C%7C%3E"><span class="hs-operator hs-var">&lt;||&gt;</span></a><span>
</span><a name="line-925"></a><span>                                 </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><a href="DynFlags.html#Opt_DeferTypedHoles"><span class="hs-identifier hs-var">Opt_DeferTypedHoles</span></a><span>
</span><a name="line-926"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628060728"><span class="hs-identifier hs-var">skol_tvs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628060729"><span class="hs-identifier hs-var">given</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1628060732"><span class="hs-identifier hs-var">deferred_type_errors</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-927"></a><span>                                            </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TcType.html#isTopTcLevel"><span class="hs-identifier hs-var">isTopTcLevel</span></a><span> </span><a href="#local-1628060731"><span class="hs-identifier hs-var">tc_lvl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-928"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060733"><a href="#local-1628060733"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060730"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-929"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#emptyTcEvBinds"><span class="hs-identifier hs-var">emptyTcEvBinds</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060733"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-930"></a><span>      </span><span class="hs-comment">-- Fast path.  We check every function argument with</span><span>
</span><a name="line-931"></a><span>      </span><span class="hs-comment">-- tcPolyExpr, which uses tcSkolemise and hence checkConstraints.</span><span>
</span><a name="line-932"></a><span>      </span><span class="hs-comment">-- But with the solver producing unlifted equalities, we need</span><span>
</span><a name="line-933"></a><span>      </span><span class="hs-comment">-- to have an EvBindsVar for them when they might be deferred to</span><span>
</span><a name="line-934"></a><span>      </span><span class="hs-comment">-- runtime. Otherwise, they end up as top-level unlifted bindings,</span><span>
</span><a name="line-935"></a><span>      </span><span class="hs-comment">-- which are verboten. See also Note [Deferred errors for coercion holes]</span><span>
</span><a name="line-936"></a><span>      </span><span class="hs-comment">-- in TcErrors.</span><span>
</span><a name="line-937"></a><span>         </span><span class="hs-keyword">else</span><span>
</span><a name="line-938"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-1628060734"><a href="#local-1628060734"><span class="hs-identifier">tclvl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060735"><a href="#local-1628060735"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060736"><a href="#local-1628060736"><span class="hs-identifier">result</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#pushLevelAndCaptureConstraints"><span class="hs-identifier hs-var">pushLevelAndCaptureConstraints</span></a><span> </span><a href="#local-1628060730"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-939"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-1628060737"><a href="#local-1628060737"><span class="hs-identifier">implics</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060738"><a href="#local-1628060738"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#buildImplicationFor"><span class="hs-identifier hs-var">buildImplicationFor</span></a><span> </span><a href="#local-1628060734"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-1628060727"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-1628060728"><span class="hs-identifier hs-var">skol_tvs</span></a><span> </span><a href="#local-1628060729"><span class="hs-identifier hs-var">given</span></a><span> </span><a href="#local-1628060735"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-940"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060737"><span class="hs-identifier hs-var">implics</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060738"><span class="hs-identifier hs-var">ev_binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060736"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-941"></a><span>
</span><a name="line-942"></a><span class="hs-identifier">buildImplicationFor</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcLevel"><span class="hs-identifier hs-type">TcLevel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#SkolemInfo"><span class="hs-identifier hs-type">SkolemInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-943"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#EvVar"><span class="hs-identifier hs-type">EvVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#WantedConstraints"><span class="hs-identifier hs-type">WantedConstraints</span></a><span>
</span><a name="line-944"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="TcRnTypes.html#Implication"><span class="hs-identifier hs-type">Implication</span></a><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#TcEvBinds"><span class="hs-identifier hs-type">TcEvBinds</span></a><span class="hs-special">)</span><span>
</span><a name="line-945"></a><a name="buildImplicationFor"><a href="TcUnify.html#buildImplicationFor"><span class="hs-identifier">buildImplicationFor</span></a></a><span> </span><a name="local-1628060739"><a href="#local-1628060739"><span class="hs-identifier">tclvl</span></a></a><span> </span><a name="local-1628060740"><a href="#local-1628060740"><span class="hs-identifier">skol_info</span></a></a><span> </span><a name="local-1628060741"><a href="#local-1628060741"><span class="hs-identifier">skol_tvs</span></a></a><span> </span><a name="local-1628060742"><a href="#local-1628060742"><span class="hs-identifier">given</span></a></a><span> </span><a name="local-1628060743"><a href="#local-1628060743"><span class="hs-identifier">wanted</span></a></a><span>
</span><a name="line-946"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcRnTypes.html#isEmptyWC"><span class="hs-identifier hs-var">isEmptyWC</span></a><span> </span><a href="#local-1628060743"><span class="hs-identifier hs-var">wanted</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1628060742"><span class="hs-identifier hs-var">given</span></a><span>
</span><a name="line-947"></a><span>             </span><span class="hs-comment">-- Optimisation : if there are no wanteds, and no givens</span><span>
</span><a name="line-948"></a><span>             </span><span class="hs-comment">-- don't generate an implication at all.</span><span>
</span><a name="line-949"></a><span>             </span><span class="hs-comment">-- Reason for the (null given): we don't want to lose</span><span>
</span><a name="line-950"></a><span>             </span><span class="hs-comment">-- the &quot;inaccessible alternative&quot; error check</span><span>
</span><a name="line-951"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#emptyTcEvBinds"><span class="hs-identifier hs-var">emptyTcEvBinds</span></a><span class="hs-special">)</span><span>
</span><a name="line-952"></a><span>
</span><a name="line-953"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-954"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-identifier">isTcTyVar</span><span> </span><span class="hs-identifier">skol_tvs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">skol_tvs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-955"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-identifier">isSkolemTyVar</span><span> </span><a href="TcType.html#isSkolemTyVar"><span class="hs-identifier hs-var">skol_tvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">skol_tvs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-956"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060744"><a href="#local-1628060744"><span class="hs-identifier">ev_binds_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcEvBinds"><span class="hs-identifier hs-var">newTcEvBinds</span></a><span>
</span><a name="line-957"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628060745"><a href="#local-1628060745"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-958"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628060746"><a href="#local-1628060746"><span class="hs-identifier">implic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#Implic"><span class="hs-identifier hs-var">Implic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_tclvl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060739"><span class="hs-identifier hs-var">tclvl</span></a><span>
</span><a name="line-959"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_skols</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060741"><span class="hs-identifier hs-var">skol_tvs</span></a><span>
</span><a name="line-960"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_no_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-961"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_given</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060742"><span class="hs-identifier hs-var">given</span></a><span>
</span><a name="line-962"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_wanted</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060743"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-963"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_status</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#IC_Unsolved"><span class="hs-identifier hs-var">IC_Unsolved</span></a><span>
</span><a name="line-964"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628060744"><span class="hs-identifier hs-var">ev_binds_var</span></a><span>
</span><a name="line-965"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060745"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-966"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_info</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060740"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-967"></a><span>
</span><a name="line-968"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Bag.html#unitBag"><span class="hs-identifier hs-var">unitBag</span></a><span> </span><a href="#local-1628060746"><span class="hs-identifier hs-var">implic</span></a><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#TcEvBinds"><span class="hs-identifier hs-var">TcEvBinds</span></a><span> </span><a href="#local-1628060744"><span class="hs-identifier hs-var">ev_binds_var</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-969"></a><span>
</span><a name="line-970"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Boxy unification
*                                                                      *
************************************************************************

The exported functions are all defined as versions of some
non-exported generic functions.
-}</span><span>
</span><a name="line-980"></a><span>
</span><a name="line-981"></a><span class="hs-comment">-- | Unify two types, discarding a resultant coercion. Any constraints</span><span>
</span><a name="line-982"></a><span class="hs-comment">-- generated will still need to be solved, however.</span><span>
</span><a name="line-983"></a><span class="hs-identifier">unifyType_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060405"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060405"><span class="hs-identifier hs-type">a</span></a><span>  </span><span class="hs-comment">-- ^ If present, has type 'ty1'</span><span>
</span><a name="line-984"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-985"></a><a name="unifyType_"><a href="TcUnify.html#unifyType_"><span class="hs-identifier">unifyType_</span></a></a><span> </span><a name="local-1628060747"><a href="#local-1628060747"><span class="hs-identifier">thing</span></a></a><span> </span><a name="local-1628060748"><a href="#local-1628060748"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628060749"><a href="#local-1628060749"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><a href="#local-1628060747"><span class="hs-identifier hs-var">thing</span></a><span> </span><a href="#local-1628060748"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060749"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-986"></a><span>
</span><a name="line-987"></a><span class="hs-identifier">unifyType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060404"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060404"><span class="hs-identifier hs-type">a</span></a><span>   </span><span class="hs-comment">-- ^ If present, has type 'ty1'</span><span>
</span><a name="line-988"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a><span>
</span><a name="line-989"></a><span class="hs-comment">-- Actual and expected types</span><span>
</span><a name="line-990"></a><span class="hs-comment">-- Returns a coercion : ty1 ~ ty2</span><span>
</span><a name="line-991"></a><a name="unifyType"><a href="TcUnify.html#unifyType"><span class="hs-identifier">unifyType</span></a></a><span> </span><a name="local-1628060750"><a href="#local-1628060750"><span class="hs-identifier">thing</span></a></a><span> </span><a name="local-1628060751"><a href="#local-1628060751"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628060752"><a href="#local-1628060752"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060753"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span> </span><a href="#local-1628060751"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060752"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-992"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-993"></a><span>    </span><a name="local-1628060753"><a href="#local-1628060753"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060751"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628060752"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-994"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_thing</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#mkErrorThing"><span class="hs-identifier hs-var">mkErrorThing</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="#local-1628060750"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-995"></a><span>
</span><a name="line-996"></a><span class="hs-comment">-- | Variant of 'unifyType' that takes an 'ExpType' as its second type</span><span>
</span><a name="line-997"></a><span class="hs-identifier">unifyExpType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060403"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060403"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-998"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpType"><span class="hs-identifier hs-type">ExpType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a><span>
</span><a name="line-999"></a><a name="unifyExpType"><a href="TcUnify.html#unifyExpType"><span class="hs-identifier">unifyExpType</span></a></a><span> </span><a name="local-1628060754"><a href="#local-1628060754"><span class="hs-identifier">mb_thing</span></a></a><span> </span><a name="local-1628060755"><a href="#local-1628060755"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628060756"><a href="#local-1628060756"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1000"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#uExpType"><span class="hs-identifier hs-var">uExpType</span></a><span> </span><a href="#local-1628060757"><span class="hs-identifier hs-var">ty_orig</span></a><span> </span><a href="#local-1628060755"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060756"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1001"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1002"></a><span>    </span><a name="local-1628060757"><a href="#local-1628060757"><span class="hs-identifier">ty_orig</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060755"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1003"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060756"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1004"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_thing</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#mkErrorThing"><span class="hs-identifier hs-var">mkErrorThing</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="#local-1628060754"><span class="hs-identifier hs-var">mb_thing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1005"></a><span>
</span><a name="line-1006"></a><span class="hs-comment">-- | Use this instead of 'Nothing' when calling 'unifyType' without</span><span>
</span><a name="line-1007"></a><span class="hs-comment">-- a good &quot;thing&quot; (where the &quot;thing&quot; has the &quot;actual&quot; type passed in)</span><span>
</span><a name="line-1008"></a><span class="hs-comment">-- This has an 'Outputable' instance, avoiding amgiguity problems.</span><span>
</span><a name="line-1009"></a><span class="hs-identifier">noThing</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="HsExpr.html#HsExpr"><span class="hs-identifier hs-type">HsExpr</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1010"></a><a name="noThing"><a href="TcUnify.html#noThing"><span class="hs-identifier">noThing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1011"></a><span>
</span><a name="line-1012"></a><span class="hs-identifier">unifyKind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-1628060402"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="#local-1628060402"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span>
</span><a name="line-1013"></a><a name="unifyKind"><a href="TcUnify.html#unifyKind"><span class="hs-identifier">unifyKind</span></a></a><span> </span><a name="local-1628060758"><a href="#local-1628060758"><span class="hs-identifier">thing</span></a></a><span> </span><a name="local-1628060759"><a href="#local-1628060759"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628060760"><a href="#local-1628060760"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060761"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="TcRnTypes.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a><span> </span><a href="#local-1628060759"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060760"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1014"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1628060761"><a href="#local-1628060761"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060759"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628060760"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1015"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_thing</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#mkErrorThing"><span class="hs-identifier hs-var">mkErrorThing</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="#local-1628060758"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1016"></a><span>
</span><a name="line-1017"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-1018"></a><span class="hs-identifier">unifyPred</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcEvidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a><span>
</span><a name="line-1019"></a><span class="hs-comment">-- Actual and expected types</span><span>
</span><a name="line-1020"></a><a name="unifyPred"><a href="TcUnify.html#unifyPred"><span class="hs-identifier">unifyPred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><a href="TcUnify.html#noThing"><span class="hs-identifier hs-var">noThing</span></a><span>
</span><a name="line-1021"></a><span>
</span><a name="line-1022"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-1023"></a><span class="hs-identifier">unifyTheta</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcThetaType"><span class="hs-identifier hs-type">TcThetaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcThetaType"><span class="hs-identifier hs-type">TcThetaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcEvidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a><span class="hs-special">]</span><span>
</span><a name="line-1024"></a><span class="hs-comment">-- Actual and expected types</span><span>
</span><a name="line-1025"></a><a name="unifyTheta"><a href="TcUnify.html#unifyTheta"><span class="hs-identifier">unifyTheta</span></a></a><span> </span><a name="local-1628060762"><a href="#local-1628060762"><span class="hs-identifier">theta1</span></a></a><span> </span><a name="local-1628060763"><a href="#local-1628060763"><span class="hs-identifier">theta2</span></a></a><span>
</span><a name="line-1026"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a><span> </span><a href="#local-1628060762"><span class="hs-identifier hs-var">theta1</span></a><span> </span><a href="#local-1628060763"><span class="hs-identifier hs-var">theta2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1027"></a><span>                  </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Contexts differ in length&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1028"></a><span>                         </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use RelaxedPolyRec to allow this&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1029"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#zipWithM"><span class="hs-identifier hs-var">zipWithM</span></a><span> </span><a href="TcUnify.html#unifyPred"><span class="hs-identifier hs-var">unifyPred</span></a><span> </span><a href="#local-1628060762"><span class="hs-identifier hs-var">theta1</span></a><span> </span><a href="#local-1628060763"><span class="hs-identifier hs-var">theta2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1030"></a><span>
</span><a name="line-1031"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
                 uType and friends
%*                                                                      *
%************************************************************************

uType is the heart of the unifier.
-}</span><span>
</span><a name="line-1040"></a><span>
</span><a name="line-1041"></a><span class="hs-identifier">uExpType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpType"><span class="hs-identifier hs-type">ExpType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span>
</span><a name="line-1042"></a><a name="uExpType"><a href="TcUnify.html#uExpType"><span class="hs-identifier">uExpType</span></a></a><span> </span><a name="local-1628060764"><a href="#local-1628060764"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-1628060765"><a href="#local-1628060765"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628060766"><a href="#local-1628060766"><span class="hs-identifier">et</span></a></a><span>
</span><a name="line-1043"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#uExpTypeX"><span class="hs-identifier hs-var">uExpTypeX</span></a><span> </span><a href="#local-1628060764"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-1628060765"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060766"><span class="hs-identifier hs-var">et</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1044"></a><span>    </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060764"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span> </span><a href="#local-1628060765"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1045"></a><span>
</span><a name="line-1046"></a><span class="hs-comment">-- | Tries to unify with an ExpType. If the ExpType is filled in, calls the first</span><span>
</span><a name="line-1047"></a><span class="hs-comment">-- continuation with the produced coercion. Otherwise, calls the second</span><span>
</span><a name="line-1048"></a><span class="hs-comment">-- continuation. This can happen either with a Check or with an untouchable</span><span>
</span><a name="line-1049"></a><span class="hs-comment">-- ExpType that reverts to a tau-type. See Note [TcLevel of ExpType]</span><span>
</span><a name="line-1050"></a><span class="hs-identifier">uExpTypeX</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#ExpType"><span class="hs-identifier hs-type">ExpType</span></a><span>
</span><a name="line-1051"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TcEvidence.html#TcCoercionN"><span class="hs-identifier hs-type">TcCoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628060401"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Infer case, co :: TcType ~N ExpType</span><span>
</span><a name="line-1052"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628060401"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- Check / untouchable case</span><span>
</span><a name="line-1053"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-1628060401"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1054"></a><a name="uExpTypeX"><a href="TcUnify.html#uExpTypeX"><span class="hs-identifier">uExpTypeX</span></a></a><span> </span><a name="local-1628060767"><a href="#local-1628060767"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-1628060768"><a href="#local-1628060768"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628060769"><a href="#local-1628060769"><span class="hs-identifier">et</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcType.html#Infer"><span class="hs-identifier hs-var">Infer</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628060770"><a href="#local-1628060770"><span class="hs-identifier">tc_lvl</span></a></a><span> </span><a name="local-1628060771"><a href="#local-1628060771"><span class="hs-identifier">ki</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-1628060772"><a href="#local-1628060772"><span class="hs-identifier">coercion_cont</span></a></a><span> </span><a name="local-1628060773"><a href="#local-1628060773"><span class="hs-identifier">type_cont</span></a></a><span>
</span><a name="line-1055"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060775"><a href="#local-1628060775"><span class="hs-identifier">cur_lvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-1056"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628060775"><span class="hs-identifier hs-var">cur_lvl</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#sameDepthAs"><span class="hs-identifier hs-var">sameDepthAs</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628060770"><span class="hs-identifier hs-var">tc_lvl</span></a><span>
</span><a name="line-1057"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060776"><a href="#local-1628060776"><span class="hs-identifier">ki_co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060774"><span class="hs-identifier hs-var">kind_orig</span></a><span> </span><a href="TcRnTypes.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628060768"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060771"><span class="hs-identifier hs-var">ki</span></a><span>
</span><a name="line-1058"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#writeExpType"><span class="hs-identifier hs-var">writeExpType</span></a><span> </span><a href="#local-1628060769"><span class="hs-identifier hs-var">et</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060768"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628060776"><span class="hs-identifier hs-var">ki_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1059"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="#local-1628060772"><span class="hs-identifier hs-var">coercion_cont</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcEvidence.html#mkTcNomReflCo"><span class="hs-identifier hs-var">mkTcNomReflCo</span></a><span> </span><a href="#local-1628060768"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><a href="TcEvidence.html#mkTcCoherenceRightCo"><span class="hs-identifier hs-var">mkTcCoherenceRightCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628060776"><span class="hs-identifier hs-var">ki_co</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1060"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Preventing writing to untouchable ExpType&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1061"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-1628060777"><a href="#local-1628060777"><span class="hs-identifier">tau</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-1628060769"><span class="hs-identifier hs-var">et</span></a><span> </span><span class="hs-comment">-- See Note [TcLevel of ExpType]</span><span>
</span><a name="line-1062"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="#local-1628060773"><span class="hs-identifier hs-var">type_cont</span></a><span> </span><a href="#local-1628060777"><span class="hs-identifier hs-var">tau</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1063"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1064"></a><span>    </span><a name="local-1628060774"><a href="#local-1628060774"><span class="hs-identifier">kind_orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#KindEqOrigin"><span class="hs-identifier hs-var">KindEqOrigin</span></a><span> </span><a href="#local-1628060768"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-1628060767"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span class="hs-special">)</span><span>
</span><a name="line-1065"></a><span class="hs-identifier">uExpTypeX</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TcType.html#Check"><span class="hs-identifier hs-var">Check</span></a><span> </span><a name="local-1628060778"><a href="#local-1628060778"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-1628060779"><a href="#local-1628060779"><span class="hs-identifier">type_cont</span></a></a><span>
</span><a name="line-1066"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060779"><span class="hs-identifier hs-var">type_cont</span></a><span> </span><a href="#local-1628060778"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1067"></a><span>
</span><a name="line-1068"></a><span class="hs-comment">------------</span><span>
</span><a name="line-1069"></a><span class="hs-identifier">uType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uType_defer</span><span>
</span><a name="line-1070"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>
</span><a name="line-1071"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a><span>
</span><a name="line-1072"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>    </span><span class="hs-comment">-- ty1 is the *actual* type</span><span>
</span><a name="line-1073"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>    </span><span class="hs-comment">-- ty2 is the *expected* type</span><span>
</span><a name="line-1074"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1075"></a><span>
</span><a name="line-1076"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-1077"></a><span class="hs-comment">-- It is always safe to defer unification to the main constraint solver</span><span>
</span><a name="line-1078"></a><span class="hs-comment">-- See Note [Deferred unification]</span><span>
</span><a name="line-1079"></a><a name="uType_defer"><a href="TcUnify.html#uType_defer"><span class="hs-identifier">uType_defer</span></a></a><span> </span><a name="local-1628060780"><a href="#local-1628060780"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-1628060781"><a href="#local-1628060781"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-1628060782"><a href="#local-1628060782"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628060783"><a href="#local-1628060783"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1080"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060784"><a href="#local-1628060784"><span class="hs-identifier">hole</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newCoercionHole"><span class="hs-identifier hs-var">newCoercionHole</span></a><span>
</span><a name="line-1081"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628060785"><a href="#local-1628060785"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getCtLocM"><span class="hs-identifier hs-var">getCtLocM</span></a><span> </span><a href="#local-1628060780"><span class="hs-identifier hs-var">origin</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628060781"><span class="hs-identifier hs-var">t_or_k</span></a><span class="hs-special">)</span><span>
</span><a name="line-1082"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitSimple"><span class="hs-identifier hs-var">emitSimple</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnTypes.html#mkNonCanonical"><span class="hs-identifier hs-var">mkNonCanonical</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1083"></a><span>             </span><a href="TcRnTypes.html#CtWanted"><span class="hs-identifier hs-var">CtWanted</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_dest</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#HoleDest"><span class="hs-identifier hs-var">HoleDest</span></a><span> </span><a href="#local-1628060784"><span class="hs-identifier hs-var">hole</span></a><span>
</span><a name="line-1084"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkPrimEqPred"><span class="hs-identifier hs-var">mkPrimEqPred</span></a><span> </span><a href="#local-1628060782"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060783"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1085"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060785"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1086"></a><span>
</span><a name="line-1087"></a><span>       </span><span class="hs-comment">-- Error trace only</span><span>
</span><a name="line-1088"></a><span>       </span><span class="hs-comment">-- NB. do *not* call mkErrInfo unless tracing is on, because</span><span>
</span><a name="line-1089"></a><span>       </span><span class="hs-comment">-- it is hugely expensive (#5631)</span><span>
</span><a name="line-1090"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#whenDOptM"><span class="hs-identifier hs-var">whenDOptM</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_tc_trace"><span class="hs-identifier hs-var">Opt_D_dump_tc_trace</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1091"></a><span>            </span><span class="hs-special">{</span><span> </span><a name="local-1628060786"><a href="#local-1628060786"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrCtxt"><span class="hs-identifier hs-var">getErrCtxt</span></a><span>
</span><a name="line-1092"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-1628060787"><a href="#local-1628060787"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#mkErrInfo"><span class="hs-identifier hs-var">mkErrInfo</span></a><span> </span><a href="VarEnv.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a><span> </span><a href="#local-1628060786"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1093"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;utype_defer&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060784"><span class="hs-identifier hs-var">hole</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060782"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span>
</span><a name="line-1094"></a><span>                                           </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060783"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#pprCtOrigin"><span class="hs-identifier hs-var">pprCtOrigin</span></a><span> </span><a href="#local-1628060780"><span class="hs-identifier hs-var">origin</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060787"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1095"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-1096"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkHoleCo"><span class="hs-identifier hs-var">mkHoleCo</span></a><span> </span><a href="#local-1628060784"><span class="hs-identifier hs-var">hole</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1628060782"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060783"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1097"></a><span>
</span><a name="line-1098"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-1099"></a><a name="uType"><a href="TcUnify.html#uType"><span class="hs-identifier">uType</span></a></a><span> </span><a name="local-1628060788"><a href="#local-1628060788"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-1628060789"><a href="#local-1628060789"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-1628060790"><a href="#local-1628060790"><span class="hs-identifier">orig_ty1</span></a></a><span> </span><a name="local-1628060791"><a href="#local-1628060791"><span class="hs-identifier">orig_ty2</span></a></a><span>
</span><a name="line-1100"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060874"><a href="#local-1628060874"><span class="hs-identifier">tclvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-1101"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;u_tys &quot;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span>
</span><a name="line-1102"></a><span>              </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;tclvl&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060874"><span class="hs-identifier hs-var">tclvl</span></a><span>
</span><a name="line-1103"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060790"><span class="hs-identifier hs-var">orig_ty1</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;~&quot;</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060791"><span class="hs-identifier hs-var">orig_ty2</span></a><span class="hs-special">]</span><span>
</span><a name="line-1104"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#pprCtOrigin"><span class="hs-identifier hs-var">pprCtOrigin</span></a><span> </span><a href="#local-1628060788"><span class="hs-identifier hs-var">origin</span></a><span class="hs-special">]</span><span>
</span><a name="line-1105"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628060875"><a href="#local-1628060875"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060792"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060790"><span class="hs-identifier hs-var">orig_ty1</span></a><span> </span><a href="#local-1628060791"><span class="hs-identifier hs-var">orig_ty2</span></a><span>
</span><a name="line-1106"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-1628060875"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1107"></a><span>            </span><span class="hs-keyword">then</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;u_tys yields no coercion&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">Outputable</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1108"></a><span>            </span><span class="hs-keyword">else</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;u_tys yields coercion:&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060875"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1109"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628060875"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1110"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1111"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1112"></a><span>        </span><span class="hs-comment">-- The arguments to 'go' are always semantically identical</span><span>
</span><a name="line-1113"></a><span>        </span><span class="hs-comment">-- to orig_ty{1,2} except for looking through type synonyms</span><span>
</span><a name="line-1114"></a><span>
</span><a name="line-1115"></a><span>        </span><span class="hs-comment">-- Variables; go for uVar</span><span>
</span><a name="line-1116"></a><span>        </span><span class="hs-comment">-- Note that we pass in *original* (before synonym expansion),</span><span>
</span><a name="line-1117"></a><span>        </span><span class="hs-comment">-- so that type variables tend to get filled in with</span><span>
</span><a name="line-1118"></a><span>        </span><span class="hs-comment">-- the most informative version of the type</span><span>
</span><a name="line-1119"></a><span>    </span><a name="local-1628060792"><a href="#local-1628060792"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628060795"><a href="#local-1628060795"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060796"><a href="#local-1628060796"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1120"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060797"><a href="#local-1628060797"><span class="hs-identifier">lookup_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#lookupTcTyVar"><span class="hs-identifier hs-var">lookupTcTyVar</span></a><span> </span><a href="#local-1628060795"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-1121"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060797"><span class="hs-identifier hs-var">lookup_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1122"></a><span>               </span><a href="TcUnify.html#Filled"><span class="hs-identifier hs-var">Filled</span></a><span> </span><a name="local-1628060798"><a href="#local-1628060798"><span class="hs-identifier">ty1</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;found filled tyvar&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060795"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;:-&gt;&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060798"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1123"></a><span>                                  </span><span class="hs-special">;</span><span> </span><a href="#local-1628060792"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060798"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060796"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1124"></a><span>               </span><a href="TcUnify.html#Unfilled"><span class="hs-identifier hs-var">Unfilled</span></a><span> </span><a name="local-1628060799"><a href="#local-1628060799"><span class="hs-identifier">ds1</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcUnify.html#uUnfilledVar"><span class="hs-identifier hs-var">uUnfilledVar</span></a><span> </span><a href="#local-1628060788"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060789"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="BasicTypes.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a><span> </span><a href="#local-1628060795"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1628060799"><span class="hs-identifier hs-var">ds1</span></a><span> </span><a href="#local-1628060796"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1125"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060800"><a href="#local-1628060800"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628060801"><a href="#local-1628060801"><span class="hs-identifier">tv2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1126"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060802"><a href="#local-1628060802"><span class="hs-identifier">lookup_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#lookupTcTyVar"><span class="hs-identifier hs-var">lookupTcTyVar</span></a><span> </span><a href="#local-1628060801"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-1127"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060802"><span class="hs-identifier hs-var">lookup_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1128"></a><span>               </span><a href="TcUnify.html#Filled"><span class="hs-identifier hs-var">Filled</span></a><span> </span><a name="local-1628060803"><a href="#local-1628060803"><span class="hs-identifier">ty2</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;found filled tyvar&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060801"><span class="hs-identifier hs-var">tv2</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;:-&gt;&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060803"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1129"></a><span>                                  </span><span class="hs-special">;</span><span> </span><a href="#local-1628060792"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060800"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060803"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1130"></a><span>               </span><a href="TcUnify.html#Unfilled"><span class="hs-identifier hs-var">Unfilled</span></a><span> </span><a name="local-1628060804"><a href="#local-1628060804"><span class="hs-identifier">ds2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcUnify.html#uUnfilledVar"><span class="hs-identifier hs-var">uUnfilledVar</span></a><span> </span><a href="#local-1628060788"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060789"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="BasicTypes.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a><span> </span><a href="#local-1628060801"><span class="hs-identifier hs-var">tv2</span></a><span> </span><a href="#local-1628060804"><span class="hs-identifier hs-var">ds2</span></a><span> </span><a href="#local-1628060800"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1131"></a><span>
</span><a name="line-1132"></a><span>      </span><span class="hs-comment">-- See Note [Expanding synonyms during unification]</span><span>
</span><a name="line-1133"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060805"><a href="#local-1628060805"><span class="hs-identifier">ty1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628060806"><a href="#local-1628060806"><span class="hs-identifier">tc1</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628060807"><a href="#local-1628060807"><span class="hs-identifier">tc2</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1134"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628060806"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1628060807"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1135"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1628060805"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1136"></a><span>
</span><a name="line-1137"></a><span>        </span><span class="hs-comment">-- See Note [Expanding synonyms during unification]</span><span>
</span><a name="line-1138"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1139"></a><span>        </span><span class="hs-comment">-- Also NB that we recurse to 'go' so that we don't push a</span><span>
</span><a name="line-1140"></a><span>        </span><span class="hs-comment">-- new item on the origin stack. As a result if we have</span><span>
</span><a name="line-1141"></a><span>        </span><span class="hs-comment">--   type Foo = Int</span><span>
</span><a name="line-1142"></a><span>        </span><span class="hs-comment">-- and we try to unify  Foo ~ Bool</span><span>
</span><a name="line-1143"></a><span>        </span><span class="hs-comment">-- we'll end up saying &quot;can't match Foo with Bool&quot;</span><span>
</span><a name="line-1144"></a><span>        </span><span class="hs-comment">-- rather than &quot;can't match &quot;Int with Bool&quot;.  See Trac #4535.</span><span>
</span><a name="line-1145"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060808"><a href="#local-1628060808"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628060809"><a href="#local-1628060809"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1146"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628060810"><a href="#local-1628060810"><span class="hs-identifier">ty1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-1628060808"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060792"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060810"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-1628060809"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1147"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628060811"><a href="#local-1628060811"><span class="hs-identifier">ty2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-1628060809"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060792"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060808"><span class="hs-identifier hs-var">ty1</span></a><span>  </span><a href="#local-1628060811"><span class="hs-identifier hs-var">ty2'</span></a><span>
</span><a name="line-1148"></a><span>
</span><a name="line-1149"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-1628060812"><a href="#local-1628060812"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-1628060813"><a href="#local-1628060813"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060814"><a href="#local-1628060814"><span class="hs-identifier">t2</span></a></a><span>
</span><a name="line-1150"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060815"><a href="#local-1628060815"><span class="hs-identifier">co_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060792"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060812"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1628060814"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1151"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoherenceLeftCo"><span class="hs-identifier hs-var">mkCoherenceLeftCo</span></a><span> </span><a href="#local-1628060815"><span class="hs-identifier hs-var">co_tys</span></a><span> </span><a href="#local-1628060813"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1152"></a><span>
</span><a name="line-1153"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060816"><a href="#local-1628060816"><span class="hs-identifier">t1</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-1628060817"><a href="#local-1628060817"><span class="hs-identifier">t2</span></a></a><span> </span><a name="local-1628060818"><a href="#local-1628060818"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060819"><a href="#local-1628060819"><span class="hs-identifier">co_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060792"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060816"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1628060817"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1155"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span> </span><a href="#local-1628060819"><span class="hs-identifier hs-var">co_tys</span></a><span> </span><a href="#local-1628060818"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1156"></a><span>
</span><a name="line-1157"></a><span>        </span><span class="hs-comment">-- Functions (or predicate functions) just check the two parts</span><span>
</span><a name="line-1158"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Anon"><span class="hs-identifier hs-var">Anon</span></a><span> </span><a name="local-1628060820"><a href="#local-1628060820"><span class="hs-identifier">fun1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060821"><a href="#local-1628060821"><span class="hs-identifier">arg1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Anon"><span class="hs-identifier hs-var">Anon</span></a><span> </span><a name="local-1628060822"><a href="#local-1628060822"><span class="hs-identifier">fun2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060823"><a href="#local-1628060823"><span class="hs-identifier">arg2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1159"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060824"><a href="#local-1628060824"><span class="hs-identifier">co_l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060788"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060789"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628060820"><span class="hs-identifier hs-var">fun1</span></a><span> </span><a href="#local-1628060822"><span class="hs-identifier hs-var">fun2</span></a><span>
</span><a name="line-1160"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060825"><a href="#local-1628060825"><span class="hs-identifier">co_r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060788"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060789"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628060821"><span class="hs-identifier hs-var">arg1</span></a><span> </span><a href="#local-1628060823"><span class="hs-identifier hs-var">arg2</span></a><span>
</span><a name="line-1161"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Coercion.html#mkFunCo"><span class="hs-identifier hs-var">mkFunCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1628060824"><span class="hs-identifier hs-var">co_l</span></a><span> </span><a href="#local-1628060825"><span class="hs-identifier hs-var">co_r</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1162"></a><span>
</span><a name="line-1163"></a><span>        </span><span class="hs-comment">-- Always defer if a type synonym family (type function)</span><span>
</span><a name="line-1164"></a><span>        </span><span class="hs-comment">-- is involved.  (Data families behave rigidly.)</span><span>
</span><a name="line-1165"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060826"><a href="#local-1628060826"><span class="hs-identifier">ty1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628060827"><a href="#local-1628060827"><span class="hs-identifier">tc1</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-1628060828"><a href="#local-1628060828"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1166"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-1628060827"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060793"><span class="hs-identifier hs-var">defer</span></a><span> </span><a href="#local-1628060826"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060828"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1167"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060829"><a href="#local-1628060829"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628060830"><a href="#local-1628060830"><span class="hs-identifier">ty2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628060831"><a href="#local-1628060831"><span class="hs-identifier">tc2</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1168"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-1628060831"><span class="hs-identifier hs-var">tc2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060793"><span class="hs-identifier hs-var">defer</span></a><span> </span><a href="#local-1628060829"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060830"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1169"></a><span>
</span><a name="line-1170"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628060832"><a href="#local-1628060832"><span class="hs-identifier">tc1</span></a></a><span> </span><a name="local-1628060833"><a href="#local-1628060833"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628060834"><a href="#local-1628060834"><span class="hs-identifier">tc2</span></a></a><span> </span><a name="local-1628060835"><a href="#local-1628060835"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1171"></a><span>      </span><span class="hs-comment">-- See Note [Mismatched type lists and application decomposition]</span><span>
</span><a name="line-1172"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628060832"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1628060834"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1628060833"><span class="hs-identifier hs-var">tys1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-1628060835"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-1173"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isGenerativeTyCon</span><span> </span><a href="TyCon.html#isGenerativeTyCon"><span class="hs-identifier hs-var">tc1</span></a><span> </span><a href="TyCon.html#isGenerativeTyCon"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060832"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1174"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060839"><a href="#local-1628060839"><span class="hs-identifier">cos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#zipWith3M"><span class="hs-identifier hs-var">zipWith3M</span></a><span> </span><span class="hs-special">(</span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060788"><span class="hs-identifier hs-var">origin</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060837"><span class="hs-identifier hs-var">t_or_ks</span></a><span> </span><a href="#local-1628060833"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-1628060835"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-1175"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1628060832"><span class="hs-identifier hs-var">tc1</span></a><span> </span><a href="#local-1628060839"><span class="hs-identifier hs-var">cos</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1176"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1177"></a><span>        </span><a name="local-1628060836"><a href="#local-1628060836"><span class="hs-identifier">bndrs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-1628060832"><span class="hs-identifier hs-var">tc1</span></a><span>
</span><a name="line-1178"></a><span>        </span><a name="local-1628060837"><a href="#local-1628060837"><span class="hs-identifier">t_or_ks</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060789"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1179"></a><span>                       </span><a href="TcRnTypes.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#repeat"><span class="hs-identifier hs-var">repeat</span></a><span> </span><a href="TcRnTypes.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a><span>
</span><a name="line-1180"></a><span>                       </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1628060838"><a href="#local-1628060838"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="TyCoRep.html#isNamedBinder"><span class="hs-identifier hs-var">isNamedBinder</span></a><span> </span><a href="#local-1628060838"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1181"></a><span>                                                  </span><span class="hs-keyword">then</span><span> </span><a href="TcRnTypes.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a><span>
</span><a name="line-1182"></a><span>                                                  </span><span class="hs-keyword">else</span><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060836"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-1183"></a><span>                                    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#repeat"><span class="hs-identifier hs-var">repeat</span></a><span> </span><a href="TcRnTypes.html#TypeLevel"><span class="hs-identifier hs-var">TypeLevel</span></a><span>
</span><a name="line-1184"></a><span>
</span><a name="line-1185"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><a name="local-1628060840"><a href="#local-1628060840"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060841"><a href="#local-1628060841"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><a name="local-1628060842"><a href="#local-1628060842"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1186"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628060840"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1628060842"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1187"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="#local-1628060841"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1188"></a><span>
</span><a name="line-1189"></a><span>        </span><span class="hs-comment">-- See Note [Care with type applications]</span><span>
</span><a name="line-1190"></a><span>        </span><span class="hs-comment">-- Do not decompose FunTy against App;</span><span>
</span><a name="line-1191"></a><span>        </span><span class="hs-comment">-- it's often a type error, so leave it for the constraint solver</span><span>
</span><a name="line-1192"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-1628060843"><a href="#local-1628060843"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-1628060844"><a href="#local-1628060844"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-1628060845"><a href="#local-1628060845"><span class="hs-identifier">s2</span></a></a><span> </span><a name="local-1628060846"><a href="#local-1628060846"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1193"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060794"><span class="hs-identifier hs-var">go_app</span></a><span> </span><a href="#local-1628060843"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-1628060844"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1628060845"><span class="hs-identifier hs-var">s2</span></a><span> </span><a href="#local-1628060846"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1194"></a><span>
</span><a name="line-1195"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-1628060847"><a href="#local-1628060847"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-1628060848"><a href="#local-1628060848"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628060849"><a href="#local-1628060849"><span class="hs-identifier">tc2</span></a></a><span> </span><a name="local-1628060850"><a href="#local-1628060850"><span class="hs-identifier">ts2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1196"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628060851"><a href="#local-1628060851"><span class="hs-identifier">ts2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060852"><a href="#local-1628060852"><span class="hs-identifier">t2'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Util.html#snocView"><span class="hs-identifier hs-var">snocView</span></a><span> </span><a href="#local-1628060850"><span class="hs-identifier hs-var">ts2</span></a><span>
</span><a name="line-1197"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">mightBeUnsaturatedTyCon</span><span> </span><a href="TyCon.html#mightBeUnsaturatedTyCon"><span class="hs-identifier hs-var">tc2</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1198"></a><span>        </span><a href="#local-1628060794"><span class="hs-identifier hs-var">go_app</span></a><span> </span><a href="#local-1628060847"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-1628060848"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a href="#local-1628060849"><span class="hs-identifier hs-var">tc2</span></a><span> </span><a href="#local-1628060851"><span class="hs-identifier hs-var">ts2'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060852"><span class="hs-identifier hs-var">t2'</span></a><span>
</span><a name="line-1199"></a><span>
</span><a name="line-1200"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628060853"><a href="#local-1628060853"><span class="hs-identifier">tc1</span></a></a><span> </span><a name="local-1628060854"><a href="#local-1628060854"><span class="hs-identifier">ts1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-1628060855"><a href="#local-1628060855"><span class="hs-identifier">s2</span></a></a><span> </span><a name="local-1628060856"><a href="#local-1628060856"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1201"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628060857"><a href="#local-1628060857"><span class="hs-identifier">ts1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060858"><a href="#local-1628060858"><span class="hs-identifier">t1'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Util.html#snocView"><span class="hs-identifier hs-var">snocView</span></a><span> </span><a href="#local-1628060854"><span class="hs-identifier hs-var">ts1</span></a><span>
</span><a name="line-1202"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">mightBeUnsaturatedTyCon</span><span> </span><a href="TyCon.html#mightBeUnsaturatedTyCon"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1203"></a><span>        </span><a href="#local-1628060794"><span class="hs-identifier hs-var">go_app</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a href="#local-1628060853"><span class="hs-identifier hs-var">tc1</span></a><span> </span><a href="#local-1628060857"><span class="hs-identifier hs-var">ts1'</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060858"><span class="hs-identifier hs-var">t1'</span></a><span> </span><a href="#local-1628060855"><span class="hs-identifier hs-var">s2</span></a><span> </span><a href="#local-1628060856"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1204"></a><span>
</span><a name="line-1205"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-1628060859"><a href="#local-1628060859"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-1628060860"><a href="#local-1628060860"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1206"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628060861"><a href="#local-1628060861"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span> </span><a href="#local-1628060859"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-1207"></a><span>                 </span><a name="local-1628060862"><a href="#local-1628060862"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span> </span><a href="#local-1628060860"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1208"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060863"><a href="#local-1628060863"><span class="hs-identifier">kco</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#KindEqOrigin"><span class="hs-identifier hs-var">KindEqOrigin</span></a><span> </span><a href="#local-1628060790"><span class="hs-identifier hs-var">orig_ty1</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628060791"><span class="hs-identifier hs-var">orig_ty2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060788"><span class="hs-identifier hs-var">origin</span></a><span>
</span><a name="line-1209"></a><span>                                        </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628060789"><span class="hs-identifier hs-var">t_or_k</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1210"></a><span>                          </span><a href="TcRnTypes.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a><span>
</span><a name="line-1211"></a><span>                          </span><a href="#local-1628060861"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060862"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1212"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Coercion.html#mkProofIrrelCo"><span class="hs-identifier hs-var">mkProofIrrelCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-1628060863"><span class="hs-identifier hs-var">kco</span></a><span> </span><a href="#local-1628060859"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-1628060860"><span class="hs-identifier hs-var">co2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1213"></a><span>
</span><a name="line-1214"></a><span>        </span><span class="hs-comment">-- Anything else fails</span><span>
</span><a name="line-1215"></a><span>        </span><span class="hs-comment">-- E.g. unifying for-all types, which is relative unusual</span><span>
</span><a name="line-1216"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060864"><a href="#local-1628060864"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628060865"><a href="#local-1628060865"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060793"><span class="hs-identifier hs-var">defer</span></a><span> </span><a href="#local-1628060864"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060865"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1217"></a><span>
</span><a name="line-1218"></a><span>    </span><span class="hs-comment">------------------</span><span>
</span><a name="line-1219"></a><span>    </span><a name="local-1628060793"><a href="#local-1628060793"><span class="hs-identifier">defer</span></a></a><span> </span><a name="local-1628060866"><a href="#local-1628060866"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-1628060867"><a href="#local-1628060867"><span class="hs-identifier">ty2</span></a></a><span>   </span><span class="hs-comment">-- See Note [Check for equality before deferring]</span><span>
</span><a name="line-1220"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628060866"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><a href="TcType.html#tcEqType"><span class="hs-identifier hs-var">tcEqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628060867"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="#local-1628060866"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1221"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#uType_defer"><span class="hs-identifier hs-var">uType_defer</span></a><span> </span><a href="#local-1628060788"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060789"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628060866"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060867"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1222"></a><span>
</span><a name="line-1223"></a><span>    </span><span class="hs-comment">------------------</span><span>
</span><a name="line-1224"></a><span>    </span><a name="local-1628060794"><a href="#local-1628060794"><span class="hs-identifier">go_app</span></a></a><span> </span><a name="local-1628060868"><a href="#local-1628060868"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-1628060869"><a href="#local-1628060869"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-1628060870"><a href="#local-1628060870"><span class="hs-identifier">s2</span></a></a><span> </span><a name="local-1628060871"><a href="#local-1628060871"><span class="hs-identifier">t2</span></a></a><span>
</span><a name="line-1225"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060872"><a href="#local-1628060872"><span class="hs-identifier">co_s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060788"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060789"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628060868"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-1628060870"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-1226"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060873"><a href="#local-1628060873"><span class="hs-identifier">co_t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060788"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060789"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628060869"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-1628060871"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1227"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Coercion.html#mkAppCo"><span class="hs-identifier hs-var">mkAppCo</span></a><span> </span><a href="#local-1628060872"><span class="hs-identifier hs-var">co_s</span></a><span> </span><a href="#local-1628060873"><span class="hs-identifier hs-var">co_t</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1228"></a><span>
</span><a name="line-1229"></a><span class="hs-comment">{- Note [Check for equality before deferring]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Particularly in ambiguity checks we can get equalities like (ty ~ ty).
If ty involves a type function we may defer, which isn't very sensible.
An egregious example of this was in test T9872a, which has a type signature
       Proxy :: Proxy (Solutions Cubes)
Doing the ambiguity check on this signature generates the equality
   Solutions Cubes ~ Solutions Cubes
and currently the constraint solver normalises both sides at vast cost.
This little short-cut in 'defer' helps quite a bit.

Note [Care with type applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Note: type applications need a bit of care!
They can match FunTy and TyConApp, so use splitAppTy_maybe
NB: we've already dealt with type variables and Notes,
so if one type is an App the other one jolly well better be too

Note [Mismatched type lists and application decomposition]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we find two TyConApps, you might think that the argument lists
are guaranteed equal length.  But they aren't. Consider matching
        w (T x) ~ Foo (T x y)
We do match (w ~ Foo) first, but in some circumstances we simply create
a deferred constraint; and then go ahead and match (T x ~ T x y).
This came up in Trac #3950.

So either
   (a) either we must check for identical argument kinds
       when decomposing applications,

   (b) or we must be prepared for ill-kinded unification sub-problems

Currently we adopt (b) since it seems more robust -- no need to maintain
a global invariant.

Note [Expanding synonyms during unification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We expand synonyms during unification, but:
 * We expand *after* the variable case so that we tend to unify
   variables with un-expanded type synonym. This just makes it
   more likely that the inferred types will mention type synonyms
   understandable to the user

 * We expand *before* the TyConApp case.  For example, if we have
      type Phantom a = Int
   and are unifying
      Phantom Int ~ Phantom Char
   it is *wrong* to unify Int and Char.

 * The problem case immediately above can happen only with arguments
   to the tycon. So we check for nullary tycons *before* expanding.
   This is particularly helpful when checking (* ~ *), because * is
   now a type synonym.

Note [Deferred Unification]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We may encounter a unification ty1 ~ ty2 that cannot be performed syntactically,
and yet its consistency is undetermined. Previously, there was no way to still
make it consistent. So a mismatch error was issued.

Now these unifications are deferred until constraint simplification, where type
family instances and given equations may (or may not) establish the consistency.
Deferred unifications are of the form
                F ... ~ ...
or              x ~ ...
where F is a type function and x is a type variable.
E.g.
        id :: x ~ y =&gt; x -&gt; y
        id e = e

involves the unification x = y. It is deferred until we bring into account the
context x ~ y to establish that it holds.

If available, we defer original types (rather than those where closed type
synonyms have already been expanded via tcCoreView).  This is, as usual, to
improve error messages.


************************************************************************
*                                                                      *
                 uVar and friends
*                                                                      *
************************************************************************

@uVar@ is called when at least one of the types being unified is a
variable.  It does {\em not} assume that the variable is a fixed point
of the substitution; rather, notice that @uVar@ (defined below) nips
back into @uTys@ if it turns out that the variable is already bound.
-}</span><span>
</span><a name="line-1319"></a><span>
</span><a name="line-1320"></a><span class="hs-identifier">uUnfilledVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>
</span><a name="line-1321"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a><span>
</span><a name="line-1322"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a><span>
</span><a name="line-1323"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVarDetails"><span class="hs-identifier hs-type">TcTyVarDetails</span></a><span>       </span><span class="hs-comment">-- Tyvar 1</span><span>
</span><a name="line-1324"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTauType"><span class="hs-identifier hs-type">TcTauType</span></a><span>                       </span><span class="hs-comment">-- Type 2</span><span>
</span><a name="line-1325"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1326"></a><span class="hs-comment">-- &quot;Unfilled&quot; means that the variable is definitely not a filled-in meta tyvar</span><span>
</span><a name="line-1327"></a><span class="hs-comment">--            It might be a skolem, or untouchable, or meta</span><span>
</span><a name="line-1328"></a><span>
</span><a name="line-1329"></a><a name="uUnfilledVar"><a href="TcUnify.html#uUnfilledVar"><span class="hs-identifier">uUnfilledVar</span></a></a><span> </span><a name="local-1628060876"><a href="#local-1628060876"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-1628060877"><a href="#local-1628060877"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-1628060878"><a href="#local-1628060878"><span class="hs-identifier">swapped</span></a></a><span> </span><a name="local-1628060879"><a href="#local-1628060879"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-1628060880"><a href="#local-1628060880"><span class="hs-identifier">details1</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628060881"><a href="#local-1628060881"><span class="hs-identifier">tv2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1330"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628060879"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1628060881"><span class="hs-identifier hs-var">tv2</span></a><span>  </span><span class="hs-comment">-- Same type variable =&gt; no-op</span><span>
</span><a name="line-1331"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628060879"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1332"></a><span>
</span><a name="line-1333"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-comment">-- Distinct type variables</span><span>
</span><a name="line-1334"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-1628060882"><a href="#local-1628060882"><span class="hs-identifier">lookup2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#lookupTcTyVar"><span class="hs-identifier hs-var">lookupTcTyVar</span></a><span> </span><a href="#local-1628060881"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-1335"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060882"><span class="hs-identifier hs-var">lookup2</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1336"></a><span>            </span><a href="TcUnify.html#Filled"><span class="hs-identifier hs-var">Filled</span></a><span> </span><a name="local-1628060883"><a href="#local-1628060883"><span class="hs-identifier">ty2'</span></a></a><span>
</span><a name="line-1337"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcUnify.html#uUnfilledVar"><span class="hs-identifier hs-var">uUnfilledVar</span></a><span> </span><a href="#local-1628060876"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060877"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628060878"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-1628060879"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1628060880"><span class="hs-identifier hs-var">details1</span></a><span> </span><a href="#local-1628060883"><span class="hs-identifier hs-var">ty2'</span></a><span>
</span><a name="line-1338"></a><span>            </span><a href="TcUnify.html#Unfilled"><span class="hs-identifier hs-var">Unfilled</span></a><span> </span><a name="local-1628060884"><a href="#local-1628060884"><span class="hs-identifier">details2</span></a></a><span>
</span><a name="line-1339"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcUnify.html#uUnfilledVars"><span class="hs-identifier hs-var">uUnfilledVars</span></a><span> </span><a href="#local-1628060876"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060877"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628060878"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-1628060879"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1628060880"><span class="hs-identifier hs-var">details1</span></a><span> </span><a href="#local-1628060881"><span class="hs-identifier hs-var">tv2</span></a><span> </span><a href="#local-1628060884"><span class="hs-identifier hs-var">details2</span></a><span>
</span><a name="line-1340"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-1341"></a><span>
</span><a name="line-1342"></a><span class="hs-identifier">uUnfilledVar</span><span> </span><a name="local-1628060885"><a href="#local-1628060885"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-1628060886"><a href="#local-1628060886"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-1628060887"><a href="#local-1628060887"><span class="hs-identifier">swapped</span></a></a><span> </span><a name="local-1628060888"><a href="#local-1628060888"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-1628060889"><a href="#local-1628060889"><span class="hs-identifier">details1</span></a></a><span> </span><a name="local-1628060890"><a href="#local-1628060890"><span class="hs-identifier">non_var_ty2</span></a></a><span>
</span><a name="line-1343"></a><span class="hs-comment">-- ty2 is not a type variable</span><span>
</span><a name="line-1344"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060889"><span class="hs-identifier hs-var">details1</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1345"></a><span>      </span><a href="TcType.html#MetaTv"><span class="hs-identifier hs-var">MetaTv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mtv_ref</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628060892"><a href="#local-1628060892"><span class="hs-identifier">ref1</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1346"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060893"><a href="#local-1628060893"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-1347"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-1628060894"><a href="#local-1628060894"><span class="hs-identifier">mb_ty2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#checkTauTvUpdate"><span class="hs-identifier hs-var">checkTauTvUpdate</span></a><span> </span><a href="#local-1628060893"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628060885"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060886"><span class="hs-identifier hs-var">t_or_k</span></a><span> </span><a href="#local-1628060888"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1628060890"><span class="hs-identifier hs-var">non_var_ty2</span></a><span>
</span><a name="line-1348"></a><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060894"><span class="hs-identifier hs-var">mb_ty2'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1349"></a><span>                  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-1628060895"><a href="#local-1628060895"><span class="hs-identifier">ty2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060896"><a href="#local-1628060896"><span class="hs-identifier">co_k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcUnify.html#maybe_sym"><span class="hs-identifier hs-var">maybe_sym</span></a><span> </span><a href="#local-1628060887"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span>
</span><a name="line-1350"></a><span>                                       </span><a href="TcUnify.html#updateMeta"><span class="hs-identifier hs-var">updateMeta</span></a><span> </span><a href="#local-1628060888"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1628060892"><span class="hs-identifier hs-var">ref1</span></a><span> </span><a href="#local-1628060895"><span class="hs-identifier hs-var">ty2'</span></a><span> </span><a href="#local-1628060896"><span class="hs-identifier hs-var">co_k</span></a><span>
</span><a name="line-1351"></a><span>                  </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Occ/type-family defer&quot;</span><span>
</span><a name="line-1352"></a><span>                                        </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060888"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-1628060888"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1353"></a><span>                                         </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060890"><span class="hs-identifier hs-var">non_var_ty2</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628060890"><span class="hs-identifier hs-var">non_var_ty2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1354"></a><span>                                  </span><span class="hs-special">;</span><span> </span><a href="#local-1628060891"><span class="hs-identifier hs-var">defer</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1355"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-1356"></a><span>
</span><a name="line-1357"></a><span>      </span><a name="local-1628060897"><a href="#local-1628060897"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Skolem defer&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060888"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><a href="#local-1628060891"><span class="hs-identifier hs-var">defer</span></a><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- Skolems of all sorts</span><span>
</span><a name="line-1358"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1359"></a><span>    </span><a name="local-1628060891"><a href="#local-1628060891"><span class="hs-identifier">defer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#unSwap"><span class="hs-identifier hs-var">unSwap</span></a><span> </span><a href="#local-1628060887"><span class="hs-identifier hs-var">swapped</span></a><span> </span><span class="hs-special">(</span><a href="TcUnify.html#uType_defer"><span class="hs-identifier hs-var">uType_defer</span></a><span> </span><a href="#local-1628060885"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060886"><span class="hs-identifier hs-var">t_or_k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628060888"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060890"><span class="hs-identifier hs-var">non_var_ty2</span></a><span>
</span><a name="line-1360"></a><span>               </span><span class="hs-comment">-- Occurs check or an untouchable: just defer</span><span>
</span><a name="line-1361"></a><span>               </span><span class="hs-comment">-- NB: occurs check isn't necessarily fatal:</span><span>
</span><a name="line-1362"></a><span>               </span><span class="hs-comment">--     eg tv1 occured in type family parameter</span><span>
</span><a name="line-1363"></a><span>
</span><a name="line-1364"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-1365"></a><span class="hs-identifier">uUnfilledVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>
</span><a name="line-1366"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a><span>
</span><a name="line-1367"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a><span>
</span><a name="line-1368"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVarDetails"><span class="hs-identifier hs-type">TcTyVarDetails</span></a><span>      </span><span class="hs-comment">-- Tyvar 1</span><span>
</span><a name="line-1369"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVarDetails"><span class="hs-identifier hs-type">TcTyVarDetails</span></a><span>      </span><span class="hs-comment">-- Tyvar 2</span><span>
</span><a name="line-1370"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1371"></a><span class="hs-comment">-- Invarant: The type variables are distinct,</span><span>
</span><a name="line-1372"></a><span class="hs-comment">--           Neither is filled in yet</span><span>
</span><a name="line-1373"></a><span>
</span><a name="line-1374"></a><a name="uUnfilledVars"><a href="TcUnify.html#uUnfilledVars"><span class="hs-identifier">uUnfilledVars</span></a></a><span> </span><a name="local-1628060898"><a href="#local-1628060898"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-1628060899"><a href="#local-1628060899"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-1628060900"><a href="#local-1628060900"><span class="hs-identifier">swapped</span></a></a><span> </span><a name="local-1628060901"><a href="#local-1628060901"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-1628060902"><a href="#local-1628060902"><span class="hs-identifier">details1</span></a></a><span> </span><a name="local-1628060903"><a href="#local-1628060903"><span class="hs-identifier">tv2</span></a></a><span> </span><a name="local-1628060904"><a href="#local-1628060904"><span class="hs-identifier">details2</span></a></a><span>
</span><a name="line-1375"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;uUnfilledVars for&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060901"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;and&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060903"><span class="hs-identifier hs-var">tv2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1376"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;uUnfilledVars&quot;</span><span> </span><span class="hs-special">(</span><span>    </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;trying to unify&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060905"><span class="hs-identifier hs-var">k1</span></a><span>
</span><a name="line-1377"></a><span>                                  </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;with&quot;</span><span>            </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-1628060906"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1378"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628060910"><a href="#local-1628060910"><span class="hs-identifier">co_k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060909"><span class="hs-identifier hs-var">kind_origin</span></a><span> </span><a href="TcRnTypes.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a><span> </span><a href="#local-1628060905"><span class="hs-identifier hs-var">k1</span></a><span> </span><a href="#local-1628060906"><span class="hs-identifier hs-var">k2</span></a><span>
</span><a name="line-1379"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628060911"><a href="#local-1628060911"><span class="hs-identifier">no_swap</span></a></a><span> </span><a name="local-1628060913"><a href="#local-1628060913"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#maybe_sym"><span class="hs-identifier hs-var">maybe_sym</span></a><span> </span><a href="#local-1628060900"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span>
</span><a name="line-1380"></a><span>                           </span><a href="TcUnify.html#updateMeta"><span class="hs-identifier hs-var">updateMeta</span></a><span> </span><a href="#local-1628060901"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1628060913"><span class="hs-identifier hs-var">ref</span></a><span> </span><a href="#local-1628060908"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-1628060910"><span class="hs-identifier hs-var">co_k</span></a><span class="hs-special">)</span><span>
</span><a name="line-1381"></a><span>             </span><a name="local-1628060912"><a href="#local-1628060912"><span class="hs-identifier">do_swap</span></a></a><span> </span><a name="local-1628060914"><a href="#local-1628060914"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#maybe_sym"><span class="hs-identifier hs-var">maybe_sym</span></a><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#flipSwap"><span class="hs-identifier hs-var">flipSwap</span></a><span> </span><a href="#local-1628060900"><span class="hs-identifier hs-var">swapped</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span>
</span><a name="line-1382"></a><span>                           </span><a href="TcUnify.html#updateMeta"><span class="hs-identifier hs-var">updateMeta</span></a><span> </span><a href="#local-1628060903"><span class="hs-identifier hs-var">tv2</span></a><span> </span><a href="#local-1628060914"><span class="hs-identifier hs-var">ref</span></a><span> </span><a href="#local-1628060907"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060910"><span class="hs-identifier hs-var">co_k</span></a><span>
</span><a name="line-1383"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-1628060902"><span class="hs-identifier hs-var">details1</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060904"><span class="hs-identifier hs-var">details2</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1384"></a><span>         </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span> </span><a href="TcType.html#MetaTv"><span class="hs-identifier hs-var">MetaTv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mtv_info</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628060915"><a href="#local-1628060915"><span class="hs-identifier">i1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mtv_ref</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628060916"><a href="#local-1628060916"><span class="hs-identifier">ref1</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1385"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="TcType.html#MetaTv"><span class="hs-identifier hs-var">MetaTv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mtv_info</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628060917"><a href="#local-1628060917"><span class="hs-identifier">i2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mtv_ref</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628060918"><a href="#local-1628060918"><span class="hs-identifier">ref2</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1386"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="TcUnify.html#nicer_to_update_tv1"><span class="hs-identifier hs-var">nicer_to_update_tv1</span></a><span> </span><a href="#local-1628060901"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1628060915"><span class="hs-identifier hs-var">i1</span></a><span> </span><a href="#local-1628060917"><span class="hs-identifier hs-var">i2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060911"><span class="hs-identifier hs-var">no_swap</span></a><span> </span><a href="#local-1628060916"><span class="hs-identifier hs-var">ref1</span></a><span>
</span><a name="line-1387"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060912"><span class="hs-identifier hs-var">do_swap</span></a><span> </span><a href="#local-1628060918"><span class="hs-identifier hs-var">ref2</span></a><span>
</span><a name="line-1388"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a href="TcType.html#MetaTv"><span class="hs-identifier hs-var">MetaTv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mtv_ref</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628060919"><a href="#local-1628060919"><span class="hs-identifier">ref1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060911"><span class="hs-identifier hs-var">no_swap</span></a><span> </span><a href="#local-1628060919"><span class="hs-identifier hs-var">ref1</span></a><span>
</span><a name="line-1389"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="TcType.html#MetaTv"><span class="hs-identifier hs-var">MetaTv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mtv_ref</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628060920"><a href="#local-1628060920"><span class="hs-identifier">ref2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060912"><span class="hs-identifier hs-var">do_swap</span></a><span> </span><a href="#local-1628060920"><span class="hs-identifier hs-var">ref2</span></a><span>
</span><a name="line-1390"></a><span>
</span><a name="line-1391"></a><span>           </span><span class="hs-comment">-- Can't do it in-place, so defer</span><span>
</span><a name="line-1392"></a><span>           </span><span class="hs-comment">-- This happens for skolems of all sorts</span><span>
</span><a name="line-1393"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;deferring because I can't find a meta-tyvar:&quot;</span><span>
</span><a name="line-1394"></a><span>                       </span><span class="hs-special">(</span><a href="TcType.html#pprTcTyVarDetails"><span class="hs-identifier hs-var">pprTcTyVarDetails</span></a><span> </span><a href="#local-1628060902"><span class="hs-identifier hs-var">details1</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TcType.html#pprTcTyVarDetails"><span class="hs-identifier hs-var">pprTcTyVarDetails</span></a><span> </span><a href="#local-1628060904"><span class="hs-identifier hs-var">details2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1395"></a><span>                   </span><span class="hs-special">;</span><span> </span><a href="BasicTypes.html#unSwap"><span class="hs-identifier hs-var">unSwap</span></a><span> </span><a href="#local-1628060900"><span class="hs-identifier hs-var">swapped</span></a><span> </span><span class="hs-special">(</span><a href="TcUnify.html#uType_defer"><span class="hs-identifier hs-var">uType_defer</span></a><span> </span><a href="#local-1628060898"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-1628060899"><span class="hs-identifier hs-var">t_or_k</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060907"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-1628060908"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1396"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1397"></a><span>    </span><a name="local-1628060905"><a href="#local-1628060905"><span class="hs-identifier">k1</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-1628060901"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-1398"></a><span>    </span><a name="local-1628060906"><a href="#local-1628060906"><span class="hs-identifier">k2</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-1628060903"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-1399"></a><span>    </span><a name="local-1628060907"><a href="#local-1628060907"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628060901"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-1400"></a><span>    </span><a name="local-1628060908"><a href="#local-1628060908"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628060903"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-1401"></a><span>    </span><a name="local-1628060909"><a href="#local-1628060909"><span class="hs-identifier">kind_origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#KindEqOrigin"><span class="hs-identifier hs-var">KindEqOrigin</span></a><span> </span><a href="#local-1628060907"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628060908"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060898"><span class="hs-identifier hs-var">origin</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628060899"><span class="hs-identifier hs-var">t_or_k</span></a><span class="hs-special">)</span><span>
</span><a name="line-1402"></a><span>
</span><a name="line-1403"></a><span class="hs-comment">-- | apply sym iff swapped</span><span>
</span><a name="line-1404"></a><span class="hs-identifier">maybe_sym</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#SwapFlag"><span class="hs-identifier hs-type">SwapFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1405"></a><a name="maybe_sym"><a href="TcUnify.html#maybe_sym"><span class="hs-identifier">maybe_sym</span></a></a><span> </span><a href="BasicTypes.html#IsSwapped"><span class="hs-identifier hs-var">IsSwapped</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span>
</span><a name="line-1406"></a><span class="hs-identifier">maybe_sym</span><span> </span><a href="BasicTypes.html#NotSwapped"><span class="hs-identifier hs-var">NotSwapped</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1407"></a><span>
</span><a name="line-1408"></a><span class="hs-identifier">nicer_to_update_tv1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#MetaInfo"><span class="hs-identifier hs-type">MetaInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#MetaInfo"><span class="hs-identifier hs-type">MetaInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1409"></a><a name="nicer_to_update_tv1"><a href="TcUnify.html#nicer_to_update_tv1"><span class="hs-identifier">nicer_to_update_tv1</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span>     </span><a href="TcType.html#SigTv"><span class="hs-identifier hs-var">SigTv</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1410"></a><span class="hs-identifier">nicer_to_update_tv1</span><span> </span><span class="hs-identifier">_</span><span>   </span><a href="TcType.html#SigTv"><span class="hs-identifier hs-var">SigTv</span></a><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1411"></a><span>        </span><span class="hs-comment">-- Try not to update SigTvs; and try to update sys-y type</span><span>
</span><a name="line-1412"></a><span>        </span><span class="hs-comment">-- variables in preference to ones gotten (say) by</span><span>
</span><a name="line-1413"></a><span>        </span><span class="hs-comment">-- instantiating a polymorphic function with a user-written</span><span>
</span><a name="line-1414"></a><span>        </span><span class="hs-comment">-- type sig</span><span>
</span><a name="line-1415"></a><span class="hs-identifier">nicer_to_update_tv1</span><span> </span><a name="local-1628060921"><a href="#local-1628060921"><span class="hs-identifier">tv1</span></a></a><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#isSystemName"><span class="hs-identifier hs-var">isSystemName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">Var</span><span class="hs-operator">.</span><span class="hs-identifier">varName</span><span> </span><a href="#local-1628060921"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1416"></a><span>
</span><a name="line-1417"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-1418"></a><span class="hs-identifier">checkTauTvUpdate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-1419"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#CtOrigin"><span class="hs-identifier hs-type">CtOrigin</span></a><span>
</span><a name="line-1420"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TypeOrKind"><span class="hs-identifier hs-type">TypeOrKind</span></a><span>
</span><a name="line-1421"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span>             </span><span class="hs-comment">-- tv :: k1</span><span>
</span><a name="line-1422"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>              </span><span class="hs-comment">-- ty :: k2</span><span>
</span><a name="line-1423"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>        </span><span class="hs-comment">-- possibly-expanded ty</span><span>
</span><a name="line-1424"></a><span>                               </span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- :: k2 ~N k1</span><span>
</span><a name="line-1425"></a><span class="hs-comment">--    (checkTauTvUpdate tv ty)</span><span>
</span><a name="line-1426"></a><span class="hs-comment">-- We are about to update the TauTv tv with ty.</span><span>
</span><a name="line-1427"></a><span class="hs-comment">-- Check (a) that tv doesn't occur in ty (occurs check)</span><span>
</span><a name="line-1428"></a><span class="hs-comment">--       (b) that kind(ty) matches kind(tv)</span><span>
</span><a name="line-1429"></a><span class="hs-comment">--</span><span>
</span><a name="line-1430"></a><span class="hs-comment">-- We have two possible outcomes:</span><span>
</span><a name="line-1431"></a><span class="hs-comment">-- (1) Return the type to update the type variable with,</span><span>
</span><a name="line-1432"></a><span class="hs-comment">--        [we know the update is ok]</span><span>
</span><a name="line-1433"></a><span class="hs-comment">-- (2) Return Nothing,</span><span>
</span><a name="line-1434"></a><span class="hs-comment">--        [the update might be dodgy]</span><span>
</span><a name="line-1435"></a><span class="hs-comment">--</span><span>
</span><a name="line-1436"></a><span class="hs-comment">-- Note that &quot;Nothing&quot; does not mean &quot;definite error&quot;.  For example</span><span>
</span><a name="line-1437"></a><span class="hs-comment">--   type family F a</span><span>
</span><a name="line-1438"></a><span class="hs-comment">--   type instance F Int = Int</span><span>
</span><a name="line-1439"></a><span class="hs-comment">-- consider</span><span>
</span><a name="line-1440"></a><span class="hs-comment">--   a ~ F a</span><span>
</span><a name="line-1441"></a><span class="hs-comment">-- This is perfectly reasonable, if we later get a ~ Int.  For now, though,</span><span>
</span><a name="line-1442"></a><span class="hs-comment">-- we return Nothing, leaving it to the later constraint simplifier to</span><span>
</span><a name="line-1443"></a><span class="hs-comment">-- sort matters out.</span><span>
</span><a name="line-1444"></a><span>
</span><a name="line-1445"></a><a name="checkTauTvUpdate"><a href="TcUnify.html#checkTauTvUpdate"><span class="hs-identifier">checkTauTvUpdate</span></a></a><span> </span><a name="local-1628060922"><a href="#local-1628060922"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-1628060923"><a href="#local-1628060923"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-1628060924"><a href="#local-1628060924"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-1628060925"><a href="#local-1628060925"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-1628060926"><a href="#local-1628060926"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1446"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcType.html#SigTv"><span class="hs-identifier hs-var">SigTv</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060929"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-1447"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isTyVarTy</span><span> </span><span class="hs-identifier hs-var">ty</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1448"></a><span>    </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1449"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1450"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060944"><a href="#local-1628060944"><span class="hs-identifier">ty</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-1628060926"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1451"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-1628060945"><a href="#local-1628060945"><span class="hs-identifier">co_k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060927"><span class="hs-identifier hs-var">kind_origin</span></a><span> </span><a href="TcRnTypes.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-1628060944"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-1628060925"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1452"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628060931"><span class="hs-identifier hs-var">defer_me</span></a><span> </span><a href="#local-1628060944"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-comment">-- Quick test</span><span>
</span><a name="line-1453"></a><span>                </span><span class="hs-comment">-- Failed quick test so try harder</span><span>
</span><a name="line-1454"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="TcType.html#occurCheckExpand"><span class="hs-identifier hs-var">occurCheckExpand</span></a><span> </span><a href="#local-1628060922"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628060925"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-1628060944"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1455"></a><span>                   </span><a href="TcType.html#OC_OK"><span class="hs-identifier hs-var">OC_OK</span></a><span> </span><a name="local-1628060946"><a href="#local-1628060946"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-1628060931"><span class="hs-identifier hs-var">defer_me</span></a><span> </span><a href="#local-1628060946"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1456"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060946"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060945"><span class="hs-identifier hs-var">co_k</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1457"></a><span>                   </span><span class="hs-identifier">_</span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1458"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060944"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060945"><span class="hs-identifier hs-var">co_k</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1459"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1460"></a><span>    </span><a name="local-1628060927"><a href="#local-1628060927"><span class="hs-identifier">kind_origin</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#KindEqOrigin"><span class="hs-identifier hs-var">KindEqOrigin</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-1628060925"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628060926"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-1628060923"><span class="hs-identifier hs-var">origin</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628060924"><span class="hs-identifier hs-var">t_or_k</span></a><span class="hs-special">)</span><span>
</span><a name="line-1461"></a><span>    </span><a name="local-1628060928"><a href="#local-1628060928"><span class="hs-identifier">details</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#tcTyVarDetails"><span class="hs-identifier hs-var">tcTyVarDetails</span></a><span> </span><a href="#local-1628060925"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1462"></a><span>    </span><a name="local-1628060929"><a href="#local-1628060929"><span class="hs-identifier">info</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mtv_info</span><span> </span><a href="#local-1628060928"><span class="hs-identifier hs-var">details</span></a><span>
</span><a name="line-1463"></a><span>    </span><a name="local-1628060930"><a href="#local-1628060930"><span class="hs-identifier">impredicative</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#canUnifyWithPolyType"><span class="hs-identifier hs-var">canUnifyWithPolyType</span></a><span> </span><a href="#local-1628060922"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-1628060928"><span class="hs-identifier hs-var">details</span></a><span>
</span><a name="line-1464"></a><span>
</span><a name="line-1465"></a><span>    </span><span class="hs-identifier">defer_me</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1466"></a><span>    </span><span class="hs-comment">-- Checks for (a) occurrence of tv</span><span>
</span><a name="line-1467"></a><span>    </span><span class="hs-comment">--            (b) type family applications</span><span>
</span><a name="line-1468"></a><span>    </span><span class="hs-comment">--            (c) foralls</span><span>
</span><a name="line-1469"></a><span>    </span><span class="hs-comment">-- See Note [Conservative unification check]</span><span>
</span><a name="line-1470"></a><span>    </span><a name="local-1628060931"><a href="#local-1628060931"><span class="hs-identifier">defer_me</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1471"></a><span>    </span><span class="hs-identifier">defer_me</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628060933"><a href="#local-1628060933"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060925"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-1628060933"><span class="hs-identifier hs-var">tv'</span></a><span>
</span><a name="line-1472"></a><span>    </span><span class="hs-identifier">defer_me</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-1628060934"><a href="#local-1628060934"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-1628060935"><a href="#local-1628060935"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-1628060934"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><a href="#local-1628060931"><span class="hs-identifier hs-var">defer_me</span></a><span> </span><a href="#local-1628060935"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1473"></a><span>                                 </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-1628060930"><span class="hs-identifier hs-var">impredicative</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="TcType.html#isTauTyCon"><span class="hs-identifier hs-var">isTauTyCon</span></a><span> </span><a href="#local-1628060934"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1474"></a><span>    </span><span class="hs-identifier">defer_me</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><a name="local-1628060936"><a href="#local-1628060936"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-1628060937"><a href="#local-1628060937"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060931"><span class="hs-identifier hs-var">defer_me</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#binderType"><span class="hs-identifier hs-var">binderType</span></a><span> </span><a href="#local-1628060936"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1628060931"><span class="hs-identifier hs-var">defer_me</span></a><span> </span><a href="#local-1628060937"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1475"></a><span>                                 </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#isNamedBinder"><span class="hs-identifier hs-var">isNamedBinder</span></a><span> </span><a href="#local-1628060936"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-1628060930"><span class="hs-identifier hs-var">impredicative</span></a><span class="hs-special">)</span><span>
</span><a name="line-1476"></a><span>    </span><span class="hs-identifier">defer_me</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-1628060938"><a href="#local-1628060938"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-1628060939"><a href="#local-1628060939"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060931"><span class="hs-identifier hs-var">defer_me</span></a><span> </span><a href="#local-1628060938"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1628060931"><span class="hs-identifier hs-var">defer_me</span></a><span> </span><a href="#local-1628060939"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1477"></a><span>    </span><span class="hs-identifier">defer_me</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-1628060940"><a href="#local-1628060940"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1628060941"><a href="#local-1628060941"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060931"><span class="hs-identifier hs-var">defer_me</span></a><span> </span><a href="#local-1628060940"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-1628060932"><span class="hs-identifier hs-var">defer_me_co</span></a><span> </span><a href="#local-1628060941"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1478"></a><span>    </span><span class="hs-identifier">defer_me</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-1628060942"><a href="#local-1628060942"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060932"><span class="hs-identifier hs-var">defer_me_co</span></a><span> </span><a href="#local-1628060942"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1479"></a><span>
</span><a name="line-1480"></a><span>      </span><span class="hs-comment">-- We don't really care if there are type families in a coercion,</span><span>
</span><a name="line-1481"></a><span>      </span><span class="hs-comment">-- but we still can't have an occurs-check failure</span><span>
</span><a name="line-1482"></a><span>    </span><a name="local-1628060932"><a href="#local-1628060932"><span class="hs-identifier">defer_me_co</span></a></a><span> </span><a name="local-1628060943"><a href="#local-1628060943"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060925"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a><span> </span><a href="#local-1628060943"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1483"></a><span>
</span><a name="line-1484"></a><span class="hs-comment">{-
Note [Conservative unification check]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When unifying (tv ~ rhs), w try to avoid creating deferred constraints
only for efficiency.  However, we do not unify (the defer_me check) if
  a) There's an occurs check (tv is in fvs(rhs))
  b) There's a type-function call in 'rhs'

If we fail defer_me we use occurCheckExpand to try to make it pass,
(see Note [Type synonyms and the occur check]) and then use defer_me
again to check.  Example: Trac #4917)
       a ~ Const a b
where type Const a b = a.  We can solve this immediately, even when
'a' is a skolem, just by expanding the synonym.

We always defer type-function calls, even if it's be perfectly safe to
unify, eg (a ~ F [b]).  Reason: this ensures that the constraint
solver gets to see, and hence simplify the type-function call, which
in turn might simplify the type of an inferred function.  Test ghci046
is a case in point.

More mysteriously, test T7010 gave a horrible error
  T7010.hs:29:21:
    Couldn't match type `Serial (ValueTuple Float)' with `IO Float'
    Expected type: (ValueTuple Vector, ValueTuple Vector)
      Actual type: (ValueTuple Vector, ValueTuple Vector)
because an insoluble type function constraint got mixed up with
a soluble one when flattening.  I never fully understood this, but
deferring type-function applications made it go away :-(.
T5853 also got a less-good error message with more aggressive
unification of type functions.

Moreover the Note [Type family sharing] gives another reason, but
again I'm not sure if it's really valid.

Note [Type synonyms and the occur check]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Generally speaking we try to update a variable with type synonyms not
expanded, which improves later error messages, unless looking
inside a type synonym may help resolve a spurious occurs check
error. Consider:
          type A a = ()

          f :: (A a -&gt; a -&gt; ()) -&gt; ()
          f = \ _ -&gt; ()

          x :: ()
          x = f (\ x p -&gt; p x)

We will eventually get a constraint of the form t ~ A t. The ok function above will
properly expand the type (A t) to just (), which is ok to be unified with t. If we had
unified with the original type A t, we would lead the type checker into an infinite loop.

Hence, if the occurs check fails for a type synonym application, then (and *only* then),
the ok function expands the synonym to detect opportunities for occurs check success using
the underlying definition of the type synonym.

The same applies later on in the constraint interaction code; see TcInteract,
function @occ_check_ok@.

Note [Type family sharing]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We must avoid eagerly unifying type variables to types that contain function symbols,
because this may lead to loss of sharing, and in turn, in very poor performance of the
constraint simplifier. Assume that we have a wanted constraint:
{
  m1 ~ [F m2],
  m2 ~ [F m3],
  m3 ~ [F m4],
  D m1,
  D m2,
  D m3
}
where D is some type class. If we eagerly unify m1 := [F m2], m2 := [F m3], m3 := [F m4],
then, after zonking, our constraint simplifier will be faced with the following wanted
constraint:
{
  D [F [F [F m4]]],
  D [F [F m4]],
  D [F m4]
}
which has to be flattened by the constraint solver. In the absence of
a flat-cache, this may generate a polynomially larger number of
flatten skolems and the constraint sets we are working with will be
polynomially larger.

Instead, if we defer the unifications m1 := [F m2], etc. we will only
be generating three flatten skolems, which is the maximum possible
sharing arising from the original constraint.  That's why we used to
use a local &quot;ok&quot; function, a variant of TcType.occurCheckExpand.

HOWEVER, we *do* now have a flat-cache, which effectively recovers the
sharing, so there's no great harm in losing it -- and it's generally
more efficient to do the unification up-front.

Note [Non-TcTyVars in TcUnify]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Because the same code is now shared between unifying types and unifying
kinds, we sometimes will see proper TyVars floating around the unifier.
Example (from test case polykinds/PolyKinds12):

    type family Apply (f :: k1 -&gt; k2) (x :: k1) :: k2
    type instance Apply g y = g y

When checking the instance declaration, we first *kind-check* the LHS
and RHS, discovering that the instance really should be

    type instance Apply k3 k4 (g :: k3 -&gt; k4) (y :: k3) = g y

During this kind-checking, all the tyvars will be TcTyVars. Then, however,
as a second pass, we desugar the RHS (which is done in functions prefixed
with &quot;tc&quot; in TcTyClsDecls&quot;). By this time, all the kind-vars are proper
TyVars, not TcTyVars, get some kind unification must happen.

Thus, we always check if a TyVar is a TcTyVar before asking if it's a
meta-tyvar.

This used to not be necessary for type-checking (that is, before * :: *)
because expressions get desugared via an algorithm separate from
type-checking (with wrappers, etc.). Types get desugared very differently,
causing this wibble in behavior seen here.
-}</span><span>
</span><a name="line-1606"></a><span>
</span><a name="line-1607"></a><span class="hs-keyword">data</span><span> </span><a name="LookupTyVarResult"><a href="TcUnify.html#LookupTyVarResult"><span class="hs-identifier">LookupTyVarResult</span></a></a><span>  </span><span class="hs-comment">-- The result of a lookupTcTyVar call</span><span>
</span><a name="line-1608"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Unfilled"><a href="TcUnify.html#Unfilled"><span class="hs-identifier">Unfilled</span></a></a><span> </span><a href="TcType.html#TcTyVarDetails"><span class="hs-identifier hs-type">TcTyVarDetails</span></a><span>     </span><span class="hs-comment">-- SkolemTv or virgin MetaTv</span><span>
</span><a name="line-1609"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Filled"><a href="TcUnify.html#Filled"><span class="hs-identifier">Filled</span></a></a><span>   </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>
</span><a name="line-1610"></a><span>
</span><a name="line-1611"></a><span class="hs-identifier">lookupTcTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcUnify.html#LookupTyVarResult"><span class="hs-identifier hs-type">LookupTyVarResult</span></a><span>
</span><a name="line-1612"></a><a name="lookupTcTyVar"><a href="TcUnify.html#lookupTcTyVar"><span class="hs-identifier">lookupTcTyVar</span></a></a><span> </span><a name="local-1628060947"><a href="#local-1628060947"><span class="hs-identifier">tyvar</span></a></a><span>
</span><a name="line-1613"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcType.html#MetaTv"><span class="hs-identifier hs-var">MetaTv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mtv_ref</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1628060949"><a href="#local-1628060949"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1628060948"><span class="hs-identifier hs-var">details</span></a><span>
</span><a name="line-1614"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060950"><a href="#local-1628060950"><span class="hs-identifier">meta_details</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IOEnv.html#readMutVar"><span class="hs-identifier hs-var">readMutVar</span></a><span> </span><a href="#local-1628060949"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-1615"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060950"><span class="hs-identifier hs-var">meta_details</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1616"></a><span>           </span><a href="TcType.html#Indirect"><span class="hs-identifier hs-var">Indirect</span></a><span> </span><a name="local-1628060951"><a href="#local-1628060951"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcUnify.html#Filled"><span class="hs-identifier hs-var">Filled</span></a><span> </span><a href="#local-1628060951"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1617"></a><span>           </span><a href="TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060952"><a href="#local-1628060952"><span class="hs-identifier">is_touchable</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#isTouchableTcM"><span class="hs-identifier hs-var">isTouchableTcM</span></a><span> </span><a href="#local-1628060947"><span class="hs-identifier hs-var">tyvar</span></a><span>
</span><a name="line-1618"></a><span>                             </span><span class="hs-comment">-- Note [Unifying untouchables]</span><span>
</span><a name="line-1619"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1628060952"><span class="hs-identifier hs-var">is_touchable</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-1620"></a><span>                            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcUnify.html#Unfilled"><span class="hs-identifier hs-var">Unfilled</span></a><span> </span><a href="#local-1628060948"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">)</span><span>
</span><a name="line-1621"></a><span>                         </span><span class="hs-keyword">else</span><span>
</span><a name="line-1622"></a><span>                            </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcUnify.html#Unfilled"><span class="hs-identifier hs-var">Unfilled</span></a><span> </span><a href="TcType.html#vanillaSkolemTv"><span class="hs-identifier hs-var">vanillaSkolemTv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1623"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-1624"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcUnify.html#Unfilled"><span class="hs-identifier hs-var">Unfilled</span></a><span> </span><a href="#local-1628060948"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">)</span><span>
</span><a name="line-1625"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1626"></a><span>    </span><a name="local-1628060948"><a href="#local-1628060948"><span class="hs-identifier">details</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#tcTyVarDetails"><span class="hs-identifier hs-var">tcTyVarDetails</span></a><span> </span><a href="#local-1628060947"><span class="hs-identifier hs-var">tyvar</span></a><span>
</span><a name="line-1627"></a><span>
</span><a name="line-1628"></a><span class="hs-comment">-- | Fill in a meta-tyvar</span><span>
</span><a name="line-1629"></a><span class="hs-identifier">updateMeta</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span>            </span><span class="hs-comment">-- ^ tv to fill in, tv :: k1</span><span>
</span><a name="line-1630"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcRef"><span class="hs-identifier hs-type">TcRef</span></a><span> </span><a href="TcType.html#MetaDetails"><span class="hs-identifier hs-type">MetaDetails</span></a><span>  </span><span class="hs-comment">-- ^ ref to tv's metadetails</span><span>
</span><a name="line-1631"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>             </span><span class="hs-comment">-- ^ ty2 :: k2</span><span>
</span><a name="line-1632"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>           </span><span class="hs-comment">-- ^ kind_co :: k2 ~N k1</span><span>
</span><a name="line-1633"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>       </span><span class="hs-comment">-- ^ :: tv ~N ty2 (= ty2 |&gt; kind_co ~N ty2)</span><span>
</span><a name="line-1634"></a><a name="updateMeta"><a href="TcUnify.html#updateMeta"><span class="hs-identifier">updateMeta</span></a></a><span> </span><a name="local-1628060953"><a href="#local-1628060953"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-1628060954"><a href="#local-1628060954"><span class="hs-identifier">ref1</span></a></a><span> </span><a name="local-1628060955"><a href="#local-1628060955"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-1628060956"><a href="#local-1628060956"><span class="hs-identifier">kind_co</span></a></a><span>
</span><a name="line-1635"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628060957"><a href="#local-1628060957"><span class="hs-identifier">ty2_refl</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="#local-1628060955"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1636"></a><span>             </span><span class="hs-special">(</span><a name="local-1628060958"><a href="#local-1628060958"><span class="hs-identifier">ty2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628060959"><a href="#local-1628060959"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-1628060955"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span class="hs-special">`</span><span> </span><a href="#local-1628060956"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-1637"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkCoherenceLeftCo"><span class="hs-identifier hs-var">mkCoherenceLeftCo</span></a><span> </span><a href="#local-1628060957"><span class="hs-identifier hs-var">ty2_refl</span></a><span> </span><a href="#local-1628060956"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1638"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#writeMetaTyVarRef"><span class="hs-identifier hs-var">writeMetaTyVarRef</span></a><span> </span><a href="#local-1628060953"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-1628060954"><span class="hs-identifier hs-var">ref1</span></a><span> </span><a href="#local-1628060958"><span class="hs-identifier hs-var">ty2'</span></a><span>
</span><a name="line-1639"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-1628060959"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1640"></a><span>
</span><a name="line-1641"></a><span class="hs-comment">{-
Note [Unifying untouchables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We treat an untouchable type variable as if it was a skolem.  That
ensures it won't unify with anything.  It's a slight had, because
we return a made-up TcTyVarDetails, but I think it works smoothly.
-}</span><span>
</span><a name="line-1648"></a><span>
</span><a name="line-1649"></a><span class="hs-comment">-- | Breaks apart a function kind into its pieces.</span><span>
</span><a name="line-1650"></a><span class="hs-identifier">matchExpectedFunKind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span>           </span><span class="hs-comment">-- ^ # of args remaining, only for errors</span><span>
</span><a name="line-1651"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span>          </span><span class="hs-comment">-- ^ type, only for errors</span><span>
</span><a name="line-1652"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span>          </span><span class="hs-comment">-- ^ function kind</span><span>
</span><a name="line-1653"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1654"></a><span>                                  </span><span class="hs-comment">-- ^ co :: old_kind ~ arg -&gt; res</span><span>
</span><a name="line-1655"></a><a name="matchExpectedFunKind"><a href="TcUnify.html#matchExpectedFunKind"><span class="hs-identifier">matchExpectedFunKind</span></a></a><span> </span><a name="local-1628060960"><a href="#local-1628060960"><span class="hs-identifier">num_args_remaining</span></a></a><span> </span><a name="local-1628060961"><a href="#local-1628060961"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060962"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-1656"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1657"></a><span>    </span><a name="local-1628060962"><a href="#local-1628060962"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-1628060964"><a href="#local-1628060964"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1628060965"><a href="#local-1628060965"><span class="hs-identifier">k'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-1628060964"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060962"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060965"><span class="hs-identifier hs-var">k'</span></a><span>
</span><a name="line-1658"></a><span>
</span><a name="line-1659"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060966"><a href="#local-1628060966"><span class="hs-identifier">k</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-1628060967"><a href="#local-1628060967"><span class="hs-identifier">kvar</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1660"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTcTyVar"><span class="hs-identifier hs-var">isTcTyVar</span></a><span> </span><a href="#local-1628060967"><span class="hs-identifier hs-var">kvar</span></a><span class="hs-special">,</span><span> </span><a href="TcType.html#isMetaTyVar"><span class="hs-identifier hs-var">isMetaTyVar</span></a><span> </span><a href="#local-1628060967"><span class="hs-identifier hs-var">kvar</span></a><span>
</span><a name="line-1661"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060968"><a href="#local-1628060968"><span class="hs-identifier">maybe_kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a><span> </span><a href="#local-1628060967"><span class="hs-identifier hs-var">kvar</span></a><span>
</span><a name="line-1662"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628060968"><span class="hs-identifier hs-var">maybe_kind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1663"></a><span>                </span><a href="TcType.html#Indirect"><span class="hs-identifier hs-var">Indirect</span></a><span> </span><a name="local-1628060969"><a href="#local-1628060969"><span class="hs-identifier">fun_kind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628060962"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-1628060969"><span class="hs-identifier hs-var">fun_kind</span></a><span>
</span><a name="line-1664"></a><span>                </span><a href="TcType.html#Flexi"><span class="hs-identifier hs-var">Flexi</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>             </span><a href="#local-1628060963"><span class="hs-identifier hs-var">defer</span></a><span> </span><a href="#local-1628060966"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1665"></a><span>
</span><a name="line-1666"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060970"><a href="#local-1628060970"><span class="hs-identifier">k</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Anon"><span class="hs-identifier hs-var">Anon</span></a><span> </span><a name="local-1628060971"><a href="#local-1628060971"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1628060972"><a href="#local-1628060972"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1667"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="#local-1628060970"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060971"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060972"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-1668"></a><span>
</span><a name="line-1669"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-1628060973"><a href="#local-1628060973"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060963"><span class="hs-identifier hs-var">defer</span></a><span> </span><a href="#local-1628060973"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-1670"></a><span>
</span><a name="line-1671"></a><span>    </span><a name="local-1628060963"><a href="#local-1628060963"><span class="hs-identifier">defer</span></a></a><span> </span><a name="local-1628060974"><a href="#local-1628060974"><span class="hs-identifier">k</span></a></a><span>
</span><a name="line-1672"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-1628060975"><a href="#local-1628060975"><span class="hs-identifier">arg_kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-1673"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060976"><a href="#local-1628060976"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-1674"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1628060977"><a href="#local-1628060977"><span class="hs-identifier">new_fun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkFunTy"><span class="hs-identifier hs-var">mkFunTy</span></a><span> </span><a href="#local-1628060975"><span class="hs-identifier hs-var">arg_kind</span></a><span> </span><a href="#local-1628060976"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1675"></a><span>                 </span><a name="local-1628060978"><a href="#local-1628060978"><span class="hs-identifier">thing</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcMType.html#mkTypeErrorThingArgs"><span class="hs-identifier hs-var">mkTypeErrorThingArgs</span></a><span> </span><a href="#local-1628060961"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-1628060960"><span class="hs-identifier hs-var">num_args_remaining</span></a><span>
</span><a name="line-1676"></a><span>                 </span><a name="local-1628060979"><a href="#local-1628060979"><span class="hs-identifier">origin</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#TypeEqOrigin"><span class="hs-identifier hs-var">TypeEqOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628060974"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-1677"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#mkCheckExpType"><span class="hs-identifier hs-var">mkCheckExpType</span></a><span> </span><a href="#local-1628060977"><span class="hs-identifier hs-var">new_fun</span></a><span>
</span><a name="line-1678"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_thing</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1628060978"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-1679"></a><span>                                        </span><span class="hs-special">}</span><span>
</span><a name="line-1680"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-1628060980"><a href="#local-1628060980"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><a href="#local-1628060979"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="TcRnTypes.html#KindLevel"><span class="hs-identifier hs-var">KindLevel</span></a><span> </span><a href="#local-1628060974"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-1628060977"><span class="hs-identifier hs-var">new_fun</span></a><span>
</span><a name="line-1681"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-1628060980"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060975"><span class="hs-identifier hs-var">arg_kind</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628060976"><span class="hs-identifier hs-var">res_kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1682"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1683"></a></pre></body></html>