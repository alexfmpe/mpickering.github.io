<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The AQUA Project, Glasgow University, 1993-1998

\section{Common subexpression}
-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CSE</span><span> </span><span class="hs-special">(</span><a href="CSE.html#cseProgram"><span class="hs-identifier hs-var">cseProgram</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSubst.html"><span class="hs-identifier">CoreSubst</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>              </span><span class="hs-special">(</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>               </span><span class="hs-special">(</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span class="hs-special">,</span><span> </span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span class="hs-special">,</span><span> </span><a href="Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a><span class="hs-special">,</span><span> </span><a href="Id.html#zapIdUsageInfo"><span class="hs-identifier hs-var">zapIdUsageInfo</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUtils.html"><span class="hs-identifier">CoreUtils</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="CoreUtils.html#mkAltExpr"><span class="hs-identifier hs-var">mkAltExpr</span></a><span>
</span><a name="line-17"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span>
</span><a name="line-18"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#stripTicksE"><span class="hs-identifier hs-var">stripTicksE</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#stripTicksT"><span class="hs-identifier hs-var">stripTicksT</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#stripTicksTopE"><span class="hs-identifier hs-var">stripTicksTopE</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>             </span><span class="hs-special">(</span><span> </span><a href="Type.html#tyConAppArgs"><span class="hs-identifier hs-var">tyConAppArgs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="BasicTypes.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="TrieMap.html"><span class="hs-identifier">TrieMap</span></a><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-comment">{-
                        Simple common sub-expression
                        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we see
        x1 = C a b
        x2 = C x1 b
we build up a reverse mapping:   C a b  -&gt; x1
                                 C x1 b -&gt; x2
and apply that to the rest of the program.

When we then see
        y1 = C a b
        y2 = C y1 b
we replace the C a b with x1.  But then we *dont* want to
add   x1 -&gt; y1  to the mapping.  Rather, we want the reverse, y1 -&gt; x1
so that a subsequent binding
        y2 = C y1 b
will get transformed to C x1 b, and then to x2.

So we carry an extra var-&gt;var substitution which we apply *before* looking up in the
reverse mapping.


Note [Shadowing]
~~~~~~~~~~~~~~~~
We have to be careful about shadowing.
For example, consider
        f = \x -&gt; let y = x+x in
                      h = \x -&gt; x+x
                  in ...

Here we must *not* do CSE on the inner x+x!  The simplifier used to guarantee no
shadowing, but it doesn't any more (it proved too hard), so we clone as we go.
We can simply add clones to the substitution already described.

Note [Case binders 1]
~~~~~~~~~~~~~~~~~~~~~~
Consider

        f = \x -&gt; case x of wild {
                        (a:as) -&gt; case a of wild1 {
                                    (p,q) -&gt; ...(wild1:as)...

Here, (wild1:as) is morally the same as (a:as) and hence equal to wild.
But that's not quite obvious.  In general we want to keep it as (wild1:as),
but for CSE purpose that's a bad idea.

So we add the binding (wild1 -&gt; a) to the extra var-&gt;var mapping.
Notice this is exactly backwards to what the simplifier does, which is
to try to replaces uses of 'a' with uses of 'wild1'

Note [Case binders 2]
~~~~~~~~~~~~~~~~~~~~~~
Consider
        case (h x) of y -&gt; ...(h x)...

We'd like to replace (h x) in the alternative, by y.  But because of
the preceding [Note: case binders 1], we only want to add the mapping
        scrutinee -&gt; case binder
to the reverse CSE mapping if the scrutinee is a non-trivial expression.
(If the scrutinee is a simple variable we want to add the mapping
        case binder -&gt; scrutinee
to the substitution

Note [CSE for INLINE and NOINLINE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There are some subtle interactions of CSE with functions that the user
has marked as INLINE or NOINLINE. (Examples from Roman Leshchinskiy.)
Consider

        yes :: Int  {-# NOINLINE yes #-}
        yes = undefined

        no :: Int   {-# NOINLINE no #-}
        no = undefined

        foo :: Int -&gt; Int -&gt; Int  {-# NOINLINE foo #-}
        foo m n = n

        {-# RULES &quot;foo/no&quot; foo no = id #-}

        bar :: Int -&gt; Int
        bar = foo yes

We do not expect the rule to fire.  But if we do CSE, then we risk
getting yes=no, and the rule does fire.  Actually, it won't because
NOINLINE means that 'yes' will never be inlined, not even if we have
yes=no.  So that's fine (now; perhaps in the olden days, yes=no would
have substituted even if 'yes' was NOINLINE).

But we do need to take care.  Consider

        {-# NOINLINE bar #-}
        bar = &lt;rhs&gt;     -- Same rhs as foo

        foo = &lt;rhs&gt;

If CSE produces
        foo = bar
then foo will never be inlined to &lt;rhs&gt; (when it should be, if &lt;rhs&gt;
is small).  The conclusion here is this:

   We should not add
       &lt;rhs&gt; :-&gt; bar
  to the CSEnv if 'bar' has any constraints on when it can inline;
  that is, if its 'activation' not always active.  Otherwise we
  might replace &lt;rhs&gt; by 'bar', and then later be unable to see that it
  really was &lt;rhs&gt;.

Note that we do not (currently) do CSE on the unfolding stored inside
an Id, even if is a 'stable' unfolding.  That means that when an
unfolding happens, it is always faithful to what the stable unfolding
originally was.


Note [CSE for case expressions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  case f x of y { pat -&gt; ...let y = f x in ... }
Then we can CSE the inner (f x) to y.  In fact 'case' is like a strict
let-binding, and we can use cseRhs for dealing with the scrutinee.

************************************************************************
*                                                                      *
\section{Common subexpression}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">cseProgram</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span>
</span><a name="line-157"></a><a name="cseProgram"><a href="CSE.html#cseProgram"><span class="hs-identifier">cseProgram</span></a></a><span> </span><a name="local-1627839737"><a href="#local-1627839737"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="CSE.html#cseBind"><span class="hs-identifier hs-var">cseBind</span></a><span> </span><a href="CSE.html#emptyCSEnv"><span class="hs-identifier hs-var">emptyCSEnv</span></a><span> </span><a href="#local-1627839737"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">cseBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><a name="cseBind"><a href="CSE.html#cseBind"><span class="hs-identifier">cseBind</span></a></a><span> </span><a name="local-1627839738"><a href="#local-1627839738"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-1627839739"><a href="#local-1627839739"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627839740"><a href="#local-1627839740"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627839743"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-1627839744"><span class="hs-identifier hs-var">b''</span></a><span> </span><a href="#local-1627839745"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-special">(</span><a name="local-1627839741"><a href="#local-1627839741"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839742"><a href="#local-1627839742"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#addBinder"><span class="hs-identifier hs-var">addBinder</span></a><span> </span><a href="#local-1627839738"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839739"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-164"></a><span>    </span><span class="hs-special">(</span><a name="local-1627839743"><a href="#local-1627839743"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-1627839744"><a href="#local-1627839744"><span class="hs-identifier">b''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839745"><a href="#local-1627839745"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#cseRhs"><span class="hs-identifier hs-var">cseRhs</span></a><span> </span><a href="#local-1627839741"><span class="hs-identifier hs-var">env1</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627839742"><span class="hs-identifier hs-var">b'</span></a><span class="hs-special">,</span><a href="#local-1627839740"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-identifier">cseBind</span><span> </span><a name="local-1627839746"><a href="#local-1627839746"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-1627839747"><a href="#local-1627839747"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627839752"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a href="#local-1627839753"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-169"></a><span>    </span><span class="hs-special">(</span><a name="local-1627839748"><a href="#local-1627839748"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><a name="local-1627839749"><a href="#local-1627839749"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-1627839747"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-170"></a><span>    </span><span class="hs-special">(</span><a name="local-1627839750"><a href="#local-1627839750"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839751"><a href="#local-1627839751"><span class="hs-identifier">bs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#addRecBinders"><span class="hs-identifier hs-var">addRecBinders</span></a><span> </span><a href="#local-1627839746"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839748"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-171"></a><span>    </span><span class="hs-special">(</span><a name="local-1627839752"><a href="#local-1627839752"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839753"><a href="#local-1627839753"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="CSE.html#cseRhs"><span class="hs-identifier hs-var">cseRhs</span></a><span> </span><a href="#local-1627839750"><span class="hs-identifier hs-var">env1</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627839751"><span class="hs-identifier hs-var">bs'</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span class="hs-special">`</span><span> </span><a href="#local-1627839749"><span class="hs-identifier hs-var">es</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-identifier">cseRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CSE.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a><span class="hs-special">,</span><span> </span><a href="CSE.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="CSE.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a><span class="hs-special">,</span><span> </span><a href="CSE.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-174"></a><a name="cseRhs"><a href="CSE.html#cseRhs"><span class="hs-identifier">cseRhs</span></a></a><span> </span><a name="local-1627839754"><a href="#local-1627839754"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627839755"><a href="#local-1627839755"><span class="hs-identifier">id'</span></a></a><span class="hs-special">,</span><a name="local-1627839756"><a href="#local-1627839756"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CSE.html#lookupCSEnv"><span class="hs-identifier hs-var">lookupCSEnv</span></a><span> </span><a href="#local-1627839754"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839760"><span class="hs-identifier hs-var">rhs''</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-176"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-177"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627839761"><span class="hs-identifier hs-var">always_active</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CSE.html#extendCSEnv"><span class="hs-identifier hs-var">extendCSEnv</span></a><span> </span><a href="#local-1627839754"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839758"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-1627839755"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-1627839757"><span class="hs-identifier hs-var">zapped_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627839758"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627839754"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span>                      </span><span class="hs-special">(</span><a href="#local-1627839755"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627839758"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>        </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627839762"><a href="#local-1627839762"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-180"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-1627839761"><span class="hs-identifier hs-var">always_active</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CSE.html#extendCSSubst"><span class="hs-identifier hs-var">extendCSSubst</span></a><span> </span><a href="#local-1627839754"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839755"><span class="hs-identifier hs-var">id'</span></a><span> </span><a href="#local-1627839762"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-1627839755"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span> </span><a href="#local-1627839759"><span class="hs-identifier hs-var">ticks</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a><span> </span><a href="#local-1627839762"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627839754"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span>                      </span><span class="hs-special">(</span><a href="#local-1627839755"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span> </span><a href="#local-1627839759"><span class="hs-identifier hs-var">ticks</span></a><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CoreSyn.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a><span> </span><a href="#local-1627839762"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span>          </span><span class="hs-comment">-- In the Just case, we have</span><span>
</span><a name="line-183"></a><span>          </span><span class="hs-comment">--        x = rhs</span><span>
</span><a name="line-184"></a><span>          </span><span class="hs-comment">--        ...</span><span>
</span><a name="line-185"></a><span>          </span><span class="hs-comment">--        x' = rhs</span><span>
</span><a name="line-186"></a><span>          </span><span class="hs-comment">-- We are replacing the second binding with x'=x</span><span>
</span><a name="line-187"></a><span>          </span><span class="hs-comment">-- and so must record that in the substitution so</span><span>
</span><a name="line-188"></a><span>          </span><span class="hs-comment">-- that subsequent uses of x' are replaced with x,</span><span>
</span><a name="line-189"></a><span>          </span><span class="hs-comment">-- See Trac #5996</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-191"></a><span>    </span><a name="local-1627839757"><a href="#local-1627839757"><span class="hs-identifier">zapped_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#zapIdUsageInfo"><span class="hs-identifier hs-var">zapIdUsageInfo</span></a><span> </span><a href="#local-1627839755"><span class="hs-identifier hs-var">id'</span></a><span>
</span><a name="line-192"></a><span>       </span><span class="hs-comment">-- Putting the Id into the environment makes it possible that</span><span>
</span><a name="line-193"></a><span>       </span><span class="hs-comment">-- it'll become shared more than it is now, which would</span><span>
</span><a name="line-194"></a><span>       </span><span class="hs-comment">-- invalidate (the usage part of) its demand info.  This caused</span><span>
</span><a name="line-195"></a><span>       </span><span class="hs-comment">-- Trac #100218.</span><span>
</span><a name="line-196"></a><span>       </span><span class="hs-comment">-- Easiest thing is to zap the usage info; subsequently</span><span>
</span><a name="line-197"></a><span>       </span><span class="hs-comment">-- performing late demand-analysis will restore it.  Don't zap</span><span>
</span><a name="line-198"></a><span>       </span><span class="hs-comment">-- the strictness info; it's not necessary to do so, and losing</span><span>
</span><a name="line-199"></a><span>       </span><span class="hs-comment">-- it is bad for performance if you don't do late demand</span><span>
</span><a name="line-200"></a><span>       </span><span class="hs-comment">-- analysis</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>    </span><a name="local-1627839758"><a href="#local-1627839758"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a><span> </span><a href="#local-1627839754"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839756"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span>    </span><a name="local-1627839759"><a href="#local-1627839759"><span class="hs-identifier">ticks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#stripTicksT"><span class="hs-identifier hs-var">stripTicksT</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627839758"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-205"></a><span>    </span><a name="local-1627839760"><a href="#local-1627839760"><span class="hs-identifier">rhs''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#stripTicksE"><span class="hs-identifier hs-var">stripTicksE</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627839758"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-206"></a><span>    </span><span class="hs-comment">-- We don't want to lose the source notes when a common sub</span><span>
</span><a name="line-207"></a><span>    </span><span class="hs-comment">-- expression gets eliminated. Hence we push all (!) of them on</span><span>
</span><a name="line-208"></a><span>    </span><span class="hs-comment">-- top of the replaced sub-expression. This is probably not too</span><span>
</span><a name="line-209"></a><span>    </span><span class="hs-comment">-- useful in practice, but upholds our semantics.</span><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span>    </span><a name="local-1627839761"><a href="#local-1627839761"><span class="hs-identifier">always_active</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span> </span><a href="#local-1627839755"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>         </span><span class="hs-comment">-- See Note [CSE for INLINE and NOINLINE]</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-identifier">tryForCSE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-215"></a><a name="tryForCSE"><a href="CSE.html#tryForCSE"><span class="hs-identifier">tryForCSE</span></a></a><span> </span><a name="local-1627839763"><a href="#local-1627839763"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627839764"><a href="#local-1627839764"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-216"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-1627839765"><span class="hs-identifier hs-var">expr'</span></a><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627839765"><span class="hs-identifier hs-var">expr'</span></a><span>       </span><span class="hs-comment">-- No point</span><span>
</span><a name="line-217"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-1627839768"><a href="#local-1627839768"><span class="hs-identifier">smaller</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CSE.html#lookupCSEnv"><span class="hs-identifier hs-var">lookupCSEnv</span></a><span> </span><a href="#local-1627839763"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839766"><span class="hs-identifier hs-var">expr''</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-1627839768"><span class="hs-identifier hs-var">smaller</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627839767"><span class="hs-identifier hs-var">ticks</span></a><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                              </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627839765"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-219"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-220"></a><span>    </span><a name="local-1627839765"><a href="#local-1627839765"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a><span> </span><a href="#local-1627839763"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839764"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-221"></a><span>    </span><a name="local-1627839766"><a href="#local-1627839766"><span class="hs-identifier">expr''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#stripTicksE"><span class="hs-identifier hs-var">stripTicksE</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627839765"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-222"></a><span>    </span><a name="local-1627839767"><a href="#local-1627839767"><span class="hs-identifier">ticks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#stripTicksT"><span class="hs-identifier hs-var">stripTicksT</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627839765"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-identifier">cseExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-225"></a><a name="cseExpr"><a href="CSE.html#cseExpr"><span class="hs-identifier">cseExpr</span></a></a><span> </span><a name="local-1627839769"><a href="#local-1627839769"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-1627839770"><a href="#local-1627839770"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><span class="hs-special">(</span><a href="CSE.html#csEnvSubst"><span class="hs-identifier hs-var">csEnvSubst</span></a><span> </span><a href="#local-1627839769"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627839770"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span class="hs-identifier">cseExpr</span><span> </span><a name="local-1627839771"><a href="#local-1627839771"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-1627839772"><a href="#local-1627839772"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span> </span><span class="hs-special">(</span><a href="CSE.html#csEnvSubst"><span class="hs-identifier hs-var">csEnvSubst</span></a><span> </span><a href="#local-1627839771"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627839772"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span class="hs-identifier">cseExpr</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-1627839773"><a href="#local-1627839773"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-1627839773"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-228"></a><span class="hs-identifier">cseExpr</span><span> </span><a name="local-1627839774"><a href="#local-1627839774"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627839775"><a href="#local-1627839775"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#lookupSubst"><span class="hs-identifier hs-var">lookupSubst</span></a><span> </span><a href="#local-1627839774"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839775"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-229"></a><span class="hs-identifier">cseExpr</span><span> </span><a name="local-1627839776"><a href="#local-1627839776"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-1627839777"><a href="#local-1627839777"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627839778"><a href="#local-1627839778"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a><span> </span><a href="#local-1627839776"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839777"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CSE.html#tryForCSE"><span class="hs-identifier hs-var">tryForCSE</span></a><span> </span><a href="#local-1627839776"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839778"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span class="hs-identifier">cseExpr</span><span> </span><a name="local-1627839779"><a href="#local-1627839779"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-1627839780"><a href="#local-1627839780"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-1627839781"><a href="#local-1627839781"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-1627839780"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">(</span><a href="CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a><span> </span><a href="#local-1627839779"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839781"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-231"></a><span class="hs-identifier">cseExpr</span><span> </span><a name="local-1627839782"><a href="#local-1627839782"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-1627839783"><a href="#local-1627839783"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-1627839784"><a href="#local-1627839784"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a><span> </span><a href="#local-1627839782"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839783"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span> </span><span class="hs-special">(</span><a href="CSE.html#csEnvSubst"><span class="hs-identifier hs-var">csEnvSubst</span></a><span> </span><a href="#local-1627839782"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627839784"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span class="hs-identifier">cseExpr</span><span> </span><a name="local-1627839785"><a href="#local-1627839785"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-1627839786"><a href="#local-1627839786"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-1627839787"><a href="#local-1627839787"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1627839788"><a href="#local-1627839788"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839789"><a href="#local-1627839789"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#addBinder"><span class="hs-identifier hs-var">addBinder</span></a><span> </span><a href="#local-1627839785"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839786"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-233"></a><span>                                     </span><span class="hs-keyword">in</span><span> </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-1627839789"><span class="hs-identifier hs-var">b'</span></a><span> </span><span class="hs-special">(</span><a href="CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a><span> </span><a href="#local-1627839788"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1627839787"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span class="hs-identifier">cseExpr</span><span> </span><a name="local-1627839790"><a href="#local-1627839790"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-1627839791"><a href="#local-1627839791"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-1627839792"><a href="#local-1627839792"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-1627839793"><a href="#local-1627839793"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839794"><a href="#local-1627839794"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#cseBind"><span class="hs-identifier hs-var">cseBind</span></a><span> </span><a href="#local-1627839790"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839791"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-235"></a><span>                                     </span><span class="hs-keyword">in</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a href="#local-1627839794"><span class="hs-identifier hs-var">bind'</span></a><span> </span><span class="hs-special">(</span><a href="CSE.html#cseExpr"><span class="hs-identifier hs-var">cseExpr</span></a><span> </span><a href="#local-1627839793"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1627839792"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span class="hs-identifier">cseExpr</span><span> </span><a name="local-1627839795"><a href="#local-1627839795"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-1627839796"><a href="#local-1627839796"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-1627839797"><a href="#local-1627839797"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-1627839798"><a href="#local-1627839798"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-1627839799"><a href="#local-1627839799"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a href="#local-1627839806"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-1627839805"><span class="hs-identifier hs-var">bndr'''</span></a><span> </span><a href="#local-1627839798"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-1627839800"><span class="hs-identifier hs-var">alts'</span></a><span>
</span><a name="line-237"></a><span>                          </span><span class="hs-keyword">where</span><span>
</span><a name="line-238"></a><span>                                </span><a name="local-1627839800"><a href="#local-1627839800"><span class="hs-identifier">alts'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#cseAlts"><span class="hs-identifier hs-var">cseAlts</span></a><span> </span><a href="#local-1627839804"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="#local-1627839806"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-1627839797"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-1627839803"><span class="hs-identifier hs-var">bndr''</span></a><span> </span><a href="#local-1627839799"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-239"></a><span>                                </span><span class="hs-special">(</span><a name="local-1627839801"><a href="#local-1627839801"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839802"><a href="#local-1627839802"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#addBinder"><span class="hs-identifier hs-var">addBinder</span></a><span> </span><a href="#local-1627839795"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839797"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-240"></a><span>                                </span><a name="local-1627839803"><a href="#local-1627839803"><span class="hs-identifier">bndr''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a><span> </span><a href="#local-1627839802"><span class="hs-identifier hs-var">bndr'</span></a><span>
</span><a name="line-241"></a><span>                                </span><span class="hs-comment">-- The swizzling from Note [Case binders 2] may</span><span>
</span><a name="line-242"></a><span>                                </span><span class="hs-comment">-- cause a dead case binder to be alive, so we</span><span>
</span><a name="line-243"></a><span>                                </span><span class="hs-comment">-- play safe here and bring them all to life</span><span>
</span><a name="line-244"></a><span>                                </span><span class="hs-special">(</span><a name="local-1627839804"><a href="#local-1627839804"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-1627839805"><a href="#local-1627839805"><span class="hs-identifier">bndr'''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839806"><a href="#local-1627839806"><span class="hs-identifier">scrut'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#cseRhs"><span class="hs-identifier hs-var">cseRhs</span></a><span> </span><a href="#local-1627839801"><span class="hs-identifier hs-var">env1</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627839803"><span class="hs-identifier hs-var">bndr''</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627839796"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>                                </span><span class="hs-comment">-- Note [CSE for case expressions]</span><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span class="hs-identifier">cseAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CSE.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CSE.html#OutAlt"><span class="hs-identifier hs-type">OutAlt</span></a><span class="hs-special">]</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><a name="cseAlts"><a href="CSE.html#cseAlts"><span class="hs-identifier">cseAlts</span></a></a><span> </span><a name="local-1627839807"><a href="#local-1627839807"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-1627839808"><a href="#local-1627839808"><span class="hs-identifier">scrut'</span></a></a><span> </span><a name="local-1627839809"><a href="#local-1627839809"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-1627839810"><a href="#local-1627839810"><span class="hs-identifier">bndr'</span></a></a><span> </span><a name="local-1627839811"><a href="#local-1627839811"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-250"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-1627839816"><span class="hs-identifier hs-var">cse_alt</span></a><span> </span><a href="#local-1627839811"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-251"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-252"></a><span>    </span><a name="local-1627839812"><a href="#local-1627839812"><span class="hs-identifier">scrut''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#stripTicksTopE"><span class="hs-identifier hs-var">stripTicksTopE</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627839808"><span class="hs-identifier hs-var">scrut'</span></a><span>
</span><a name="line-253"></a><span>    </span><span class="hs-special">(</span><a name="local-1627839813"><a href="#local-1627839813"><span class="hs-identifier">con_target</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839814"><a href="#local-1627839814"><span class="hs-identifier">alt_env</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627839812"><span class="hs-identifier hs-var">scrut''</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-255"></a><span>            </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-1627839817"><a href="#local-1627839817"><span class="hs-identifier">v'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627839817"><span class="hs-identifier hs-var">v'</span></a><span class="hs-special">,</span><span>     </span><a href="CSE.html#extendCSSubst"><span class="hs-identifier hs-var">extendCSSubst</span></a><span> </span><a href="#local-1627839807"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839809"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-1627839817"><span class="hs-identifier hs-var">v'</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- See Note [Case binders 1]</span><span>
</span><a name="line-256"></a><span>                                                             </span><span class="hs-comment">-- map: bndr -&gt; v'</span><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span>            </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-special">(</span><a href="#local-1627839810"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">,</span><span> </span><a href="CSE.html#extendCSEnv"><span class="hs-identifier hs-var">extendCSEnv</span></a><span> </span><a href="#local-1627839807"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-1627839808"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-1627839810"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Case binders 2]</span><span>
</span><a name="line-259"></a><span>                                                             </span><span class="hs-comment">-- map: scrut' -&gt; bndr'</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span>    </span><a name="local-1627839815"><a href="#local-1627839815"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#tyConAppArgs"><span class="hs-identifier hs-var">tyConAppArgs</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-1627839809"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span>    </span><a name="local-1627839816"><a href="#local-1627839816"><span class="hs-identifier">cse_alt</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-1627839818"><a href="#local-1627839818"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839819"><a href="#local-1627839819"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839820"><a href="#local-1627839820"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-1627839819"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>                </span><span class="hs-comment">-- Don't try CSE if there are no args; it just increases the number</span><span>
</span><a name="line-266"></a><span>                </span><span class="hs-comment">-- of live vars.  E.g.</span><span>
</span><a name="line-267"></a><span>                </span><span class="hs-comment">--      case x of { True -&gt; ....True.... }</span><span>
</span><a name="line-268"></a><span>                </span><span class="hs-comment">-- Don't replace True by x!</span><span>
</span><a name="line-269"></a><span>                </span><span class="hs-comment">-- Hence the 'null args', which also deal with literals and DEFAULT</span><span>
</span><a name="line-270"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a href="#local-1627839818"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627839822"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="CSE.html#tryForCSE"><span class="hs-identifier hs-var">tryForCSE</span></a><span> </span><a href="#local-1627839823"><span class="hs-identifier hs-var">new_env</span></a><span> </span><a href="#local-1627839820"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-272"></a><span>          </span><span class="hs-special">(</span><a name="local-1627839821"><a href="#local-1627839821"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839822"><a href="#local-1627839822"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#addBinders"><span class="hs-identifier hs-var">addBinders</span></a><span> </span><a href="#local-1627839814"><span class="hs-identifier hs-var">alt_env</span></a><span> </span><a href="#local-1627839819"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-273"></a><span>          </span><a name="local-1627839823"><a href="#local-1627839823"><span class="hs-identifier">new_env</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#extendCSEnv"><span class="hs-identifier hs-var">extendCSEnv</span></a><span> </span><a href="#local-1627839821"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1627839824"><span class="hs-identifier hs-var">con_expr</span></a><span> </span><a href="#local-1627839813"><span class="hs-identifier hs-var">con_target</span></a><span>
</span><a name="line-274"></a><span>          </span><a name="local-1627839824"><a href="#local-1627839824"><span class="hs-identifier">con_expr</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkAltExpr"><span class="hs-identifier hs-var">mkAltExpr</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a href="#local-1627839818"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627839822"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-1627839815"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span>    </span><span class="hs-identifier">cse_alt</span><span> </span><span class="hs-special">(</span><a name="local-1627839825"><a href="#local-1627839825"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839826"><a href="#local-1627839826"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839827"><a href="#local-1627839827"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-277"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627839825"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627839829"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="CSE.html#tryForCSE"><span class="hs-identifier hs-var">tryForCSE</span></a><span> </span><a href="#local-1627839828"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-1627839827"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-278"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-279"></a><span>          </span><span class="hs-special">(</span><a name="local-1627839828"><a href="#local-1627839828"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839829"><a href="#local-1627839829"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#addBinders"><span class="hs-identifier hs-var">addBinders</span></a><span> </span><a href="#local-1627839814"><span class="hs-identifier hs-var">alt_env</span></a><span> </span><a href="#local-1627839826"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\section{The CSE envt}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-keyword">type</span><span> </span><a name="InExpr"><a href="CSE.html#InExpr"><span class="hs-identifier">InExpr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>         </span><span class="hs-comment">-- Pre-cloning</span><span>
</span><a name="line-290"></a><span class="hs-keyword">type</span><span> </span><a name="InBndr"><a href="CSE.html#InBndr"><span class="hs-identifier">InBndr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span>
</span><a name="line-291"></a><span class="hs-keyword">type</span><span> </span><a name="InAlt"><a href="CSE.html#InAlt"><span class="hs-identifier">InAlt</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-keyword">type</span><span> </span><a name="OutExpr"><a href="CSE.html#OutExpr"><span class="hs-identifier">OutExpr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>        </span><span class="hs-comment">-- Post-cloning</span><span>
</span><a name="line-294"></a><span class="hs-keyword">type</span><span> </span><a name="OutBndr"><a href="CSE.html#OutBndr"><span class="hs-identifier">OutBndr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span>
</span><a name="line-295"></a><span class="hs-keyword">type</span><span> </span><a name="OutAlt"><a href="CSE.html#OutAlt"><span class="hs-identifier">OutAlt</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-keyword">data</span><span> </span><a name="CSEnv"><a href="CSE.html#CSEnv"><span class="hs-identifier">CSEnv</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="CS"><a href="CSE.html#CS"><span class="hs-identifier">CS</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a href="CSE.html#cs_map"><span class="hs-identifier">cs_map</span></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="TrieMap.html#CoreMap"><span class="hs-identifier hs-type">CoreMap</span></a><span> </span><span class="hs-special">(</span><a href="CSE.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Key, value</span><span>
</span><a name="line-298"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="CSE.html#cs_subst"><span class="hs-identifier">cs_subst</span></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span class="hs-identifier">emptyCSEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span>
</span><a name="line-301"></a><a name="emptyCSEnv"><a href="CSE.html#emptyCSEnv"><span class="hs-identifier">emptyCSEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CSE.html#CS"><span class="hs-identifier hs-var">CS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cs_map</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TrieMap.html#emptyCoreMap"><span class="hs-identifier hs-var">emptyCoreMap</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cs_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span class="hs-identifier">lookupCSEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-304"></a><a name="lookupCSEnv"><a href="CSE.html#lookupCSEnv"><span class="hs-identifier">lookupCSEnv</span></a></a><span> </span><span class="hs-special">(</span><a href="CSE.html#CS"><span class="hs-identifier hs-var">CS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cs_map</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627839830"><a href="#local-1627839830"><span class="hs-identifier">csmap</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-1627839831"><a href="#local-1627839831"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-305"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TrieMap.html#lookupCoreMap"><span class="hs-identifier hs-var">lookupCoreMap</span></a><span> </span><a href="#local-1627839830"><span class="hs-identifier hs-var">csmap</span></a><span> </span><a href="#local-1627839831"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-306"></a><span>      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-1627839832"><a href="#local-1627839832"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-1627839832"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-307"></a><span>      </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.9.0.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span class="hs-identifier">extendCSEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span>
</span><a name="line-310"></a><a name="extendCSEnv"><a href="CSE.html#extendCSEnv"><span class="hs-identifier">extendCSEnv</span></a></a><span> </span><a name="local-1627839833"><a href="#local-1627839833"><span class="hs-identifier">cse</span></a></a><span> </span><a name="local-1627839834"><a href="#local-1627839834"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-1627839835"><a href="#local-1627839835"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-311"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627839833"><span class="hs-identifier hs-var">cse</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cs_map</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TrieMap.html#extendCoreMap"><span class="hs-identifier hs-var">extendCoreMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cs_map</span><span> </span><a href="#local-1627839833"><span class="hs-identifier hs-var">cse</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627839836"><span class="hs-identifier hs-var">sexpr</span></a><span> </span><span class="hs-special">(</span><a href="#local-1627839836"><span class="hs-identifier hs-var">sexpr</span></a><span class="hs-special">,</span><a href="#local-1627839835"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-312"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-1627839836"><a href="#local-1627839836"><span class="hs-identifier">sexpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#stripTicksE"><span class="hs-identifier hs-var">stripTicksE</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-1627839834"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span class="hs-identifier">csEnvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-315"></a><a name="csEnvSubst"><a href="CSE.html#csEnvSubst"><span class="hs-identifier">csEnvSubst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cs_subst</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span class="hs-identifier">lookupSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-318"></a><a name="lookupSubst"><a href="CSE.html#lookupSubst"><span class="hs-identifier">lookupSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CSE.html#CS"><span class="hs-identifier hs-var">CS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cs_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-1627839837"><a href="#local-1627839837"><span class="hs-identifier">sub</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-1627839838"><a href="#local-1627839838"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;CSE.lookupSubst&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1627839837"><span class="hs-identifier hs-var">sub</span></a><span> </span><a href="#local-1627839838"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span class="hs-identifier">extendCSSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span>
</span><a name="line-321"></a><a name="extendCSSubst"><a href="CSE.html#extendCSSubst"><span class="hs-identifier">extendCSSubst</span></a></a><span> </span><a name="local-1627839839"><a href="#local-1627839839"><span class="hs-identifier">cse</span></a></a><span> </span><a name="local-1627839840"><a href="#local-1627839840"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-1627839841"><a href="#local-1627839841"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627839839"><span class="hs-identifier hs-var">cse</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cs_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cs_subst</span><span> </span><a href="#local-1627839839"><span class="hs-identifier hs-var">cse</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627839840"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-1627839841"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span class="hs-identifier">addBinder</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">)</span><span>
</span><a name="line-324"></a><a name="addBinder"><a href="CSE.html#addBinder"><span class="hs-identifier">addBinder</span></a></a><span> </span><a name="local-1627839842"><a href="#local-1627839842"><span class="hs-identifier">cse</span></a></a><span> </span><a name="local-1627839843"><a href="#local-1627839843"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627839842"><span class="hs-identifier hs-var">cse</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cs_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627839844"><span class="hs-identifier hs-var">sub'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-1627839845"><span class="hs-identifier hs-var">v'</span></a><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>                </span><span class="hs-keyword">where</span><span>
</span><a name="line-326"></a><span>                  </span><span class="hs-special">(</span><a name="local-1627839844"><a href="#local-1627839844"><span class="hs-identifier">sub'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839845"><a href="#local-1627839845"><span class="hs-identifier">v'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cs_subst</span><span> </span><a href="#local-1627839842"><span class="hs-identifier hs-var">cse</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627839843"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-identifier">addBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-329"></a><a name="addBinders"><a href="CSE.html#addBinders"><span class="hs-identifier">addBinders</span></a></a><span> </span><a name="local-1627839846"><a href="#local-1627839846"><span class="hs-identifier">cse</span></a></a><span> </span><a name="local-1627839847"><a href="#local-1627839847"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627839846"><span class="hs-identifier hs-var">cse</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cs_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627839848"><span class="hs-identifier hs-var">sub'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-1627839849"><span class="hs-identifier hs-var">vs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>                </span><span class="hs-keyword">where</span><span>
</span><a name="line-331"></a><span>                  </span><span class="hs-special">(</span><a name="local-1627839848"><a href="#local-1627839848"><span class="hs-identifier">sub'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839849"><a href="#local-1627839849"><span class="hs-identifier">vs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cs_subst</span><span> </span><a href="#local-1627839846"><span class="hs-identifier hs-var">cse</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627839847"><span class="hs-identifier hs-var">vs</span></a><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span class="hs-identifier">addRecBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CSE.html#CSEnv"><span class="hs-identifier hs-type">CSEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-334"></a><a name="addRecBinders"><a href="CSE.html#addRecBinders"><span class="hs-identifier">addRecBinders</span></a></a><span> </span><a name="local-1627839850"><a href="#local-1627839850"><span class="hs-identifier">cse</span></a></a><span> </span><a name="local-1627839851"><a href="#local-1627839851"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1627839850"><span class="hs-identifier hs-var">cse</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cs_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627839852"><span class="hs-identifier hs-var">sub'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-1627839853"><span class="hs-identifier hs-var">vs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>                </span><span class="hs-keyword">where</span><span>
</span><a name="line-336"></a><span>                  </span><span class="hs-special">(</span><a name="local-1627839852"><a href="#local-1627839852"><span class="hs-identifier">sub'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627839853"><a href="#local-1627839853"><span class="hs-identifier">vs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substRecBndrs"><span class="hs-identifier hs-var">substRecBndrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cs_subst</span><span> </span><a href="#local-1627839850"><span class="hs-identifier hs-var">cse</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627839851"><span class="hs-identifier hs-var">vs</span></a><span>
</span><a name="line-337"></a></pre></body></html>