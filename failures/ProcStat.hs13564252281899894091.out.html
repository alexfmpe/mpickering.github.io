<a href="Processes.hs1439025357738342585.out.html">prev</a></br><a href="failures.html">home</a></br><a href="Product.hs1073185695316824712.out.html">next</a></br></br><pre>61d60
< data ProcInfo = ProcInfo { procPid          ∷ Pid
62d60
<                          , procName         ∷ ByteString
63d60
<                          , procState        ∷ ProcState
64d60
<                          , procPPid         ∷ Int
65d60
<                          , procGId          ∷ Int
66d60
<                          , procSId          ∷ Int
67d60
<                          , procTty          ∷ Int
68d60
<                          , procTtyGid       ∷ Int
69d60
<                          , procFlags        ∷ [ProcFlag]
70d60
<                          , procMinFlt       ∷ Word
71d60
<                          , procCMinFlt      ∷ Word
72d60
<                          , procMajFlt       ∷ Word
73d60
<                          , procCMajFlt      ∷ Word
74d60
<                          , procUTime        ∷ Word
75d60
<                          , procSTime        ∷ Word
76d60
<                          , procCUTime       ∷ Int
77d60
<                          , procCSTime       ∷ Int
78d60
<                          , procPriority     ∷ Int
79d60
<                          , procNice         ∷ Int
80d60
<                          , procNumThreads   ∷ Int
81d60
<                          , procStartTime    ∷ Word64
82d60
<                          , procVSize        ∷ Word
83d60
<                          , procRss          ∷ Int
84d60
<                          , procRssLim       ∷ Word
85d60
<                          , procStartCode    ∷ Word
86d60
<                          , procEndCode      ∷ Word
87d60
<                          , procStartStack   ∷ Word
88d60
<                          , procEsp          ∷ Word
89d60
<                          , procEip          ∷ Word
90d60
<                          , procSignal       ∷ Word
91d60
<                          , procBlocked      ∷ Word
92d60
<                          , procSigIgnore    ∷ Word
93d60
<                          , procSigCatch     ∷ Word
94d60
<                          , procWChan        ∷ Word
95d60
<                          , procNSwap        ∷ Word
96d60
<                          , procCNSwap       ∷ Word
97d60
<                          , procExitSignal   ∷ Int
98d60
<                          , procCpuNum       ∷ Int
99d60
<                          , procRtPriority   ∷ Word
100d60
<                          , procPolicy       ∷ Word
101d60
<                          , procBlkIoTicks   ∷ Word64
102d60
<                          , procGuestTime    ∷ Word
103c61
<                          , procCGuestTime   ∷ Int
---
> data ProcInfo = ProcInfo { procPid          :: Pid
103a62
>                          , procName         :: ByteString
103a63
>                          , procState        :: ProcState
103a64
>                          , procPPid         :: Int
103a65
>                          , procGId          :: Int
103a66
>                          , procSId          :: Int
103a67
>                          , procTty          :: Int
103a68
>                          , procTtyGid       :: Int
103a69
>                          , procFlags        :: [ProcFlag]
103a70
>                          , procMinFlt       :: Word
103a71
>                          , procCMinFlt      :: Word
103a72
>                          , procMajFlt       :: Word
103a73
>                          , procCMajFlt      :: Word
103a74
>                          , procUTime        :: Word
103a75
>                          , procSTime        :: Word
103a76
>                          , procCUTime       :: Int
103a77
>                          , procCSTime       :: Int
103a78
>                          , procPriority     :: Int
103a79
>                          , procNice         :: Int
103a80
>                          , procNumThreads   :: Int
103a81
>                          , procStartTime    :: Word64
103a82
>                          , procVSize        :: Word
103a83
>                          , procRss          :: Int
103a84
>                          , procRssLim       :: Word
103a85
>                          , procStartCode    :: Word
103a86
>                          , procEndCode      :: Word
103a87
>                          , procStartStack   :: Word
103a88
>                          , procEsp          :: Word
103a89
>                          , procEip          :: Word
103a90
>                          , procSignal       :: Word
103a91
>                          , procBlocked      :: Word
103a92
>                          , procSigIgnore    :: Word
103a93
>                          , procSigCatch     :: Word
103a94
>                          , procWChan        :: Word
103a95
>                          , procNSwap        :: Word
103a96
>                          , procCNSwap       :: Word
103a97
>                          , procExitSignal   :: Int
103a98
>                          , procCpuNum       :: Int
103a99
>                          , procRtPriority   :: Word
103a100
>                          , procPolicy       :: Word
103a101
>                          , procBlkIoTicks   :: Word64
103a102
>                          , procGuestTime    :: Word
103a103
>                          , procCGuestTime   :: Int
106c106
< charToProcState ∷ Char → Maybe ProcState
---
> charToProcState :: Char -> Maybe ProcState
108d107
<     'R' → Just Running
109d107
<     'S' → Just Sleeping
110d107
<     'D' → Just DiskSleeping
111d107
<     'Z' → Just Zombie
112d107
<     'T' → Just Traced
113d107
<     'W' → Just Paging
114c108
<     _   → Nothing
---
>     'R' -> Just Running
114a109
>     'S' -> Just Sleeping
114a110
>     'D' -> Just DiskSleeping
114a111
>     'Z' -> Just Zombie
114a112
>     'T' -> Just Traced
114a113
>     'W' -> Just Paging
114a114
>     _   -> Nothing
116c116
< flagToProcFlags ∷ Word → [ProcFlag]
---
> flagToProcFlags :: Word -> [ProcFlag]
120c120
<     hasFlag ∷ Bits a ⇒ a → a → Bool
---
>     hasFlag :: Bits a => a -> a -> Bool
125c125
< parser ∷ Parser ProcInfo
---
> parser :: Parser ProcInfo
127d126
<     pid             ← sdc
128d126
<     name            ← dos $ char '(' *> takeTill (== ')') <* anyChar
129d126
<     state           ← maybe empty return =<< charToProcState <$> dos anyChar
130d126
<     ppid            ← sdc
131d126
<     gid             ← sdc
132d126
<     sid             ← sdc
133d126
<     tty             ← sdc
134d126
<     ttyGid          ← sdc
135d126
<     flags           ← flagToProcFlags <$> sdc
136d126
<     minFlt          ← dc
137d126
<     cMinFlt         ← dc
138d126
<     majFlt          ← dc
139d126
<     cMajFlt         ← dc
140d126
<     uTime           ← dc
141d126
<     sTime           ← dc
142d126
<     cuTime          ← sdc
143d126
<     csTime          ← sdc
144d126
<     pri             ← sdc
145d126
<     nice            ← sdc
146d126
<     nt              ← sdc
147d126
<     _               ← dos $ char '0'
148d126
<     st              ← sdc
149d126
<     vSize           ← dc
150d126
<     rss             ← dc
151d126
<     rssLim          ← dc
152d126
<     startCode       ← dc
153d126
<     endCode         ← dc
154d126
<     startStack      ← dc
155d126
<     esp             ← dc
156d126
<     eip             ← dc
157d126
<     signal          ← dc
158d126
<     blockedS        ← dc
159d126
<     sigIgnore       ← dc
160d126
<     sigCatch        ← dc
161d126
<     wChan           ← dc
162d126
<     nSwap           ← dc
163d126
<     cnSwap          ← dc
164d126
<     exitSignal      ← sdc
165d126
<     cpuNum          ← sdc
166d126
<     rtPri           ← dc
167d126
<     policy          ← dc
168d126
<     blkIOTicks      ← dc
169d126
<     guestTime       ← dc
170c127
<     cGuestTime      ← signed decimal
---
>     pid             <- sdc
170a128
>     name            <- dos $ char '(' *> takeTill (== ')') <* anyChar
170a129
>     state           <- maybe empty return =<< charToProcState <$> dos anyChar
170a130
>     ppid            <- sdc
170a131
>     gid             <- sdc
170a132
>     sid             <- sdc
170a133
>     tty             <- sdc
170a134
>     ttyGid          <- sdc
170a135
>     flags           <- flagToProcFlags <$> sdc
170a136
>     minFlt          <- dc
170a137
>     cMinFlt         <- dc
170a138
>     majFlt          <- dc
170a139
>     cMajFlt         <- dc
170a140
>     uTime           <- dc
170a141
>     sTime           <- dc
170a142
>     cuTime          <- sdc
170a143
>     csTime          <- sdc
170a144
>     pri             <- sdc
170a145
>     nice            <- sdc
170a146
>     nt              <- sdc
170a147
>     _               <- dos $ char '0'
170a148
>     st              <- sdc
170a149
>     vSize           <- dc
170a150
>     rss             <- dc
170a151
>     rssLim          <- dc
170a152
>     startCode       <- dc
170a153
>     endCode         <- dc
170a154
>     startStack      <- dc
170a155
>     esp             <- dc
170a156
>     eip             <- dc
170a157
>     signal          <- dc
170a158
>     blockedS        <- dc
170a159
>     sigIgnore       <- dc
170a160
>     sigCatch        <- dc
170a161
>     wChan           <- dc
170a162
>     nSwap           <- dc
170a163
>     cnSwap          <- dc
170a164
>     exitSignal      <- sdc
170a165
>     cpuNum          <- sdc
170a166
>     rtPri           <- dc
170a167
>     policy          <- dc
170a168
>     blkIOTicks      <- dc
170a169
>     guestTime       <- dc
170a170
>     cGuestTime      <- signed decimal
215d214
<     dos ∷ Parser a → Parser a
216d214
<     dos p = p >>= \x → space >> return x
217c215
<     dc ∷ Integral a ⇒ Parser a
---
>     dos :: Parser a -> Parser a
217a216
>     dos p = p >>= \x -> space >> return x
217a217
>     dc :: Integral a => Parser a
219c219
<     sdc ∷ Integral a ⇒ Parser a
---
>     sdc :: Integral a => Parser a
222c222
< procStat ∷ Pid → IO (Maybe ProcInfo)
---
> procStat :: Pid -> IO (Maybe ProcInfo)
224c224
<     s ← bracket (openFile filename ReadMode) hClose S8.hGetContents
---
>     s <- bracket (openFile filename ReadMode) hClose S8.hGetContents
227a228
> 
</pre></br><h2>original</h2></br><pre>{-# LANGUAGE UnicodeSyntax #-}
module System.Linux.ProcStat ( ProcState (..)
                             , ProcFlag  (..)
                             , ProcInfo  (..)
                             , Pid
                             , procStat
                             ) where

import Data.ByteString.Char8 (ByteString)
import qualified Data.ByteString.Char8 as S8
import Data.Word
import Data.Attoparsec.Char8
import Control.Applicative
import System.IO
import Control.Exception (bracket)
import Data.Bits

type Pid = Int

data ProcState = Running
               | Sleeping
               | DiskSleeping
               | Zombie
               | Traced
               | Paging
               deriving Show

data ProcFlag = KSoftIrqD
              | Starting
              | Exiting
              | ExitPidDone
              | VCpu
              | WqWorker
              | ForkNoExec
              | MceProcess
              | SuperPriv
              | DumpCore
              | Signaled
              | MemAlloc
              | UsedMath
              | Freezing
              | NoFreeze
              | Frozen
              | FsTrans
              | KSwapD
              | OomOrigin
              | LessThrottle
              | KThread
              | Randomize
              | SwapWrite
              | SpreadPage
              | SpreadSlab
              | ThreadBound
              | MceEarly
              | MemPolicy
              | MutexTester
              | FreezerSkip
              | FreezerNoSig
              deriving (Show, Enum)

data ProcInfo = ProcInfo { procPid          ∷ Pid
                         , procName         ∷ ByteString
                         , procState        ∷ ProcState
                         , procPPid         ∷ Int
                         , procGId          ∷ Int
                         , procSId          ∷ Int
                         , procTty          ∷ Int
                         , procTtyGid       ∷ Int
                         , procFlags        ∷ [ProcFlag]
                         , procMinFlt       ∷ Word
                         , procCMinFlt      ∷ Word
                         , procMajFlt       ∷ Word
                         , procCMajFlt      ∷ Word
                         , procUTime        ∷ Word
                         , procSTime        ∷ Word
                         , procCUTime       ∷ Int
                         , procCSTime       ∷ Int
                         , procPriority     ∷ Int
                         , procNice         ∷ Int
                         , procNumThreads   ∷ Int
                         , procStartTime    ∷ Word64
                         , procVSize        ∷ Word
                         , procRss          ∷ Int
                         , procRssLim       ∷ Word
                         , procStartCode    ∷ Word
                         , procEndCode      ∷ Word
                         , procStartStack   ∷ Word
                         , procEsp          ∷ Word
                         , procEip          ∷ Word
                         , procSignal       ∷ Word
                         , procBlocked      ∷ Word
                         , procSigIgnore    ∷ Word
                         , procSigCatch     ∷ Word
                         , procWChan        ∷ Word
                         , procNSwap        ∷ Word
                         , procCNSwap       ∷ Word
                         , procExitSignal   ∷ Int
                         , procCpuNum       ∷ Int
                         , procRtPriority   ∷ Word
                         , procPolicy       ∷ Word
                         , procBlkIoTicks   ∷ Word64
                         , procGuestTime    ∷ Word
                         , procCGuestTime   ∷ Int
                         } deriving Show

charToProcState ∷ Char → Maybe ProcState
charToProcState c = case c of
    'R' → Just Running
    'S' → Just Sleeping
    'D' → Just DiskSleeping
    'Z' → Just Zombie
    'T' → Just Traced
    'W' → Just Paging
    _   → Nothing

flagToProcFlags ∷ Word → [ProcFlag]
flagToProcFlags x = foldr step [] flagMap
  where
    flagMap = zip (iterate (*2) 1) [KSoftIrqD .. FreezerNoSig]
    hasFlag ∷ Bits a ⇒ a → a → Bool
    hasFlag a b = a .&. b == b
    step (val, pflag) pflags | x `hasFlag` val = pflag : pflags
                             | otherwise       = pflags

parser ∷ Parser ProcInfo
parser = do
    pid             ← sdc
    name            ← dos $ char '(' *> takeTill (== ')') <* anyChar
    state           ← maybe empty return =<< charToProcState <$> dos anyChar
    ppid            ← sdc
    gid             ← sdc
    sid             ← sdc
    tty             ← sdc
    ttyGid          ← sdc
    flags           ← flagToProcFlags <$> sdc
    minFlt          ← dc
    cMinFlt         ← dc
    majFlt          ← dc
    cMajFlt         ← dc
    uTime           ← dc
    sTime           ← dc
    cuTime          ← sdc
    csTime          ← sdc
    pri             ← sdc
    nice            ← sdc
    nt              ← sdc
    _               ← dos $ char '0'
    st              ← sdc
    vSize           ← dc
    rss             ← dc
    rssLim          ← dc
    startCode       ← dc
    endCode         ← dc
    startStack      ← dc
    esp             ← dc
    eip             ← dc
    signal          ← dc
    blockedS        ← dc
    sigIgnore       ← dc
    sigCatch        ← dc
    wChan           ← dc
    nSwap           ← dc
    cnSwap          ← dc
    exitSignal      ← sdc
    cpuNum          ← sdc
    rtPri           ← dc
    policy          ← dc
    blkIOTicks      ← dc
    guestTime       ← dc
    cGuestTime      ← signed decimal
    return $ ProcInfo pid
                      name
                      state
                      ppid
                      gid
                      sid
                      tty
                      ttyGid
                      flags
                      minFlt
                      cMinFlt
                      majFlt
                      cMajFlt
                      uTime
                      sTime
                      cuTime
                      csTime
                      pri
                      nice
                      nt
                      st
                      vSize
                      rss
                      rssLim
                      startCode
                      endCode
                      startStack
                      esp
                      eip
                      signal
                      blockedS
                      sigIgnore
                      sigCatch
                      wChan
                      nSwap
                      cnSwap
                      exitSignal
                      cpuNum
                      rtPri
                      policy
                      blkIOTicks
                      guestTime
                      cGuestTime
  where
    dos ∷ Parser a → Parser a
    dos p = p >>= \x → space >> return x
    dc ∷ Integral a ⇒ Parser a
    dc = dos decimal
    sdc ∷ Integral a ⇒ Parser a
    sdc = signed dc

procStat ∷ Pid → IO (Maybe ProcInfo)
procStat pid = (`catch` const (return Nothing)) $ do
    s ← bracket (openFile filename ReadMode) hClose S8.hGetContents
    return $ maybeResult $ parse parser s
  where
    filename = "/proc/" ++ show pid ++ "/stat"
</pre></br><h2>printed</h2></br><pre>{-# LANGUAGE UnicodeSyntax #-}
module System.Linux.ProcStat ( ProcState (..)
                             , ProcFlag  (..)
                             , ProcInfo  (..)
                             , Pid
                             , procStat
                             ) where

import Data.ByteString.Char8 (ByteString)
import qualified Data.ByteString.Char8 as S8
import Data.Word
import Data.Attoparsec.Char8
import Control.Applicative
import System.IO
import Control.Exception (bracket)
import Data.Bits

type Pid = Int

data ProcState = Running
               | Sleeping
               | DiskSleeping
               | Zombie
               | Traced
               | Paging
               deriving Show

data ProcFlag = KSoftIrqD
              | Starting
              | Exiting
              | ExitPidDone
              | VCpu
              | WqWorker
              | ForkNoExec
              | MceProcess
              | SuperPriv
              | DumpCore
              | Signaled
              | MemAlloc
              | UsedMath
              | Freezing
              | NoFreeze
              | Frozen
              | FsTrans
              | KSwapD
              | OomOrigin
              | LessThrottle
              | KThread
              | Randomize
              | SwapWrite
              | SpreadPage
              | SpreadSlab
              | ThreadBound
              | MceEarly
              | MemPolicy
              | MutexTester
              | FreezerSkip
              | FreezerNoSig
              deriving (Show, Enum)

data ProcInfo = ProcInfo { procPid          :: Pid
                         , procName         :: ByteString
                         , procState        :: ProcState
                         , procPPid         :: Int
                         , procGId          :: Int
                         , procSId          :: Int
                         , procTty          :: Int
                         , procTtyGid       :: Int
                         , procFlags        :: [ProcFlag]
                         , procMinFlt       :: Word
                         , procCMinFlt      :: Word
                         , procMajFlt       :: Word
                         , procCMajFlt      :: Word
                         , procUTime        :: Word
                         , procSTime        :: Word
                         , procCUTime       :: Int
                         , procCSTime       :: Int
                         , procPriority     :: Int
                         , procNice         :: Int
                         , procNumThreads   :: Int
                         , procStartTime    :: Word64
                         , procVSize        :: Word
                         , procRss          :: Int
                         , procRssLim       :: Word
                         , procStartCode    :: Word
                         , procEndCode      :: Word
                         , procStartStack   :: Word
                         , procEsp          :: Word
                         , procEip          :: Word
                         , procSignal       :: Word
                         , procBlocked      :: Word
                         , procSigIgnore    :: Word
                         , procSigCatch     :: Word
                         , procWChan        :: Word
                         , procNSwap        :: Word
                         , procCNSwap       :: Word
                         , procExitSignal   :: Int
                         , procCpuNum       :: Int
                         , procRtPriority   :: Word
                         , procPolicy       :: Word
                         , procBlkIoTicks   :: Word64
                         , procGuestTime    :: Word
                         , procCGuestTime   :: Int
                         } deriving Show

charToProcState :: Char -> Maybe ProcState
charToProcState c = case c of
    'R' -> Just Running
    'S' -> Just Sleeping
    'D' -> Just DiskSleeping
    'Z' -> Just Zombie
    'T' -> Just Traced
    'W' -> Just Paging
    _   -> Nothing

flagToProcFlags :: Word -> [ProcFlag]
flagToProcFlags x = foldr step [] flagMap
  where
    flagMap = zip (iterate (*2) 1) [KSoftIrqD .. FreezerNoSig]
    hasFlag :: Bits a => a -> a -> Bool
    hasFlag a b = a .&. b == b
    step (val, pflag) pflags | x `hasFlag` val = pflag : pflags
                             | otherwise       = pflags

parser :: Parser ProcInfo
parser = do
    pid             <- sdc
    name            <- dos $ char '(' *> takeTill (== ')') <* anyChar
    state           <- maybe empty return =<< charToProcState <$> dos anyChar
    ppid            <- sdc
    gid             <- sdc
    sid             <- sdc
    tty             <- sdc
    ttyGid          <- sdc
    flags           <- flagToProcFlags <$> sdc
    minFlt          <- dc
    cMinFlt         <- dc
    majFlt          <- dc
    cMajFlt         <- dc
    uTime           <- dc
    sTime           <- dc
    cuTime          <- sdc
    csTime          <- sdc
    pri             <- sdc
    nice            <- sdc
    nt              <- sdc
    _               <- dos $ char '0'
    st              <- sdc
    vSize           <- dc
    rss             <- dc
    rssLim          <- dc
    startCode       <- dc
    endCode         <- dc
    startStack      <- dc
    esp             <- dc
    eip             <- dc
    signal          <- dc
    blockedS        <- dc
    sigIgnore       <- dc
    sigCatch        <- dc
    wChan           <- dc
    nSwap           <- dc
    cnSwap          <- dc
    exitSignal      <- sdc
    cpuNum          <- sdc
    rtPri           <- dc
    policy          <- dc
    blkIOTicks      <- dc
    guestTime       <- dc
    cGuestTime      <- signed decimal
    return $ ProcInfo pid
                      name
                      state
                      ppid
                      gid
                      sid
                      tty
                      ttyGid
                      flags
                      minFlt
                      cMinFlt
                      majFlt
                      cMajFlt
                      uTime
                      sTime
                      cuTime
                      csTime
                      pri
                      nice
                      nt
                      st
                      vSize
                      rss
                      rssLim
                      startCode
                      endCode
                      startStack
                      esp
                      eip
                      signal
                      blockedS
                      sigIgnore
                      sigCatch
                      wChan
                      nSwap
                      cnSwap
                      exitSignal
                      cpuNum
                      rtPri
                      policy
                      blkIOTicks
                      guestTime
                      cGuestTime
  where
    dos :: Parser a -> Parser a
    dos p = p >>= \x -> space >> return x
    dc :: Integral a => Parser a
    dc = dos decimal
    sdc :: Integral a => Parser a
    sdc = signed dc

procStat :: Pid -> IO (Maybe ProcInfo)
procStat pid = (`catch` const (return Nothing)) $ do
    s <- bracket (openFile filename ReadMode) hClose S8.hGetContents
    return $ maybeResult $ parse parser s
  where
    filename = "/proc/" ++ show pid ++ "/stat"

</pre>