<a href="Metadata.hs800532526565116027.out.html">prev</a></br><a href="failures.html">home</a></br><a href="Mini.hs1121267422972559129.out.html">next</a></br></br><pre>22c22
< startSchema = [api|
---
> startSchema = 
24d23
< id :: Id
25d23
<     = basic integer
27d24
< idId :: IdId
28d24
<     = Id
30d25
< an_enum :: AnEnum
31d25
<     = enum
32d25
<       | foo
33d25
<       | bar
35d26
< another_enum :: AnotherEnum
36d26
<     = enum
37d26
<       | foo
38d26
<       | woo
40d27
< a_union :: AUnion
41d27
<     = union
42d27
<       | bar :: Bar
44d28
< another_union :: AnotherUnion
45d28
<     = union
46d28
<       | foo :: Foo
47d28
<       | woo :: Id
49d29
< dbs :: DatabaseSnapshot
50d29
<     = record
51d29
<         foo   :: ? [Foo]        nothing
52d29
<         bar   :: ? [Bar]        []
53d29
<         recur :: ? [Recursive]
55d30
< fooPrefix :: Foo
56d30
<     = record
57d30
<         id   :: Id
58d30
<         nest :: Nested
59d30
<         en   :: AnEnum
60d30
<         un   :: AUnion
61d30
<         quux :: ? IdId
63d31
< barPrefix :: Bar
64d31
<     = record
65d31
<        id :: Id
67d32
< nestedPrefix :: Nested
68d32
<     = record
69d32
<        id :: Id
71d33
< recursive :: Recursive
72d33
<     = record
73d33
<       id    :: Id
74d33
<       recur :: ? Recursive
76d34
< |]
78a37
> 
78a38
> 
78a39
> 
78a40
> 
78a41
> 
78a42
> 
78a43
> 
78a44
> 
78a45
> 
78a46
> 
78a47
> 
78a48
> 
78a49
> 
78a50
> 
78a51
> 
78a52
> 
78a53
> 
78a54
> 
78a55
> 
78a56
> 
78a57
> 
78a58
> 
78a59
> 
78a60
> 
78a61
> 
78a62
> 
78a63
> 
78a64
> 
78a65
> 
78a66
> 
78a67
> 
78a68
> 
78a69
> 
78a70
> 
78a71
> 
78a72
> 
78a73
> 
78a74
> 
78a75
> 
78a76
> 
78a77
> 
78a78
> 
81c81
< (endSchema, changelog) = [apiWithChangelog|
---
> (endSchema, changelog) = 
83d82
< id :: Id
84d82
<     = basic integer
86d83
< idId :: IdId
87d83
<     = Id
89d84
< bin :: Binary
90d84
<     = basic binary
92d85
< an_enum :: AnEnum
93d85
<     = enum
94d85
<       | foofoo
95d85
<       | bar
96d85
<       | baz
98d86
< another_enum :: AnotherEnum
99d86
<     = enum
100d86
<       | foo
101d86
<       | woo
102d86
<       | barbar
104d87
< a_union :: AUnion
105d87
<     = union
106d87
<       | barbar :: RenamedBar
107d87
<       | baz :: Baz
109d88
< another_union :: AnotherUnion
110d88
<     = union
111d88
<       | foo :: Foo
112d88
<       | woo :: Id
113d88
<       | barbar :: RenamedBar
115d89
< dbs :: DatabaseSnapshot
116d89
<     = record
117d89
<         foo   :: ? [Foo]
118d89
<         bar2  :: ? [Bar2]
119d89
<         boz   :: ? [Baz]
120d89
<         recur :: ? [Recursive]
121d89
<         recur2 :: ? [DuplicateRecursive]
123d90
< fooPrefix :: Foo
124d90
<     = record
125d90
<         id   :: Id
126d90
<         nest :: RenamedNested
127d90
<         en   :: AnEnum
128d90
<         un   :: AUnion
129d90
<         c    :: string
130d90
<         nolist  :: [string]
131d90
<         nomaybe :: ? string
133d91
< barPrefix :: RenamedBar
134d91
<     = record
135d91
<        id :: Id
137d92
< bar2Prefix :: Bar2
138d92
<     = record
139d92
<        id :: Id
141d93
< nestedPrefix :: RenamedNested
142d93
<     = record
143d93
<        id :: Id
144d93
<        new :: string
146d94
< bazPrefix :: Baz
147d94
<     = record
148d94
<        id :: Id
149d94
<        yy :: string
151d95
< recursive :: Recursive
152d95
<     = record
153d95
<         renamed_id :: Id
154d95
<         recur      :: ? Recursive
155d95
<         new        :: string
156d95
<         newnew     :: string
158d96
< duplicaterecursive :: DuplicateRecursive
159d96
<     = record
160d96
<         renamed_id :: Id
161d96
<         recur      :: ? Recursive
162d96
<         new        :: string
164d97
< new :: New
165d97
<     = basic integer
167d98
< changes
169d99
< version "development"
170d99
<   // changes since last release
171d99
<   added New basic integer
173d100
< version "2.6"
174d100
<   // add fields with implicit default values
175d100
<   changed record Foo
176d100
<     field added nolist  :: [string]
177d100
<     field added nomaybe :: ? string
179d101
< version "2.5"
180d101
<   // schema-changing custom record migration
181d101
<   migration record Recursive DuplicateNew
183d102
< version "2.4"
184d102
<   // schema-changing custom database migration
185d102
<   migration DuplicateRecursive
187d103
< version "2.3"
188d103
<   // changing a recursively defined record
189d103
<   changed record Recursive
190d103
<     field renamed id to renamed_id
191d103
<     field added new :: string default "hello"
193d104
< version "2.2"
194d104
<   // changing a nested union
195d104
<   changed union AUnion
196d104
<     alternative renamed bar to barbar
198d105
< version "2.1"
199d105
<   // Changing a nested enum
200d105
<   changed enum AnEnum
201d105
<     alternative renamed foo to foofoo
203d106
< version "2.0"
204d106
<   // Changing a nested record
205d106
<   changed record RenamedNested
206d106
<     field added new :: string default "hello"
208d107
< version "1.9"
209d107
<   // Deleting a table
210d107
<   changed record DatabaseSnapshot
211d107
<     field removed bar
213d108
< version "1.8"
214d108
<   // Renaming a table
215d108
<   changed record DatabaseSnapshot
216d108
<     field renamed baz to boz
218d109
< version "1.7"
219d109
<   // Adding a table
220d109
<   changed record DatabaseSnapshot
221d109
<     field added baz :: ? [Baz] default []
223d110
< version "1.6"
224d110
<   // Custom change to the whole database
225d110
<   migration DuplicateBar
226d110
<   changed record DatabaseSnapshot
227d110
<     field added bar2 :: ? [Bar2] default nothing
228d110
<   added Bar2 record
229d110
<     id :: Id
231d111
< version "1.5"
232d111
<   // Custom change to a record
233d111
<   migration record Foo CopyIDtoC
235d112
< version "1.4"
236d112
<   // Renaming enum values
237d112
<   changed enum AnotherEnum
238d112
<     alternative renamed bar to barbar
240d113
< version "1.3"
241d113
<   // Deleting enum values
242d113
<   changed enum AnotherEnum
243d113
<     alternative removed baz
245d114
< version "1.2"
246d114
<   // Adding enum values
247d114
<   changed enum AnEnum
248d114
<     alternative added baz
249d114
<   changed enum AnotherEnum
250d114
<     alternative added bar
251d114
<     alternative added baz
253d115
< version "1.1"
254d115
<   // Renaming union alternatives
255d115
<   changed union AnotherUnion
256d115
<     alternative renamed bar to barbar
258d116
< version "1.0"
259d116
<   // Deleting union alternatives
260d116
<   changed union AnotherUnion
261d116
<     alternative removed baz
263d117
< version "0.9"
264d117
<   // Adding union alternatives
265d117
<   changed union AUnion
266d117
<     alternative added baz :: Baz
267d117
<   changed union AnotherUnion
268d117
<     alternative added bar :: RenamedBar
269d117
<     alternative added baz :: Baz
271d118
< version "0.8"
272d118
<   // Custom migration on fields
273d118
<   changed record Foo
274d118
<     field changed c :: string migration ConvertBinaryToString
276d119
< version "0.7"
277d119
<   // Renaming fields
278d119
<   changed record Foo
279d119
<     field renamed b to c
280d119
<   changed record Baz
281d119
<     field renamed y to yy
283d120
< version "0.6"
284d120
<   // Deleting fields
285d120
<   changed record Foo
286d120
<     field removed quux
287d120
<   changed record Baz
288d120
<     field removed x
290d121
< version "0.5"
291d121
<   // Adding fields
292d121
<   changed record Foo
293d121
<     field added b :: Binary default "Zm9vYmFy"
294d121
<   changed record Baz
295d121
<     field added x :: integer
296d121
<     field added y :: string
298d122
< version "0.4"
299d122
<   // Renaming types
300d122
<   renamed Nested to RenamedNested
301d122
<   renamed Bar to RenamedBar
303d123
< version "0.3"
304d123
<   // Deleting types
305d123
<   removed ASynonym
307d124
< version "0.2"
308d124
<   // Adding types
309d124
<   added ASynonym Binary
310d124
<   added Binary basic binary
311d124
<   added Baz record
312d124
<     id :: Id
314d125
< version "0.1"
315d125
<   // No changes
317d126
< version "0"
319d127
< |]
321a130
> 
321a131
> 
321a132
> 
321a133
> 
321a134
> 
321a135
> 
321a136
> 
321a137
> 
321a138
> 
321a139
> 
321a140
> 
321a141
> 
321a142
> 
321a143
> 
321a144
> 
321a145
> 
321a146
> 
321a147
> 
321a148
> 
321a149
> 
321a150
> 
321a151
> 
321a152
> 
321a153
> 
321a154
> 
321a155
> 
321a156
> 
321a157
> 
321a158
> 
321a159
> 
321a160
> 
321a161
> 
321a162
> 
321a163
> 
321a164
> 
321a165
> 
321a166
> 
321a167
> 
321a168
> 
321a169
> 
321a170
> 
321a171
> 
321a172
> 
321a173
> 
321a174
> 
321a175
> 
321a176
> 
321a177
> 
321a178
> 
321a179
> 
321a180
> 
321a181
> 
321a182
> 
321a183
> 
321a184
> 
321a185
> 
321a186
> 
321a187
> 
321a188
> 
321a189
> 
321a190
> 
321a191
> 
321a192
> 
321a193
> 
321a194
> 
321a195
> 
321a196
> 
321a197
> 
321a198
> 
321a199
> 
321a200
> 
321a201
> 
321a202
> 
321a203
> 
321a204
> 
321a205
> 
321a206
> 
321a207
> 
321a208
> 
321a209
> 
321a210
> 
321a211
> 
321a212
> 
321a213
> 
321a214
> 
321a215
> 
321a216
> 
321a217
> 
321a218
> 
321a219
> 
321a220
> 
321a221
> 
321a222
> 
321a223
> 
321a224
> 
321a225
> 
321a226
> 
321a227
> 
321a228
> 
321a229
> 
321a230
> 
321a231
> 
321a232
> 
321a233
> 
321a234
> 
321a235
> 
321a236
> 
321a237
> 
321a238
> 
321a239
> 
321a240
> 
321a241
> 
321a242
> 
321a243
> 
321a244
> 
321a245
> 
321a246
> 
321a247
> 
321a248
> 
321a249
> 
321a250
> 
321a251
> 
321a252
> 
321a253
> 
321a254
> 
321a255
> 
321a256
> 
321a257
> 
321a258
> 
321a259
> 
321a260
> 
321a261
> 
321a262
> 
321a263
> 
321a264
> 
321a265
> 
321a266
> 
321a267
> 
321a268
> 
321a269
> 
321a270
> 
321a271
> 
321a272
> 
321a273
> 
321a274
> 
321a275
> 
321a276
> 
321a277
> 
321a278
> 
321a279
> 
321a280
> 
321a281
> 
321a282
> 
321a283
> 
321a284
> 
321a285
> 
321a286
> 
321a287
> 
321a288
> 
321a289
> 
321a290
> 
321a291
> 
321a292
> 
321a293
> 
321a294
> 
321a295
> 
321a296
> 
321a297
> 
321a298
> 
321a299
> 
321a300
> 
321a301
> 
321a302
> 
321a303
> 
321a304
> 
321a305
> 
321a306
> 
321a307
> 
321a308
> 
321a309
> 
321a310
> 
321a311
> 
321a312
> 
321a313
> 
321a314
> 
321a315
> 
321a316
> 
321a317
> 
321a318
> 
321a319
> 
321a320
> 
321a321
> 
323d322
< (_, badChangelog) = [apiWithChangelog|
324c323
< changes
---
> (_, badChangelog) = 
326d324
< version "3.1"
327d324
<   // Adding a table without a default
328d324
<   changed record DatabaseSnapshot
329d324
<     field added badtable :: Nested
331d325
< version "3.0"
332d325
<   // Renaming to an existing val
333d325
<   changed enum AnotherEnum
334d325
<     alternative renamed foo to woo
336d326
< version "2.9"
337d326
<   // Renaming a missing val
338d326
<   changed enum AnotherEnum
339d326
<     alternative renamed missing to also_missing
341d327
< version "2.8"
342d327
<   // Deleting a missing val
343d327
<   changed enum AnotherEnum
344d327
<     alternative removed missing
346d328
< version "2.7"
347d328
<   // Adding a val that already exists
348d328
<   changed enum AnEnum
349d328
<     alternative added bar
351d329
< version "2.6"
352d329
<   // Removing vals from a type in use
353d329
<   changed enum AnEnum
354d329
<     alternative removed foo
356d330
< version "2.5"
357d330
<   // Adding vals to a non-existent type
358d330
<   changed enum NotThere
359d330
<     alternative added oops
361d331
< version "2.4"
362d331
<   // Adding vals to a non-enum
363d331
<   changed enum Id
364d331
<     alternative added oops
366d332
< version "2.3"
367d332
<   // Renaming to an existing alt
368d332
<   changed union AnotherUnion
369d332
<     alternative renamed foo to woo
371d333
< version "2.2"
372d333
<   // Renaming a missing alt
373d333
<   changed union AnotherUnion
374d333
<     alternative renamed missing to also_missing
376d334
< version "2.1"
377d334
<   // Deleting a missing alt
378d334
<   changed union AnotherUnion
379d334
<     alternative removed missing
381d335
< version "2.0"
382d335
<   // Adding an alt that already exists
383d335
<   changed union AUnion
384d335
<     alternative added bar :: Bar
386d336
< version "1.9"
387d336
<   // Adding an alt with a malformed type
388d336
<   changed union AUnion
389d336
<     alternative added oops :: Missing
391d337
< version "1.8"
392d337
<   // Removing alts from a type in use
393d337
<   changed union AUnion
394d337
<     alternative removed foo
396d338
< version "1.7"
397d338
<   // Adding alts to a non-existent type
398d338
<   changed union NotThere
399d338
<     alternative added oops :: Id
401d339
< version "1.6"
402d339
<   // Adding alts to a non-union
403d339
<   changed union Id
404d339
<     alternative added oops :: Id
406d340
< version "1.5"
407d340
<   // Renaming to an existing field
408d340
<   changed record Foo
409d340
<     field renamed en to un
411d341
< version "1.4"
412d341
<   // Renaming a missing field
413d341
<   changed record Foo
414d341
<     field renamed missing to also_missing
416d342
< version "1.3"
417d342
<   // Deleting a missing field
418d342
<   changed record Foo
419d342
<     field removed missing
421d343
< version "1.2"
422d343
<   // Adding a field with an ill-typed default value
423d343
<   changed record Foo
424d343
<     field added oops :: Id default "hello"
426d344
< version "1.1"
427d344
<   // Adding a field without a default value
428d344
<   changed record Foo
429d344
<     field added oops :: Id
431d345
< version "1.0"
432d345
<   // Adding a field that already exists
433d345
<   changed record Foo
434d345
<     field added id :: Id
436d346
< version "0.9"
437d346
<   // Adding a field with a malformed type
438d346
<   changed record Foo
439d346
<     field added oops :: Missing
441d347
< // // This is now legal:
442d347
< // version "0.8"
443d347
< //  // Adding fields to a type in use
444d347
< //  changed record Nested
445d347
< //    field added oops :: Id
447d348
< version "0.7"
448d348
<   // Adding fields to a non-existent type
449d348
<   changed record NotThere
450d348
<     field added oops :: Id
452d349
< version "0.6"
453d349
<   // Adding fields to a non-record
454d349
<   changed record Id
455d349
<     field added oops :: Id
457d350
< version "0.5"
458d350
<   // Renaming to an existing type
459d350
<   renamed Id to AnEnum
461d351
< version "0.4"
462d351
<   // Renaming a missing type
463d351
<   renamed NotThere to SomethingElse
465d352
< version "0.3"
466d352
<   // Deleting a missing type
467d352
<   removed NotThere
469d353
< version "0.2"
470d353
<   // Adding an ill-formed type
471d353
<   added New Missing
473d354
< version "0.1"
474d354
<   // Adding a type that already exists
475d354
<   added Id basic binary
477d355
< version "0"
478d355
< |]
479a357
> 
479a358
> 
479a359
> 
479a360
> 
479a361
> 
479a362
> 
479a363
> 
479a364
> 
479a365
> 
479a366
> 
479a367
> 
479a368
> 
479a369
> 
479a370
> 
479a371
> 
479a372
> 
479a373
> 
479a374
> 
479a375
> 
479a376
> 
479a377
> 
479a378
> 
479a379
> 
479a380
> 
479a381
> 
479a382
> 
479a383
> 
479a384
> 
479a385
> 
479a386
> 
479a387
> 
479a388
> 
479a389
> 
479a390
> 
479a391
> 
479a392
> 
479a393
> 
479a394
> 
479a395
> 
479a396
> 
479a397
> 
479a398
> 
479a399
> 
479a400
> 
479a401
> 
479a402
> 
479a403
> 
479a404
> 
479a405
> 
479a406
> 
479a407
> 
479a408
> 
479a409
> 
479a410
> 
479a411
> 
479a412
> 
479a413
> 
479a414
> 
479a415
> 
479a416
> 
479a417
> 
479a418
> 
479a419
> 
479a420
> 
479a421
> 
479a422
> 
479a423
> 
479a424
> 
479a425
> 
479a426
> 
479a427
> 
479a428
> 
479a429
> 
479a430
> 
479a431
> 
479a432
> 
479a433
> 
479a434
> 
479a435
> 
479a436
> 
479a437
> 
479a438
> 
479a439
> 
479a440
> 
479a441
> 
479a442
> 
479a443
> 
479a444
> 
479a445
> 
479a446
> 
479a447
> 
479a448
> 
479a449
> 
479a450
> 
479a451
> 
479a452
> 
479a453
> 
479a454
> 
479a455
> 
479a456
> 
479a457
> 
479a458
> 
479a459
> 
479a460
> 
479a461
> 
479a462
> 
479a463
> 
479a464
> 
479a465
> 
479a466
> 
479a467
> 
479a468
> 
479a469
> 
479a470
> 
479a471
> 
479a472
> 
479a473
> 
479a474
> 
479a475
> 
479a476
> 
479a477
> 
479a478
> 
479a479
> 
579d578
<     outOfOrder = snd [apiWithChangelog|
580d578
< changes
581d578
< version "0.1"
582d578
< version "0.2"
583c579
< |]
---
>     outOfOrder = snd 
585d580
<     incomplete = snd [apiWithChangelog|
586d580
< changes
587d580
< version "0.1"
588d580
< |]
590d581
<     badCustomMigration = snd [apiWithChangelog|
591d581
< changes
592d581
< version "0.2"
593d581
<   migration DuplicateBar
594d581
< version "0.1"
595d581
< |]
597a584
> 
597a585
>     incomplete = snd 
597a586
> 
597a587
> 
597a588
> 
597a589
> 
597a590
>     badCustomMigration = snd 
597a591
> 
597a592
> 
597a593
> 
597a594
> 
597a595
> 
597a596
> 
597a597
> 
606a607
> 
</pre></br><h2>original</h2></br><pre>{-# LANGUAGE QuasiQuotes                #-}
{-# LANGUAGE OverloadedStrings          #-}

-- This module provides data for Data.API.Test.Migration; it is
-- separated out because of the Template Haskell staging restriction.

module Data.API.Test.MigrationData where

import           Data.API.Changes
import           Data.API.JSON
import           Data.API.Parse
import           Data.API.Types

import qualified Data.Aeson as JS
import qualified Data.Set as Set
import qualified Data.Text as T
import           Data.Version
import           Distribution.Text (simpleParse)


startSchema :: API
startSchema = [api|

id :: Id
    = basic integer

idId :: IdId
    = Id

an_enum :: AnEnum
    = enum
      | foo
      | bar

another_enum :: AnotherEnum
    = enum
      | foo
      | woo

a_union :: AUnion
    = union
      | bar :: Bar

another_union :: AnotherUnion
    = union
      | foo :: Foo
      | woo :: Id

dbs :: DatabaseSnapshot
    = record
        foo   :: ? [Foo]        nothing
        bar   :: ? [Bar]        []
        recur :: ? [Recursive]

fooPrefix :: Foo
    = record
        id   :: Id
        nest :: Nested
        en   :: AnEnum
        un   :: AUnion
        quux :: ? IdId

barPrefix :: Bar
    = record
       id :: Id

nestedPrefix :: Nested
    = record
       id :: Id

recursive :: Recursive
    = record
      id    :: Id
      recur :: ? Recursive

|]


endSchema :: API
changelog :: APIChangelog
(endSchema, changelog) = [apiWithChangelog|

id :: Id
    = basic integer

idId :: IdId
    = Id

bin :: Binary
    = basic binary

an_enum :: AnEnum
    = enum
      | foofoo
      | bar
      | baz

another_enum :: AnotherEnum
    = enum
      | foo
      | woo
      | barbar

a_union :: AUnion
    = union
      | barbar :: RenamedBar
      | baz :: Baz

another_union :: AnotherUnion
    = union
      | foo :: Foo
      | woo :: Id
      | barbar :: RenamedBar

dbs :: DatabaseSnapshot
    = record
        foo   :: ? [Foo]
        bar2  :: ? [Bar2]
        boz   :: ? [Baz]
        recur :: ? [Recursive]
        recur2 :: ? [DuplicateRecursive]

fooPrefix :: Foo
    = record
        id   :: Id
        nest :: RenamedNested
        en   :: AnEnum
        un   :: AUnion
        c    :: string
        nolist  :: [string]
        nomaybe :: ? string

barPrefix :: RenamedBar
    = record
       id :: Id

bar2Prefix :: Bar2
    = record
       id :: Id

nestedPrefix :: RenamedNested
    = record
       id :: Id
       new :: string

bazPrefix :: Baz
    = record
       id :: Id
       yy :: string

recursive :: Recursive
    = record
        renamed_id :: Id
        recur      :: ? Recursive
        new        :: string
        newnew     :: string

duplicaterecursive :: DuplicateRecursive
    = record
        renamed_id :: Id
        recur      :: ? Recursive
        new        :: string

new :: New
    = basic integer

changes

version "development"
  // changes since last release
  added New basic integer

version "2.6"
  // add fields with implicit default values
  changed record Foo
    field added nolist  :: [string]
    field added nomaybe :: ? string

version "2.5"
  // schema-changing custom record migration
  migration record Recursive DuplicateNew

version "2.4"
  // schema-changing custom database migration
  migration DuplicateRecursive

version "2.3"
  // changing a recursively defined record
  changed record Recursive
    field renamed id to renamed_id
    field added new :: string default "hello"

version "2.2"
  // changing a nested union
  changed union AUnion
    alternative renamed bar to barbar

version "2.1"
  // Changing a nested enum
  changed enum AnEnum
    alternative renamed foo to foofoo

version "2.0"
  // Changing a nested record
  changed record RenamedNested
    field added new :: string default "hello"

version "1.9"
  // Deleting a table
  changed record DatabaseSnapshot
    field removed bar

version "1.8"
  // Renaming a table
  changed record DatabaseSnapshot
    field renamed baz to boz

version "1.7"
  // Adding a table
  changed record DatabaseSnapshot
    field added baz :: ? [Baz] default []

version "1.6"
  // Custom change to the whole database
  migration DuplicateBar
  changed record DatabaseSnapshot
    field added bar2 :: ? [Bar2] default nothing
  added Bar2 record
    id :: Id

version "1.5"
  // Custom change to a record
  migration record Foo CopyIDtoC

version "1.4"
  // Renaming enum values
  changed enum AnotherEnum
    alternative renamed bar to barbar

version "1.3"
  // Deleting enum values
  changed enum AnotherEnum
    alternative removed baz

version "1.2"
  // Adding enum values
  changed enum AnEnum
    alternative added baz
  changed enum AnotherEnum
    alternative added bar
    alternative added baz

version "1.1"
  // Renaming union alternatives
  changed union AnotherUnion
    alternative renamed bar to barbar

version "1.0"
  // Deleting union alternatives
  changed union AnotherUnion
    alternative removed baz

version "0.9"
  // Adding union alternatives
  changed union AUnion
    alternative added baz :: Baz
  changed union AnotherUnion
    alternative added bar :: RenamedBar
    alternative added baz :: Baz

version "0.8"
  // Custom migration on fields
  changed record Foo
    field changed c :: string migration ConvertBinaryToString

version "0.7"
  // Renaming fields
  changed record Foo
    field renamed b to c
  changed record Baz
    field renamed y to yy

version "0.6"
  // Deleting fields
  changed record Foo
    field removed quux
  changed record Baz
    field removed x

version "0.5"
  // Adding fields
  changed record Foo
    field added b :: Binary default "Zm9vYmFy"
  changed record Baz
    field added x :: integer
    field added y :: string

version "0.4"
  // Renaming types
  renamed Nested to RenamedNested
  renamed Bar to RenamedBar

version "0.3"
  // Deleting types
  removed ASynonym

version "0.2"
  // Adding types
  added ASynonym Binary
  added Binary basic binary
  added Baz record
    id :: Id

version "0.1"
  // No changes

version "0"

|]


badChangelog :: APIChangelog
(_, badChangelog) = [apiWithChangelog|
changes

version "3.1"
  // Adding a table without a default
  changed record DatabaseSnapshot
    field added badtable :: Nested

version "3.0"
  // Renaming to an existing val
  changed enum AnotherEnum
    alternative renamed foo to woo

version "2.9"
  // Renaming a missing val
  changed enum AnotherEnum
    alternative renamed missing to also_missing

version "2.8"
  // Deleting a missing val
  changed enum AnotherEnum
    alternative removed missing

version "2.7"
  // Adding a val that already exists
  changed enum AnEnum
    alternative added bar

version "2.6"
  // Removing vals from a type in use
  changed enum AnEnum
    alternative removed foo

version "2.5"
  // Adding vals to a non-existent type
  changed enum NotThere
    alternative added oops

version "2.4"
  // Adding vals to a non-enum
  changed enum Id
    alternative added oops

version "2.3"
  // Renaming to an existing alt
  changed union AnotherUnion
    alternative renamed foo to woo

version "2.2"
  // Renaming a missing alt
  changed union AnotherUnion
    alternative renamed missing to also_missing

version "2.1"
  // Deleting a missing alt
  changed union AnotherUnion
    alternative removed missing

version "2.0"
  // Adding an alt that already exists
  changed union AUnion
    alternative added bar :: Bar

version "1.9"
  // Adding an alt with a malformed type
  changed union AUnion
    alternative added oops :: Missing

version "1.8"
  // Removing alts from a type in use
  changed union AUnion
    alternative removed foo

version "1.7"
  // Adding alts to a non-existent type
  changed union NotThere
    alternative added oops :: Id

version "1.6"
  // Adding alts to a non-union
  changed union Id
    alternative added oops :: Id

version "1.5"
  // Renaming to an existing field
  changed record Foo
    field renamed en to un

version "1.4"
  // Renaming a missing field
  changed record Foo
    field renamed missing to also_missing

version "1.3"
  // Deleting a missing field
  changed record Foo
    field removed missing

version "1.2"
  // Adding a field with an ill-typed default value
  changed record Foo
    field added oops :: Id default "hello"

version "1.1"
  // Adding a field without a default value
  changed record Foo
    field added oops :: Id

version "1.0"
  // Adding a field that already exists
  changed record Foo
    field added id :: Id

version "0.9"
  // Adding a field with a malformed type
  changed record Foo
    field added oops :: Missing

// // This is now legal:
// version "0.8"
//  // Adding fields to a type in use
//  changed record Nested
//    field added oops :: Id

version "0.7"
  // Adding fields to a non-existent type
  changed record NotThere
    field added oops :: Id

version "0.6"
  // Adding fields to a non-record
  changed record Id
    field added oops :: Id

version "0.5"
  // Renaming to an existing type
  renamed Id to AnEnum

version "0.4"
  // Renaming a missing type
  renamed NotThere to SomethingElse

version "0.3"
  // Deleting a missing type
  removed NotThere

version "0.2"
  // Adding an ill-formed type
  added New Missing

version "0.1"
  // Adding a type that already exists
  added Id basic binary

version "0"
|]

expectedApplyFailures :: [(Version, Version, ApplyFailure)]
expectedApplyFailures = map toVersions $
  [ ("0",   "0.1", TypeExists (TypeName "Id"))
  , ("0.1", "0.2", DeclMalformed (TypeName "New")
                       (NTypeSynonym (TyName (TypeName "Missing")))
                       (Set.singleton (TypeName "Missing")))
  , ("0.2", "0.3", TypeDoesNotExist (TypeName "NotThere"))
  , ("0.3", "0.4", TypeDoesNotExist (TypeName "NotThere"))
  , ("0.4", "0.5", TypeExists (TypeName "AnEnum"))
  , ("0.5", "0.6", TypeWrongKind (TypeName "Id") TKRecord)
  , ("0.6", "0.7", TypeDoesNotExist (TypeName "NotThere"))
--  , ("0.7", "0.8", TypeInUse (TypeName "Nested"))
  , ("0.8", "0.9", TypeMalformed
                       (TyName (TypeName "Missing"))
                       (Set.singleton (TypeName "Missing")))
  , ("0.9", "1.0", FieldExists (TypeName "Foo") TKRecord (FieldName "id"))
  , ("1.0", "1.1", DefaultMissing (TypeName "Foo") (FieldName "oops"))
  , ("1.1", "1.2", FieldBadDefaultValue (TypeName "Foo") (FieldName "oops")
                       (TyName (TypeName "Id")) (DefValString (T.pack "hello")))
  , ("1.2", "1.3", FieldDoesNotExist (TypeName "Foo") TKRecord (FieldName "missing"))
  , ("1.3", "1.4", FieldDoesNotExist (TypeName "Foo") TKRecord (FieldName "missing"))
  , ("1.4", "1.5", FieldExists (TypeName "Foo") TKRecord (FieldName "un"))
  , ("1.5", "1.6", TypeWrongKind (TypeName "Id") TKUnion)
  , ("1.6", "1.7", TypeDoesNotExist (TypeName "NotThere"))
  , ("1.7", "1.8", TypeInUse (TypeName "AUnion"))
  , ("1.8", "1.9", TypeMalformed
                       (TyName (TypeName "Missing"))
                       (Set.singleton (TypeName "Missing")))
  , ("1.9", "2.0", FieldExists (TypeName "AUnion") TKUnion (FieldName "bar"))
  , ("2.0", "2.1", FieldDoesNotExist (TypeName "AnotherUnion") TKUnion (FieldName "missing"))
  , ("2.1", "2.2", FieldDoesNotExist (TypeName "AnotherUnion") TKUnion (FieldName "missing"))
  , ("2.2", "2.3", FieldExists (TypeName "AnotherUnion") TKUnion (FieldName "woo"))
  , ("2.3", "2.4", TypeWrongKind (TypeName "Id") TKEnum)
  , ("2.4", "2.5", TypeDoesNotExist (TypeName "NotThere"))
  , ("2.5", "2.6", TypeInUse (TypeName "AnEnum"))
  , ("2.6", "2.7", FieldExists (TypeName "AnEnum") TKEnum (FieldName "bar"))
  , ("2.7", "2.8", FieldDoesNotExist (TypeName "AnotherEnum") TKEnum (FieldName "missing"))
  , ("2.8", "2.9", FieldDoesNotExist (TypeName "AnotherEnum") TKEnum (FieldName "missing"))
  , ("2.9", "3.0", FieldExists (TypeName "AnotherEnum") TKEnum (FieldName "woo"))
  , ("3.0", "3.1", DefaultMissing (TypeName "DatabaseSnapshot") (FieldName "badtable"))
  ]
  where
    toVersions (s, s', x)
      | Just v  <- simpleParse s
      , Just v' <- simpleParse s'
      , v < v'                    = (v, v', x)
      | otherwise = error $ "expectedApplyFailures: bad versions "
                            ++ show s ++ " and " ++ show s'

type MigrateFailureTest = ( String
                          , (API, Version)  -- Start version
                          , (API, VersionExtra)  -- End version
                          , APIChangelog
                          , JS.Value
                          , MigrateFailure -> Bool )

expectedMigrateFailures :: [MigrateFailureTest]
expectedMigrateFailures =
  [ ( "Out of order"
    , (startSchema, ver "0.1")
    , (endSchema, verRelease "0.2")
    , outOfOrder
    , startData
    , (== ValidateFailure (ChangelogOutOfOrder (verRelease "0.1") (verRelease "0.2")))
    )

  , ("Incomplete"
    , (startSchema, ver "0.1")
    , (endSchema, verRelease "2.5")
    , incomplete
    , startData
    , \ err -> case err of
                 ValidateFailure (ChangelogIncomplete _ _ _) -> True
                 _                                           -> False
    )

  , ( "Downgrade"
    , (startSchema, ver "0.2")
    , (startSchema, verRelease "0.1")
    , changelog
    , startData
    , (== ValidateFailure (CannotDowngrade (verRelease "0.2") (verRelease "0.1")))
    )

  , ("Bad custom migration"
    , (startSchema, ver "0.1")
    , (startSchema, verRelease "0.2")
    , badCustomMigration
    , startData
    , \ err -> case err of
                 ValueError (JSONError UnexpectedField) [InField t] -> t == "bar2"
                 _                                                  -> False
    )
  ]
  where
    ver s | Just v <- simpleParse s = v
          | otherwise = error $ "expectedValidateFailures: bad version " ++ show s
    verRelease s = Release $ ver s

    outOfOrder = snd [apiWithChangelog|
changes
version "0.1"
version "0.2"
|]

    incomplete = snd [apiWithChangelog|
changes
version "0.1"
|]

    badCustomMigration = snd [apiWithChangelog|
changes
version "0.2"
  migration DuplicateBar
version "0.1"
|]


startData, endData :: JS.Value
Just startData = JS.decode "{ \"foo\": [ {\"id\": 42, \"nest\": { \"id\": 3 }, \"en\": \"foo\", \"un\": { \"bar\": { \"id\": 43 } }, \"quux\": null } ], \"bar\": [ { \"id\": 4 } ], \"recur\": [{ \"id\": 9, \"recur\": { \"id\": 8, \"recur\": null} }] }"
Just endData = JS.decode "{ \"foo\": [ {\"id\":42, \"nest\": { \"id\": 3, \"new\": \"hello\" }, \"c\": \"foobar42\", \"en\": \"foofoo\", \"un\": { \"barbar\": { \"id\": 43 } }, \"nolist\": [], \"nomaybe\": null } ], \"boz\": [], \"bar2\": [ {\"id\": 4 } ], \"recur\": [{ \"renamed_id\": 9, \"new\": \"hello\", \"newnew\": \"hello\", \"recur\": { \"renamed_id\": 8, \"new\": \"hello\", \"newnew\": \"hello\", \"recur\": null} }], \"recur2\": [{ \"renamed_id\": 9, \"new\": \"hello\", \"recur\": { \"renamed_id\": 8, \"new\": \"hello\", \"newnew\": \"hello\", \"recur\": null} }] }"

startVersion :: Version
startVersion = changelogStartVersion changelog

root_ :: TypeName
root_ = TypeName "DatabaseSnapshot"
</pre></br><h2>printed</h2></br><pre>{-# LANGUAGE QuasiQuotes                #-}
{-# LANGUAGE OverloadedStrings          #-}

-- This module provides data for Data.API.Test.Migration; it is
-- separated out because of the Template Haskell staging restriction.

module Data.API.Test.MigrationData where

import           Data.API.Changes
import           Data.API.JSON
import           Data.API.Parse
import           Data.API.Types

import qualified Data.Aeson as JS
import qualified Data.Set as Set
import qualified Data.Text as T
import           Data.Version
import           Distribution.Text (simpleParse)


startSchema :: API
startSchema = 
























































endSchema :: API
changelog :: APIChangelog
(endSchema, changelog) = 
















































































































































































































































badChangelog :: APIChangelog
(_, badChangelog) = 




























































































































































expectedApplyFailures :: [(Version, Version, ApplyFailure)]
expectedApplyFailures = map toVersions $
  [ ("0",   "0.1", TypeExists (TypeName "Id"))
  , ("0.1", "0.2", DeclMalformed (TypeName "New")
                       (NTypeSynonym (TyName (TypeName "Missing")))
                       (Set.singleton (TypeName "Missing")))
  , ("0.2", "0.3", TypeDoesNotExist (TypeName "NotThere"))
  , ("0.3", "0.4", TypeDoesNotExist (TypeName "NotThere"))
  , ("0.4", "0.5", TypeExists (TypeName "AnEnum"))
  , ("0.5", "0.6", TypeWrongKind (TypeName "Id") TKRecord)
  , ("0.6", "0.7", TypeDoesNotExist (TypeName "NotThere"))
--  , ("0.7", "0.8", TypeInUse (TypeName "Nested"))
  , ("0.8", "0.9", TypeMalformed
                       (TyName (TypeName "Missing"))
                       (Set.singleton (TypeName "Missing")))
  , ("0.9", "1.0", FieldExists (TypeName "Foo") TKRecord (FieldName "id"))
  , ("1.0", "1.1", DefaultMissing (TypeName "Foo") (FieldName "oops"))
  , ("1.1", "1.2", FieldBadDefaultValue (TypeName "Foo") (FieldName "oops")
                       (TyName (TypeName "Id")) (DefValString (T.pack "hello")))
  , ("1.2", "1.3", FieldDoesNotExist (TypeName "Foo") TKRecord (FieldName "missing"))
  , ("1.3", "1.4", FieldDoesNotExist (TypeName "Foo") TKRecord (FieldName "missing"))
  , ("1.4", "1.5", FieldExists (TypeName "Foo") TKRecord (FieldName "un"))
  , ("1.5", "1.6", TypeWrongKind (TypeName "Id") TKUnion)
  , ("1.6", "1.7", TypeDoesNotExist (TypeName "NotThere"))
  , ("1.7", "1.8", TypeInUse (TypeName "AUnion"))
  , ("1.8", "1.9", TypeMalformed
                       (TyName (TypeName "Missing"))
                       (Set.singleton (TypeName "Missing")))
  , ("1.9", "2.0", FieldExists (TypeName "AUnion") TKUnion (FieldName "bar"))
  , ("2.0", "2.1", FieldDoesNotExist (TypeName "AnotherUnion") TKUnion (FieldName "missing"))
  , ("2.1", "2.2", FieldDoesNotExist (TypeName "AnotherUnion") TKUnion (FieldName "missing"))
  , ("2.2", "2.3", FieldExists (TypeName "AnotherUnion") TKUnion (FieldName "woo"))
  , ("2.3", "2.4", TypeWrongKind (TypeName "Id") TKEnum)
  , ("2.4", "2.5", TypeDoesNotExist (TypeName "NotThere"))
  , ("2.5", "2.6", TypeInUse (TypeName "AnEnum"))
  , ("2.6", "2.7", FieldExists (TypeName "AnEnum") TKEnum (FieldName "bar"))
  , ("2.7", "2.8", FieldDoesNotExist (TypeName "AnotherEnum") TKEnum (FieldName "missing"))
  , ("2.8", "2.9", FieldDoesNotExist (TypeName "AnotherEnum") TKEnum (FieldName "missing"))
  , ("2.9", "3.0", FieldExists (TypeName "AnotherEnum") TKEnum (FieldName "woo"))
  , ("3.0", "3.1", DefaultMissing (TypeName "DatabaseSnapshot") (FieldName "badtable"))
  ]
  where
    toVersions (s, s', x)
      | Just v  <- simpleParse s
      , Just v' <- simpleParse s'
      , v < v'                    = (v, v', x)
      | otherwise = error $ "expectedApplyFailures: bad versions "
                            ++ show s ++ " and " ++ show s'

type MigrateFailureTest = ( String
                          , (API, Version)  -- Start version
                          , (API, VersionExtra)  -- End version
                          , APIChangelog
                          , JS.Value
                          , MigrateFailure -> Bool )

expectedMigrateFailures :: [MigrateFailureTest]
expectedMigrateFailures =
  [ ( "Out of order"
    , (startSchema, ver "0.1")
    , (endSchema, verRelease "0.2")
    , outOfOrder
    , startData
    , (== ValidateFailure (ChangelogOutOfOrder (verRelease "0.1") (verRelease "0.2")))
    )

  , ("Incomplete"
    , (startSchema, ver "0.1")
    , (endSchema, verRelease "2.5")
    , incomplete
    , startData
    , \ err -> case err of
                 ValidateFailure (ChangelogIncomplete _ _ _) -> True
                 _                                           -> False
    )

  , ( "Downgrade"
    , (startSchema, ver "0.2")
    , (startSchema, verRelease "0.1")
    , changelog
    , startData
    , (== ValidateFailure (CannotDowngrade (verRelease "0.2") (verRelease "0.1")))
    )

  , ("Bad custom migration"
    , (startSchema, ver "0.1")
    , (startSchema, verRelease "0.2")
    , badCustomMigration
    , startData
    , \ err -> case err of
                 ValueError (JSONError UnexpectedField) [InField t] -> t == "bar2"
                 _                                                  -> False
    )
  ]
  where
    ver s | Just v <- simpleParse s = v
          | otherwise = error $ "expectedValidateFailures: bad version " ++ show s
    verRelease s = Release $ ver s

    outOfOrder = snd 





    incomplete = snd 




    badCustomMigration = snd 







startData, endData :: JS.Value
Just startData = JS.decode "{ \"foo\": [ {\"id\": 42, \"nest\": { \"id\": 3 }, \"en\": \"foo\", \"un\": { \"bar\": { \"id\": 43 } }, \"quux\": null } ], \"bar\": [ { \"id\": 4 } ], \"recur\": [{ \"id\": 9, \"recur\": { \"id\": 8, \"recur\": null} }] }"
Just endData = JS.decode "{ \"foo\": [ {\"id\":42, \"nest\": { \"id\": 3, \"new\": \"hello\" }, \"c\": \"foobar42\", \"en\": \"foofoo\", \"un\": { \"barbar\": { \"id\": 43 } }, \"nolist\": [], \"nomaybe\": null } ], \"boz\": [], \"bar2\": [ {\"id\": 4 } ], \"recur\": [{ \"renamed_id\": 9, \"new\": \"hello\", \"newnew\": \"hello\", \"recur\": { \"renamed_id\": 8, \"new\": \"hello\", \"newnew\": \"hello\", \"recur\": null} }], \"recur2\": [{ \"renamed_id\": 9, \"new\": \"hello\", \"recur\": { \"renamed_id\": 8, \"new\": \"hello\", \"newnew\": \"hello\", \"recur\": null} }] }"

startVersion :: Version
startVersion = changelogStartVersion changelog

root_ :: TypeName
root_ = TypeName "DatabaseSnapshot"

</pre>