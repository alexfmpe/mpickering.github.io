<a href="Handle.hs5950286351962408013.out.html">prev</a></br><a href="failures.html">home</a></br><a href="Hash.hs1073185695316824712.out.html">next</a></br></br><pre>53d52
< GO(IdentityT)
54d52
< GO(ListT)
55d52
< GO(MaybeT)
56d52
< GOX(Error e, ErrorT e)
57d52
< GO(ReaderT r)
58d52
< GO(StateT s)
59d52
< GOX(Monoid w, WriterT w)
60d52
< GOX(Monoid w, RWST r w s)
61d52
< GOX(Monoid w, Strict.RWST r w s)
62d52
< GO(Strict.StateT s)
63d52
< GOX(Monoid w, Strict.WriterT w)
64d52
< GO(Pipe l i o u)
65c53
< GO(ConduitM i o)
---
> instanceGO(IdentityT)         m => MonadHandler (IdentityT m) where type HandlerSite (IdentityT m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a54
> instanceGO(ListT)MonadHandler m => MonadHandler (ListT m) where type HandlerSite (ListT m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a55
> instanceGO(MaybeTMonadHandler)            m => MonadHandler (MaybeT m) where type HandlerSite (MaybeT m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a56
> instanceGOX(Error(Errore, ErrorT, MonadHandlere)          m) => MonadHandler ( ErrorT e m) where type HandlerSite ( ErrorT e m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a57
> instanceGO(ReaderTr)         m => MonadHandler (ReaderT r m) where type HandlerSite (ReaderT r m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a58
> instanceGO(StateTMonadHandlers)          m => MonadHandler (StateT s m) where type HandlerSite (StateT s m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a59
> instanceGOX(MonoidMonoidw, WriterT, MonadHandlerw)         m) => MonadHandler ( WriterT w m) where type HandlerSite ( WriterT w m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a60
> instanceGOX(MonoidMonoidw, RWST,rMonadHandlerw s)        m) => MonadHandler ( RWST r w s m) where type HandlerSite ( RWST r w s m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a61
> instanceGOX(MonoidMonoidw, Strict.RWST, MonadHandlerr w s) m) => MonadHandler ( Strict.RWST r w s m) where type HandlerSite ( Strict.RWST r w s m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a62
> instanceGO(Strict.StateTs)   m => MonadHandler (Strict.StateT s m) where type HandlerSite (Strict.StateT s m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a63
> instanceGOX(MonoidMonoidw, Strict.WriterT, MonadHandlerw)  m) => MonadHandler ( Strict.WriterT w m) where type HandlerSite ( Strict.WriterT w m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a64
> instanceGO(Pipe lMonadHandleri o u)      m => MonadHandler (Pipe l i o u m) where type HandlerSite (Pipe l i o u m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
65a65
> instanceGO(ConduitMi o)      m => MonadHandler (ConduitM i o m) where type HandlerSite (ConduitM i o m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
76d75
< GO(IdentityT)
77d75
< GO(ListT)
78d75
< GO(MaybeT)
79d75
< GOX(Error e, ErrorT e)
80d75
< GO(ReaderT r)
81d75
< GO(StateT s)
82d75
< GOX(Monoid w, WriterT w)
83d75
< GOX(Monoid w, RWST r w s)
84d75
< GOX(Monoid w, Strict.RWST r w s)
85d75
< GO(Strict.StateT s)
86d75
< GOX(Monoid w, Strict.WriterT w)
87d75
< GO(Pipe l i o u)
88c76
< GO(ConduitM i o)
---
> instanceGO(IdentityT)        m => MonadWidget (IdentityT m) where liftWidgetT = lift . liftWidgetT
88a77
> instanceGO(ListT)MonadWidget m => MonadWidget (ListT m) where liftWidgetT = lift . liftWidgetT
88a78
> instanceGO(MaybeTMonadWidget)           m => MonadWidget (MaybeT m) where liftWidgetT = lift . liftWidgetT
88a79
> instanceGOX(Error(Errore, ErrorT, MonadWidgete)         m) => MonadWidget ( ErrorT e m) where liftWidgetT = lift . liftWidgetT
88a80
> instanceGO(ReaderTr)        m => MonadWidget (ReaderT r m) where liftWidgetT = lift . liftWidgetT
88a81
> instanceGO(StateTMonadWidgets)         m => MonadWidget (StateT s m) where liftWidgetT = lift . liftWidgetT
88a82
> instanceGOX(MonoidMonoidw, WriterT, MonadWidgetw)        m) => MonadWidget ( WriterT w m) where liftWidgetT = lift . liftWidgetT
88a83
> instanceGOX(MonoidMonoidw, RWST,rMonadWidgetw s)       m) => MonadWidget ( RWST r w s m) where liftWidgetT = lift . liftWidgetT
88a84
> instanceGOX(MonoidMonoidw, Strict.RWST, MonadWidgetr w s)m) => MonadWidget ( Strict.RWST r w s m) where liftWidgetT = lift . liftWidgetT
88a85
> instanceGO(Strict.StateTs)  m => MonadWidget (Strict.StateT s m) where liftWidgetT = lift . liftWidgetT
88a86
> instanceGOX(MonoidMonoidw, Strict.WriterT, MonadWidgetw) m) => MonadWidget ( Strict.WriterT w m) where liftWidgetT = lift . liftWidgetT
88a87
> instanceGO(Pipe lMonadWidgeti o u)     m => MonadWidget (Pipe l i o u m) where liftWidgetT = lift . liftWidgetT
88a88
> instanceGO(ConduitMi o)     m => MonadWidget (ConduitM i o m) where liftWidgetT = lift . liftWidgetT
90a91
> 
</pre></br><h2>original</h2></br><pre>{-# LANGUAGE CPP #-}
{-# LANGUAGE TypeFamilies #-}
{-# LANGUAGE ConstraintKinds #-}
{-# LANGUAGE TupleSections #-}
{-# LANGUAGE FlexibleInstances #-}
{-# LANGUAGE FlexibleContexts #-}
{-# LANGUAGE UndecidableInstances #-}
module Yesod.Core.Class.Handler
    ( MonadHandler (..)
    , MonadWidget (..)
    ) where

import Yesod.Core.Types
import Data.Monoid (mempty)
import Control.Monad (liftM)
import Control.Monad.IO.Class (liftIO)
import Control.Monad.Trans.Resource (MonadResource, MonadResourceBase)
import Control.Monad.Trans.Class (lift)
import Data.Monoid (Monoid)
import Data.Conduit.Internal (Pipe, ConduitM)

import Control.Monad.Trans.Identity ( IdentityT)
import Control.Monad.Trans.List     ( ListT    )
import Control.Monad.Trans.Maybe    ( MaybeT   )
import Control.Monad.Trans.Error    ( ErrorT, Error)
import Control.Monad.Trans.Reader   ( ReaderT  )
import Control.Monad.Trans.State    ( StateT   )
import Control.Monad.Trans.Writer   ( WriterT  )
import Control.Monad.Trans.RWS      ( RWST     )
import qualified Control.Monad.Trans.RWS.Strict    as Strict ( RWST   )
import qualified Control.Monad.Trans.State.Strict  as Strict ( StateT )
import qualified Control.Monad.Trans.Writer.Strict as Strict ( WriterT )

class MonadResource m => MonadHandler m where
    type HandlerSite m
    liftHandlerT :: HandlerT (HandlerSite m) IO a -> m a

replaceToParent :: HandlerData site route -> HandlerData site ()
replaceToParent hd = hd { handlerToParent = const () }

instance MonadResourceBase m => MonadHandler (HandlerT site m) where
    type HandlerSite (HandlerT site m) = site
    liftHandlerT (HandlerT f) = HandlerT $ liftIO . f . replaceToParent
{-# RULES "liftHandlerT (HandlerT site IO)" liftHandlerT = id #-}

instance MonadResourceBase m => MonadHandler (WidgetT site m) where
    type HandlerSite (WidgetT site m) = site
    liftHandlerT (HandlerT f) = WidgetT $ liftIO . liftM (, mempty) . f . replaceToParent
{-# RULES "liftHandlerT (WidgetT site IO)" forall f. liftHandlerT (HandlerT f) = WidgetT $ liftM (, mempty) . f #-}

#define GO(T) instance MonadHandler m => MonadHandler (T m) where type HandlerSite (T m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
#define GOX(X, T) instance (X, MonadHandler m) => MonadHandler (T m) where type HandlerSite (T m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
GO(IdentityT)
GO(ListT)
GO(MaybeT)
GOX(Error e, ErrorT e)
GO(ReaderT r)
GO(StateT s)
GOX(Monoid w, WriterT w)
GOX(Monoid w, RWST r w s)
GOX(Monoid w, Strict.RWST r w s)
GO(Strict.StateT s)
GOX(Monoid w, Strict.WriterT w)
GO(Pipe l i o u)
GO(ConduitM i o)
#undef GO
#undef GOX

class MonadHandler m => MonadWidget m where
    liftWidgetT :: WidgetT (HandlerSite m) IO a -> m a
instance MonadResourceBase m => MonadWidget (WidgetT site m) where
    liftWidgetT (WidgetT f) = WidgetT $ liftIO . f . replaceToParent

#define GO(T) instance MonadWidget m => MonadWidget (T m) where liftWidgetT = lift . liftWidgetT
#define GOX(X, T) instance (X, MonadWidget m) => MonadWidget (T m) where liftWidgetT = lift . liftWidgetT
GO(IdentityT)
GO(ListT)
GO(MaybeT)
GOX(Error e, ErrorT e)
GO(ReaderT r)
GO(StateT s)
GOX(Monoid w, WriterT w)
GOX(Monoid w, RWST r w s)
GOX(Monoid w, Strict.RWST r w s)
GO(Strict.StateT s)
GOX(Monoid w, Strict.WriterT w)
GO(Pipe l i o u)
GO(ConduitM i o)
#undef GO
#undef GOX
</pre></br><h2>printed</h2></br><pre>{-# LANGUAGE CPP #-}
{-# LANGUAGE TypeFamilies #-}
{-# LANGUAGE ConstraintKinds #-}
{-# LANGUAGE TupleSections #-}
{-# LANGUAGE FlexibleInstances #-}
{-# LANGUAGE FlexibleContexts #-}
{-# LANGUAGE UndecidableInstances #-}
module Yesod.Core.Class.Handler
    ( MonadHandler (..)
    , MonadWidget (..)
    ) where

import Yesod.Core.Types
import Data.Monoid (mempty)
import Control.Monad (liftM)
import Control.Monad.IO.Class (liftIO)
import Control.Monad.Trans.Resource (MonadResource, MonadResourceBase)
import Control.Monad.Trans.Class (lift)
import Data.Monoid (Monoid)
import Data.Conduit.Internal (Pipe, ConduitM)

import Control.Monad.Trans.Identity ( IdentityT)
import Control.Monad.Trans.List     ( ListT    )
import Control.Monad.Trans.Maybe    ( MaybeT   )
import Control.Monad.Trans.Error    ( ErrorT, Error)
import Control.Monad.Trans.Reader   ( ReaderT  )
import Control.Monad.Trans.State    ( StateT   )
import Control.Monad.Trans.Writer   ( WriterT  )
import Control.Monad.Trans.RWS      ( RWST     )
import qualified Control.Monad.Trans.RWS.Strict    as Strict ( RWST   )
import qualified Control.Monad.Trans.State.Strict  as Strict ( StateT )
import qualified Control.Monad.Trans.Writer.Strict as Strict ( WriterT )

class MonadResource m => MonadHandler m where
    type HandlerSite m
    liftHandlerT :: HandlerT (HandlerSite m) IO a -> m a

replaceToParent :: HandlerData site route -> HandlerData site ()
replaceToParent hd = hd { handlerToParent = const () }

instance MonadResourceBase m => MonadHandler (HandlerT site m) where
    type HandlerSite (HandlerT site m) = site
    liftHandlerT (HandlerT f) = HandlerT $ liftIO . f . replaceToParent
{-# RULES "liftHandlerT (HandlerT site IO)" liftHandlerT = id #-}

instance MonadResourceBase m => MonadHandler (WidgetT site m) where
    type HandlerSite (WidgetT site m) = site
    liftHandlerT (HandlerT f) = WidgetT $ liftIO . liftM (, mempty) . f . replaceToParent
{-# RULES "liftHandlerT (WidgetT site IO)" forall f. liftHandlerT (HandlerT f) = WidgetT $ liftM (, mempty) . f #-}

#define GO(T) instance MonadHandler m => MonadHandler (T m) where type HandlerSite (T m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
#define GOX(X, T) instance (X, MonadHandler m) => MonadHandler (T m) where type HandlerSite (T m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGO(IdentityT)         m => MonadHandler (IdentityT m) where type HandlerSite (IdentityT m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGO(ListT)MonadHandler m => MonadHandler (ListT m) where type HandlerSite (ListT m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGO(MaybeTMonadHandler)            m => MonadHandler (MaybeT m) where type HandlerSite (MaybeT m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGOX(Error(Errore, ErrorT, MonadHandlere)          m) => MonadHandler ( ErrorT e m) where type HandlerSite ( ErrorT e m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGO(ReaderTr)         m => MonadHandler (ReaderT r m) where type HandlerSite (ReaderT r m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGO(StateTMonadHandlers)          m => MonadHandler (StateT s m) where type HandlerSite (StateT s m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGOX(MonoidMonoidw, WriterT, MonadHandlerw)         m) => MonadHandler ( WriterT w m) where type HandlerSite ( WriterT w m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGOX(MonoidMonoidw, RWST,rMonadHandlerw s)        m) => MonadHandler ( RWST r w s m) where type HandlerSite ( RWST r w s m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGOX(MonoidMonoidw, Strict.RWST, MonadHandlerr w s) m) => MonadHandler ( Strict.RWST r w s m) where type HandlerSite ( Strict.RWST r w s m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGO(Strict.StateTs)   m => MonadHandler (Strict.StateT s m) where type HandlerSite (Strict.StateT s m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGOX(MonoidMonoidw, Strict.WriterT, MonadHandlerw)  m) => MonadHandler ( Strict.WriterT w m) where type HandlerSite ( Strict.WriterT w m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGO(Pipe lMonadHandleri o u)      m => MonadHandler (Pipe l i o u m) where type HandlerSite (Pipe l i o u m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
instanceGO(ConduitMi o)      m => MonadHandler (ConduitM i o m) where type HandlerSite (ConduitM i o m) = HandlerSite m; liftHandlerT = lift . liftHandlerT
#undef GO
#undef GOX

class MonadHandler m => MonadWidget m where
    liftWidgetT :: WidgetT (HandlerSite m) IO a -> m a
instance MonadResourceBase m => MonadWidget (WidgetT site m) where
    liftWidgetT (WidgetT f) = WidgetT $ liftIO . f . replaceToParent

#define GO(T) instance MonadWidget m => MonadWidget (T m) where liftWidgetT = lift . liftWidgetT
#define GOX(X, T) instance (X, MonadWidget m) => MonadWidget (T m) where liftWidgetT = lift . liftWidgetT
instanceGO(IdentityT)        m => MonadWidget (IdentityT m) where liftWidgetT = lift . liftWidgetT
instanceGO(ListT)MonadWidget m => MonadWidget (ListT m) where liftWidgetT = lift . liftWidgetT
instanceGO(MaybeTMonadWidget)           m => MonadWidget (MaybeT m) where liftWidgetT = lift . liftWidgetT
instanceGOX(Error(Errore, ErrorT, MonadWidgete)         m) => MonadWidget ( ErrorT e m) where liftWidgetT = lift . liftWidgetT
instanceGO(ReaderTr)        m => MonadWidget (ReaderT r m) where liftWidgetT = lift . liftWidgetT
instanceGO(StateTMonadWidgets)         m => MonadWidget (StateT s m) where liftWidgetT = lift . liftWidgetT
instanceGOX(MonoidMonoidw, WriterT, MonadWidgetw)        m) => MonadWidget ( WriterT w m) where liftWidgetT = lift . liftWidgetT
instanceGOX(MonoidMonoidw, RWST,rMonadWidgetw s)       m) => MonadWidget ( RWST r w s m) where liftWidgetT = lift . liftWidgetT
instanceGOX(MonoidMonoidw, Strict.RWST, MonadWidgetr w s)m) => MonadWidget ( Strict.RWST r w s m) where liftWidgetT = lift . liftWidgetT
instanceGO(Strict.StateTs)  m => MonadWidget (Strict.StateT s m) where liftWidgetT = lift . liftWidgetT
instanceGOX(MonoidMonoidw, Strict.WriterT, MonadWidgetw) m) => MonadWidget ( Strict.WriterT w m) where liftWidgetT = lift . liftWidgetT
instanceGO(Pipe lMonadWidgeti o u)     m => MonadWidget (Pipe l i o u m) where liftWidgetT = lift . liftWidgetT
instanceGO(ConduitMi o)     m => MonadWidget (ConduitM i o m) where liftWidgetT = lift . liftWidgetT
#undef GO
#undef GOX

</pre>