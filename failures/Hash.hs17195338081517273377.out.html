<a href="Hash.hs11477222941070477904.out.html">prev</a></br><a href="failures.html">home</a></br><a href="Hash1.hs8235644401115438165.out.html">next</a></br></br><pre>129c129
< DEFINE_INSTANCE(MD2, MD2, 16)
---
> dataDEFINE_INSTANCE = MD2 deriving(MD2, MD2Show, 16; instance HashAlgorithm MD2 where { hashInit = Context c where { ( MD2.Ctx c) =  MD2.init } ; hashBlockSize ~(Context _) =  16 ; hashUpdates (Context c) bs = Context nc where { ( MD2.Ctx nc) =  MD2.updates ( MD2.Ctx c) bs } ; hashFinalize (Context c) = Digest $  MD2.finalize ( MD2.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( MD2.finalize  MD2.init) } };
131c131
< DEFINE_INSTANCE(MD4, MD4, 64)
---
> dataDEFINE_INSTANCE = MD4 deriving(MD4, MD4Show, 64; instance HashAlgorithm MD4 where { hashInit = Context c where { ( MD4.Ctx c) =  MD4.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( MD4.Ctx nc) =  MD4.updates ( MD4.Ctx c) bs } ; hashFinalize (Context c) = Digest $  MD4.finalize ( MD4.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( MD4.finalize  MD4.init) } };
133c133
< DEFINE_INSTANCE(MD5, MD5, 64)
---
> dataDEFINE_INSTANCE = MD5 deriving(MD5, MD5Show, 64; instance HashAlgorithm MD5 where { hashInit = Context c where { ( MD5.Ctx c) =  MD5.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( MD5.Ctx nc) =  MD5.updates ( MD5.Ctx c) bs } ; hashFinalize (Context c) = Digest $  MD5.finalize ( MD5.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( MD5.finalize  MD5.init) } };
135c135
< DEFINE_INSTANCE(SHA1, SHA1, 64)
---
> dataDEFINE_INSTANCE = SHA1(SHA1, SHA1Show, 64; instance HashAlgorithm SHA1 where { hashInit = Context c where { ( SHA1.Ctx c) =  SHA1.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( SHA1.Ctx nc) =  SHA1.updates ( SHA1.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA1.finalize ( SHA1.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA1.finalize  SHA1.init) } };
137c137
< DEFINE_INSTANCE(SHA224, SHA224, 64)
---
> dataDEFINE_INSTANCE = SHA224(SHA224, SHA224Show, 64; instance HashAlgorithm SHA224 where { hashInit = Context c where { ( SHA224.Ctx c) =  SHA224.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( SHA224.Ctx nc) =  SHA224.updates ( SHA224.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA224.finalize ( SHA224.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA224.finalize  SHA224.init) } };
139c139
< DEFINE_INSTANCE(SHA256, SHA256, 64)
---
> dataDEFINE_INSTANCE = SHA256(SHA256, SHA256Show, 64; instance HashAlgorithm SHA256 where { hashInit = Context c where { ( SHA256.Ctx c) =  SHA256.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( SHA256.Ctx nc) =  SHA256.updates ( SHA256.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA256.finalize ( SHA256.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA256.finalize  SHA256.init) } };
141c141
< DEFINE_INSTANCE(SHA384, SHA384, 128)
---
> dataDEFINE_INSTANCE = SHA384(SHA384, SHA384Show, 128;)instance HashAlgorithm SHA384 where { hashInit = Context c where { ( SHA384.Ctx c) =  SHA384.init } ; hashBlockSize ~(Context _) =  128 ; hashUpdates (Context c) bs = Context nc where { ( SHA384.Ctx nc) =  SHA384.updates ( SHA384.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA384.finalize ( SHA384.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA384.finalize  SHA384.init) } };
143c143
< DEFINE_INSTANCE(SHA512, SHA512, 128)
---
> dataDEFINE_INSTANCE = SHA512(SHA512, SHA512Show, 128;)instance HashAlgorithm SHA512 where { hashInit = Context c where { ( SHA512.Ctx c) =  SHA512.init } ; hashBlockSize ~(Context _) =  128 ; hashUpdates (Context c) bs = Context nc where { ( SHA512.Ctx nc) =  SHA512.updates ( SHA512.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA512.finalize ( SHA512.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA512.finalize  SHA512.init) } };
146c146
< DEFINE_INSTANCE(RIPEMD160, RIPEMD160, 64)
---
> dataDEFINE_INSTANCE =RIPEMD160, derivingRIPEMD160Show, 64; instance HashAlgorithm RIPEMD160 where { hashInit = Context c where { ( RIPEMD160.Ctx c) =  RIPEMD160.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( RIPEMD160.Ctx nc) =  RIPEMD160.updates ( RIPEMD160.Ctx c) bs } ; hashFinalize (Context c) = Digest $  RIPEMD160.finalize ( RIPEMD160.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( RIPEMD160.finalize  RIPEMD160.init) } };
148c148
< DEFINE_INSTANCE(Whirlpool, Whirlpool, 64)
---
> dataDEFINE_INSTANCE =Whirlpool, derivingWhirlpoolShow, 64; instance HashAlgorithm Whirlpool where { hashInit = Context c where { ( Whirlpool.Ctx c) =  Whirlpool.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Whirlpool.Ctx nc) =  Whirlpool.updates ( Whirlpool.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Whirlpool.finalize ( Whirlpool.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Whirlpool.finalize  Whirlpool.init) } };
150c150
< DEFINE_INSTANCE(Tiger, Tiger, 64)
---
> dataDEFINE_INSTANCE = Tiger(Tiger, TigerShow, 64; instance HashAlgorithm Tiger where { hashInit = Context c where { ( Tiger.Ctx c) =  Tiger.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Tiger.Ctx nc) =  Tiger.updates ( Tiger.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Tiger.finalize ( Tiger.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Tiger.finalize  Tiger.init) } };
153c153
< DEFINE_INSTANCE_LEN(SHA3_224, SHA3, 224, 144)
---
> dataDEFINE_INSTANCE_LEN = SHA3_224(SHA3_224, SHA3Show, 224;,instance144)    HashAlgorithm SHA3_224 where { hashInit = Context c where { ( SHA3.Ctx c) =  SHA3.init  224 } ; hashBlockSize ~(Context _) =  144 ; hashUpdates (Context c) bs = Context nc where { ( SHA3.Ctx nc) =  SHA3.updates ( SHA3.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA3.finalize ( SHA3.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA3.finalize ( SHA3.init  224)) } };
155c155
< DEFINE_INSTANCE_LEN(SHA3_256, SHA3, 256, 136)
---
> dataDEFINE_INSTANCE_LEN = SHA3_256(SHA3_256, SHA3Show, 256;,instance136)    HashAlgorithm SHA3_256 where { hashInit = Context c where { ( SHA3.Ctx c) =  SHA3.init  256 } ; hashBlockSize ~(Context _) =  136 ; hashUpdates (Context c) bs = Context nc where { ( SHA3.Ctx nc) =  SHA3.updates ( SHA3.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA3.finalize ( SHA3.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA3.finalize ( SHA3.init  256)) } };
157c157
< DEFINE_INSTANCE_LEN(SHA3_384, SHA3, 384, 104)
---
> dataDEFINE_INSTANCE_LEN = SHA3_384(SHA3_384, SHA3Show, 384;,instance104)    HashAlgorithm SHA3_384 where { hashInit = Context c where { ( SHA3.Ctx c) =  SHA3.init  384 } ; hashBlockSize ~(Context _) =  104 ; hashUpdates (Context c) bs = Context nc where { ( SHA3.Ctx nc) =  SHA3.updates ( SHA3.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA3.finalize ( SHA3.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA3.finalize ( SHA3.init  384)) } };
159c159
< DEFINE_INSTANCE_LEN(SHA3_512, SHA3, 512, 72)
---
> dataDEFINE_INSTANCE_LEN = SHA3_512(SHA3_512, SHA3Show, 512;,instance72)     HashAlgorithm SHA3_512 where { hashInit = Context c where { ( SHA3.Ctx c) =  SHA3.init  512 } ; hashBlockSize ~(Context _) =  72 ; hashUpdates (Context c) bs = Context nc where { ( SHA3.Ctx nc) =  SHA3.updates ( SHA3.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA3.finalize ( SHA3.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA3.finalize ( SHA3.init  512)) } };
162c162
< DEFINE_INSTANCE_LEN(Skein256_224, Skein256, 224, 32)
---
> dataDEFINE_INSTANCE_LEN =(Skein256_224,derivingSkein256Show, 224;,instance32)     HashAlgorithm Skein256_224 where { hashInit = Context c where { ( Skein256.Ctx c) =  Skein256.init  224 } ; hashBlockSize ~(Context _) =  32 ; hashUpdates (Context c) bs = Context nc where { ( Skein256.Ctx nc) =  Skein256.updates ( Skein256.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein256.finalize ( Skein256.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein256.finalize ( Skein256.init  224)) } };
164c164
< DEFINE_INSTANCE_LEN(Skein256_256, Skein256, 256, 32)
---
> dataDEFINE_INSTANCE_LEN =(Skein256_256,derivingSkein256Show, 256;,instance32)     HashAlgorithm Skein256_256 where { hashInit = Context c where { ( Skein256.Ctx c) =  Skein256.init  256 } ; hashBlockSize ~(Context _) =  32 ; hashUpdates (Context c) bs = Context nc where { ( Skein256.Ctx nc) =  Skein256.updates ( Skein256.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein256.finalize ( Skein256.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein256.finalize ( Skein256.init  256)) } };
167c167
< DEFINE_INSTANCE_LEN(Skein512_224, Skein512, 224, 64)
---
> dataDEFINE_INSTANCE_LEN =(Skein512_224,derivingSkein512Show, 224;,instance64)     HashAlgorithm Skein512_224 where { hashInit = Context c where { ( Skein512.Ctx c) =  Skein512.init  224 } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Skein512.Ctx nc) =  Skein512.updates ( Skein512.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein512.finalize ( Skein512.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein512.finalize ( Skein512.init  224)) } };
169c169
< DEFINE_INSTANCE_LEN(Skein512_256, Skein512, 256, 64)
---
> dataDEFINE_INSTANCE_LEN =(Skein512_256,derivingSkein512Show, 256;,instance64)     HashAlgorithm Skein512_256 where { hashInit = Context c where { ( Skein512.Ctx c) =  Skein512.init  256 } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Skein512.Ctx nc) =  Skein512.updates ( Skein512.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein512.finalize ( Skein512.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein512.finalize ( Skein512.init  256)) } };
171c171
< DEFINE_INSTANCE_LEN(Skein512_384, Skein512, 384, 64)
---
> dataDEFINE_INSTANCE_LEN =(Skein512_384,derivingSkein512Show, 384;,instance64)     HashAlgorithm Skein512_384 where { hashInit = Context c where { ( Skein512.Ctx c) =  Skein512.init  384 } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Skein512.Ctx nc) =  Skein512.updates ( Skein512.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein512.finalize ( Skein512.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein512.finalize ( Skein512.init  384)) } };
173c173
< DEFINE_INSTANCE_LEN(Skein512_512, Skein512, 512, 64)
---
> dataDEFINE_INSTANCE_LEN =(Skein512_512,derivingSkein512Show, 512;,instance64)     HashAlgorithm Skein512_512 where { hashInit = Context c where { ( Skein512.Ctx c) =  Skein512.init  512 } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Skein512.Ctx nc) =  Skein512.updates ( Skein512.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein512.finalize ( Skein512.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein512.finalize ( Skein512.init  512)) } };
213a214
> 
</pre></br><h2>original</h2></br><pre>{-# LANGUAGE CPP #-}
-- |
-- Module      : Crypto.Hash
-- License     : BSD-style
-- Maintainer  : Vincent Hanquez <vincent@snarc.org>
-- Stability   : experimental
-- Portability : unknown
--
-- Generalized cryptographic hash interface, that you can use with cryptographic hash
-- algorithm that belong to the HashAlgorithm type class.
--
-- > import Crypto.Hash
-- >
-- > sha1 :: ByteString -> Digest SHA1
-- > sha1 = hash
-- >
-- > hexSha3_512 :: ByteString -> String
-- > hexSha3_512 bs = show (hash bs :: Digest SHA3_512)
--
module Crypto.Hash
    (
    -- * Types
      HashAlgorithm(..)
    , HashFunctionBS
    , HashFunctionLBS
    , Context
    , Digest
    -- * Functions
    , digestToByteString
    , digestToHexByteString
    , hash
    , hashlazy
    , hashUpdate
    , hashInitAlg
    -- * hash algorithms
    , MD2(..)
    , MD4(..)
    , MD5(..)
    , SHA1(..)
    , SHA224(..)
    , SHA256(..)
    , SHA384(..)
    , SHA512(..)
    , RIPEMD160(..)
    , Tiger(..)
    , SHA3_224(..)
    , SHA3_256(..)
    , SHA3_384(..)
    , SHA3_512(..)
    , Skein256_224(..)
    , Skein256_256(..)
    , Skein512_224(..)
    , Skein512_256(..)
    , Skein512_384(..)
    , Skein512_512(..)
    , Whirlpool(..)
    -- * MAC algorithms
    , HMAC(..)
    , hmac
    , hmacAlg
    ) where

import Crypto.Hash.Types
import Crypto.Hash.Utils
import Data.ByteString (ByteString)
import Data.Byteable
import Data.Bits (xor)
import qualified Data.ByteString as B
import qualified Data.ByteString.Lazy as L

import qualified Crypto.Hash.MD2 as MD2
import qualified Crypto.Hash.MD4 as MD4
import qualified Crypto.Hash.MD5 as MD5
import qualified Crypto.Hash.SHA1 as SHA1
import qualified Crypto.Hash.SHA224 as SHA224
import qualified Crypto.Hash.SHA256 as SHA256
import qualified Crypto.Hash.SHA384 as SHA384
import qualified Crypto.Hash.SHA512 as SHA512
import qualified Crypto.Hash.SHA3 as SHA3
import qualified Crypto.Hash.RIPEMD160 as RIPEMD160
import qualified Crypto.Hash.Tiger as Tiger
import qualified Crypto.Hash.Skein256 as Skein256
import qualified Crypto.Hash.Skein512 as Skein512
import qualified Crypto.Hash.Whirlpool as Whirlpool

-- | Alias to a single pass hash function that operate on a strict bytestring
type HashFunctionBS a = ByteString -> Digest a

-- | Alias to a single pass hash function that operate on a lazy bytestring
type HashFunctionLBS a = L.ByteString -> Digest a

-- | run hashUpdates on one single bytestring and return the updated context.
hashUpdate :: HashAlgorithm a => Context a -> ByteString -> Context a
hashUpdate ctx b = hashUpdates ctx [b]

-- | Hash a strict bytestring into a digest.
hash :: HashAlgorithm a => ByteString -> Digest a
hash bs = hashFinalize $ hashUpdate hashInit bs

-- | Hash a lazy bytestring into a digest.
hashlazy :: HashAlgorithm a => L.ByteString -> Digest a
hashlazy lbs = hashFinalize $ hashUpdates hashInit (L.toChunks lbs)

-- | Return the hexadecimal (base16) bytestring of the digest
digestToHexByteString :: Digest a -> ByteString
digestToHexByteString = toHex . toBytes

#define DEFINE_INSTANCE(NAME, MODULENAME, BLOCKSIZE) \
data NAME = NAME deriving Show; \
instance HashAlgorithm NAME where \
    { hashInit = Context c where { (MODULENAME.Ctx c) = MODULENAME.init } \
    ; hashBlockSize ~(Context _) = BLOCKSIZE \
    ; hashUpdates (Context c) bs = Context nc where { (MODULENAME.Ctx nc) = MODULENAME.updates (MODULENAME.Ctx c) bs } \
    ; hashFinalize (Context c) = Digest $ MODULENAME.finalize (MODULENAME.Ctx c) \
    ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length (MODULENAME.finalize MODULENAME.init) } \
    };

#define DEFINE_INSTANCE_LEN(NAME, MODULENAME, LEN, BLOCKSIZE) \
data NAME = NAME deriving Show; \
instance HashAlgorithm NAME where \
    { hashInit = Context c where { (MODULENAME.Ctx c) = MODULENAME.init LEN } \
    ; hashBlockSize ~(Context _) = BLOCKSIZE \
    ; hashUpdates (Context c) bs = Context nc where { (MODULENAME.Ctx nc) = MODULENAME.updates (MODULENAME.Ctx c) bs } \
    ; hashFinalize (Context c) = Digest $ MODULENAME.finalize (MODULENAME.Ctx c) \
    ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length (MODULENAME.finalize (MODULENAME.init LEN)) } \
    };

-- | MD2 cryptographic hash
DEFINE_INSTANCE(MD2, MD2, 16)
-- | MD4 cryptographic hash
DEFINE_INSTANCE(MD4, MD4, 64)
-- | MD5 cryptographic hash
DEFINE_INSTANCE(MD5, MD5, 64)
-- | SHA1 cryptographic hash
DEFINE_INSTANCE(SHA1, SHA1, 64)
-- | SHA224 cryptographic hash
DEFINE_INSTANCE(SHA224, SHA224, 64)
-- | SHA256 cryptographic hash
DEFINE_INSTANCE(SHA256, SHA256, 64)
-- | SHA384 cryptographic hash
DEFINE_INSTANCE(SHA384, SHA384, 128)
-- | SHA512 cryptographic hash
DEFINE_INSTANCE(SHA512, SHA512, 128)

-- | RIPEMD160 cryptographic hash
DEFINE_INSTANCE(RIPEMD160, RIPEMD160, 64)
-- | Whirlpool cryptographic hash
DEFINE_INSTANCE(Whirlpool, Whirlpool, 64)
-- | Tiger cryptographic hash
DEFINE_INSTANCE(Tiger, Tiger, 64)

-- | SHA3 (224 bits version) cryptographic hash
DEFINE_INSTANCE_LEN(SHA3_224, SHA3, 224, 144)
-- | SHA3 (256 bits version) cryptographic hash
DEFINE_INSTANCE_LEN(SHA3_256, SHA3, 256, 136)
-- | SHA3 (384 bits version) cryptographic hash
DEFINE_INSTANCE_LEN(SHA3_384, SHA3, 384, 104)
-- | SHA3 (512 bits version) cryptographic hash
DEFINE_INSTANCE_LEN(SHA3_512, SHA3, 512, 72)

-- | Skein256 (224 bits version) cryptographic hash
DEFINE_INSTANCE_LEN(Skein256_224, Skein256, 224, 32)
-- | Skein256 (256 bits version) cryptographic hash
DEFINE_INSTANCE_LEN(Skein256_256, Skein256, 256, 32)

-- | Skein512 (224 bits version) cryptographic hash
DEFINE_INSTANCE_LEN(Skein512_224, Skein512, 224, 64)
-- | Skein512 (256 bits version) cryptographic hash
DEFINE_INSTANCE_LEN(Skein512_256, Skein512, 256, 64)
-- | Skein512 (384 bits version) cryptographic hash
DEFINE_INSTANCE_LEN(Skein512_384, Skein512, 384, 64)
-- | Skein512 (512 bits version) cryptographic hash
DEFINE_INSTANCE_LEN(Skein512_512, Skein512, 512, 64)

-- | Initialize a new context for a specified hash algorithm
hashInitAlg :: HashAlgorithm alg => alg -> Context alg
hashInitAlg _ = hashInit

-- | Represent an HMAC that is a phantom type with the hash used to produce the mac.
--
-- The Eq instance is constant time.
newtype HMAC a = HMAC { hmacGetDigest :: Digest a }

instance Byteable (HMAC a) where
    toBytes (HMAC b) = toBytes b

instance Eq (HMAC a) where
    (HMAC b1) == (HMAC b2) = constEqBytes (toBytes b1) (toBytes b2)

-- | compute a MAC using the supplied hashing function
hmac :: HashAlgorithm a
     => ByteString       -- ^ Secret key
     -> ByteString       -- ^ Message to MAC
     -> HMAC a
hmac secret msg = doHMAC hashInit
  where doHMAC :: HashAlgorithm a => Context a -> HMAC a
        doHMAC ctxInit = HMAC $ hashF $ B.append opad (toBytes $ hashF $ B.append ipad msg)
          where opad = B.map (xor 0x5c) k'
                ipad = B.map (xor 0x36) k'

                k'  = B.append kt pad
                kt  = if B.length secret > fromIntegral blockSize then toBytes (hashF secret) else secret
                pad = B.replicate (fromIntegral blockSize - B.length kt) 0
                hashF = hashFinalize . hashUpdate ctxInit
                blockSize = hashBlockSize ctxInit

-- | compute a HMAC using a specified algorithm
hmacAlg :: HashAlgorithm a
        => a           -- ^ the hash algorithm the actual value is unused.
        -> ByteString  -- ^ Secret key
        -> ByteString  -- ^ Message to MAC
        -> HMAC a
hmacAlg _ secret msg = hmac secret msg
</pre></br><h2>printed</h2></br><pre>{-# LANGUAGE CPP #-}
-- |
-- Module      : Crypto.Hash
-- License     : BSD-style
-- Maintainer  : Vincent Hanquez <vincent@snarc.org>
-- Stability   : experimental
-- Portability : unknown
--
-- Generalized cryptographic hash interface, that you can use with cryptographic hash
-- algorithm that belong to the HashAlgorithm type class.
--
-- > import Crypto.Hash
-- >
-- > sha1 :: ByteString -> Digest SHA1
-- > sha1 = hash
-- >
-- > hexSha3_512 :: ByteString -> String
-- > hexSha3_512 bs = show (hash bs :: Digest SHA3_512)
--
module Crypto.Hash
    (
    -- * Types
      HashAlgorithm(..)
    , HashFunctionBS
    , HashFunctionLBS
    , Context
    , Digest
    -- * Functions
    , digestToByteString
    , digestToHexByteString
    , hash
    , hashlazy
    , hashUpdate
    , hashInitAlg
    -- * hash algorithms
    , MD2(..)
    , MD4(..)
    , MD5(..)
    , SHA1(..)
    , SHA224(..)
    , SHA256(..)
    , SHA384(..)
    , SHA512(..)
    , RIPEMD160(..)
    , Tiger(..)
    , SHA3_224(..)
    , SHA3_256(..)
    , SHA3_384(..)
    , SHA3_512(..)
    , Skein256_224(..)
    , Skein256_256(..)
    , Skein512_224(..)
    , Skein512_256(..)
    , Skein512_384(..)
    , Skein512_512(..)
    , Whirlpool(..)
    -- * MAC algorithms
    , HMAC(..)
    , hmac
    , hmacAlg
    ) where

import Crypto.Hash.Types
import Crypto.Hash.Utils
import Data.ByteString (ByteString)
import Data.Byteable
import Data.Bits (xor)
import qualified Data.ByteString as B
import qualified Data.ByteString.Lazy as L

import qualified Crypto.Hash.MD2 as MD2
import qualified Crypto.Hash.MD4 as MD4
import qualified Crypto.Hash.MD5 as MD5
import qualified Crypto.Hash.SHA1 as SHA1
import qualified Crypto.Hash.SHA224 as SHA224
import qualified Crypto.Hash.SHA256 as SHA256
import qualified Crypto.Hash.SHA384 as SHA384
import qualified Crypto.Hash.SHA512 as SHA512
import qualified Crypto.Hash.SHA3 as SHA3
import qualified Crypto.Hash.RIPEMD160 as RIPEMD160
import qualified Crypto.Hash.Tiger as Tiger
import qualified Crypto.Hash.Skein256 as Skein256
import qualified Crypto.Hash.Skein512 as Skein512
import qualified Crypto.Hash.Whirlpool as Whirlpool

-- | Alias to a single pass hash function that operate on a strict bytestring
type HashFunctionBS a = ByteString -> Digest a

-- | Alias to a single pass hash function that operate on a lazy bytestring
type HashFunctionLBS a = L.ByteString -> Digest a

-- | run hashUpdates on one single bytestring and return the updated context.
hashUpdate :: HashAlgorithm a => Context a -> ByteString -> Context a
hashUpdate ctx b = hashUpdates ctx [b]

-- | Hash a strict bytestring into a digest.
hash :: HashAlgorithm a => ByteString -> Digest a
hash bs = hashFinalize $ hashUpdate hashInit bs

-- | Hash a lazy bytestring into a digest.
hashlazy :: HashAlgorithm a => L.ByteString -> Digest a
hashlazy lbs = hashFinalize $ hashUpdates hashInit (L.toChunks lbs)

-- | Return the hexadecimal (base16) bytestring of the digest
digestToHexByteString :: Digest a -> ByteString
digestToHexByteString = toHex . toBytes

#define DEFINE_INSTANCE(NAME, MODULENAME, BLOCKSIZE) \
data NAME = NAME deriving Show; \
instance HashAlgorithm NAME where \
    { hashInit = Context c where { (MODULENAME.Ctx c) = MODULENAME.init } \
    ; hashBlockSize ~(Context _) = BLOCKSIZE \
    ; hashUpdates (Context c) bs = Context nc where { (MODULENAME.Ctx nc) = MODULENAME.updates (MODULENAME.Ctx c) bs } \
    ; hashFinalize (Context c) = Digest $ MODULENAME.finalize (MODULENAME.Ctx c) \
    ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length (MODULENAME.finalize MODULENAME.init) } \
    };

#define DEFINE_INSTANCE_LEN(NAME, MODULENAME, LEN, BLOCKSIZE) \
data NAME = NAME deriving Show; \
instance HashAlgorithm NAME where \
    { hashInit = Context c where { (MODULENAME.Ctx c) = MODULENAME.init LEN } \
    ; hashBlockSize ~(Context _) = BLOCKSIZE \
    ; hashUpdates (Context c) bs = Context nc where { (MODULENAME.Ctx nc) = MODULENAME.updates (MODULENAME.Ctx c) bs } \
    ; hashFinalize (Context c) = Digest $ MODULENAME.finalize (MODULENAME.Ctx c) \
    ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length (MODULENAME.finalize (MODULENAME.init LEN)) } \
    };

-- | MD2 cryptographic hash
dataDEFINE_INSTANCE = MD2 deriving(MD2, MD2Show, 16; instance HashAlgorithm MD2 where { hashInit = Context c where { ( MD2.Ctx c) =  MD2.init } ; hashBlockSize ~(Context _) =  16 ; hashUpdates (Context c) bs = Context nc where { ( MD2.Ctx nc) =  MD2.updates ( MD2.Ctx c) bs } ; hashFinalize (Context c) = Digest $  MD2.finalize ( MD2.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( MD2.finalize  MD2.init) } };
-- | MD4 cryptographic hash
dataDEFINE_INSTANCE = MD4 deriving(MD4, MD4Show, 64; instance HashAlgorithm MD4 where { hashInit = Context c where { ( MD4.Ctx c) =  MD4.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( MD4.Ctx nc) =  MD4.updates ( MD4.Ctx c) bs } ; hashFinalize (Context c) = Digest $  MD4.finalize ( MD4.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( MD4.finalize  MD4.init) } };
-- | MD5 cryptographic hash
dataDEFINE_INSTANCE = MD5 deriving(MD5, MD5Show, 64; instance HashAlgorithm MD5 where { hashInit = Context c where { ( MD5.Ctx c) =  MD5.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( MD5.Ctx nc) =  MD5.updates ( MD5.Ctx c) bs } ; hashFinalize (Context c) = Digest $  MD5.finalize ( MD5.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( MD5.finalize  MD5.init) } };
-- | SHA1 cryptographic hash
dataDEFINE_INSTANCE = SHA1(SHA1, SHA1Show, 64; instance HashAlgorithm SHA1 where { hashInit = Context c where { ( SHA1.Ctx c) =  SHA1.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( SHA1.Ctx nc) =  SHA1.updates ( SHA1.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA1.finalize ( SHA1.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA1.finalize  SHA1.init) } };
-- | SHA224 cryptographic hash
dataDEFINE_INSTANCE = SHA224(SHA224, SHA224Show, 64; instance HashAlgorithm SHA224 where { hashInit = Context c where { ( SHA224.Ctx c) =  SHA224.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( SHA224.Ctx nc) =  SHA224.updates ( SHA224.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA224.finalize ( SHA224.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA224.finalize  SHA224.init) } };
-- | SHA256 cryptographic hash
dataDEFINE_INSTANCE = SHA256(SHA256, SHA256Show, 64; instance HashAlgorithm SHA256 where { hashInit = Context c where { ( SHA256.Ctx c) =  SHA256.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( SHA256.Ctx nc) =  SHA256.updates ( SHA256.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA256.finalize ( SHA256.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA256.finalize  SHA256.init) } };
-- | SHA384 cryptographic hash
dataDEFINE_INSTANCE = SHA384(SHA384, SHA384Show, 128;)instance HashAlgorithm SHA384 where { hashInit = Context c where { ( SHA384.Ctx c) =  SHA384.init } ; hashBlockSize ~(Context _) =  128 ; hashUpdates (Context c) bs = Context nc where { ( SHA384.Ctx nc) =  SHA384.updates ( SHA384.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA384.finalize ( SHA384.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA384.finalize  SHA384.init) } };
-- | SHA512 cryptographic hash
dataDEFINE_INSTANCE = SHA512(SHA512, SHA512Show, 128;)instance HashAlgorithm SHA512 where { hashInit = Context c where { ( SHA512.Ctx c) =  SHA512.init } ; hashBlockSize ~(Context _) =  128 ; hashUpdates (Context c) bs = Context nc where { ( SHA512.Ctx nc) =  SHA512.updates ( SHA512.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA512.finalize ( SHA512.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA512.finalize  SHA512.init) } };

-- | RIPEMD160 cryptographic hash
dataDEFINE_INSTANCE =RIPEMD160, derivingRIPEMD160Show, 64; instance HashAlgorithm RIPEMD160 where { hashInit = Context c where { ( RIPEMD160.Ctx c) =  RIPEMD160.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( RIPEMD160.Ctx nc) =  RIPEMD160.updates ( RIPEMD160.Ctx c) bs } ; hashFinalize (Context c) = Digest $  RIPEMD160.finalize ( RIPEMD160.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( RIPEMD160.finalize  RIPEMD160.init) } };
-- | Whirlpool cryptographic hash
dataDEFINE_INSTANCE =Whirlpool, derivingWhirlpoolShow, 64; instance HashAlgorithm Whirlpool where { hashInit = Context c where { ( Whirlpool.Ctx c) =  Whirlpool.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Whirlpool.Ctx nc) =  Whirlpool.updates ( Whirlpool.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Whirlpool.finalize ( Whirlpool.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Whirlpool.finalize  Whirlpool.init) } };
-- | Tiger cryptographic hash
dataDEFINE_INSTANCE = Tiger(Tiger, TigerShow, 64; instance HashAlgorithm Tiger where { hashInit = Context c where { ( Tiger.Ctx c) =  Tiger.init } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Tiger.Ctx nc) =  Tiger.updates ( Tiger.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Tiger.finalize ( Tiger.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Tiger.finalize  Tiger.init) } };

-- | SHA3 (224 bits version) cryptographic hash
dataDEFINE_INSTANCE_LEN = SHA3_224(SHA3_224, SHA3Show, 224;,instance144)    HashAlgorithm SHA3_224 where { hashInit = Context c where { ( SHA3.Ctx c) =  SHA3.init  224 } ; hashBlockSize ~(Context _) =  144 ; hashUpdates (Context c) bs = Context nc where { ( SHA3.Ctx nc) =  SHA3.updates ( SHA3.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA3.finalize ( SHA3.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA3.finalize ( SHA3.init  224)) } };
-- | SHA3 (256 bits version) cryptographic hash
dataDEFINE_INSTANCE_LEN = SHA3_256(SHA3_256, SHA3Show, 256;,instance136)    HashAlgorithm SHA3_256 where { hashInit = Context c where { ( SHA3.Ctx c) =  SHA3.init  256 } ; hashBlockSize ~(Context _) =  136 ; hashUpdates (Context c) bs = Context nc where { ( SHA3.Ctx nc) =  SHA3.updates ( SHA3.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA3.finalize ( SHA3.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA3.finalize ( SHA3.init  256)) } };
-- | SHA3 (384 bits version) cryptographic hash
dataDEFINE_INSTANCE_LEN = SHA3_384(SHA3_384, SHA3Show, 384;,instance104)    HashAlgorithm SHA3_384 where { hashInit = Context c where { ( SHA3.Ctx c) =  SHA3.init  384 } ; hashBlockSize ~(Context _) =  104 ; hashUpdates (Context c) bs = Context nc where { ( SHA3.Ctx nc) =  SHA3.updates ( SHA3.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA3.finalize ( SHA3.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA3.finalize ( SHA3.init  384)) } };
-- | SHA3 (512 bits version) cryptographic hash
dataDEFINE_INSTANCE_LEN = SHA3_512(SHA3_512, SHA3Show, 512;,instance72)     HashAlgorithm SHA3_512 where { hashInit = Context c where { ( SHA3.Ctx c) =  SHA3.init  512 } ; hashBlockSize ~(Context _) =  72 ; hashUpdates (Context c) bs = Context nc where { ( SHA3.Ctx nc) =  SHA3.updates ( SHA3.Ctx c) bs } ; hashFinalize (Context c) = Digest $  SHA3.finalize ( SHA3.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( SHA3.finalize ( SHA3.init  512)) } };

-- | Skein256 (224 bits version) cryptographic hash
dataDEFINE_INSTANCE_LEN =(Skein256_224,derivingSkein256Show, 224;,instance32)     HashAlgorithm Skein256_224 where { hashInit = Context c where { ( Skein256.Ctx c) =  Skein256.init  224 } ; hashBlockSize ~(Context _) =  32 ; hashUpdates (Context c) bs = Context nc where { ( Skein256.Ctx nc) =  Skein256.updates ( Skein256.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein256.finalize ( Skein256.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein256.finalize ( Skein256.init  224)) } };
-- | Skein256 (256 bits version) cryptographic hash
dataDEFINE_INSTANCE_LEN =(Skein256_256,derivingSkein256Show, 256;,instance32)     HashAlgorithm Skein256_256 where { hashInit = Context c where { ( Skein256.Ctx c) =  Skein256.init  256 } ; hashBlockSize ~(Context _) =  32 ; hashUpdates (Context c) bs = Context nc where { ( Skein256.Ctx nc) =  Skein256.updates ( Skein256.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein256.finalize ( Skein256.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein256.finalize ( Skein256.init  256)) } };

-- | Skein512 (224 bits version) cryptographic hash
dataDEFINE_INSTANCE_LEN =(Skein512_224,derivingSkein512Show, 224;,instance64)     HashAlgorithm Skein512_224 where { hashInit = Context c where { ( Skein512.Ctx c) =  Skein512.init  224 } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Skein512.Ctx nc) =  Skein512.updates ( Skein512.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein512.finalize ( Skein512.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein512.finalize ( Skein512.init  224)) } };
-- | Skein512 (256 bits version) cryptographic hash
dataDEFINE_INSTANCE_LEN =(Skein512_256,derivingSkein512Show, 256;,instance64)     HashAlgorithm Skein512_256 where { hashInit = Context c where { ( Skein512.Ctx c) =  Skein512.init  256 } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Skein512.Ctx nc) =  Skein512.updates ( Skein512.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein512.finalize ( Skein512.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein512.finalize ( Skein512.init  256)) } };
-- | Skein512 (384 bits version) cryptographic hash
dataDEFINE_INSTANCE_LEN =(Skein512_384,derivingSkein512Show, 384;,instance64)     HashAlgorithm Skein512_384 where { hashInit = Context c where { ( Skein512.Ctx c) =  Skein512.init  384 } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Skein512.Ctx nc) =  Skein512.updates ( Skein512.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein512.finalize ( Skein512.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein512.finalize ( Skein512.init  384)) } };
-- | Skein512 (512 bits version) cryptographic hash
dataDEFINE_INSTANCE_LEN =(Skein512_512,derivingSkein512Show, 512;,instance64)     HashAlgorithm Skein512_512 where { hashInit = Context c where { ( Skein512.Ctx c) =  Skein512.init  512 } ; hashBlockSize ~(Context _) =  64 ; hashUpdates (Context c) bs = Context nc where { ( Skein512.Ctx nc) =  Skein512.updates ( Skein512.Ctx c) bs } ; hashFinalize (Context c) = Digest $  Skein512.finalize ( Skein512.Ctx c) ; digestFromByteString bs = if B.length bs == len then (Just $ Digest bs) else Nothing where { len = B.length ( Skein512.finalize ( Skein512.init  512)) } };

-- | Initialize a new context for a specified hash algorithm
hashInitAlg :: HashAlgorithm alg => alg -> Context alg
hashInitAlg _ = hashInit

-- | Represent an HMAC that is a phantom type with the hash used to produce the mac.
--
-- The Eq instance is constant time.
newtype HMAC a = HMAC { hmacGetDigest :: Digest a }

instance Byteable (HMAC a) where
    toBytes (HMAC b) = toBytes b

instance Eq (HMAC a) where
    (HMAC b1) == (HMAC b2) = constEqBytes (toBytes b1) (toBytes b2)

-- | compute a MAC using the supplied hashing function
hmac :: HashAlgorithm a
     => ByteString       -- ^ Secret key
     -> ByteString       -- ^ Message to MAC
     -> HMAC a
hmac secret msg = doHMAC hashInit
  where doHMAC :: HashAlgorithm a => Context a -> HMAC a
        doHMAC ctxInit = HMAC $ hashF $ B.append opad (toBytes $ hashF $ B.append ipad msg)
          where opad = B.map (xor 0x5c) k'
                ipad = B.map (xor 0x36) k'

                k'  = B.append kt pad
                kt  = if B.length secret > fromIntegral blockSize then toBytes (hashF secret) else secret
                pad = B.replicate (fromIntegral blockSize - B.length kt) 0
                hashF = hashFinalize . hashUpdate ctxInit
                blockSize = hashBlockSize ctxInit

-- | compute a HMAC using a specified algorithm
hmacAlg :: HashAlgorithm a
        => a           -- ^ the hash algorithm the actual value is unused.
        -> ByteString  -- ^ Secret key
        -> ByteString  -- ^ Message to MAC
        -> HMAC a
hmacAlg _ secret msg = hmac secret msg

</pre>