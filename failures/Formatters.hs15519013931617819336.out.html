<a href="Formats.hs15320627671049997439.out.html">prev</a></br><a href="failures.html">home</a></br><a href="Formatters.hs5298553951812423303.out.html">next</a></br></br><pre>31c31
< startFormat ∷ Formatter c
---
> startFormat :: Formatter c
35c35
< outString ∷ String → Formatter c
---
> outString :: String -> Formatter c
39c39
< newLine ∷ Formatter c
---
> newLine :: Formatter c
44c44
<   (<++>) ∷ Formatter c → a → Formatter c
---
>   (<++>) :: Formatter c -> a -> Formatter c
50c50
<   cm <++> s = cm <++> ((return [OutString s]) ∷ Formatter c)
---
>   cm <++> s = cm <++> ((return [OutString s]) :: Formatter c)
52c52
< setBold ∷  IO ()
---
> setBold ::  IO ()
55c55
< setColor ∷ ColorIntensity → Color → IO ()
---
> setColor :: ColorIntensity -> Color -> IO ()
59c59
< reset ∷  IO ()
---
> reset ::  IO ()
63c63
< outItem ∷  OutItem → IO ()
---
> outItem ::  OutItem -> IO ()
71c71
<   configShow ∷ s → Formatter c
---
>   configShow :: s -> Formatter c
80c80
< bold ∷ (RuntimeConfig (PrintConfig c)) ⇒ TodoItem → Formatter c
---
> bold :: (RuntimeConfig (PrintConfig c)) => TodoItem -> Formatter c
83d82
<   showColors ← askBase outColors
84d82
<   hlOn ← askBase outHighlight
85d82
<   getclr ← asks printItemColor
86d82
<   hlPred ← asks doHighlight
87c83
<   (hlInt, hlClr) ← asks printHighlightColor
---
>   showColors <- askBase outColors
87a84
>   hlOn <- askBase outHighlight
87a85
>   getclr <- asks printItemColor
87a86
>   hlPred <- asks doHighlight
87a87
>   (hlInt, hlClr) <- asks printHighlightColor
92d91
<                            Nothing        → [SetBold, OutString s, ResetAll]
93c92
<                            Just (int,clr) → [SetBold, OutSetColor int clr, OutString s, ResetAll]
---
>                            Nothing        -> [SetBold, OutString s, ResetAll]
93a93
>                            Just (int,clr) -> [SetBold, OutSetColor int clr, OutString s, ResetAll]
97c97
< colorStatus ∷ (RuntimeConfig (PrintConfig c)) ⇒ String → Formatter c
---
> colorStatus :: (RuntimeConfig (PrintConfig c)) => String -> Formatter c
99c99
<   getclr ← asks printStatusColor
---
>   getclr <- asks printStatusColor
104c104
< colored ∷ (RuntimeConfig (PrintConfig c)) ⇒ ColorIntensity → Color → String → Formatter c
---
> colored :: (RuntimeConfig (PrintConfig c)) => ColorIntensity -> Color -> String -> Formatter c
106c106
<   col ← askBase outColors
---
>   col <- askBase outColors
111c111
< printM ∷ (RuntimeConfig (PrintConfig c)) ⇒ TodoItem → Formatter c
---
> printM :: (RuntimeConfig (PrintConfig c)) => TodoItem -> Formatter c
114c114
<     printf :: (RuntimeConfig (PrintConfig c)) ⇒ String → Formatter c
---
>     printf :: (RuntimeConfig (PrintConfig c)) => String -> Formatter c
119c119
<     printf (x:xs)      = do r ← printf xs
---
>     printf (x:xs)      = do r <- printf xs
134c134
<     itemPart ∷ (RuntimeConfig (PrintConfig c)) ⇒ Char → Formatter c
---
>     itemPart :: (RuntimeConfig (PrintConfig c)) => Char -> Formatter c
151d150
< instance (RuntimeConfig (PrintConfig c)) ⇒ ConfigShow c TodoItem where
152c151
<     configShow item = (startFormat ∷ Formatter c) <++> (printM item ∷ Formatter c)
---
> instance (RuntimeConfig (PrintConfig c)) => ConfigShow c TodoItem where
152a152
>     configShow item = (startFormat :: Formatter c) <++> (printM item :: Formatter c)
152a153
> 
</pre></br><h2>original</h2></br><pre>{-# LANGUAGE UnicodeSyntax, TypeSynonymInstances, MultiParamTypeClasses, FlexibleInstances, ScopedTypeVariables, FlexibleContexts, UndecidableInstances #-}
module Todos.Formatters
  (OutItem (..),
   Formatter,
   outItem,
   startFormat, newLine,
   ConfigShow (..),
   ConfigAdd (..)
  ) where

import Prelude.Unicode
import Control.Monad
import Control.Monad.Reader
import System.Console.ANSI

import Todos.Types
import Todos.Config
-- import Todos.Default.ConfigInstances ()

-- | Item which could be printed to the console
data OutItem = OutString String
             | OutSetColor ColorIntensity Color
             | SetBold
             | ResetAll
    deriving (Show)

-- | Produce a list of OutItem's depending on PrintConfig
type Formatter c = Reader (PrintConfig c) [OutItem]

-- | Empty Formatter
startFormat ∷ Formatter c
startFormat = return []

-- | Output given string
outString ∷ String → Formatter c
outString s = return [OutString s]

-- | Output new line
newLine ∷ Formatter c
newLine = outString "\n"

class ConfigAdd c a where
  -- | Execute Formatter and a consequently
  (<++>) ∷ Formatter c → a → Formatter c

instance ConfigAdd c (Formatter c) where
  (<++>) = liftM2 (⧺)

instance ConfigAdd c String where
  cm <++> s = cm <++> ((return [OutString s]) ∷ Formatter c)

setBold ∷  IO ()
setBold = setSGR [SetConsoleIntensity BoldIntensity]

setColor ∷ ColorIntensity → Color → IO ()
setColor int clr = setSGR [SetColor Foreground int clr]

-- | Reset all (color, bold, ...) attributes
reset ∷  IO ()
reset = setSGR []

-- | Print OutItem to console
outItem ∷  OutItem → IO ()
outItem (OutString s)   = putStr s
outItem (OutSetColor i c) = setColor i c
outItem SetBold         = setBold
outItem ResetAll        = reset

-- | Similar to Show, but output can depend on PrintConfig
class ConfigShow c s where
  configShow ∷ s → Formatter c

instance ConfigShow c String where
  configShow s = return [OutString s]

instance ConfigShow c (Formatter c) where
  configShow = id

-- | Output bold (and maybe colored) item name
bold ∷ (RuntimeConfig (PrintConfig c)) ⇒ TodoItem → Formatter c
bold item = do
  let s = itemName item
  showColors ← askBase outColors
  hlOn ← askBase outHighlight
  getclr ← asks printItemColor
  hlPred ← asks doHighlight
  (hlInt, hlClr) ← asks printHighlightColor
  return $ if showColors
              then if hlOn && hlPred item
                     then [SetBold, OutSetColor hlInt hlClr, OutString s, ResetAll]
                     else case getclr item of
                           Nothing        → [SetBold, OutString s, ResetAll]
                           Just (int,clr) → [SetBold, OutSetColor int clr, OutString s, ResetAll]
              else [OutString s]

-- | Output colored item status
colorStatus ∷ (RuntimeConfig (PrintConfig c)) ⇒ String → Formatter c
colorStatus st = do
  getclr ← asks printStatusColor
  let (int, clr) = getclr st
  colored int clr st

-- | Output string in specified color
colored ∷ (RuntimeConfig (PrintConfig c)) ⇒ ColorIntensity → Color → String → Formatter c
colored int clr str = do
  col ← askBase outColors
  if col
    then return [OutSetColor int clr, OutString str, ResetAll]
    else return [OutString str]

printM ∷ (RuntimeConfig (PrintConfig c)) ⇒ TodoItem → Formatter c
printM item = askBase outputFormat >>= printf
  where
    printf :: (RuntimeConfig (PrintConfig c)) ⇒ String → Formatter c
    printf ""          = return []
    printf [c]         = return [OutString [c]]
    printf ('%':c:xs)  = liftM2 (⧺) (itemPart c) (printf xs)
    printf ('\\':c:xs) = liftM2 (:) (outChar $ escape c) (printf xs)
    printf (x:xs)      = do r ← printf xs
                            return $ (OutString [x]):r

    outChar c = return (OutString [c])

    escape '\\' = '\\'
    escape 't'  = '\t'
    escape 'n'  = '\n'
    escape 'b'  = '\b'
    escape 'v'  = '\v'
    escape c    = c

    tags = filter (not ∘ null) $ itemTags item
    string s = return [OutString s]

    itemPart ∷ (RuntimeConfig (PrintConfig c)) ⇒ Char → Formatter c
    itemPart 'n' = bold item
    itemPart 't' = if null tags
                     then return []
                     else string ("[" ⧺ unwords tags ⧺ "] ")
    itemPart 's' = colorStatus (itemStatus item)
    itemPart 'p' = string (itemPrefix item)
    itemPart 'd' = string (itemDescr item)
    itemPart 'f' = string (fileName item)
    itemPart 'i' = colored Dull Yellow (makeId item)
    itemPart 'l' = string (show $ lineNr item)
    itemPart 'D' | null dates' = return []
                 | otherwise = string $ "(" ⧺ dates' ⧺ ") "
    itemPart c   = string [c]

    dates' = showDates [StartDate `is` startDate item, EndDate `is` endDate item, Deadline `is` deadline item]

instance (RuntimeConfig (PrintConfig c)) ⇒ ConfigShow c TodoItem where
    configShow item = (startFormat ∷ Formatter c) <++> (printM item ∷ Formatter c)
</pre></br><h2>printed</h2></br><pre>{-# LANGUAGE UnicodeSyntax, TypeSynonymInstances, MultiParamTypeClasses, FlexibleInstances, ScopedTypeVariables, FlexibleContexts, UndecidableInstances #-}
module Todos.Formatters
  (OutItem (..),
   Formatter,
   outItem,
   startFormat, newLine,
   ConfigShow (..),
   ConfigAdd (..)
  ) where

import Prelude.Unicode
import Control.Monad
import Control.Monad.Reader
import System.Console.ANSI

import Todos.Types
import Todos.Config
-- import Todos.Default.ConfigInstances ()

-- | Item which could be printed to the console
data OutItem = OutString String
             | OutSetColor ColorIntensity Color
             | SetBold
             | ResetAll
    deriving (Show)

-- | Produce a list of OutItem's depending on PrintConfig
type Formatter c = Reader (PrintConfig c) [OutItem]

-- | Empty Formatter
startFormat :: Formatter c
startFormat = return []

-- | Output given string
outString :: String -> Formatter c
outString s = return [OutString s]

-- | Output new line
newLine :: Formatter c
newLine = outString "\n"

class ConfigAdd c a where
  -- | Execute Formatter and a consequently
  (<++>) :: Formatter c -> a -> Formatter c

instance ConfigAdd c (Formatter c) where
  (<++>) = liftM2 (⧺)

instance ConfigAdd c String where
  cm <++> s = cm <++> ((return [OutString s]) :: Formatter c)

setBold ::  IO ()
setBold = setSGR [SetConsoleIntensity BoldIntensity]

setColor :: ColorIntensity -> Color -> IO ()
setColor int clr = setSGR [SetColor Foreground int clr]

-- | Reset all (color, bold, ...) attributes
reset ::  IO ()
reset = setSGR []

-- | Print OutItem to console
outItem ::  OutItem -> IO ()
outItem (OutString s)   = putStr s
outItem (OutSetColor i c) = setColor i c
outItem SetBold         = setBold
outItem ResetAll        = reset

-- | Similar to Show, but output can depend on PrintConfig
class ConfigShow c s where
  configShow :: s -> Formatter c

instance ConfigShow c String where
  configShow s = return [OutString s]

instance ConfigShow c (Formatter c) where
  configShow = id

-- | Output bold (and maybe colored) item name
bold :: (RuntimeConfig (PrintConfig c)) => TodoItem -> Formatter c
bold item = do
  let s = itemName item
  showColors <- askBase outColors
  hlOn <- askBase outHighlight
  getclr <- asks printItemColor
  hlPred <- asks doHighlight
  (hlInt, hlClr) <- asks printHighlightColor
  return $ if showColors
              then if hlOn && hlPred item
                     then [SetBold, OutSetColor hlInt hlClr, OutString s, ResetAll]
                     else case getclr item of
                           Nothing        -> [SetBold, OutString s, ResetAll]
                           Just (int,clr) -> [SetBold, OutSetColor int clr, OutString s, ResetAll]
              else [OutString s]

-- | Output colored item status
colorStatus :: (RuntimeConfig (PrintConfig c)) => String -> Formatter c
colorStatus st = do
  getclr <- asks printStatusColor
  let (int, clr) = getclr st
  colored int clr st

-- | Output string in specified color
colored :: (RuntimeConfig (PrintConfig c)) => ColorIntensity -> Color -> String -> Formatter c
colored int clr str = do
  col <- askBase outColors
  if col
    then return [OutSetColor int clr, OutString str, ResetAll]
    else return [OutString str]

printM :: (RuntimeConfig (PrintConfig c)) => TodoItem -> Formatter c
printM item = askBase outputFormat >>= printf
  where
    printf :: (RuntimeConfig (PrintConfig c)) => String -> Formatter c
    printf ""          = return []
    printf [c]         = return [OutString [c]]
    printf ('%':c:xs)  = liftM2 (⧺) (itemPart c) (printf xs)
    printf ('\\':c:xs) = liftM2 (:) (outChar $ escape c) (printf xs)
    printf (x:xs)      = do r <- printf xs
                            return $ (OutString [x]):r

    outChar c = return (OutString [c])

    escape '\\' = '\\'
    escape 't'  = '\t'
    escape 'n'  = '\n'
    escape 'b'  = '\b'
    escape 'v'  = '\v'
    escape c    = c

    tags = filter (not ∘ null) $ itemTags item
    string s = return [OutString s]

    itemPart :: (RuntimeConfig (PrintConfig c)) => Char -> Formatter c
    itemPart 'n' = bold item
    itemPart 't' = if null tags
                     then return []
                     else string ("[" ⧺ unwords tags ⧺ "] ")
    itemPart 's' = colorStatus (itemStatus item)
    itemPart 'p' = string (itemPrefix item)
    itemPart 'd' = string (itemDescr item)
    itemPart 'f' = string (fileName item)
    itemPart 'i' = colored Dull Yellow (makeId item)
    itemPart 'l' = string (show $ lineNr item)
    itemPart 'D' | null dates' = return []
                 | otherwise = string $ "(" ⧺ dates' ⧺ ") "
    itemPart c   = string [c]

    dates' = showDates [StartDate `is` startDate item, EndDate `is` endDate item, Deadline `is` deadline item]

instance (RuntimeConfig (PrintConfig c)) => ConfigShow c TodoItem where
    configShow item = (startFormat :: Formatter c) <++> (printM item :: Formatter c)

</pre>