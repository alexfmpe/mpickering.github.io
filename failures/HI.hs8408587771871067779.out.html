<a href="HFoldable.hs18010486321442353559.out.html">prev</a></br><a href="failures.html">home</a></br><a href="Higher.hs1433118632248263272.out.html">next</a></br></br><pre>54c54
< {-# LINE 74 "src/ehc/HI.chs" #-}
---
> 
54a55
> 
54a56
> 
54a57
> 
54a58
> 
54a59
> 
54a60
> 
54a61
> 
54a62
> 
54a63
> 
54a64
> 
54a65
> 
54a66
> 
54a67
> 
54a68
> 
54a69
> 
54a70
> 
54a71
> 
54a72
> 
54a73
> 
63c82
< {-# LINE 88 "src/ehc/HI.chs" #-}
---
> 
63a83
> 
63a84
> 
63a85
> 
63a86
> 
63a87
> 
106c130
< {-# LINE 145 "src/ehc/HI.chs" #-}
---
> 
106a131
> 
106a132
> 
106a133
> 
106a134
> 
106a135
> 
106a136
> 
106a137
> 
106a138
> 
106a139
> 
106a140
> 
106a141
> 
106a142
> 
106a143
> 
106a144
> 
121c159
< {-# LINE 172 "src/ehc/HI.chs" #-}
---
> 
121a160
> 
121a161
> 
121a162
> 
121a163
> 
121a164
> 
121a165
> 
121a166
> 
121a167
> 
121a168
> 
121a169
> 
121a170
> 
121a171
> 
126c176
< {-# LINE 178 "src/ehc/HI.chs" #-}
---
> 
126a177
> 
130c181
< {-# LINE 188 "src/ehc/HI.chs" #-}
---
> 
130a182
> 
130a183
> 
130a184
> 
130a185
> 
130a186
> 
130a187
> 
148c205
< {-# LINE 229 "src/ehc/HI.chs" #-}
---
> 
148a206
> 
148a207
> 
148a208
> 
148a209
> 
148a210
> 
148a211
> 
148a212
> 
148a213
> 
148a214
> 
148a215
> 
148a216
> 
148a217
> 
148a218
> 
148a219
> 
148a220
> 
148a221
> 
148a222
> 
148a223
> 
148a224
> 
148a225
> 
148a226
> 
148a227
> 
148a228
> 
152c232
< {-# LINE 234 "src/ehc/HI.chs" #-}
---
> 
152a233
> 
169c250
< {-# LINE 259 "src/ehc/HI.chs" #-}
---
> 
169a251
> 
169a252
> 
169a253
> 
169a254
> 
169a255
> 
169a256
> 
169a257
> 
169a258
> 
195c284
< {-# LINE 295 "src/ehc/HI.chs" #-}
---
> 
195a285
> 
195a286
> 
195a287
> 
195a288
> 
195a289
> 
195a290
> 
195a291
> 
195a292
> 
195a293
> 
195a294
> 
200c299
< {-# LINE 301 "src/ehc/HI.chs" #-}
---
> 
200a300
> 
229c329
< {-# LINE 337 "src/ehc/HI.chs" #-}
---
> 
229a330
> 
229a331
> 
229a332
> 
229a333
> 
229a334
> 
229a335
> 
229a336
> 
242c349
< {-# LINE 355 "src/ehc/HI.chs" #-}
---
> 
242a350
> 
242a351
> 
242a352
> 
242a353
> 
242a354
> 
249c361
< {-# LINE 367 "src/ehc/HI.chs" #-}
---
> 
249a362
> 
249a363
> 
249a364
> 
249a365
> 
249a366
> 
255c372
< {-# LINE 374 "src/ehc/HI.chs" #-}
---
> 
255a373
> 
263c381
< {-# LINE 387 "src/ehc/HI.chs" #-}
---
> 
263a382
> 
263a383
> 
263a384
> 
263a385
> 
263a386
> 
267c390
< {-# LINE 396 "src/ehc/HI.chs" #-}
---
> 
267a391
> 
267a392
> 
267a393
> 
267a394
> 
267a395
> 
272c400
< {-# LINE 402 "src/ehc/HI.chs" #-}
---
> 
272a401
> 
370c499
< {-# LINE 525 "src/ehc/HI.chs" #-}
---
> 
370a500
> 
370a501
> 
370a502
> 
370a503
> 
370a504
> 
370a505
> 
370a506
> 
370a507
> 
370a508
> 
370a509
> 
370a510
> 
370a511
> 
370a512
> 
370a513
> 
370a514
> 
370a515
> 
370a516
> 
370a517
> 
370a518
> 
370a519
> 
370a520
> 
370a521
> 
370a522
> 
370a523
> 
370a524
> 
442a597
> 
</pre></br><h2>original</h2></br><pre>module UHC.Light.Compiler.HI
( Visible (..)
, HIInfoUsedModMp, HIInfo (..)
, emptyHIInfo
, hiiIsEmpty
, hiiIdDefOccGam
, mentrelToIdDefOccGam
, hiiIdDefOccGamToHIIdGam, hiiIdDefOccGamFromHIIdGam
, HIOrigin (..)
, HIValidity (..)
, sgetHIInfo
, ImpHIMp
, hiiUnion
, hiiIncludeCacheOfImport )
where
import UHC.Light.Compiler.Base.Common
import UHC.Light.Compiler.Opts
import UHC.Light.Compiler.Base.HsName.Builtin
import UHC.Light.Compiler.NameAspect
import UHC.Light.Compiler.Gam.Full
import UHC.Light.Compiler.Gam.ClassDefaultGam
import UHC.Light.Compiler.Ty
import UHC.Light.Compiler.Base.Target
import UHC.Light.Compiler.Core
import UHC.Light.Compiler.LamInfo
import UHC.Light.Compiler.Config
import UHC.Light.Compiler.Module.ImportExport
import UHC.Light.Compiler.Pred.ToCHR
import UHC.Light.Compiler.CHR.Solve
import qualified UHC.Light.Compiler.Gam.ClGam as Pr
import qualified Data.Set as Set
import qualified Data.Map as Map
import qualified UHC.Util.Rel as Rel
import qualified UHC.Util.FastSeq as Seq
import UHC.Util.Utils
import Control.Monad
import UHC.Util.Binary
import Data.Typeable (Typeable)
import Data.Generics (Data)
import UHC.Util.Serialize
import qualified UHC.Light.Compiler.Config as Cfg
import qualified UHC.Light.Compiler.ConfigInternalVersions as Cfg
import qualified UHC.Light.Compiler.SourceCodeSig as Sig
import UHC.Light.Compiler.Base.Debug
import UHC.Util.Pretty








{-# LINE 74 "src/ehc/HI.chs" #-}
data Visible
  = VisibleNo | VisibleYes
  deriving Eq

instance Show Visible where
  show VisibleNo  = "visibleno"
  show VisibleYes = "visibleyes"

{-# LINE 88 "src/ehc/HI.chs" #-}
type HIInfoUsedModMp = (Map.Map HsName (Set.Set HsName))

-- | Encoding of info in .hi file, when changed also change {%{EH}ConfigInternalVersions}
data HIInfo
  = HIInfo
      { hiiValidity             :: !HIValidity                              -- a valid HI info?
      , hiiInternalVersions     :: !Cfg.InternalVersionCombined             -- internal version
      , hiiOrigin               :: !HIOrigin                                -- where did the HI come from
      , hiiSrcSig               :: !String                                  -- compiler source signature (md5)
      , hiiTarget               :: !Target                                  -- for which backend the hi is generated
      , hiiTargetFlavor         :: !TargetFlavor                            -- for which flavor the hi is generated
      , hiiCompiler             :: !String                                  -- compiler version info
      , hiiCompileFlags         :: !String                                  -- flags
      , hiiHasMain              :: !Bool                                    -- has file a main?
      , hiiModuleNm             :: !HsName                                  -- module name
      , hiiSrcTimeStamp         :: !String                                  -- timestamp of compiler source
      , hiiSrcVersionMajor      :: !String                                  -- major (etc) version numbers
      , hiiSrcVersionMinor      :: !String
      , hiiSrcVersionMinorMinor :: !String
      , hiiSrcVersionSvn        :: !String                                  -- svn version

      , hiiExps                 :: !ModEntRel                               -- exported stuff
      , hiiHiddenExps           :: !ModEntRel                               -- exported, but hidden otherwise (instances, optimized code variants, ...)
      , hiiFixityGam            :: !FixityGam                               -- fixity of identifiers
      , hiiHIDeclImpModS        :: !(Set.Set HsName)                        -- declared imports
      , hiiHIUsedImpModS        :: !(Set.Set HsName)                        -- used imports, usually indirectly via renaming
      , hiiTransClosedUsedModMp :: !HIInfoUsedModMp                         -- used modules with their imports, required to be linked together, transitively closed/cached over imported modules
      , hiiTransClosedOrphanModS:: !(Set.Set HsName)                        -- orphan modules, required to read its .hi file, transitively closed/cached over imported modules
      , hiiMbOrphan             :: !(Maybe (Set.Set HsName))                -- is orphan module, carrying the module names required
      , hiiValGam               :: !ValGam                                  -- value identifier environment
      , hiiTyGam                :: !TyGam                                   -- type identifier env
      , hiiTyKiGam              :: !TyKiGam                                 -- type/tyvar kind env
      , hiiPolGam               :: !PolGam                                  -- polarity env
      , hiiDataGam              :: !DataGam                                 -- datatype info env
      , hiiClGam                :: !Pr.ClGam                                -- class env
      , hiiClDfGam              :: !ClassDefaultGam                         -- class defaults env
      , hiiCHRStore             :: !ScopedPredStore                         -- rule database
      , hiiLamMp                :: !LamMp                                   -- codegen info for identifiers
      , hiiImpHIMp              :: !ImpHIMp                                 -- cache of HIInfo's of imported modules, filtered for visibility
      }
  deriving (Typeable, Data)

{-# LINE 145 "src/ehc/HI.chs" #-}
emptyHIInfo :: HIInfo
emptyHIInfo
  = HIInfo HIValidity_Absent
           Cfg.internalVersionCombined
           HIOrigin_FromFile
           "" defaultTarget defaultTargetFlavor "" "" False hsnUnknown "" "" "" "" ""
           Rel.empty Rel.empty emptyGam
           Set.empty Set.empty
           Map.empty Set.empty
           Nothing
           emptyGam emptyGam emptyGam emptyGam emptyGam emptyGam emptyGam emptyCHRStore
           Map.empty
           Map.empty

{-# LINE 172 "src/ehc/HI.chs" #-}
-- | not empty if ok
hiiIsEmpty :: HIInfo -> Bool
hiiIsEmpty hii = hiiValidity hii /= HIValidity_Ok

{-# LINE 178 "src/ehc/HI.chs" #-}
hiiIdDefOccGam :: HIInfo -> IdDefOccGam
hiiIdDefOccGam hii = hiiIdDefOccGamFromHIIdGam $ mentrelToIdDefOccGam (hiiModuleNm hii) (hiiExps hii)

{-# LINE 188 "src/ehc/HI.chs" #-}
instance Show HIInfo where
  show _ = "HIInfo"

instance PP HIInfo where
  pp i = "HIInfo" >#< (   "ModNm  =" >#< pp         (             hiiModuleNm              i)
                      >-< "DeclImp=" >#< ppCommas   (Set.toList $ hiiHIDeclImpModS         i)
                      >-< "UsedImp=" >#< ppCommas   (Set.toList $ hiiHIUsedImpModS         i)
                      >-< "AllUsed=" >#< ppAssocLV  (assocLMapElt (ppCommas . Set.toList) $ Map.toList $ hiiTransClosedUsedModMp i)
                      >-< "AllOrph=" >#< ppCommas   (Set.toList $ hiiTransClosedOrphanModS i)
                      >-< "MbOrph =" >#< ppCommas   (maybe [] Set.toList $ hiiMbOrphan     i)
                      -- >-< "Exps="    >#< pp         (hiiExps          i)
                      -- >-< "Exps(H)=" >#< pp         (hiiHiddenExps    i)
                      -- >-< "ValGam =" >#< pp         (hiiValGam        i)
                      -- >-< "TyGam  =" >#< pp         (hiiTyGam         i)
                      -- >-< "Cached =" >#< ppAssocLV  (assocLMapElt pp $ Map.toList $ hiiImpHIMp    i)
                      )

{-# LINE 229 "src/ehc/HI.chs" #-}
type ImpHIMp = Map.Map HsName HIInfo


{-# LINE 234 "src/ehc/HI.chs" #-}
-- | combine HI info for a single module, as extracted from the cached hiiImpHIMp of the module importing these combined modules
hiiUnion :: HIInfo -> HIInfo -> HIInfo
hiiUnion m1 m2
  = m1 { hiiFixityGam           = hiiFixityGam      m1 `gamUnion`       hiiFixityGam    m2
       -- , hiiIdDefHIIdGam        = hiiIdDefHIIdGam    m1 `gamUnion`       hiiIdDefHIIdGam m2
       , hiiValGam              = hiiValGam         m1 `gamUnion`       hiiValGam       m2
       , hiiTyGam               = hiiTyGam          m1 `gamUnion`       hiiTyGam        m2
       , hiiTyKiGam             = hiiTyKiGam        m1 `gamUnion`       hiiTyKiGam      m2
       , hiiPolGam              = hiiPolGam         m1 `gamUnion`       hiiPolGam       m2
       , hiiDataGam             = hiiDataGam        m1 `gamUnion`       hiiDataGam      m2
       , hiiClGam               = hiiClGam          m1 `gamUnion`       hiiClGam        m2
       , hiiClDfGam             = hiiClDfGam        m1 `gamUnion`       hiiClDfGam      m2
       , hiiCHRStore            = hiiCHRStore       m1 `chrStoreUnion`  hiiCHRStore     m2
       , hiiLamMp               = hiiLamMp          m1 `Map.union`      hiiLamMp        m2
       }

{-# LINE 259 "src/ehc/HI.chs" #-}
-- | restrict envs to the ones being in the filter map, so only those visible relative to that map remain
hiiRestrictToFilterMp :: ModEntRelFilterMp -> HIInfo -> HIInfo
hiiRestrictToFilterMp mfm hii
  = hii
      { hiiFixityGam            = fg expVT $ hiiFixityGam       hii
      -- , hiiIdDefHIIdGam         = fg (\o -> exp (ioccKind o) (ioccNm o))
      --                                      $ hiiIdDefHIIdGam    hii
      , hiiValGam               = fg expV  $ hiiValGam          hii
      , hiiTyGam                = fg expT  $ hiiTyGam           hii
      , hiiTyKiGam              = fg expT' $ hiiTyKiGam         hii
      , hiiPolGam               = fg expT  $ hiiPolGam          hii
      , hiiDataGam              = fg expT  $ hiiDataGam         hii
      , hiiClGam                = fg expC  $ hiiClGam           hii
      , hiiClDfGam              = fg expC  $ hiiClDfGam         hii
      , hiiLamMp                = fm expV  $ hiiLamMp           hii
      }
  where exp k  = (`Set.member` Map.findWithDefault Set.empty k mfm)
        expV   = exp IdOcc_Val
        expT   = exp IdOcc_Type
        expT'  = maybe False (exp IdOcc_Type) . tyKiKeyMbName
        expVT x= expV x || expT x
        expC   = expT -- exp IdOcc_Class
        fg p   = fst . gamPartition (\k _ -> p k)
        fm p   = Map.filterWithKey (\k _ -> p k)

{-# LINE 295 "src/ehc/HI.chs" #-}
-- | restrict envs to the ones being exported, so only the visible part remains
hiiRestrictToExported :: HIInfo -> HIInfo
hiiRestrictToExported hii = hiiRestrictToFilterMp (mentrelToFilterMp [] (hiiExps hii) `mentrelFilterMpUnion` mentrelToFilterMp [] (hiiHiddenExps hii)) hii

{-# LINE 301 "src/ehc/HI.chs" #-}
-- | include the imported HIInfos in this one, restricted to their exports, to be done just before saving
hiiIncludeCacheOfImport :: (HsName -> HIInfo) -> ModEntRelFilterMp -> HIInfo -> HIInfo
hiiIncludeCacheOfImport imp mfm hii
  = hii
      { hiiImpHIMp = Map.map reset $ Map.unions [top, subtop]
      }
  where -- imports of this module
        top    = Map.unions [ Map.singleton i $ hiiRestrictToFilterMp mfm $ {- (\x -> tr "hiiIncludeCacheOfImport.1" (i >#< x) x) $ -} imp i | i <- Set.toList $ hiiHIDeclImpModS hii `Set.union` hiiHIUsedImpModS hii ]

        -- the closure of the imports w.r.t. import relationship
        subtop = Map.map (hiiRestrictToFilterMp mfm) $ Map.unionsWith hiiUnion $ map hiiImpHIMp $ Map.elems top

        -- reset some info in cached hii's
        reset hii = hii { hiiImpHIMp                = Map.empty
                        , hiiExps                   = Rel.empty
                        , hiiHiddenExps             = Rel.empty
                        , hiiHIDeclImpModS          = Set.empty
                        , hiiHIUsedImpModS          = Set.empty
                        , hiiCHRStore               = emptyCHRStore     -- this cannot be, but no solution for filtering this...
                        , hiiSrcSig                 = ""
                        , hiiCompiler               = ""
                        , hiiSrcTimeStamp           = ""
                        , hiiSrcVersionMajor        = ""
                        , hiiSrcVersionMinor        = ""
                        , hiiSrcVersionMinorMinor   = ""
                        , hiiSrcVersionSvn          = ""
                        }

{-# LINE 337 "src/ehc/HI.chs" #-}
mentrelToIdDefOccGam :: HsName -> ModEntRel -> Gam IdOcc IdOcc -- IdDefOccGam
mentrelToIdDefOccGam modNm r
  = gamFromAssocL
      [ ( IdOcc n' k
        -- , mkIdDefOcc (IdOcc (ioccNm $ mentIdOcc e) k) IdAsp_Any nmLevOutside emptyRange
        , IdOcc (ioccNm $ mentIdOcc e) k
        )
      | (n,e) <- Rel.toList r
      , let k  = ioccKind $ mentIdOcc e
            n' = hsnSetQual modNm n
      ]

{-# LINE 355 "src/ehc/HI.chs" #-}
hiiIdDefOccGamToHIIdGam :: IdDefOccGam -> Gam IdOcc IdOcc
hiiIdDefOccGamToHIIdGam = gamMap (\(k,v) -> (k,doccOcc v))

hiiIdDefOccGamFromHIIdGam :: Gam IdOcc IdOcc -> IdDefOccGam
hiiIdDefOccGamFromHIIdGam = gamMap (\(k,v) -> (k,mkIdDefOcc v IdAsp_Any nmLevOutside emptyRange))

{-# LINE 367 "src/ehc/HI.chs" #-}
data HIOrigin
  = HIOrigin_FromFile                               -- from .hi file
  | HIOrigin_FromImportedBy HsNameS                 -- reconstructed from modules which imported this hi
  deriving (Eq,Show,Typeable,Data)

{-# LINE 374 "src/ehc/HI.chs" #-}
data HIValidity
  = HIValidity_Ok               -- ok
  | HIValidity_WrongMagic       -- wrong magic number
  | HIValidity_Inconsistent     -- inconsistent with compiler
  | HIValidity_Absent           -- not available
  deriving (Eq,Enum,Show,Typeable,Data)

{-# LINE 387 "src/ehc/HI.chs" #-}
gamFlatten :: Ord k => Gam k v -> Gam k v
gamFlatten = id -- gamFromAssocL . gamToAssocL

{-# LINE 396 "src/ehc/HI.chs" #-}
instance Serialize HIValidity where
  sput = sputEnum8
  sget = sgetEnum8

{-# LINE 402 "src/ehc/HI.chs" #-}
sgetHIInfo :: EHCOpts -> SGet HIInfo
sgetHIInfo opts = do
  { hi_magic <- sequence $ replicate (length Cfg.magicNumberHI) sgetWord8
  ; if hi_magic == Cfg.magicNumberHI
    then do { hi_sig   <- sget
            ; hi_ts    <- sget
            ; hi_iv    <- sget
            ; hi_t     <- sget
            ; hi_tv    <- sget
            ; hi_fl    <- sget
            ; hi_comp  <- sget
            ; if ( {-   hi_sig == Sig.sig
                   && hi_ts  == Sig.timestamp
                   && -}
                      hi_iv  == hiiInternalVersions emptyHIInfo
                   && hi_t   == ehcOptTarget        opts
                   && hi_tv  == ehcOptTargetFlavor  opts
                 )
                 || not (ehcOptHiValidityCheck opts)
              then do { hi_nm     <- sget
                      ; hi_hm     <- sget
                      ; hi_m      <- sget
                      ; hi_mm     <- sget
                      ; hi_mmm    <- sget
                      ; hi_svn    <- sget
                      ; e         <- sget
                      ; he        <- sget
                      ; fg        <- sget
                      ; impd      <- sget
                      ; impu      <- sget
                      ; tclused   <- sget
                      ; tclorph   <- sget
                      ; isorph    <- sget
                      ; vg        <- sget
                      ; tg        <- sget
                      ; tkg       <- sget
                      ; pg        <- sget
                      ; dg        <- sget
                      ; cg        <- sget
                      ; cdg       <- sget
                      ; cs        <- sget
                      ; am        <- sget
                      ; him       <- sget
                      ; return
                          (emptyHIInfo
                            { hiiValidity             = HIValidity_Ok
                            , hiiSrcSig               = hi_sig
                            , hiiCompiler             = hi_comp
                            , hiiCompileFlags         = hi_fl
                            , hiiTarget               = hi_t
                            , hiiTargetFlavor         = hi_tv
                            , hiiHasMain              = hi_hm
                            , hiiSrcTimeStamp         = hi_ts
                            , hiiInternalVersions     = hi_iv
                            , hiiModuleNm             = hi_nm
                            , hiiSrcVersionMajor      = hi_m
                            , hiiSrcVersionMinor      = hi_mm
                            , hiiSrcVersionMinorMinor = hi_mmm
                            , hiiSrcVersionSvn        = hi_svn
                            , hiiExps                 = e
                            , hiiHiddenExps           = he
                            , hiiFixityGam            = fg
                            , hiiHIDeclImpModS        = impd
                            , hiiHIUsedImpModS        = impu
                            , hiiTransClosedUsedModMp = tclused
                            , hiiTransClosedOrphanModS= tclorph
                            , hiiMbOrphan             = isorph
                            , hiiValGam               = vg
                            , hiiTyGam                = tg
                            , hiiTyKiGam              = tkg
                            , hiiPolGam               = pg
                            , hiiDataGam              = dg
                            , hiiClGam                = cg
                            , hiiClDfGam              = cdg
                            , hiiCHRStore             = cs
                            , hiiLamMp                = am
                            , hiiImpHIMp              = him
                            })
                      }
              else return $
                     emptyHIInfo
                       { hiiValidity             = HIValidity_Inconsistent
                       , hiiSrcSig               = hi_sig
                       , hiiSrcTimeStamp         = hi_ts
                       , hiiInternalVersions     = hi_iv
                       , hiiCompileFlags         = hi_fl
                       , hiiCompiler             = hi_comp
                       , hiiTarget               = hi_t
                       , hiiTargetFlavor         = hi_tv
                       }
            }
    else return $
           emptyHIInfo
             { hiiValidity             = HIValidity_WrongMagic
             }
  }

{-# LINE 525 "src/ehc/HI.chs" #-}
instance Serialize HIInfo where
  sput       (HIInfo
                  { hiiSrcSig               = hi_sig
                  , hiiTarget               = hi_t
                  , hiiTargetFlavor         = hi_tv
                  , hiiCompiler             = hi_comp
                  , hiiCompileFlags         = hi_fl
                  , hiiModuleNm             = hi_nm
                  , hiiHasMain              = hi_hm
                  , hiiSrcTimeStamp         = hi_ts
                  , hiiInternalVersions     = hi_iv
                  , hiiSrcVersionMajor      = hi_m
                  , hiiSrcVersionMinor      = hi_mm
                  , hiiSrcVersionMinorMinor = hi_mmm
                  , hiiSrcVersionSvn        = hi_svn
                  , hiiExps                 = e
                  , hiiHiddenExps           = he
                  , hiiFixityGam            = fg
                  , hiiHIDeclImpModS        = impd
                  , hiiHIUsedImpModS        = impu
                  , hiiTransClosedUsedModMp = tclused
                  , hiiTransClosedOrphanModS= tclorph
                  , hiiMbOrphan             = isorph
                  , hiiValGam               = vg
                  , hiiTyGam                = tg
                  , hiiTyKiGam              = tkg
                  , hiiPolGam               = pg
                  , hiiDataGam              = dg
                  , hiiClGam                = cg
                  , hiiClDfGam              = cdg
                  , hiiCHRStore             = cs
                  , hiiLamMp                = am
                  , hiiImpHIMp              = him
                  })
              =    mapM sputWord8 Cfg.magicNumberHI
                >> sput hi_sig
                >> sput hi_ts
                >> sput hi_iv
                >> sput hi_t
                >> sput hi_tv
                >> sput hi_fl
                >> sput hi_comp
                >> sput hi_nm
                >> sput hi_hm
                >> sput hi_m
                >> sput hi_mm
                >> sput hi_mmm
                >> sput hi_svn
                >> sput e
                >> sput he
                >> sput (gamFlatten fg)
                >> sput impd
                >> sput impu
                >> sput tclused
                >> sput tclorph
                >> sput isorph
                >> sput (gamFlatten vg)
                >> sput (gamFlatten tg)
                >> sput (gamFlatten tkg)
                >> sput (gamFlatten pg)
                >> sput (gamFlatten dg)
                >> sput (gamFlatten cg)
                >> sput (gamFlatten cdg)
                >> sput cs
                >> sput am
                >> sput him

  sget = sgetHIInfo (defaultEHCOpts
                       { ehcOptHiValidityCheck = False
                       }
                    )

</pre></br><h2>printed</h2></br><pre>module UHC.Light.Compiler.HI
( Visible (..)
, HIInfoUsedModMp, HIInfo (..)
, emptyHIInfo
, hiiIsEmpty
, hiiIdDefOccGam
, mentrelToIdDefOccGam
, hiiIdDefOccGamToHIIdGam, hiiIdDefOccGamFromHIIdGam
, HIOrigin (..)
, HIValidity (..)
, sgetHIInfo
, ImpHIMp
, hiiUnion
, hiiIncludeCacheOfImport )
where
import UHC.Light.Compiler.Base.Common
import UHC.Light.Compiler.Opts
import UHC.Light.Compiler.Base.HsName.Builtin
import UHC.Light.Compiler.NameAspect
import UHC.Light.Compiler.Gam.Full
import UHC.Light.Compiler.Gam.ClassDefaultGam
import UHC.Light.Compiler.Ty
import UHC.Light.Compiler.Base.Target
import UHC.Light.Compiler.Core
import UHC.Light.Compiler.LamInfo
import UHC.Light.Compiler.Config
import UHC.Light.Compiler.Module.ImportExport
import UHC.Light.Compiler.Pred.ToCHR
import UHC.Light.Compiler.CHR.Solve
import qualified UHC.Light.Compiler.Gam.ClGam as Pr
import qualified Data.Set as Set
import qualified Data.Map as Map
import qualified UHC.Util.Rel as Rel
import qualified UHC.Util.FastSeq as Seq
import UHC.Util.Utils
import Control.Monad
import UHC.Util.Binary
import Data.Typeable (Typeable)
import Data.Generics (Data)
import UHC.Util.Serialize
import qualified UHC.Light.Compiler.Config as Cfg
import qualified UHC.Light.Compiler.ConfigInternalVersions as Cfg
import qualified UHC.Light.Compiler.SourceCodeSig as Sig
import UHC.Light.Compiler.Base.Debug
import UHC.Util.Pretty




























data Visible
  = VisibleNo | VisibleYes
  deriving Eq

instance Show Visible where
  show VisibleNo  = "visibleno"
  show VisibleYes = "visibleyes"







type HIInfoUsedModMp = (Map.Map HsName (Set.Set HsName))

-- | Encoding of info in .hi file, when changed also change {%{EH}ConfigInternalVersions}
data HIInfo
  = HIInfo
      { hiiValidity             :: !HIValidity                              -- a valid HI info?
      , hiiInternalVersions     :: !Cfg.InternalVersionCombined             -- internal version
      , hiiOrigin               :: !HIOrigin                                -- where did the HI come from
      , hiiSrcSig               :: !String                                  -- compiler source signature (md5)
      , hiiTarget               :: !Target                                  -- for which backend the hi is generated
      , hiiTargetFlavor         :: !TargetFlavor                            -- for which flavor the hi is generated
      , hiiCompiler             :: !String                                  -- compiler version info
      , hiiCompileFlags         :: !String                                  -- flags
      , hiiHasMain              :: !Bool                                    -- has file a main?
      , hiiModuleNm             :: !HsName                                  -- module name
      , hiiSrcTimeStamp         :: !String                                  -- timestamp of compiler source
      , hiiSrcVersionMajor      :: !String                                  -- major (etc) version numbers
      , hiiSrcVersionMinor      :: !String
      , hiiSrcVersionMinorMinor :: !String
      , hiiSrcVersionSvn        :: !String                                  -- svn version

      , hiiExps                 :: !ModEntRel                               -- exported stuff
      , hiiHiddenExps           :: !ModEntRel                               -- exported, but hidden otherwise (instances, optimized code variants, ...)
      , hiiFixityGam            :: !FixityGam                               -- fixity of identifiers
      , hiiHIDeclImpModS        :: !(Set.Set HsName)                        -- declared imports
      , hiiHIUsedImpModS        :: !(Set.Set HsName)                        -- used imports, usually indirectly via renaming
      , hiiTransClosedUsedModMp :: !HIInfoUsedModMp                         -- used modules with their imports, required to be linked together, transitively closed/cached over imported modules
      , hiiTransClosedOrphanModS:: !(Set.Set HsName)                        -- orphan modules, required to read its .hi file, transitively closed/cached over imported modules
      , hiiMbOrphan             :: !(Maybe (Set.Set HsName))                -- is orphan module, carrying the module names required
      , hiiValGam               :: !ValGam                                  -- value identifier environment
      , hiiTyGam                :: !TyGam                                   -- type identifier env
      , hiiTyKiGam              :: !TyKiGam                                 -- type/tyvar kind env
      , hiiPolGam               :: !PolGam                                  -- polarity env
      , hiiDataGam              :: !DataGam                                 -- datatype info env
      , hiiClGam                :: !Pr.ClGam                                -- class env
      , hiiClDfGam              :: !ClassDefaultGam                         -- class defaults env
      , hiiCHRStore             :: !ScopedPredStore                         -- rule database
      , hiiLamMp                :: !LamMp                                   -- codegen info for identifiers
      , hiiImpHIMp              :: !ImpHIMp                                 -- cache of HIInfo's of imported modules, filtered for visibility
      }
  deriving (Typeable, Data)
















emptyHIInfo :: HIInfo
emptyHIInfo
  = HIInfo HIValidity_Absent
           Cfg.internalVersionCombined
           HIOrigin_FromFile
           "" defaultTarget defaultTargetFlavor "" "" False hsnUnknown "" "" "" "" ""
           Rel.empty Rel.empty emptyGam
           Set.empty Set.empty
           Map.empty Set.empty
           Nothing
           emptyGam emptyGam emptyGam emptyGam emptyGam emptyGam emptyGam emptyCHRStore
           Map.empty
           Map.empty














-- | not empty if ok
hiiIsEmpty :: HIInfo -> Bool
hiiIsEmpty hii = hiiValidity hii /= HIValidity_Ok



hiiIdDefOccGam :: HIInfo -> IdDefOccGam
hiiIdDefOccGam hii = hiiIdDefOccGamFromHIIdGam $ mentrelToIdDefOccGam (hiiModuleNm hii) (hiiExps hii)








instance Show HIInfo where
  show _ = "HIInfo"

instance PP HIInfo where
  pp i = "HIInfo" >#< (   "ModNm  =" >#< pp         (             hiiModuleNm              i)
                      >-< "DeclImp=" >#< ppCommas   (Set.toList $ hiiHIDeclImpModS         i)
                      >-< "UsedImp=" >#< ppCommas   (Set.toList $ hiiHIUsedImpModS         i)
                      >-< "AllUsed=" >#< ppAssocLV  (assocLMapElt (ppCommas . Set.toList) $ Map.toList $ hiiTransClosedUsedModMp i)
                      >-< "AllOrph=" >#< ppCommas   (Set.toList $ hiiTransClosedOrphanModS i)
                      >-< "MbOrph =" >#< ppCommas   (maybe [] Set.toList $ hiiMbOrphan     i)
                      -- >-< "Exps="    >#< pp         (hiiExps          i)
                      -- >-< "Exps(H)=" >#< pp         (hiiHiddenExps    i)
                      -- >-< "ValGam =" >#< pp         (hiiValGam        i)
                      -- >-< "TyGam  =" >#< pp         (hiiTyGam         i)
                      -- >-< "Cached =" >#< ppAssocLV  (assocLMapElt pp $ Map.toList $ hiiImpHIMp    i)
                      )

























type ImpHIMp = Map.Map HsName HIInfo




-- | combine HI info for a single module, as extracted from the cached hiiImpHIMp of the module importing these combined modules
hiiUnion :: HIInfo -> HIInfo -> HIInfo
hiiUnion m1 m2
  = m1 { hiiFixityGam           = hiiFixityGam      m1 `gamUnion`       hiiFixityGam    m2
       -- , hiiIdDefHIIdGam        = hiiIdDefHIIdGam    m1 `gamUnion`       hiiIdDefHIIdGam m2
       , hiiValGam              = hiiValGam         m1 `gamUnion`       hiiValGam       m2
       , hiiTyGam               = hiiTyGam          m1 `gamUnion`       hiiTyGam        m2
       , hiiTyKiGam             = hiiTyKiGam        m1 `gamUnion`       hiiTyKiGam      m2
       , hiiPolGam              = hiiPolGam         m1 `gamUnion`       hiiPolGam       m2
       , hiiDataGam             = hiiDataGam        m1 `gamUnion`       hiiDataGam      m2
       , hiiClGam               = hiiClGam          m1 `gamUnion`       hiiClGam        m2
       , hiiClDfGam             = hiiClDfGam        m1 `gamUnion`       hiiClDfGam      m2
       , hiiCHRStore            = hiiCHRStore       m1 `chrStoreUnion`  hiiCHRStore     m2
       , hiiLamMp               = hiiLamMp          m1 `Map.union`      hiiLamMp        m2
       }










-- | restrict envs to the ones being in the filter map, so only those visible relative to that map remain
hiiRestrictToFilterMp :: ModEntRelFilterMp -> HIInfo -> HIInfo
hiiRestrictToFilterMp mfm hii
  = hii
      { hiiFixityGam            = fg expVT $ hiiFixityGam       hii
      -- , hiiIdDefHIIdGam         = fg (\o -> exp (ioccKind o) (ioccNm o))
      --                                      $ hiiIdDefHIIdGam    hii
      , hiiValGam               = fg expV  $ hiiValGam          hii
      , hiiTyGam                = fg expT  $ hiiTyGam           hii
      , hiiTyKiGam              = fg expT' $ hiiTyKiGam         hii
      , hiiPolGam               = fg expT  $ hiiPolGam          hii
      , hiiDataGam              = fg expT  $ hiiDataGam         hii
      , hiiClGam                = fg expC  $ hiiClGam           hii
      , hiiClDfGam              = fg expC  $ hiiClDfGam         hii
      , hiiLamMp                = fm expV  $ hiiLamMp           hii
      }
  where exp k  = (`Set.member` Map.findWithDefault Set.empty k mfm)
        expV   = exp IdOcc_Val
        expT   = exp IdOcc_Type
        expT'  = maybe False (exp IdOcc_Type) . tyKiKeyMbName
        expVT x= expV x || expT x
        expC   = expT -- exp IdOcc_Class
        fg p   = fst . gamPartition (\k _ -> p k)
        fm p   = Map.filterWithKey (\k _ -> p k)












-- | restrict envs to the ones being exported, so only the visible part remains
hiiRestrictToExported :: HIInfo -> HIInfo
hiiRestrictToExported hii = hiiRestrictToFilterMp (mentrelToFilterMp [] (hiiExps hii) `mentrelFilterMpUnion` mentrelToFilterMp [] (hiiHiddenExps hii)) hii



-- | include the imported HIInfos in this one, restricted to their exports, to be done just before saving
hiiIncludeCacheOfImport :: (HsName -> HIInfo) -> ModEntRelFilterMp -> HIInfo -> HIInfo
hiiIncludeCacheOfImport imp mfm hii
  = hii
      { hiiImpHIMp = Map.map reset $ Map.unions [top, subtop]
      }
  where -- imports of this module
        top    = Map.unions [ Map.singleton i $ hiiRestrictToFilterMp mfm $ {- (\x -> tr "hiiIncludeCacheOfImport.1" (i >#< x) x) $ -} imp i | i <- Set.toList $ hiiHIDeclImpModS hii `Set.union` hiiHIUsedImpModS hii ]

        -- the closure of the imports w.r.t. import relationship
        subtop = Map.map (hiiRestrictToFilterMp mfm) $ Map.unionsWith hiiUnion $ map hiiImpHIMp $ Map.elems top

        -- reset some info in cached hii's
        reset hii = hii { hiiImpHIMp                = Map.empty
                        , hiiExps                   = Rel.empty
                        , hiiHiddenExps             = Rel.empty
                        , hiiHIDeclImpModS          = Set.empty
                        , hiiHIUsedImpModS          = Set.empty
                        , hiiCHRStore               = emptyCHRStore     -- this cannot be, but no solution for filtering this...
                        , hiiSrcSig                 = ""
                        , hiiCompiler               = ""
                        , hiiSrcTimeStamp           = ""
                        , hiiSrcVersionMajor        = ""
                        , hiiSrcVersionMinor        = ""
                        , hiiSrcVersionMinorMinor   = ""
                        , hiiSrcVersionSvn          = ""
                        }









mentrelToIdDefOccGam :: HsName -> ModEntRel -> Gam IdOcc IdOcc -- IdDefOccGam
mentrelToIdDefOccGam modNm r
  = gamFromAssocL
      [ ( IdOcc n' k
        -- , mkIdDefOcc (IdOcc (ioccNm $ mentIdOcc e) k) IdAsp_Any nmLevOutside emptyRange
        , IdOcc (ioccNm $ mentIdOcc e) k
        )
      | (n,e) <- Rel.toList r
      , let k  = ioccKind $ mentIdOcc e
            n' = hsnSetQual modNm n
      ]







hiiIdDefOccGamToHIIdGam :: IdDefOccGam -> Gam IdOcc IdOcc
hiiIdDefOccGamToHIIdGam = gamMap (\(k,v) -> (k,doccOcc v))

hiiIdDefOccGamFromHIIdGam :: Gam IdOcc IdOcc -> IdDefOccGam
hiiIdDefOccGamFromHIIdGam = gamMap (\(k,v) -> (k,mkIdDefOcc v IdAsp_Any nmLevOutside emptyRange))







data HIOrigin
  = HIOrigin_FromFile                               -- from .hi file
  | HIOrigin_FromImportedBy HsNameS                 -- reconstructed from modules which imported this hi
  deriving (Eq,Show,Typeable,Data)



data HIValidity
  = HIValidity_Ok               -- ok
  | HIValidity_WrongMagic       -- wrong magic number
  | HIValidity_Inconsistent     -- inconsistent with compiler
  | HIValidity_Absent           -- not available
  deriving (Eq,Enum,Show,Typeable,Data)







gamFlatten :: Ord k => Gam k v -> Gam k v
gamFlatten = id -- gamFromAssocL . gamToAssocL







instance Serialize HIValidity where
  sput = sputEnum8
  sget = sgetEnum8



sgetHIInfo :: EHCOpts -> SGet HIInfo
sgetHIInfo opts = do
  { hi_magic <- sequence $ replicate (length Cfg.magicNumberHI) sgetWord8
  ; if hi_magic == Cfg.magicNumberHI
    then do { hi_sig   <- sget
            ; hi_ts    <- sget
            ; hi_iv    <- sget
            ; hi_t     <- sget
            ; hi_tv    <- sget
            ; hi_fl    <- sget
            ; hi_comp  <- sget
            ; if ( {-   hi_sig == Sig.sig
                   && hi_ts  == Sig.timestamp
                   && -}
                      hi_iv  == hiiInternalVersions emptyHIInfo
                   && hi_t   == ehcOptTarget        opts
                   && hi_tv  == ehcOptTargetFlavor  opts
                 )
                 || not (ehcOptHiValidityCheck opts)
              then do { hi_nm     <- sget
                      ; hi_hm     <- sget
                      ; hi_m      <- sget
                      ; hi_mm     <- sget
                      ; hi_mmm    <- sget
                      ; hi_svn    <- sget
                      ; e         <- sget
                      ; he        <- sget
                      ; fg        <- sget
                      ; impd      <- sget
                      ; impu      <- sget
                      ; tclused   <- sget
                      ; tclorph   <- sget
                      ; isorph    <- sget
                      ; vg        <- sget
                      ; tg        <- sget
                      ; tkg       <- sget
                      ; pg        <- sget
                      ; dg        <- sget
                      ; cg        <- sget
                      ; cdg       <- sget
                      ; cs        <- sget
                      ; am        <- sget
                      ; him       <- sget
                      ; return
                          (emptyHIInfo
                            { hiiValidity             = HIValidity_Ok
                            , hiiSrcSig               = hi_sig
                            , hiiCompiler             = hi_comp
                            , hiiCompileFlags         = hi_fl
                            , hiiTarget               = hi_t
                            , hiiTargetFlavor         = hi_tv
                            , hiiHasMain              = hi_hm
                            , hiiSrcTimeStamp         = hi_ts
                            , hiiInternalVersions     = hi_iv
                            , hiiModuleNm             = hi_nm
                            , hiiSrcVersionMajor      = hi_m
                            , hiiSrcVersionMinor      = hi_mm
                            , hiiSrcVersionMinorMinor = hi_mmm
                            , hiiSrcVersionSvn        = hi_svn
                            , hiiExps                 = e
                            , hiiHiddenExps           = he
                            , hiiFixityGam            = fg
                            , hiiHIDeclImpModS        = impd
                            , hiiHIUsedImpModS        = impu
                            , hiiTransClosedUsedModMp = tclused
                            , hiiTransClosedOrphanModS= tclorph
                            , hiiMbOrphan             = isorph
                            , hiiValGam               = vg
                            , hiiTyGam                = tg
                            , hiiTyKiGam              = tkg
                            , hiiPolGam               = pg
                            , hiiDataGam              = dg
                            , hiiClGam                = cg
                            , hiiClDfGam              = cdg
                            , hiiCHRStore             = cs
                            , hiiLamMp                = am
                            , hiiImpHIMp              = him
                            })
                      }
              else return $
                     emptyHIInfo
                       { hiiValidity             = HIValidity_Inconsistent
                       , hiiSrcSig               = hi_sig
                       , hiiSrcTimeStamp         = hi_ts
                       , hiiInternalVersions     = hi_iv
                       , hiiCompileFlags         = hi_fl
                       , hiiCompiler             = hi_comp
                       , hiiTarget               = hi_t
                       , hiiTargetFlavor         = hi_tv
                       }
            }
    else return $
           emptyHIInfo
             { hiiValidity             = HIValidity_WrongMagic
             }
  }



























instance Serialize HIInfo where
  sput       (HIInfo
                  { hiiSrcSig               = hi_sig
                  , hiiTarget               = hi_t
                  , hiiTargetFlavor         = hi_tv
                  , hiiCompiler             = hi_comp
                  , hiiCompileFlags         = hi_fl
                  , hiiModuleNm             = hi_nm
                  , hiiHasMain              = hi_hm
                  , hiiSrcTimeStamp         = hi_ts
                  , hiiInternalVersions     = hi_iv
                  , hiiSrcVersionMajor      = hi_m
                  , hiiSrcVersionMinor      = hi_mm
                  , hiiSrcVersionMinorMinor = hi_mmm
                  , hiiSrcVersionSvn        = hi_svn
                  , hiiExps                 = e
                  , hiiHiddenExps           = he
                  , hiiFixityGam            = fg
                  , hiiHIDeclImpModS        = impd
                  , hiiHIUsedImpModS        = impu
                  , hiiTransClosedUsedModMp = tclused
                  , hiiTransClosedOrphanModS= tclorph
                  , hiiMbOrphan             = isorph
                  , hiiValGam               = vg
                  , hiiTyGam                = tg
                  , hiiTyKiGam              = tkg
                  , hiiPolGam               = pg
                  , hiiDataGam              = dg
                  , hiiClGam                = cg
                  , hiiClDfGam              = cdg
                  , hiiCHRStore             = cs
                  , hiiLamMp                = am
                  , hiiImpHIMp              = him
                  })
              =    mapM sputWord8 Cfg.magicNumberHI
                >> sput hi_sig
                >> sput hi_ts
                >> sput hi_iv
                >> sput hi_t
                >> sput hi_tv
                >> sput hi_fl
                >> sput hi_comp
                >> sput hi_nm
                >> sput hi_hm
                >> sput hi_m
                >> sput hi_mm
                >> sput hi_mmm
                >> sput hi_svn
                >> sput e
                >> sput he
                >> sput (gamFlatten fg)
                >> sput impd
                >> sput impu
                >> sput tclused
                >> sput tclorph
                >> sput isorph
                >> sput (gamFlatten vg)
                >> sput (gamFlatten tg)
                >> sput (gamFlatten tkg)
                >> sput (gamFlatten pg)
                >> sput (gamFlatten dg)
                >> sput (gamFlatten cg)
                >> sput (gamFlatten cdg)
                >> sput cs
                >> sput am
                >> sput him

  sget = sgetHIInfo (defaultEHCOpts
                       { ehcOptHiValidityCheck = False
                       }
                    )


</pre>