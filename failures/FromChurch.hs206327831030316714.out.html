<a href="from_xsd.hs1703775251803694459.out.html">prev</a></br><a href="failures.html">home</a></br><a href="FromHs.hs13723664371388337879.out.html">next</a></br></br><pre>12d11
< type instance PathArg (Term a     ': '[] ) = a
13d11
< type instance PathArg (Meta a b p ': rest) = PathArg rest
14d11
< type instance PathArg (InR l p    ': rest) = PathArg rest
15c12
< type instance PathArg (InL r p    ': rest) = PathArg rest
---
> type instance PathArg (Term a      :     ) = a
15a13
> type instance PathArg (Meta a b p  : rest) = PathArg rest
15a14
> type instance PathArg (InR l p     : rest) = PathArg rest
15a15
> type instance PathArg (InL r p     : rest) = PathArg rest
31d30
< type instance MakeProdPaths (K1 a t p) s all    = Reverse (Term (K1 a t p) ': s) ': all
32c31
< type instance MakeProdPaths (M1 a b f p) s all  = MakeProdPaths (f p) (Meta a b p ': s) all
---
> type instance MakeProdPaths (K1 a t p) s all    = Reverse (Term (K1 a t p)  : s)  : all
32a32
> type instance MakeProdPaths (M1 a b f p) s all  = MakeProdPaths (f p) (Meta a b p  : s) all
34d33
<   Append (MakeProdPaths (l p) (InL (r p) p ': s) '[])
35c34
<           (Append (MakeProdPaths (r p) (InR (l p) p ': s) '[]) all)
---
>   Append (MakeProdPaths (l p) (InL (r p) p  : s)    )
35a35
>           (Append (MakeProdPaths (r p) (InR (l p) p  : s)    ) all)
39c39
< instance GUpdate (Term (K1 a t p) ': '[]) (K1 a t p) where
---
> instance GUpdate (Term (K1 a t p)  :    ) (K1 a t p) where
41c41
< instance GUpdate rest (l p) => GUpdate (InL (r p) p ': rest) ((:*:) l r p) where
---
> instance GUpdate rest (l p) => GUpdate (InL (r p) p  : rest) ((:*:) l r p) where
43c43
< instance GUpdate rest (r p) => GUpdate (InR (l p) p ': rest) ((:*:) l r p) where
---
> instance GUpdate rest (r p) => GUpdate (InR (l p) p  : rest) ((:*:) l r p) where
45c45
< instance GUpdate rest (f p) => GUpdate (Meta a b p ': rest) (M1 a b f p) where
---
> instance GUpdate rest (f p) => GUpdate (Meta a b p  : rest) (M1 a b f p) where
49d48
< type instance Fill (x ': xs) r = StripK (PathArg x) -> Fill xs r
50c49
< type instance Fill '[] r = r
---
> type instance Fill (x  : xs) r = StripK (PathArg x) -> Fill xs r
50a50
> type instance Fill     r = r
54c54
< instance GFill '[] a where
---
> instance GFill     a where
57c57
<          GFill (x ': xs) a where
---
>          GFill (x  : xs) a where
62d61
<   Append (MakePaths (l p) (InL (r p) p ': s) '[])
63c62
<           (Append (MakePaths (r p) (InR (l p) p ': s) '[]) all)
---
>   Append (MakePaths (l p) (InL (r p) p  : s)    )
63a63
>           (Append (MakePaths (r p) (InR (l p) p  : s)    ) all)
65d64
<   MakePaths (f p) (Meta a b p ': s) all
66d64
< type instance MakePaths (K1 a t p) s all    =  Reverse (Term (K1 a t p) ': s)    ': all
67d64
< type instance MakePaths (U1 p) s all        =  Reverse (Term (U1 p) ': s)        ': all
68c65
< type instance MakePaths ((:*:) l r p) s all =  Reverse (Term ((:*:) l r p) ': s) ': all
---
>   MakePaths (f p) (Meta a b p  : s) all
68a66
> type instance MakePaths (K1 a t p) s all    =  Reverse (Term (K1 a t p)  : s)     : all
68a67
> type instance MakePaths (U1 p) s all        =  Reverse (Term (U1 p)  : s)         : all
68a68
> type instance MakePaths ((:*:) l r p) s all =  Reverse (Term ((:*:) l r p)  : s)  : all
71c71
< type instance ReconstructPath (InL r p  ': rest) =
---
> type instance ReconstructPath (InL r p   : rest) =
73c73
< type instance ReconstructPath (InR l p  ': rest) =
---
> type instance ReconstructPath (InR l p   : rest) =
75d74
< type instance ReconstructPath (Meta a b p ': rest) = M1 a b (WithoutParam (ReconstructPath rest)) p
76c75
< type instance ReconstructPath (Term a     ': '[])  = a
---
> type instance ReconstructPath (Meta a b p  : rest) = M1 a b (WithoutParam (ReconstructPath rest)) p
76a76
> type instance ReconstructPath (Term a      :    )  = a
80c80
< instance GPath (Term a ': '[]) where
---
> instance GPath (Term a  :    ) where
83c83
<          => GPath (InR r p ': rest) where
---
>          => GPath (InR r p  : rest) where
86c86
<          => GPath (InL l p ': rest) where
---
>          => GPath (InL l p  : rest) where
89c89
<          => GPath (Meta a b p ': rest) where
---
>          => GPath (Meta a b p  : rest) where
97c97
<          => GBuild (x ': xs) (r -> f') r where
---
>          => GBuild (x  : xs) (r -> f') r where
99c99
< instance ((f -> g) ~ Fill (MakeProdPaths (PathArg x) '[] '[]) r,
---
> instance ((f -> g) ~ Fill (MakeProdPaths (PathArg x)        ) r,
101c101
<           (GFill (MakeProdPaths (PathArg x) '[] '[]) (PathArg x)),
---
>           (GFill (MakeProdPaths (PathArg x)        ) (PathArg x)),
103c103
<          => GBuild (x ': xs) ((f -> g) -> f') r where
---
>          => GBuild (x  : xs) ((f -> g) -> f') r where
106c106
<           prod :: forall xs. Proxy xs -> Proxy (MakeProdPaths (PathArg (Head xs)) '[] '[])
---
>           prod :: forall xs. Proxy xs -> Proxy (MakeProdPaths (PathArg (Head xs))        )
108c108
< instance GBuild '[] r r where
---
> instance GBuild     r r where
109a110
> 
</pre></br><h2>original</h2></br><pre>{-# LANGUAGE TypeFamilies,          TypeOperators,     UndecidableInstances #-}
{-# LANGUAGE MultiParamTypeClasses, FlexibleInstances, FlexibleContexts     #-}
{-# LANGUAGE ScopedTypeVariables,   PolyKinds,         DataKinds            #-}
module Data.Church.Internal.FromChurch where
import Data.Proxy
import GHC.Generics
import Data.Church.Internal.TF

data Traverse a = Meta a a a | InL a a | InR a a | Term a

type family PathArg (t :: [Traverse *])
type instance PathArg (Term a     ': '[] ) = a
type instance PathArg (Meta a b p ': rest) = PathArg rest
type instance PathArg (InR l p    ': rest) = PathArg rest
type instance PathArg (InL r p    ': rest) = PathArg rest

-- | Construct a product type where all the fields are
-- _|_
class GEmpty a where
  empty :: a
instance GEmpty (U1 p) where
  empty = U1
instance GEmpty (K1 a t p) where
  empty = K1 (error "generic-church: Error! The impossible has happened.")
instance GEmpty (f p) => GEmpty (M1 a b f p) where
  empty = M1 empty
instance (GEmpty (l p), GEmpty (r p)) => GEmpty ((:*:) l r p) where
  empty = empty :*: empty

type family MakeProdPaths v (m :: [Traverse *]) (r :: [ [Traverse *] ]) :: [[Traverse *]]
type instance MakeProdPaths (K1 a t p) s all    = Reverse (Term (K1 a t p) ': s) ': all
type instance MakeProdPaths (M1 a b f p) s all  = MakeProdPaths (f p) (Meta a b p ': s) all
type instance MakeProdPaths ((:*:) l r p) s all =
  Append (MakeProdPaths (l p) (InL (r p) p ': s) '[])
          (Append (MakeProdPaths (r p) (InR (l p) p ': s) '[]) all)

class GUpdate (path :: [Traverse *]) a where
  update :: Proxy path -> a -> PathArg path -> a
instance GUpdate (Term (K1 a t p) ': '[]) (K1 a t p) where
  update _ _ a = a
instance GUpdate rest (l p) => GUpdate (InL (r p) p ': rest) ((:*:) l r p) where
  update p (l :*: r) a = update (pTail p) l a :*: r
instance GUpdate rest (r p) => GUpdate (InR (l p) p ': rest) ((:*:) l r p) where
  update p (l :*: r) a = l :*: update (pTail p) r a
instance GUpdate rest (f p) => GUpdate (Meta a b p ': rest) (M1 a b f p) where
  update p (M1 f) a = M1 (update (pTail p) f a)

type family Fill (paths :: [[Traverse *]]) r
type instance Fill (x ': xs) r = StripK (PathArg x) -> Fill xs r
type instance Fill '[] r = r

class GFill (paths :: [[Traverse *]]) a where
  fill :: Proxy paths -> (a -> r) -> a -> Fill paths r
instance GFill '[] a where
  fill _ f a = f a
instance (PathArg x ~ K1 m t p, StripK (PathArg x) ~ t, GUpdate x a, GFill xs a) =>
         GFill (x ': xs) a where
  fill p f a = \x -> fill (pTail p) f $ update (pHead p) a (K1 x)

type family MakePaths v (m :: [Traverse *]) (r :: [ [Traverse *] ]) :: [[Traverse *]]
type instance MakePaths ((:+:) l r p) s all =
  Append (MakePaths (l p) (InL (r p) p ': s) '[])
          (Append (MakePaths (r p) (InR (l p) p ': s) '[]) all)
type instance MakePaths (M1 a b f p) s all  =
  MakePaths (f p) (Meta a b p ': s) all
type instance MakePaths (K1 a t p) s all    =  Reverse (Term (K1 a t p) ': s)    ': all
type instance MakePaths (U1 p) s all        =  Reverse (Term (U1 p) ': s)        ': all
type instance MakePaths ((:*:) l r p) s all =  Reverse (Term ((:*:) l r p) ': s) ': all

type family ReconstructPath (t :: [Traverse *])
type instance ReconstructPath (InL r p  ': rest) =
  (WithoutParam (ReconstructPath rest) :+: WithoutParam r) p
type instance ReconstructPath (InR l p  ': rest) =
  (WithoutParam l :+: WithoutParam (ReconstructPath rest)) p
type instance ReconstructPath (Meta a b p ': rest) = M1 a b (WithoutParam (ReconstructPath rest)) p
type instance ReconstructPath (Term a     ': '[])  = a

class GPath (p :: [Traverse *]) where
  path :: Proxy p -> PathArg p -> ReconstructPath p
instance GPath (Term a ': '[]) where
  path _ = id
instance ((WithoutParam (ReconstructPath rest)) p ~ ReconstructPath rest, GPath rest)
         => GPath (InR r p ': rest) where
  path p a = R1 $ path (pTail p) a
instance ((WithoutParam (ReconstructPath rest)) p ~ ReconstructPath rest, GPath rest)
         => GPath (InL l p ': rest) where
  path p a = L1 $ path (pTail p) a
instance ((WithoutParam (ReconstructPath rest)) p ~ ReconstructPath rest, GPath rest)
         => GPath (Meta a b p ': rest) where
  path p a = M1 $ path (pTail p) a

class GBuild (paths :: [[Traverse *]])f r where
  build :: Proxy paths -> f -> r

-- | Unit case. This represents constructors with no arguments
instance (ReconstructPath x ~ r, GPath x, GBuild xs f' r, PathArg x ~ U1 p)
         => GBuild (x ': xs) (r -> f') r where
  build p f = build (pTail p) $ f (path (pHead p) U1)
instance ((f -> g) ~ Fill (MakeProdPaths (PathArg x) '[] '[]) r,
          ReconstructPath x ~ r, GEmpty (PathArg x), GBuild xs f' r,
          (GFill (MakeProdPaths (PathArg x) '[] '[]) (PathArg x)),
          GPath x)
         => GBuild (x ': xs) ((f -> g) -> f') r where
  build p f = build (pTail p) $ f (fill (prod p) (path (pHead p)) empty)
    where
          prod :: forall xs. Proxy xs -> Proxy (MakeProdPaths (PathArg (Head xs)) '[] '[])
          prod _ = Proxy
instance GBuild '[] r r where
  build _ f = f
</pre></br><h2>printed</h2></br><pre>{-# LANGUAGE TypeFamilies,          TypeOperators,     UndecidableInstances #-}
{-# LANGUAGE MultiParamTypeClasses, FlexibleInstances, FlexibleContexts     #-}
{-# LANGUAGE ScopedTypeVariables,   PolyKinds,         DataKinds            #-}
module Data.Church.Internal.FromChurch where
import Data.Proxy
import GHC.Generics
import Data.Church.Internal.TF

data Traverse a = Meta a a a | InL a a | InR a a | Term a

type family PathArg (t :: [Traverse *])
type instance PathArg (Term a      :     ) = a
type instance PathArg (Meta a b p  : rest) = PathArg rest
type instance PathArg (InR l p     : rest) = PathArg rest
type instance PathArg (InL r p     : rest) = PathArg rest

-- | Construct a product type where all the fields are
-- _|_
class GEmpty a where
  empty :: a
instance GEmpty (U1 p) where
  empty = U1
instance GEmpty (K1 a t p) where
  empty = K1 (error "generic-church: Error! The impossible has happened.")
instance GEmpty (f p) => GEmpty (M1 a b f p) where
  empty = M1 empty
instance (GEmpty (l p), GEmpty (r p)) => GEmpty ((:*:) l r p) where
  empty = empty :*: empty

type family MakeProdPaths v (m :: [Traverse *]) (r :: [ [Traverse *] ]) :: [[Traverse *]]
type instance MakeProdPaths (K1 a t p) s all    = Reverse (Term (K1 a t p)  : s)  : all
type instance MakeProdPaths (M1 a b f p) s all  = MakeProdPaths (f p) (Meta a b p  : s) all
type instance MakeProdPaths ((:*:) l r p) s all =
  Append (MakeProdPaths (l p) (InL (r p) p  : s)    )
          (Append (MakeProdPaths (r p) (InR (l p) p  : s)    ) all)

class GUpdate (path :: [Traverse *]) a where
  update :: Proxy path -> a -> PathArg path -> a
instance GUpdate (Term (K1 a t p)  :    ) (K1 a t p) where
  update _ _ a = a
instance GUpdate rest (l p) => GUpdate (InL (r p) p  : rest) ((:*:) l r p) where
  update p (l :*: r) a = update (pTail p) l a :*: r
instance GUpdate rest (r p) => GUpdate (InR (l p) p  : rest) ((:*:) l r p) where
  update p (l :*: r) a = l :*: update (pTail p) r a
instance GUpdate rest (f p) => GUpdate (Meta a b p  : rest) (M1 a b f p) where
  update p (M1 f) a = M1 (update (pTail p) f a)

type family Fill (paths :: [[Traverse *]]) r
type instance Fill (x  : xs) r = StripK (PathArg x) -> Fill xs r
type instance Fill     r = r

class GFill (paths :: [[Traverse *]]) a where
  fill :: Proxy paths -> (a -> r) -> a -> Fill paths r
instance GFill     a where
  fill _ f a = f a
instance (PathArg x ~ K1 m t p, StripK (PathArg x) ~ t, GUpdate x a, GFill xs a) =>
         GFill (x  : xs) a where
  fill p f a = \x -> fill (pTail p) f $ update (pHead p) a (K1 x)

type family MakePaths v (m :: [Traverse *]) (r :: [ [Traverse *] ]) :: [[Traverse *]]
type instance MakePaths ((:+:) l r p) s all =
  Append (MakePaths (l p) (InL (r p) p  : s)    )
          (Append (MakePaths (r p) (InR (l p) p  : s)    ) all)
type instance MakePaths (M1 a b f p) s all  =
  MakePaths (f p) (Meta a b p  : s) all
type instance MakePaths (K1 a t p) s all    =  Reverse (Term (K1 a t p)  : s)     : all
type instance MakePaths (U1 p) s all        =  Reverse (Term (U1 p)  : s)         : all
type instance MakePaths ((:*:) l r p) s all =  Reverse (Term ((:*:) l r p)  : s)  : all

type family ReconstructPath (t :: [Traverse *])
type instance ReconstructPath (InL r p   : rest) =
  (WithoutParam (ReconstructPath rest) :+: WithoutParam r) p
type instance ReconstructPath (InR l p   : rest) =
  (WithoutParam l :+: WithoutParam (ReconstructPath rest)) p
type instance ReconstructPath (Meta a b p  : rest) = M1 a b (WithoutParam (ReconstructPath rest)) p
type instance ReconstructPath (Term a      :    )  = a

class GPath (p :: [Traverse *]) where
  path :: Proxy p -> PathArg p -> ReconstructPath p
instance GPath (Term a  :    ) where
  path _ = id
instance ((WithoutParam (ReconstructPath rest)) p ~ ReconstructPath rest, GPath rest)
         => GPath (InR r p  : rest) where
  path p a = R1 $ path (pTail p) a
instance ((WithoutParam (ReconstructPath rest)) p ~ ReconstructPath rest, GPath rest)
         => GPath (InL l p  : rest) where
  path p a = L1 $ path (pTail p) a
instance ((WithoutParam (ReconstructPath rest)) p ~ ReconstructPath rest, GPath rest)
         => GPath (Meta a b p  : rest) where
  path p a = M1 $ path (pTail p) a

class GBuild (paths :: [[Traverse *]])f r where
  build :: Proxy paths -> f -> r

-- | Unit case. This represents constructors with no arguments
instance (ReconstructPath x ~ r, GPath x, GBuild xs f' r, PathArg x ~ U1 p)
         => GBuild (x  : xs) (r -> f') r where
  build p f = build (pTail p) $ f (path (pHead p) U1)
instance ((f -> g) ~ Fill (MakeProdPaths (PathArg x)        ) r,
          ReconstructPath x ~ r, GEmpty (PathArg x), GBuild xs f' r,
          (GFill (MakeProdPaths (PathArg x)        ) (PathArg x)),
          GPath x)
         => GBuild (x  : xs) ((f -> g) -> f') r where
  build p f = build (pTail p) $ f (fill (prod p) (path (pHead p)) empty)
    where
          prod :: forall xs. Proxy xs -> Proxy (MakeProdPaths (PathArg (Head xs))        )
          prod _ = Proxy
instance GBuild     r r where
  build _ f = f

</pre>